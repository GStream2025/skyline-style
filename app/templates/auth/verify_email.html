{% extends "base.html" %}
{% block title %}Verificar correo · {{ (APP_NAME or "Skyline Store")|e }}{% endblock %}

{% block extra_head %}
<meta name="robots" content="{{ 'index,follow' if (ENV|default('')|lower == 'production') else 'noindex,nofollow' }}">
{% set _csp_nonce = (csp_nonce if csp_nonce is defined and csp_nonce else (nonce if nonce is defined and nonce else '')) %}

{% set _csrf = '' %}
{% if csrf_token is defined and csrf_token %}
  {% set _csrf = csrf_token() %}
{% elif csrf_token_value is defined and csrf_token_value %}
  {% set _csrf = csrf_token_value %}
{% endif %}
<meta name="csrf-token" content="{{ (_csrf|string)|e }}">

{% set _has_ep = has_endpoint if has_endpoint is defined else none %}
{% macro safe_url(ep, fb='') %}{% if _has_ep and _has_ep(ep) %}{{ url_for(ep) }}{% else %}{{ fb }}{% endif %}{% endmacro %}

<style{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
.ss-ve{min-height:70vh;display:grid;place-items:center;padding:32px 14px}
.ss-ve__card{max-width:560px;width:100%;border-radius:26px;border:1px solid rgba(148,163,184,.22);background:rgba(255,255,255,.9);box-shadow:0 22px 60px rgba(2,6,23,.12)}
.ss-ve__head{padding:20px;border-bottom:1px solid rgba(148,163,184,.16)}
.ss-ve__body{padding:20px}
.ss-ve__title{font-size:clamp(1.4rem,3vw,1.9rem);font-weight:900}
.ss-ve__sub{margin-top:.4rem;color:rgba(11,18,32,.7);font-weight:700}
.ss-ve__flash{margin-top:12px;padding:10px 12px;border-radius:14px;font-weight:800}
.ss-ve__flash.error{background:rgba(255,0,0,.06)}
.ss-ve__flash.success{background:rgba(34,197,94,.1)}
.ss-ve__flash.info{background:rgba(47,123,255,.08)}
.ss-ve__note{margin-top:14px;padding:12px;border-radius:16px;border:1px dashed rgba(148,163,184,.32);font-size:.86rem}
.ss-ve__actions{display:grid;gap:10px;margin-top:16px}
.ss-ve__btn{padding:12px 14px;border-radius:999px;border:1px solid rgba(15,23,42,.12);font-weight:900;cursor:pointer}
.ss-ve__btn[disabled]{opacity:.65;cursor:not-allowed}
.ss-ve__live{display:none;margin-top:12px;font-size:.86rem;font-weight:800}
.ss-ve__live.is-on{display:block}
.ss-ve__spin{width:16px;height:16px;border-radius:999px;border:2px solid rgba(253,230,138,.25);border-top-color:rgba(253,230,138,.95);animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(prefers-reduced-motion:reduce){.ss-ve__spin{animation:none}}
</style>
{% endblock %}

{% block content %}
{% set email = (user.email if user is defined and user and user.email is defined else '')|trim %}
{% set home_url = safe_url('main.home','/') %}
{% set shop_url = safe_url('shop.shop','/shop') %}
{% set resend_json = safe_url('auth.resend_verification_json','') %}
{% set resend_post = safe_url('auth.resend_verification','') %}
{% set resend_ep = resend_json if resend_json else resend_post %}
{% set resend_is_json = true if resend_json else false %}

<section class="ss-ve">
  <div class="ss-ve__card">
    <div class="ss-ve__head">
      <h1 class="ss-ve__title">Verificá tu correo</h1>
      <p class="ss-ve__sub">
        {% if email %}Enviamos un enlace a <b>{{ email|e }}</b>.{% else %}Enviamos un enlace a tu correo.{% endif %}
        Confirmalo para activar tu cuenta.
      </p>
    </div>

    <div class="ss-ve__body">
      {% for c,m in get_flashed_messages(with_categories=true) %}
        {% set k = c if c in ['error','success','info'] else 'info' %}
        <div class="ss-ve__flash {{ k }}">{{ m }}</div>
      {% endfor %}

      <div class="ss-ve__note">
        Revisá Spam o Promociones. El enlace puede tardar unos minutos.
      </div>

      <div id="veLive" class="ss-ve__live" role="status"></div>

      <form id="resendForm" method="post" action="{{ resend_ep }}">
        <input type="hidden" name="csrf_token" value="{{ (_csrf|string)|e }}">
        {% if email %}<input type="hidden" name="email" value="{{ email|e }}">{% endif %}
      </form>

      <div class="ss-ve__actions">
        <button id="btnResend" class="ss-ve__btn"
                {% if not resend_ep %}disabled aria-disabled="true"{% endif %}>
          <span id="veSpin" class="ss-ve__spin" style="display:none"></span>
          <span id="btnTxt">{% if resend_ep %}Reenviar correo{% else %}Reenvío no disponible{% endif %}</span>
        </button>
        <a class="ss-ve__btn" href="{{ home_url }}">Volver al inicio</a>
      </div>

      <p style="margin-top:14px;font-size:.82rem">
        ¿Ya verificaste? Cerrá sesión y volvé a entrar.
        <a href="{{ shop_url }}">Ir a la tienda</a>
      </p>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
(() => {
  const btn = document.getElementById('btnResend');
  const txt = document.getElementById('btnTxt');
  const spin = document.getElementById('veSpin');
  const live = document.getElementById('veLive');
  const form = document.getElementById('resendForm');

  const endpoint = {{ resend_ep|tojson }};
  const isJson = {{ resend_is_json|tojson }};
  const COOLDOWN = 30000;
  const KEY = "ss_verify_cd";

  const say = m => { if(live){ live.textContent=m||''; live.classList.toggle('is-on',!!m);} };
  const getCd = () => parseInt(localStorage.getItem(KEY)||"0",10);
  const setCd = t => localStorage.setItem(KEY,String(t));

  const updateBtn = () => {
    const left = Math.ceil((getCd()-Date.now())/1000);
    if(left>0){
      btn.disabled=true; txt.textContent=`Reenviar en ${left}s`;
    }else{
      btn.disabled=!endpoint; txt.textContent=endpoint?"Reenviar correo":"Reenvío no disponible";
    }
  };

  const send = async () => {
    if(!endpoint || btn.disabled) return;
    setCd(Date.now()+COOLDOWN);
    updateBtn();
    spin.style.display='inline-block';
    say("Enviando correo…");

    if(!isJson){
      try{ form.submit(); }catch(_){}
      return;
    }

    try{
      const csrf = document.querySelector('meta[name="csrf-token"]')?.content || '';
      const r = await fetch(endpoint,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Accept":"application/json",
          "X-CSRF-Token":csrf
        },
        credentials:"same-origin"
      });
      const j = await r.json();
      if(!r.ok || j.ok===false) throw new Error(j.message||"Error");
      say("Correo reenviado. Revisá tu email.");
    }catch(e){
      say("No se pudo reenviar automáticamente. Intentá más tarde.");
    }finally{
      spin.style.display='none';
      updateBtn();
    }
  };

  if(btn) btn.addEventListener('click', send);
  setInterval(updateBtn,500);
  updateBtn();
})();
</script>
{% endblock %}
