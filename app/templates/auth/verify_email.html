{% extends "base.html" %}

{% block title %}Verificar correo ¬∑ Skyline Store{% endblock %}

{% block extra_head %}
{# ==========================================================
   VERIFY EMAIL ‚Äî ULTRA PRO (FINAL)
   - Sin dependencias
   - CSRF real (csrf_token() o variable)
   - Endpoints robustos
   - Cooldown persistente (localStorage)
   - Accesible y responsive
========================================================== #}

{# Meta CSRF para fetch (si base.html no lo incluye) #}
{% if csrf_token is defined %}
  {% if csrf_token is callable %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
  {% else %}
    <meta name="csrf-token" content="{{ csrf_token }}">
  {% endif %}
{% endif %}

<style>
  .ss-ve{
    --ink: var(--ink, #0b1220);
    --muted: rgba(11,18,32,.68);
    --stroke: rgba(148,163,184,.22);
    --shadow: 0 22px 60px rgba(2,6,23,.12);
    --ease: var(--ease, cubic-bezier(.2,.8,.2,1));
    min-height: 70vh;
    display:grid;
    place-items:center;
    padding: clamp(26px, 4vw, 44px) 14px;
    background:
      radial-gradient(820px 460px at 12% 0%, rgba(47,123,255,.08), transparent 60%),
      radial-gradient(820px 460px at 88% 12%, rgba(255,181,71,.10), transparent 60%);
  }

  .ss-ve__card{
    width:100%;
    max-width: 560px;
    border-radius: 26px;
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.88);
    box-shadow: var(--shadow);
    overflow:hidden;
  }

  .ss-ve__head{
    padding: 18px 18px 14px;
    background:
      radial-gradient(520px 240px at 0% 0%, rgba(245,158,11,.18), transparent 60%),
      radial-gradient(520px 240px at 100% 0%, rgba(56,189,248,.16), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.84), rgba(255,255,255,.76));
    border-bottom: 1px solid rgba(148,163,184,.16);
  }

  .ss-ve__body{ padding: 16px 18px 18px; }
  @media(min-width:520px){
    .ss-ve__body{ padding: 18px 20px 20px; }
    .ss-ve__head{ padding: 20px 20px 16px; }
  }

  .ss-ve__icon{
    width:54px;height:54px;border-radius:18px;
    display:grid;place-items:center;
    background: rgba(245,158,11,.12);
    border:1px solid rgba(245,158,11,.25);
    box-shadow: 0 10px 22px rgba(2,6,23,.08);
  }

  .ss-ve__title{
    margin: 10px 0 0;
    font-weight: 1000;
    letter-spacing: -.6px;
    color: var(--ink);
    font-size: clamp(1.4rem, 3vw, 1.9rem);
    line-height: 1.15;
  }

  .ss-ve__sub{
    margin: .5rem 0 0;
    color: var(--muted);
    font-weight: 850;
    line-height: 1.55;
  }

  .ss-ve__flash{
    margin-top: 12px;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,.20);
    background: rgba(255,255,255,.74);
    color: rgba(11,18,32,.80);
    font-weight: 900;
    font-size: .88rem;
  }
  .ss-ve__flash.error{ background: rgba(255,0,0,.06); border-color: rgba(255,0,0,.14); }
  .ss-ve__flash.warning{ background: rgba(255,181,71,.10); border-color: rgba(255,181,71,.18); }
  .ss-ve__flash.success{ background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.18); }
  .ss-ve__flash.info{ background: rgba(47,123,255,.08); border-color: rgba(47,123,255,.16); }

  .ss-ve__note{
    margin-top: 12px;
    padding: 12px 12px;
    border-radius: 16px;
    border: 1px dashed rgba(148,163,184,.32);
    background: rgba(248,250,252,.78);
    color: rgba(11,18,32,.76);
    font-size: .86rem;
    line-height: 1.45;
    font-weight: 850;
  }

  .ss-ve__live{
    margin-top: 10px;
    border-radius: 14px;
    padding: 10px 12px;
    border: 1px solid rgba(148,163,184,.20);
    background: rgba(255,255,255,.72);
    color: rgba(11,18,32,.78);
    font-weight: 900;
    font-size: .86rem;
    display:none;
  }
  .ss-ve__live.is-on{ display:block; }

  .ss-ve__actions{ display:grid; gap:10px; margin-top: 14px; }

  .ss-ve__btn{
    display:inline-flex; align-items:center; justify-content:center; gap:10px;
    padding: 12px 14px;
    border-radius: 999px;
    border: 1px solid rgba(15,23,42,.12);
    background: rgba(11,18,32,.96);
    color: rgba(253,230,138,.96);
    font-weight: 1000;
    cursor:pointer;
    transition: transform .14s var(--ease), box-shadow .14s var(--ease), filter .14s var(--ease);
    user-select:none;
    text-decoration:none;
  }
  .ss-ve__btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 26px rgba(2,6,23,.14); filter:saturate(1.05) }
  .ss-ve__btn:active{ transform: translateY(0) }
  .ss-ve__btn[disabled]{ opacity:.72; cursor:not-allowed; transform:none; box-shadow:none; }

  .ss-ve__btn--ghost{
    background: transparent;
    color: rgba(11,18,32,.86);
  }

  .ss-ve__row{
    display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between;
    gap: 10px;
    margin-top: 12px;
  }
  .ss-ve__link{
    display:inline-flex; align-items:center; gap:8px;
    font-size: .88rem;
    color: rgba(245,158,11,.92);
    text-decoration:none;
    font-weight: 950;
  }
  .ss-ve__link:hover{ opacity:.92; text-decoration: underline; }

  .ss-ve__small{
    margin: 12px 0 0;
    color: rgba(11,18,32,.56);
    font-size: .82rem;
    font-weight: 850;
    line-height: 1.45;
  }

  .ss-ve__spin{
    width:16px;height:16px;border-radius:999px;
    border:2px solid rgba(253,230,138,.25);
    border-top-color: rgba(253,230,138,.96);
    animation: ss-ve-rot .9s linear infinite;
  }
  @keyframes ss-ve-rot{ to{ transform: rotate(360deg) } }

  .ss-ve :focus-visible{
    outline:none;
    box-shadow: 0 0 0 4px rgba(37,99,235,.18);
    border-radius: 12px;
  }

  @media (prefers-reduced-motion: reduce){
    .ss-ve *{ transition:none!important; }
    .ss-ve__spin{ animation:none!important; }
    .ss-ve__btn:hover{ transform:none!important; }
  }

  @media print{
    header.topbar, footer, .ss-header, .ss-footer, nav{ display:none!important; }
    .ss-ve{ min-height:auto; padding:0; }
    .ss-ve__card{ box-shadow:none; border:1px solid #ddd; background:#fff; }
  }
</style>
{% endblock %}

{% block content %}
{# ---------------- Datos seguros ---------------- #}
{% set email = (user.email if user is defined and user and user.email is defined else (customer_email if customer_email is defined else "")) %}
{% set support_email = (support_email if support_email is defined else "soporte@skylinestore.com") %}

{# URLs robustas #}
{% set home_url = (url_for('main.home') if 'main.home' in current_app.view_functions else '/') %}
{% set shop_url = (url_for('shop.shop') if 'shop.shop' in current_app.view_functions else '/shop') %}

{# Endpoint de reenv√≠o: prioriza uno ‚Äújson‚Äù, sino normal #}
{% if 'auth.resend_verification_json' in current_app.view_functions %}
  {% set resend_endpoint = url_for('auth.resend_verification_json') %}
{% elif 'auth.resend_verification' in current_app.view_functions %}
  {% set resend_endpoint = url_for('auth.resend_verification') %}
{% else %}
  {% set resend_endpoint = '' %}
{% endif %}

<section class="ss-ve" aria-label="Verificar correo">
  <div class="ss-ve__card" role="region" aria-label="Verificaci√≥n de email">

    <div class="ss-ve__head">
      <div class="ss-ve__icon" aria-hidden="true">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:rgba(245,158,11,.95)" stroke-width="1.8">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l9 6 9-6M5 19h14a2 2 0 002-2V7a2 2 0 00-1-1.732L12 2 4 5.268A2 2 0 003 7v10a2 2 0 002 2z"/>
        </svg>
      </div>

      <h1 class="ss-ve__title">Verific√° tu correo</h1>
      <p class="ss-ve__sub">
        {% if email %}
          Te enviamos un enlace a <b>{{ email }}</b> para confirmar tu cuenta.
        {% else %}
          Te enviamos un enlace para confirmar tu cuenta.
        {% endif %}
        Este paso ayuda a mantener tu perfil m√°s seguro.
      </p>
    </div>

    <div class="ss-ve__body">

      {# Flash por redirect #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="ss-ve__flash {{ category|e }}">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <div class="ss-ve__note">
        üîí <b>Tip:</b> revis√° ‚ÄúSpam/Promociones‚Äù. A veces el correo cae ah√≠.
        Si ped√≠s reenv√≠o, esper√° 30‚Äì60 segundos antes de volver a intentarlo.
      </div>

      <div id="veLive" class="ss-ve__live" role="status" aria-live="polite"></div>

      <div class="ss-ve__actions">
        <button id="btnResend"
                type="button"
                class="ss-ve__btn"
                aria-busy="false"
                {% if not resend_endpoint %}disabled{% endif %}>
          <span id="veSpin" class="ss-ve__spin" style="display:none" aria-hidden="true"></span>
          <span id="btnTxt">{% if resend_endpoint %}Reenviar correo{% else %}Reenv√≠o no disponible{% endif %}</span>
        </button>

        <a class="ss-ve__btn ss-ve__btn--ghost" href="{{ home_url }}">Volver al inicio</a>
      </div>

      <div class="ss-ve__row">
        <a class="ss-ve__link" href="mailto:{{ support_email }}">‚úâÔ∏è Soporte: {{ support_email }}</a>
        <a class="ss-ve__link" href="{{ shop_url }}">üõçÔ∏è Ir a la tienda</a>
      </div>

      <p class="ss-ve__small">
        Si ya verificaste tu cuenta y segu√≠s viendo esta pantalla, cerr√° sesi√≥n y volv√© a entrar.
      </p>

      {# Hidden CSRF fallback #}
      {% if csrf_token is defined %}
        {% if csrf_token is callable %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% else %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {% endif %}
      {% endif %}
    </div>

  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(() => {
  const btn  = document.getElementById('btnResend');
  const live = document.getElementById('veLive');
  const spin = document.getElementById('veSpin');
  const txt  = document.getElementById('btnTxt');

  const endpoint = {{ resend_endpoint|tojson }};
  const email = {{ (email|tojson) if email else '""' }};

  const LS_KEY = "ss_verify_resend_cooldown_until";
  const COOLDOWN_MS = 30000;

  let locked = false;
  let tickTimer = null;

  const say = (m) => {
    if(!live) return;
    live.textContent = m;
    live.classList.add('is-on');
  };

  const readCsrf = () => {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta && meta.content) return meta.content.trim();
    const inp = document.querySelector('input[name="csrf_token"]');
    if (inp && inp.value) return inp.value.trim();
    return "";
  };

  const setBusy = (on) => {
    if(!btn) return;
    btn.setAttribute('aria-busy', on ? 'true' : 'false');
    if(spin) spin.style.display = on ? 'inline-block' : 'none';
  };

  const getCooldownUntil = () => {
    try{
      const v = parseInt(localStorage.getItem(LS_KEY) || "0", 10);
      return isNaN(v) ? 0 : v;
    }catch(e){
      return 0;
    }
  };

  const setCooldownUntil = (t) => {
    try{ localStorage.setItem(LS_KEY, String(t)); }catch(e){}
  };

  const stopTick = () => {
    if(tickTimer) clearInterval(tickTimer);
    tickTimer = null;
  };

  const startTick = () => {
    stopTick();
    tickTimer = setInterval(() => {
      if(!btn || !txt) return;
      const until = getCooldownUntil();
      const left = Math.ceil((until - Date.now()) / 1000);

      if(left <= 0){
        stopTick();
        txt.textContent = "Reenviar correo";
        btn.disabled = !endpoint; // si no hay endpoint, sigue bloqueado
        return;
      }

      txt.textContent = `Reenviar en ${left}s`;
      btn.disabled = true;
    }, 250);
  };

  const ensureCooldownUI = () => {
    if(!btn || !txt) return;
    const until = getCooldownUntil();
    if(until > Date.now()){
      startTick();
    }else{
      txt.textContent = endpoint ? "Reenviar correo" : "Reenv√≠o no disponible";
      btn.disabled = !endpoint;
    }
  };

  const send = async () => {
    if(locked) return;
    if(!endpoint){
      say("El reenv√≠o autom√°tico no est√° habilitado en este servidor.");
      return;
    }

    const until = getCooldownUntil();
    if(until > Date.now()){
      const left = Math.ceil((until - Date.now()) / 1000);
      say(`Esper√° ${left}s para reenviar de nuevo.`);
      startTick();
      return;
    }

    locked = true;
    btn.disabled = true;
    setBusy(true);
    txt.textContent = "Enviando‚Ä¶";
    say("Enviando correo de verificaci√≥n‚Ä¶");

    try{
      const headers = {
        "Accept":"application/json",
        "Content-Type":"application/json"
      };
      const csrf = readCsrf();
      if(csrf) headers["X-CSRF-Token"] = csrf;

      const r = await fetch(endpoint, {
        method: "POST",
        headers,
        credentials: "same-origin",
        body: JSON.stringify({ email: email || undefined })
      });

      let data = null;
      try{ data = await r.json(); }catch(e){}

      if(!r.ok || (data && data.ok === false)){
        const msg = (data && (data.message || data.error)) ? (data.message || data.error) : "No se pudo reenviar.";
        throw new Error(msg);
      }

      say("Listo ‚úÖ Te reenviamos el email. Revis√° tu bandeja y spam/promociones.");
      const newUntil = Date.now() + COOLDOWN_MS;
      setCooldownUntil(newUntil);
      startTick();

    }catch(e){
      say((e && e.message) ? e.message : "No est√° disponible el reenv√≠o autom√°tico en este momento. Prob√° m√°s tarde o escribinos a soporte.");
      ensureCooldownUI();
    }finally{
      locked = false;
      setBusy(false);
      // el bot√≥n lo maneja el tick / cooldown; no lo re-habilitamos ac√° a ciegas
      ensureCooldownUI();
    }
  };

  if(btn) btn.addEventListener('click', send);
  ensureCooldownUI();
})();
</script>
{% endblock %}
