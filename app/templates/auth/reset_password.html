{% extends "base.html" %}

{% block title %}Restablecer contrase√±a | Skyline Store{% endblock %}

{% block extra_head %}
  <meta name="robots" content="{{ 'index,follow' if ENV == 'production' else 'noindex,nofollow' }}">
  <style>
    .ss-auth{min-height:72vh;display:grid;place-items:center;padding:28px 14px}
    .ss-card{width:100%;max-width:520px;background:rgba(255,255,255,.92);border:1px solid rgba(15,23,42,.10);border-radius:26px;
      box-shadow:0 26px 60px rgba(2,6,23,.12);overflow:hidden;position:relative}
    .ss-card:before{content:"";position:absolute;inset:-1px;border-radius:26px;
      background:radial-gradient(900px 420px at 20% 10%, rgba(37,99,235,.16), transparent 55%),
                 radial-gradient(800px 420px at 85% 20%, rgba(6,182,212,.14), transparent 58%),
                 radial-gradient(900px 520px at 50% 110%, rgba(245,158,11,.12), transparent 60%);
      pointer-events:none}
    .ss-inner{position:relative;padding:22px 20px 18px}
    .ss-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px}
    .ss-title{margin:0;font-size:1.35rem;letter-spacing:-.02em;color:#0b1220}
    .ss-sub{margin:4px 0 0;color:rgba(2,6,23,.66);font-size:.95rem}
    .ss-badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.75);font-weight:700;font-size:.9rem}
    .ss-form{display:grid;gap:12px;margin-top:12px}
    .ss-field label{display:flex;align-items:center;justify-content:space-between;gap:10px;font-size:.92rem;font-weight:700;color:rgba(2,6,23,.78)}
    .ss-hint{font-weight:600;font-size:.82rem;opacity:.7}
    .ss-input{width:100%;margin-top:6px;padding:12px 12px;border-radius:14px;border:1px solid rgba(15,23,42,.16);
      background:rgba(255,255,255,.88);outline:0;font-size:.95rem}
    .ss-input:focus{box-shadow:0 0 0 4px rgba(37,99,235,.14);border-color:rgba(37,99,235,.35)}
    .ss-pass{display:flex;align-items:center;gap:10px}
    .ss-toggle{flex:0 0 auto;border:1px solid rgba(15,23,42,.12);background:rgba(255,255,255,.8);border-radius:12px;padding:10px 12px;
      cursor:pointer;font-weight:800}
    .ss-meter{height:10px;border-radius:999px;background:rgba(15,23,42,.08);overflow:hidden}
    .ss-meter > span{display:block;height:100%;width:0%}
    .ss-rules{display:grid;gap:6px;margin-top:8px;color:rgba(2,6,23,.68);font-size:.88rem}
    .ss-rules span{display:flex;align-items:center;gap:8px}
    .ss-dot{width:8px;height:8px;border-radius:50%;background:rgba(2,6,23,.28)}
    .ss-actions{display:grid;gap:10px;margin-top:8px}
    .ss-btn{width:100%;border:0;border-radius:14px;padding:12px 14px;font-weight:900;cursor:pointer;
      background:linear-gradient(135deg, #0b1220, #111827);color:#fff}
    .ss-btn:hover{filter:brightness(1.06)}
    .ss-btn[aria-busy="true"]{opacity:.86;cursor:progress}
    .ss-ghost{display:flex;justify-content:center;gap:10px;font-weight:700;color:rgba(2,6,23,.70);font-size:.92rem}
    .ss-ghost a{color:rgba(37,99,235,1);text-decoration:none}
    .ss-ghost a:hover{text-decoration:underline}
    .ss-note{padding:12px 14px;border-top:1px solid rgba(15,23,42,.08);background:rgba(255,255,255,.72);color:rgba(2,6,23,.60);font-size:.86rem}
    .ss-spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.9);border-right-color:transparent;border-radius:50%;
      display:inline-block;vertical-align:-3px;animation:sspin .9s linear infinite;margin-right:8px}
    @keyframes sspin{to{transform:rotate(360deg)}}
    @media (max-width:520px){.ss-inner{padding:18px 14px}}
  </style>
{% endblock %}

{% block content %}
{# ===============================
   RESET PASSWORD ‚Äî PRO / NO BREAK
   ‚úÖ CSRF compatible
   ‚úÖ endpoints safe
   ‚úÖ token hidden
   ‚úÖ password strength + match
   ‚úÖ submit loading
================================ #}

{% set _vf = (view_functions if view_functions is defined and view_functions else {}) %}

{% set login_ep = 'auth.login' %}
{% if login_ep not in _vf %}{% set login_ep = None %}{% endif %}

{% set reset_ep = 'auth.reset_password' %}
{% if reset_ep not in _vf %}{% set reset_ep = None %}{% endif %}

{% set login_url = '/account' %}
{% if login_ep %}{% set login_url = url_for(login_ep) %}{% endif %}

{% set action_url = '/account' %}
{% if reset_ep %}
  {# si te llega token por query o por contexto, lo mandamos #}
  {% set t = (token if token is defined else request.args.get('token','')) %}
  {% set action_url = url_for(reset_ep, token=t) %}
{% endif %}

{% set tkn = (token if token is defined else request.args.get('token','')) %}

<section class="ss-auth" aria-label="Restablecer contrase√±a">
  <div class="ss-card" role="region" aria-label="Restablecer contrase√±a">
    <div class="ss-inner">
      <div class="ss-top">
        <div>
          <h1 class="ss-title">Restablecer contrase√±a</h1>
          <p class="ss-sub">Eleg√≠ una nueva contrase√±a segura para tu cuenta.</p>
        </div>
        <span class="ss-badge" aria-label="Conexi√≥n segura">üîí Seguro</span>
      </div>

      {# Flash messages #}
      {% for category, msg in get_flashed_messages(with_categories=true) %}
        {% set cat = category|string|lower %}
        {% set cat = cat if cat in ['error','warning','success','info'] else 'info' %}
        <div style="margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(15,23,42,.12);background:rgba(255,255,255,.78)"
             role="alert">
          {{ msg }}
        </div>
      {% endfor %}

      <form class="ss-form" id="resetForm" method="post" action="{{ action_url }}" novalidate>
        {# CSRF √∫nico #}
        {% if csrf_token is callable %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% elif csrf_token is defined %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {% elif form is defined and form.hidden_tag is defined %}
          {{ form.hidden_tag() }}
        {% elif form is defined and form.csrf_token is defined %}
          {{ form.csrf_token }}
        {% endif %}

        {# token #}
        {% if tkn %}
          <input type="hidden" name="token" value="{{ tkn|e }}">
        {% endif %}

        <div class="ss-field">
          <label for="p1">
            <span>Nueva contrase√±a</span>
            <span class="ss-hint" id="p1Hint">8+ caracteres</span>
          </label>
          <div class="ss-pass">
            <input id="p1" class="ss-input" type="password" name="password"
                   required minlength="8" maxlength="128"
                   autocomplete="new-password" aria-describedby="p1Hint"
                   placeholder="Tu nueva contrase√±a">
            <button class="ss-toggle" type="button" id="tg1" aria-label="Mostrar contrase√±a" aria-pressed="false">üëÅ</button>
          </div>
          <div class="ss-meter" aria-hidden="true"><span id="meterBar"></span></div>
          <div class="ss-rules" aria-live="polite">
            <span><i class="ss-dot" id="rLen"></i> 8+ caracteres</span>
            <span><i class="ss-dot" id="rMix"></i> Letras y n√∫meros</span>
            <span><i class="ss-dot" id="rUp"></i> May√∫scula recomendada</span>
            <span><i class="ss-dot" id="rSym"></i> S√≠mbolo recomendado</span>
          </div>
        </div>

        <div class="ss-field">
          <label for="p2">
            <span>Repetir contrase√±a</span>
            <span class="ss-hint" id="p2Hint">Debe coincidir</span>
          </label>
          <div class="ss-pass">
            <input id="p2" class="ss-input" type="password" name="password2"
                   required minlength="8" maxlength="128"
                   autocomplete="new-password" aria-describedby="p2Hint"
                   placeholder="Repetir contrase√±a">
            <button class="ss-toggle" type="button" id="tg2" aria-label="Mostrar confirmaci√≥n" aria-pressed="false">üëÅ</button>
          </div>
          <div id="match" style="margin-top:8px;font-weight:700;color:rgba(2,6,23,.62)" aria-live="polite">
            ‚Ä¢ Debe coincidir
          </div>
        </div>

        <div class="ss-actions">
          <button type="submit" class="ss-btn" id="submitBtn">Guardar contrase√±a</button>
          <div class="ss-ghost">
            <a href="{{ login_url }}">Volver a ingresar</a>
          </div>
        </div>
      </form>
    </div>

    <div class="ss-note">
      Tip: si el enlace expir√≥, ped√≠ uno nuevo desde ‚ÄúOlvid√© mi contrase√±a‚Äù.
    </div>
  </div>
</section>

<script>
(() => {
  const p1 = document.getElementById("p1");
  const p2 = document.getElementById("p2");
  const tg1 = document.getElementById("tg1");
  const tg2 = document.getElementById("tg2");
  const meter = document.getElementById("meterBar");
  const match = document.getElementById("match");
  const btn = document.getElementById("submitBtn");
  const form = document.getElementById("resetForm");

  if (!p1 || !p2 || !meter || !match || !btn || !form) return;

  const dot = (id, ok) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.style.background = ok ? "rgba(34,197,94,.9)" : "rgba(2,6,23,.28)";
  };

  const score = (v) => {
    let s = 0;
    if (v.length >= 8) s += 30;
    if (/[a-z]/.test(v) && /[0-9]/.test(v)) s += 25;
    if (/[A-Z]/.test(v)) s += 20;
    if (/[^A-Za-z0-9]/.test(v)) s += 25;
    return Math.max(0, Math.min(100, s));
  };

  const refresh = () => {
    const v = p1.value || "";
    const sc = score(v);
    meter.style.width = sc + "%";
    meter.style.background = sc >= 80 ? "rgba(34,197,94,.85)" : (sc >= 50 ? "rgba(245,158,11,.85)" : "rgba(239,68,68,.85)");

    dot("rLen", v.length >= 8);
    dot("rMix", /[a-z]/.test(v) && /[0-9]/.test(v));
    dot("rUp", /[A-Z]/.test(v));
    dot("rSym", /[^A-Za-z0-9]/.test(v));

    const ok = (p1.value && p2.value && p1.value === p2.value);
    match.textContent = ok ? "‚úî Coinciden" : "‚Ä¢ Debe coincidir";
    match.style.color = ok ? "rgba(34,197,94,.95)" : "rgba(2,6,23,.62)";
  };

  const toggle = (inp, btn) => {
    const isPw = inp.type === "password";
    inp.type = isPw ? "text" : "password";
    btn.setAttribute("aria-pressed", isPw ? "true" : "false");
    btn.textContent = isPw ? "üôà" : "üëÅ";
  };

  tg1 && tg1.addEventListener("click", () => toggle(p1, tg1));
  tg2 && tg2.addEventListener("click", () => toggle(p2, tg2));
  p1.addEventListener("input", refresh);
  p2.addEventListener("input", refresh);
  refresh();

  form.addEventListener("submit", (e) => {
    if (!p1.value || p1.value.length < 8) { e.preventDefault(); p1.focus(); return; }
    if (p1.value !== p2.value) { e.preventDefault(); p2.focus(); return; }

    btn.disabled = true;
    btn.setAttribute("aria-busy","true");
    btn.innerHTML = '<span class="ss-spinner"></span> Guardando...';
  }, { passive:false });
})();
</script>
{% endblock %}
