{% extends "base.html" %}
{% block title %}Olvid√© mi contrase√±a | Skyline Store{% endblock %}

{% block extra_head %}
  <meta name="robots" content="{{ 'index,follow' if ENV == 'production' else 'noindex,nofollow' }}">
  <style>
    .ss-auth{min-height:72vh;display:grid;place-items:center;padding:28px 14px}
    .ss-card{width:100%;max-width:520px;background:rgba(255,255,255,.92);border:1px solid rgba(15,23,42,.10);border-radius:26px;
      box-shadow:0 26px 60px rgba(2,6,23,.12);overflow:hidden;position:relative}
    .ss-card:before{content:"";position:absolute;inset:-1px;border-radius:26px;
      background:radial-gradient(900px 420px at 20% 10%, rgba(37,99,235,.16), transparent 55%),
                 radial-gradient(800px 420px at 85% 20%, rgba(6,182,212,.14), transparent 58%),
                 radial-gradient(900px 520px at 50% 110%, rgba(245,158,11,.12), transparent 60%);
      pointer-events:none}
    .ss-inner{position:relative;padding:22px 20px 18px}
    .ss-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px}
    .ss-title{margin:0;font-size:1.35rem;letter-spacing:-.02em;color:#0b1220}
    .ss-sub{margin:4px 0 0;color:rgba(2,6,23,.66);font-size:.95rem}
    .ss-badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.75);font-weight:800;font-size:.9rem}
    .ss-flash{margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(15,23,42,.12);background:rgba(255,255,255,.78)}
    .ss-flash.error{border-color:rgba(220,38,38,.25)}
    .ss-flash.success{border-color:rgba(34,197,94,.25)}
    .ss-form{display:grid;gap:12px;margin-top:12px}
    .ss-field label{display:flex;align-items:center;justify-content:space-between;gap:10px;font-size:.92rem;font-weight:800;color:rgba(2,6,23,.78)}
    .ss-hint{font-weight:600;font-size:.82rem;opacity:.7}
    .ss-input{width:100%;margin-top:6px;padding:12px 12px;border-radius:14px;border:1px solid rgba(15,23,42,.16);
      background:rgba(255,255,255,.88);outline:0;font-size:.95rem}
    .ss-input:focus{box-shadow:0 0 0 4px rgba(37,99,235,.14);border-color:rgba(37,99,235,.35)}
    .ss-row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .ss-btn{width:100%;border:0;border-radius:14px;padding:12px 14px;font-weight:900;cursor:pointer;
      background:linear-gradient(135deg, #0b1220, #111827);color:#fff}
    .ss-btn:hover{filter:brightness(1.06)}
    .ss-btn[aria-busy="true"]{opacity:.86;cursor:progress}
    .ss-ghost{display:flex;gap:12px;justify-content:center;font-weight:700;color:rgba(2,6,23,.70);font-size:.92rem}
    .ss-ghost a{color:rgba(37,99,235,1);text-decoration:none}
    .ss-ghost a:hover{text-decoration:underline}
    .ss-note{padding:12px 14px;border-top:1px solid rgba(15,23,42,.08);background:rgba(255,255,255,.72);color:rgba(2,6,23,.60);font-size:.86rem}
    .ss-list{margin:10px 0 0;padding-left:18px;color:rgba(2,6,23,.64);font-size:.9rem}
    .ss-spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.9);border-right-color:transparent;border-radius:50%;
      display:inline-block;vertical-align:-3px;animation:sspin .9s linear infinite;margin-right:8px}
    @keyframes sspin{to{transform:rotate(360deg)}}
    @media (max-width:520px){.ss-inner{padding:18px 14px}}
  </style>
{% endblock %}

{% block content %}
{# ==========================================
   FORGOT PASSWORD ‚Äî ULTRA PRO / NO BREAK
   ‚úÖ Endpoints safe
   ‚úÖ CSRF compatible
   ‚úÖ Anti-bot honeypot
   ‚úÖ UX pro + mensajes
   ‚úÖ No filtra si el email existe (recomendado)
========================================== #}

{% set _vf = (view_functions if view_functions is defined and view_functions else {}) %}

{% set forgot_ep = 'auth.forgot' %}
{% if forgot_ep not in _vf %}{% set forgot_ep = None %}{% endif %}

{% set login_ep = 'auth.login' %}
{% if login_ep not in _vf %}{% set login_ep = None %}{% endif %}

{% set register_ep = 'auth.register' %}
{% if register_ep not in _vf %}{% set register_ep = None %}{% endif %}

{% set action_url = '/account' %}
{% if forgot_ep %}{% set action_url = url_for(forgot_ep) %}{% endif %}

{% set login_url = '/account' %}
{% if login_ep %}{% set login_url = url_for(login_ep) %}{% endif %}

{% set register_url = '/account' %}
{% if register_ep %}{% set register_url = url_for(register_ep) %}{% endif %}

{% set posted_email = request.form.get('email','') %}

<section class="ss-auth" aria-label="Recuperar contrase√±a">
  <div class="ss-card" role="region" aria-label="Recuperar contrase√±a">
    <div class="ss-inner">

      <div class="ss-top">
        <div>
          <h1 class="ss-title">¬øOlvidaste tu contrase√±a?</h1>
          <p class="ss-sub">Te enviamos un enlace seguro para restablecerla.</p>
        </div>
        <span class="ss-badge" aria-label="Conexi√≥n segura">üîí Seguro</span>
      </div>

      {# Flash #}
      {% for category, msg in get_flashed_messages(with_categories=true) %}
        {% set cat = category|string|lower %}
        {% set cat = cat if cat in ['error','warning','success','info'] else 'info' %}
        <div class="ss-flash {{ cat }}" role="alert">{{ msg }}</div>
      {% endfor %}

      <form class="ss-form" id="forgotForm" method="post" action="{{ action_url }}" novalidate>
        {# CSRF √∫nico #}
        {% if csrf_token is callable %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% elif csrf_token is defined %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {% elif form is defined and form.hidden_tag is defined %}
          {{ form.hidden_tag() }}
        {% elif form is defined and form.csrf_token is defined %}
          {{ form.csrf_token }}
        {% endif %}

        {# NONCE opcional #}
        {% if nonce is defined and nonce %}
          <input type="hidden" name="nonce" value="{{ nonce }}">
        {% endif %}

        {# Honeypot anti-bot #}
        <div style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden" aria-hidden="true">
          <label>Website</label>
          <input type="text" name="website" tabindex="-1" autocomplete="off">
        </div>

        <div class="ss-field">
          <label for="email">
            <span>Email</span>
            <span class="ss-hint" id="emailHint">Requerido</span>
          </label>
          <input id="email"
                 class="ss-input"
                 type="email"
                 name="email"
                 required
                 maxlength="254"
                 autocomplete="email"
                 inputmode="email"
                 autocapitalize="none"
                 spellcheck="false"
                 aria-describedby="emailHint"
                 value="{{ posted_email }}"
                 placeholder="tu@email.com">
        </div>

        <button type="submit" class="ss-btn" id="submitBtn">
          Enviar enlace de recuperaci√≥n
        </button>

        <ul class="ss-list" aria-label="Informaci√≥n">
          <li>Si el email existe, vas a recibir un enlace en unos minutos.</li>
          <li>Revis√° ‚ÄúSpam / Promociones‚Äù.</li>
          <li>El enlace vence por seguridad.</li>
        </ul>

        <div class="ss-ghost" aria-label="Links">
          <a href="{{ login_url }}">Volver a ingresar</a>
          <a href="{{ register_url }}">Crear cuenta</a>
        </div>
      </form>
    </div>

    <div class="ss-note">
      Por seguridad, no confirmamos si un email est√° registrado.
    </div>
  </div>
</section>

<script>
(() => {
  const f = document.getElementById("forgotForm");
  const b = document.getElementById("submitBtn");
  const e = document.getElementById("email");
  if (!f || !b || !e) return;
  if (f.dataset.bound === "1") return;
  f.dataset.bound = "1";

  f.addEventListener("submit", (ev) => {
    const val = (e.value || "").trim();
    if (!val || !val.includes("@")) { ev.preventDefault(); e.focus(); return; }

    b.disabled = true;
    b.setAttribute("aria-busy","true");
    b.innerHTML = '<span class="ss-spinner"></span> Enviando...';
  }, { passive:false });
})();
</script>
{% endblock %}
