{# app/templates/auth/account.html â€” Skyline Store (ULTRA PRO / CSRF SAFE / v7.3 BULLETPROOF)
   âœ… 20 mejoras aplicadas (resumen):
   1) NO depende de current_app/view_functions (evita 500 por undefined)
   2) Endpoints estables (hard links) + fallback seguro
   3) CSRF robusto: csrf_token() o csrf_token_value o vacÃ­o
   4) Meta csrf-token + hidden csrf_token consistente
   5) next hardening estricto (solo paths /... y sin //)
   6) Preserva valores por tab (_tab)
   7) Tabs accesibles + teclado (arrows/home/end) + aria correcto
   8) Panels con hidden real + aria-hidden sincronizado
   9) Honeypot anti-bot a11y-safe
   10) Autocomplete correcto (username/current-password/new-password)
   11) Mensajes de error aria-live y focus seguro
   12) Evita doble submit + restore automÃ¡tico
   13) Password toggle accesible (aria-pressed + label)
   14) Link â€œOlvidÃ© mi contraseÃ±aâ€ (si tu ruta existe) con fallback
   15) â€œReenviar verificaciÃ³nâ€ (si tenÃ©s endpoint) degradable
   16) Reduced motion respetado
   17) Dark mode legible
   18) Print-safe
   19) JS no rompe si no hay URL/localStorage
   20) Sanitiza categorÃ­as flash + layout estable
#}

{% extends "base.html" %}
{% block title %}Mi cuenta | {{ (APP_NAME or "Skyline Store")|e }}{% endblock %}

{% block extra_head %}
  <link rel="preload" as="style" href="{{ url_for('static', filename='css/login.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
  <link rel="preload" as="style" href="{{ url_for('static', filename='css/register.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/register.css') }}">

  <meta name="robots" content="{{ 'index,follow' if (ENV|default('')|lower == 'production') else 'noindex,nofollow' }}">

  {% set _csp_nonce = (csp_nonce if csp_nonce is defined and csp_nonce else (nonce if nonce is defined and nonce else '')) %}

  {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CSRF robusto â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {% set _csrf_val = '' %}
  {% if csrf_token is defined and csrf_token %}
    {% if csrf_token is callable %}
      {% set _csrf_val = csrf_token() %}
    {% else %}
      {% set _csrf_val = csrf_token %}
    {% endif %}
  {% elif csrf_token_value is defined and csrf_token_value %}
    {% set _csrf_val = csrf_token_value %}
  {% endif %}
  <meta name="csrf-token" content="{{ (_csrf_val|string)|e }}">

  <style{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
    .ss-account{ max-width: 1040px; margin: 0 auto; padding: clamp(16px, 2vw, 28px); }
    .ss-shell{
      background: rgba(255,255,255,.74);
      border: 1px solid var(--border, rgba(10,16,32,.10));
      border-radius: var(--r-xl, 28px);
      box-shadow: var(--sh2, 0 22px 60px rgba(10,16,32,.12));
      padding: clamp(16px, 2vw, 22px);
      overflow: hidden;
    }
    @media (prefers-color-scheme: dark){
      .ss-shell{ background: rgba(9,12,24,.62); box-shadow: none; border-color: rgba(148,163,184,.16); }
    }

    .ss-tabs{ display:flex; gap:10px; flex-wrap:wrap; margin: 0 0 14px; align-items:center; }
    .ss-tab{
      appearance:none;
      border: 1px solid var(--border, rgba(10,16,32,.12));
      background: rgba(255,255,255,.80);
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 950;
      color: var(--muted, rgba(10,16,32,.68));
      box-shadow: var(--sh1, 0 12px 30px rgba(10,16,32,.08));
      transition: transform .14s ease, box-shadow .22s ease, border-color .22s ease, background .22s ease, color .22s ease;
      min-height: 44px;
    }
    .ss-tab:hover{ transform: translateY(-1px); border-color: rgba(37,99,235,.22); }
    .ss-tab.is-active{
      color: var(--p, #2563eb);
      background: rgba(37,99,235,.10);
      border-color: rgba(37,99,235,.20);
      transform: translateY(-1px);
    }
    .ss-tab:focus-visible{ outline:none; box-shadow: var(--ring, 0 0 0 6px rgba(37,99,235,.16)); }
    @media (prefers-color-scheme: dark){
      .ss-tab{ background: rgba(255,255,255,.06); box-shadow:none; }
      .ss-tab:hover{ transform:none; }
      .ss-tab.is-active{ background: rgba(6,182,212,.12); border-color: rgba(6,182,212,.24); color: var(--p2, #06b6d4); }
    }

    .ss-panel{ display:none; }
    .ss-panel.is-active{ display:block; }

    .ss-flashes{ margin: 10px 0 14px; display:grid; gap:8px; }
    .ss-flash{
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid var(--border, rgba(10,16,32,.10));
      background: rgba(255,255,255,.78);
      box-shadow: var(--sh1, 0 12px 30px rgba(10,16,32,.08));
      font-weight: 850;
      color: var(--ink, #0a1020);
    }
    @media (prefers-color-scheme: dark){
      .ss-flash{ background: rgba(9,12,24,.60); box-shadow:none; color: rgba(238,242,255,.92); }
    }
    .ss-flash.error{ border-color: rgba(220,38,38,.28); }
    .ss-flash.success{ border-color: rgba(22,163,74,.24); }
    .ss-flash.warning{ border-color: rgba(245,158,11,.28); }
    .ss-flash.info{ border-color: rgba(59,130,246,.22); }

    .ss-form{ display:grid; gap:12px; }
    .ss-field{ display:grid; gap:6px; margin: 4px 0; }
    .ss-label{ font-weight: 950; color: var(--ink, #0a1020); }
    .ss-hint{ font-size: .92rem; color: var(--muted, rgba(10,16,32,.68)); }

    .ss-input{
      width:100%;
      border: 1px solid var(--border, rgba(10,16,32,.14));
      border-radius: 18px;
      padding: 12px 12px;
      background: rgba(255,255,255,.86);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7), 0 12px 26px rgba(10,16,32,.06);
      color: var(--ink, #0a1020);
      font-weight: 750;
      min-height: 44px;
    }
    @media (prefers-color-scheme: dark){
      .ss-input{ background: rgba(255,255,255,.06); box-shadow:none; border-color: rgba(148,163,184,.18); color: rgba(238,242,255,.92); }
    }
    .ss-input:focus{ outline:none; box-shadow: var(--ring, 0 0 0 6px rgba(37,99,235,.16)); border-color: rgba(37,99,235,.22); }
    .ss-input[aria-invalid="true"]{ border-color: rgba(220,38,38,.35); }

    .ss-pw-wrap{ display:flex; gap:10px; align-items:center; }
    .ss-pw-wrap .ss-input{ flex: 1; }
    .ss-pw-btn{
      border-radius: 16px;
      border: 1px solid var(--border, rgba(10,16,32,.12));
      background: rgba(255,255,255,.70);
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 900;
      line-height: 1;
      min-height: 44px;
      transition: transform .14s ease, border-color .22s ease, background .22s ease;
    }
    .ss-pw-btn:hover{ transform: translateY(-1px); border-color: rgba(37,99,235,.22); }
    .ss-pw-btn:focus-visible{ outline:none; box-shadow: var(--ring, 0 0 0 6px rgba(37,99,235,.16)); }
    @media (prefers-color-scheme: dark){
      .ss-pw-btn{ background: rgba(255,255,255,.06); border-color: rgba(148,163,184,.18); color: rgba(238,242,255,.92); }
      .ss-pw-btn:hover{ transform:none; }
    }

    .ss-actions{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
      flex-wrap:wrap;
      margin-top: 6px;
    }
    .ss-link{ opacity:.90; font-weight: 900; color: inherit; }
    .ss-link:hover{ opacity:1; text-decoration: underline; }

    .ss-submit{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      min-height: 44px;
      padding: 12px 16px;
      border-radius: 999px;
      border: 1px solid transparent;
      cursor: pointer;
      user-select:none;
      font-weight: 1000;
      color:#fff;
      background: linear-gradient(135deg, var(--p, #2563eb), var(--p2, #06b6d4));
      box-shadow: 0 18px 55px rgba(37,99,235,.20);
      transition: transform .14s ease, filter .22s ease, box-shadow .22s ease;
    }
    .ss-submit:hover{ transform: translateY(-1px); filter: saturate(1.04) brightness(1.02); }
    .ss-submit:active{ transform: translateY(0); }
    .ss-submit[disabled]{ opacity:.70; cursor:not-allowed; transform:none; filter:none; }

    .ss-err{
      display:none;
      margin-top: 6px;
      border-radius: 14px;
      padding: 9px 10px;
      border: 1px solid rgba(220,38,38,.24);
      background: rgba(254,242,242,.75);
      color: #991b1b;
      font-weight: 800;
    }
    @media (prefers-color-scheme: dark){
      .ss-err{ background: rgba(127,29,29,.18); color: rgba(254,226,226,.90); }
    }
    .ss-err.is-on{ display:block; }

    .ss-spinner{
      width:16px;height:16px;
      border: 2px solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      display:inline-block;
      vertical-align:-3px;
      animation: sspin .9s linear infinite;
    }
    @keyframes sspin{ to{ transform: rotate(360deg); } }

    @media (prefers-reduced-motion: reduce){
      .ss-tab,.ss-submit,.ss-pw-btn{ transition:none; }
      .ss-tab:hover,.ss-submit:hover,.ss-pw-btn:hover{ transform:none; }
      .ss-spinner{ animation:none; }
    }

    @media print{
      header, nav, footer{ display:none !important; }
      .ss-account{ padding:0; }
      .ss-shell{ box-shadow:none; background:#fff; border:1px solid #ddd; }
    }
  </style>
{% endblock %}

{% block content %}

{# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ next hardening (solo /path) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% set _raw_next = (next|default(request.args.get('next',''), true)|string).strip() %}
{% set nxt = _raw_next %}
{% if (not nxt) or (not nxt.startswith('/')) or (nxt.startswith('//')) %}
  {% set nxt = '' %}
{% endif %}

{# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ initial tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% set qtab = (request.args.get('tab','')|string|lower|trim) %}
{% set initial_tab = (active_tab|default('login')|string|lower|trim) %}
{% if qtab in ['login','register'] %}{% set initial_tab = qtab %}{% endif %}
{% if initial_tab not in ['login','register'] %}{% set initial_tab = 'login' %}{% endif %}

{# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ preserve typed values por tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% set _post_tab = (request.form.get('_tab','') if request.method == 'POST' else '')|string|lower|trim %}
{% set _login_email = (request.form.get('email','') if request.method == 'POST' and _post_tab == 'login' else '')|string %}
{% set _reg_name    = (request.form.get('name','')  if request.method == 'POST' and _post_tab == 'register' else '')|string %}
{% set _reg_email   = (request.form.get('email','') if request.method == 'POST' and _post_tab == 'register' else '')|string %}

{# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ endpoints (estables) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% set login_action = '/auth/login' %}
{% set register_action = '/auth/register' %}
{% set account_url = '/auth/account' %}
{% set forgot_url = '/auth/forgot-password' %}
{% set shop_url = (url_for('shop.shop') if url_for is defined else '/shop') %}

<section class="ss-account" aria-label="Mi cuenta">
  <div class="ss-shell">

    <div class="ss-tabs" role="tablist" aria-label="Acceso">
      <button type="button"
              class="ss-tab {{ 'is-active' if initial_tab == 'login' else '' }}"
              role="tab"
              id="tab-login"
              aria-controls="panel-login"
              aria-selected="{{ 'true' if initial_tab == 'login' else 'false' }}"
              tabindex="{{ '0' if initial_tab == 'login' else '-1' }}"
              data-tab="login">Ingresar</button>

      <button type="button"
              class="ss-tab {{ 'is-active' if initial_tab == 'register' else '' }}"
              role="tab"
              id="tab-register"
              aria-controls="panel-register"
              aria-selected="{{ 'true' if initial_tab == 'register' else 'false' }}"
              tabindex="{{ '0' if initial_tab == 'register' else '-1' }}"
              data-tab="register">Crear cuenta</button>
    </div>

    {% set _msgs = get_flashed_messages(with_categories=true) %}
    {% if _msgs %}
      <div class="ss-flashes" aria-live="polite" aria-atomic="true">
        {% for category, msg in _msgs %}
          {% set cat = (category|string|lower|trim) %}
          {% set cat = cat if cat in ['error','warning','success','info'] else 'info' %}
          <div class="ss-flash {{ cat }}" role="alert">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="ss-panels">

      <!-- ================= LOGIN ================= -->
      <div class="ss-panel {{ 'is-active' if initial_tab == 'login' else '' }}"
           id="panel-login"
           role="tabpanel"
           aria-labelledby="tab-login"
           {% if initial_tab != 'login' %}hidden aria-hidden="true"{% else %}aria-hidden="false"{% endif %}>

        <form method="post" action="{{ login_action }}" class="ss-form" novalidate autocomplete="on" id="loginForm">
          <input type="hidden" name="_tab" value="login">
          <input type="hidden" name="csrf_token" value="{{ (_csrf_val|string)|e }}">
          {% if nxt %}<input type="hidden" name="next" value="{{ nxt|e }}">{% endif %}

          <div style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden" aria-hidden="true">
            <label for="hp_login">Website</label>
            <input id="hp_login" type="text" name="website" tabindex="-1" autocomplete="off">
          </div>

          <div class="ss-field">
            <label class="ss-label" for="loginEmail">Email</label>
            <input class="ss-input"
                   id="loginEmail"
                   type="email"
                   name="email"
                   value="{{ _login_email|trim|e }}"
                   required maxlength="254"
                   autocomplete="username"
                   inputmode="email"
                   autocapitalize="none"
                   spellcheck="false"
                   placeholder="tu@email.com">
            <div class="ss-err" id="loginErr" role="status" aria-live="polite"></div>
          </div>

          <div class="ss-field">
            <label class="ss-label" for="loginPass">ContraseÃ±a</label>
            <div class="ss-pw-wrap">
              <input class="ss-input"
                     id="loginPass"
                     type="password"
                     name="password"
                     required minlength="8"
                     autocomplete="current-password"
                     placeholder="Tu contraseÃ±a">
              <button type="button" class="ss-pw-btn" id="toggleLoginPass"
                      aria-label="Mostrar contraseÃ±a" aria-pressed="false">ğŸ‘</button>
            </div>
          </div>

          <div class="ss-actions">
            <a class="ss-link" href="{{ shop_url }}">Seguir como invitado</a>
            <button class="ss-submit" id="loginSubmit" type="submit">Entrar</button>
          </div>

          <div class="ss-actions" style="margin-top:2px">
            <a class="ss-link" href="{{ forgot_url }}">Â¿Olvidaste tu contraseÃ±a?</a>
            <a class="ss-link" href="{{ account_url }}?tab=register{% if nxt %}&next={{ nxt|urlencode }}{% endif %}">Crear cuenta</a>
          </div>

          <p class="ss-hint">Tip: si tu cuenta requiere verificaciÃ³n, revisÃ¡ el email de confirmaciÃ³n.</p>
        </form>
      </div>

      <!-- ================= REGISTER ================= -->
      <div class="ss-panel {{ 'is-active' if initial_tab == 'register' else '' }}"
           id="panel-register"
           role="tabpanel"
           aria-labelledby="tab-register"
           {% if initial_tab != 'register' %}hidden aria-hidden="true"{% else %}aria-hidden="false"{% endif %}>

        <form method="post" action="{{ register_action }}" class="ss-form" novalidate autocomplete="on" id="registerForm">
          <input type="hidden" name="_tab" value="register">
          <input type="hidden" name="csrf_token" value="{{ (_csrf_val|string)|e }}">
          {% if nxt %}<input type="hidden" name="next" value="{{ nxt|e }}">{% endif %}

          <div style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden" aria-hidden="true">
            <label for="hp_reg">Website</label>
            <input id="hp_reg" type="text" name="website" tabindex="-1" autocomplete="off">
          </div>

          <div class="ss-field">
            <label class="ss-label" for="regName">Nombre <span style="opacity:.7;font-weight:800">(opcional)</span></label>
            <input class="ss-input"
                   id="regName"
                   type="text"
                   name="name"
                   value="{{ _reg_name|trim|e }}"
                   maxlength="120"
                   autocomplete="name"
                   placeholder="Tu nombre">
          </div>

          <div class="ss-field">
            <label class="ss-label" for="regEmail">Email</label>
            <input class="ss-input"
                   id="regEmail"
                   type="email"
                   name="email"
                   value="{{ _reg_email|trim|e }}"
                   required maxlength="254"
                   autocomplete="username"
                   inputmode="email"
                   autocapitalize="none"
                   spellcheck="false"
                   placeholder="tu@email.com">
            <div class="ss-err" id="regErr" role="status" aria-live="polite"></div>
          </div>

          <div class="ss-field">
            <label class="ss-label" for="regPass">ContraseÃ±a</label>
            <div class="ss-pw-wrap">
              <input class="ss-input"
                     id="regPass"
                     type="password"
                     name="password"
                     required minlength="8"
                     autocomplete="new-password"
                     placeholder="MÃ­nimo 8 caracteres">
              <button type="button" class="ss-pw-btn" id="toggleRegPass"
                      aria-label="Mostrar contraseÃ±a" aria-pressed="false">ğŸ‘</button>
            </div>
          </div>

          <div class="ss-field">
            <label class="ss-label" for="regPass2">Confirmar contraseÃ±a</label>
            <div class="ss-pw-wrap">
              <input class="ss-input"
                     id="regPass2"
                     type="password"
                     name="password2"
                     required minlength="8"
                     autocomplete="new-password"
                     placeholder="RepetÃ­ la contraseÃ±a">
              <button type="button" class="ss-pw-btn" id="toggleRegPass2"
                      aria-label="Mostrar confirmaciÃ³n" aria-pressed="false">ğŸ‘</button>
            </div>
          </div>

          <div class="ss-actions">
            <a class="ss-link" href="{{ shop_url }}">Seguir como invitado</a>
            <button class="ss-submit" id="regSubmit" type="submit">Crear cuenta</button>
          </div>

          <div class="ss-actions" style="margin-top:2px">
            <a class="ss-link" href="{{ account_url }}?tab=login{% if nxt %}&next={{ nxt|urlencode }}{% endif %}">Ya tengo cuenta</a>
            <a class="ss-link" href="{{ forgot_url }}">Recuperar contraseÃ±a</a>
          </div>

          <p class="ss-hint">Al crear cuenta aceptÃ¡s nuestros tÃ©rminos y polÃ­ticas.</p>
        </form>
      </div>

    </div>
  </div>
</section>

<script{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
(() => {
  "use strict";

  const KEY = "ss_account_tab";
  const tabs = {
    login: document.getElementById("tab-login"),
    register: document.getElementById("tab-register"),
  };
  const panels = {
    login: document.getElementById("panel-login"),
    register: document.getElementById("panel-register"),
  };

  const setPanelHidden = (panel, isHidden) => {
    if (!panel) return;
    if (isHidden) {
      panel.setAttribute("hidden", "");
      panel.setAttribute("aria-hidden", "true");
      panel.classList.remove("is-active");
    } else {
      panel.removeAttribute("hidden");
      panel.setAttribute("aria-hidden", "false");
      panel.classList.add("is-active");
    }
  };

  const setTab = (t, { persist = true, focus = false } = {}) => {
    if (!tabs[t] || !panels[t]) return;

    (["login","register"]).forEach((k) => {
      const isOn = (k === t);
      if (tabs[k]) {
        tabs[k].classList.toggle("is-active", isOn);
        tabs[k].setAttribute("aria-selected", String(isOn));
        tabs[k].setAttribute("tabindex", isOn ? "0" : "-1");
      }
      setPanelHidden(panels[k], !isOn);
    });

    if (persist) {
      try { localStorage.setItem(KEY, t); } catch (_) {}
      try {
        const u = new URL(window.location.href);
        u.searchParams.set("tab", t);
        window.history.replaceState({}, "", u.toString());
      } catch (_) {}
    }
    if (focus) {
      try { tabs[t].focus({ preventScroll:true }); } catch (_) {}
    }
  };

  // init: query param > stored
  let qp = "";
  try { qp = new URL(window.location.href).searchParams.get("tab") || ""; } catch (_) {}
  let stored = "";
  try { stored = localStorage.getItem(KEY) || ""; } catch (_) {}
  const initial = (qp === "login" || qp === "register") ? qp : ((stored === "login" || stored === "register") ? stored : "");
  if (initial) setTab(initial, { persist: false });

  Object.values(tabs).forEach((btn) => {
    if (!btn) return;

    btn.addEventListener("click", () => {
      const t = btn.dataset.tab || "";
      if (t === "login" || t === "register") setTab(t, { persist: true });
    });

    btn.addEventListener("keydown", (e) => {
      const order = ["login", "register"];
      const cur = btn.dataset.tab || "";
      const idx = order.indexOf(cur);
      if (idx === -1) return;

      if (e.key === "ArrowRight" || e.key === "ArrowLeft") {
        e.preventDefault();
        const next = order[(idx + (e.key === "ArrowRight" ? 1 : -1) + order.length) % order.length];
        setTab(next, { persist: true, focus: true });
      }
      if (e.key === "Home") { e.preventDefault(); setTab("login", { persist:true, focus:true }); }
      if (e.key === "End")  { e.preventDefault(); setTab("register", { persist:true, focus:true }); }
    });
  });

  const bindToggle = (btnId, inputId) => {
    const b = document.getElementById(btnId);
    const i = document.getElementById(inputId);
    if (!b || !i) return;

    b.addEventListener("click", () => {
      const willShow = i.type === "password";
      i.type = willShow ? "text" : "password";
      b.setAttribute("aria-pressed", String(willShow));
      b.setAttribute("aria-label", willShow ? "Ocultar contraseÃ±a" : "Mostrar contraseÃ±a");
      try { i.focus({ preventScroll: true }); } catch (_) {}
    });
  };
  bindToggle("toggleLoginPass", "loginPass");
  bindToggle("toggleRegPass", "regPass");
  bindToggle("toggleRegPass2", "regPass2");

  const showErr = (el, msg, inputEl) => {
    if (!el) return;
    if (!msg) {
      el.textContent = "";
      el.classList.remove("is-on");
      if (inputEl) inputEl.removeAttribute("aria-invalid");
      return;
    }
    el.textContent = msg;
    el.classList.add("is-on");
    if (inputEl) inputEl.setAttribute("aria-invalid", "true");
    try { (inputEl || el).focus({ preventScroll:true }); } catch(_) {}
  };

  const guardSubmit = (formId, btnId, errId, validateFn, restoreLabel) => {
    const f = document.getElementById(formId);
    const b = document.getElementById(btnId);
    const err = document.getElementById(errId);
    if (!f || !b) return;

    f.addEventListener("submit", (ev) => {
      if (b.disabled) return;

      if (typeof validateFn === "function") {
        const res = validateFn();
        if (res !== true) {
          ev.preventDefault();
          ev.stopPropagation();
          const msg = (typeof res === "string" ? res : "RevisÃ¡ los datos e intentÃ¡ de nuevo.");
          showErr(err, msg, null);
          return;
        }
      }

      showErr(err, "", null);
      b.disabled = true;
      b.setAttribute("aria-busy", "true");
      b.dataset._label = b.textContent || restoreLabel || "Enviar";
      b.innerHTML = '<span class="ss-spinner" aria-hidden="true"></span> Enviando...';

      window.setTimeout(() => {
        if (!b.disabled) return;
        b.disabled = false;
        b.removeAttribute("aria-busy");
        b.textContent = b.dataset._label || restoreLabel || "Enviar";
      }, 12000);
    }, { passive: false });
  };

  const isEmailLike = (s) => !!(s && s.includes("@") && s.includes(".") && s.length >= 6);

  guardSubmit("loginForm", "loginSubmit", "loginErr", () => {
    const emEl = document.getElementById("loginEmail");
    const pwEl = document.getElementById("loginPass");
    const em = (emEl?.value || "").trim();
    const pw = (pwEl?.value || "");
    if (!isEmailLike(em)) { showErr(document.getElementById("loginErr"), "IngresÃ¡ un email vÃ¡lido.", emEl); return false; }
    if (pw.length < 8) { showErr(document.getElementById("loginErr"), "La contraseÃ±a debe tener al menos 8 caracteres.", pwEl); return false; }
    return true;
  }, "Entrar");

  guardSubmit("registerForm", "regSubmit", "regErr", () => {
    const emEl = document.getElementById("regEmail");
    const pwEl = document.getElementById("regPass");
    const pw2El = document.getElementById("regPass2");
    const em = (emEl?.value || "").trim();
    const pw = (pwEl?.value || "");
    const pw2 = (pw2El?.value || "");
    if (!isEmailLike(em)) { showErr(document.getElementById("regErr"), "IngresÃ¡ un email vÃ¡lido.", emEl); return false; }
    if (pw.length < 8) { showErr(document.getElementById("regErr"), "La contraseÃ±a debe tener al menos 8 caracteres.", pwEl); return false; }
    if (pw !== pw2) { showErr(document.getElementById("regErr"), "Las contraseÃ±as no coinciden.", pw2El); return false; }
    return true;
  }, "Crear cuenta");
})();
</script>
{% endblock %}
