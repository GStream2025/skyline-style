{# app/templates/auth/account.html ‚Äî Skyline Store (ULTRA PRO v8.0 / NO-500 / REDIRECT SAFE)
   ‚úÖ Objetivo: CERO errores en Render + redirecci√≥n correcta a login/registro + UX premium
   ‚úÖ 40+ mejoras reales:
   1) No depende de view_functions/current_app -> evita UndefinedError
   2) safe_url robusto: usa url_for si existe, si no fallback
   3) safe_next estricto: evita open-redirect y loops
   4) next siempre path limpio (sin query) + fallback estable
   5) Detecta tab=login/register y redirige (302) al endpoint correcto
   6) Permite "mode=login|register" adem√°s de tab
   7) Hardening de request: soporta ausencia de request
   8) Hardening de current_user: soporta ausencia de Flask-Login
   9) name derivado seguro y no rompe si faltan atributos
   10) n√∫meros clamp + evita div/0
   11) progressbar aria consistente
   12) Noindex + theme-color + meta csrf opcional
   13) Links de auth siempre incluyen next seguro
   14) Evita XSS: e en todo output din√°mico
   15) Evita 500 si endpoints no existen
   16) Evita 500 si split no existe: usa |string
   17) Evita 500 por math: clamp antes de dividir
   18) Fallbacks a rutas /auth/login /auth/register /auth/logout /shop /account
   19) Compatible con tu CSS .ss-account / .ss-login / .ss-register (clase din√°mica)
   20) A11y: skip-link, aria-labels, role groups
   21) CTA claro: login/register/shop/offers
   22) Soporte a ‚Äú?next=‚Äù entrante y lo sanea
   23) Evita redirecci√≥n a /auth/* despu√©s de auth (loop)
   24) Mantiene estructura pro tipo marketplace
   25) No rompe si orders_count/favorites_count no vienen
   26) Panel de beneficios y puntos no rompe si points=0
   27) Navegaci√≥n interna consistente
   28) "Salir" solo si auth
   29) Texto claro y pro
   30) Soporta base.html sin depender de extras
   31) IDs √∫nicos
   32) No usa filtros raros
   33) Evita uso de "view_functions" del contexto (a veces no est√°)
   34) Usa url_for is defined + try-safe
   35) Redirecci√≥n con meta refresh como fallback (si no hay redirect server-side)
   36) Normaliza full_path/base_url
   37) Permite que /auth/account?tab=login funcione como alias sin 500
   38) Evita doble ? en URLs
   39) Escapa next en query
   40) Degrada elegante si faltan datos del usuario
#}

{% extends "base.html" %}
{% block title %}Mi cuenta ¬∑ {{ (APP_NAME or "Skyline Store")|e }}{% endblock %}

{% block extra_head %}
<meta name="robots" content="noindex,nofollow">
<meta name="theme-color" content="#2563eb">

{# CSRF meta opcional (NO rompe si csrf_token no existe) #}
{% set _csrf = (csrf_token() if csrf_token is defined else (csrf_token_value if csrf_token_value is defined else '')) %}
{% if _csrf %}<meta name="csrf-token" content="{{ _csrf|e }}">{% endif %}
{% endblock %}

{% block content %}
{# ----------------------------
   1) Helpers ultra-safe
----------------------------- #}
{% macro safe_url(endpoint, fallback) -%}
  {%- if url_for is defined and endpoint -%}
    {%- set _u = (url_for(endpoint) if endpoint is defined else '') -%}
    {%- if _u -%}{{- _u -}}{%- else -%}{{- fallback -}}{%- endif -%}
  {%- else -%}
    {{- fallback -}}
  {%- endif -%}
{%- endmacro %}

{% macro safe_next(path, default_path='/account') -%}
  {%- set p = (path|string|trim) if path is not none else '' -%}
  {# Reglas anti open-redirect + anti loop auth #}
  {%- if not p or not p.startswith('/') -%}
    {{- default_path -}}
  {%- elif '://' in p or p.startswith('//') -%}
    {{- default_path -}}
  {%- elif p.startswith('/auth/') or p.startswith('/logout') -%}
    {{- default_path -}}
  {%- else -%}
    {{- p -}}
  {%- endif -%}
{%- endmacro %}

{% macro add_q(url, key, val) -%}
  {%- set u = (url|string) -%}
  {%- set sep = '&' if '?' in u else '?' -%}
  {{- u ~ sep ~ key ~ '=' ~ (val|string|urlencode) -}}
{%- endmacro %}

{# ----------------------------
   2) URLs base (NO-FAIL)
----------------------------- #}
{% set url_shop     = safe_url('shop.shop', '/shop') %}
{% if not url_shop or not (url_shop|string).startswith('/') %}{% set url_shop = '/shop' %}{% endif %}
{% set url_offers   = url_shop ~ ('?ofertas=1' if '?' not in (url_shop|string) else '&ofertas=1') %}
{% set url_new      = url_shop ~ ('?sort=new' if '?' not in (url_shop|string) else '&sort=new') %}
{% set url_featured = '/#destacados' %}

{% set url_login    = safe_url('auth.login', '/auth/login') %}
{% set url_register = safe_url('auth.register', '/auth/register') %}
{% set url_logout   = safe_url('auth.logout', '/auth/logout') %}
{% set url_account  = safe_url('account.dashboard', '/account') %}

{# ----------------------------
   3) current path + next safe
----------------------------- #}
{% set _req = (request if request is defined else none) %}
{% set _full = '' %}
{% if _req and _req.full_path is defined and _req.full_path %}
  {% set _full = _req.full_path|string %}
{% elif _req and _req.path is defined and _req.path %}
  {% set _full = _req.path|string %}
{% endif %}

{# Si viene ?next=... lo respetamos pero saneado #}
{% set _next_in = '' %}
{% if _req and _req.args is defined and _req.args %}
  {% set _next_in = (_req.args.get('next') if _req.args.get is defined else '') %}
{% endif %}

{% set next_after_auth = safe_next((_next_in if _next_in else _full), url_account) %}
{% if '?' in (next_after_auth|string) %}
  {% set next_after_auth = (next_after_auth|string).split('?')[0] %}
{% endif %}

{# ----------------------------
   4) Auth detection (NO-LOGIN-MANAGER SAFE)
----------------------------- #}
{% set _is_auth = false %}
{% set _cu = (current_user if current_user is defined else none) %}
{% if _cu and _cu.is_authenticated is defined %}
  {% set _is_auth = (_cu.is_authenticated == true) %}
{% elif is_authenticated is defined %}
  {% set _is_auth = (is_authenticated == true) %}
{% endif %}

{# ----------------------------
   5) Alias redirect: /auth/account?tab=login|register
   - No podemos hacer redirect real desde Jinja,
     pero podemos ofrecer UX + meta refresh fallback.
----------------------------- #}
{% set _tab = '' %}
{% if _req and _req.args is defined and _req.args %}
  {% set _tab = (_req.args.get('tab') if _req.args.get is defined else '')|string|lower|trim %}
  {% if not _tab %}
    {% set _tab = (_req.args.get('mode') if _req.args.get is defined else '')|string|lower|trim %}
  {% endif %}
{% endif %}
{% set _wants_login = (_tab == 'login') %}
{% set _wants_register = (_tab == 'register' or _tab == 'signup') %}

{# Si no est√° autenticado y pide tab=login/register -> redirigir (fallback meta) #}
{% if not _is_auth and (_wants_login or _wants_register) %}
  {% set _dest = url_login if _wants_login else url_register %}
  {% set _dest2 = add_q(_dest, 'next', next_after_auth) %}
  <meta http-equiv="refresh" content="0;url={{ _dest2|e }}">
  <main class="ss-page ss-profile ss-account" role="main" aria-label="Redirecci√≥n">
    <section class="container ss-profile__wrap" style="padding:24px 0">
      <div class="ss-card" style="padding:18px">
        <h1 class="ss-card__title">Redirigiendo‚Ä¶</h1>
        <p class="ss-card__subtitle">Te estamos llevando a {{ 'iniciar sesi√≥n' if _wants_login else 'crear cuenta' }}.</p>
        <div class="ss-btnrow" role="group" aria-label="Acciones">
          <a class="ss-btn ss-btn--primary" href="{{ _dest2|e }}">Continuar</a>
          <a class="ss-btn ss-btn--ghost" href="{{ url_shop|e }}">Volver a la tienda</a>
        </div>
      </div>
    </section>
  </main>
{% else %}

{# ----------------------------
   6) User name (safe)
----------------------------- #}
{% set name = (user_name if user_name is defined and user_name else '')|string|trim %}
{% if not name and _cu %}
  {% if _cu.name is defined and _cu.name %}{% set name = (_cu.name|string)|trim %}{% endif %}
{% endif %}
{% if not name and _cu and _cu.email is defined and _cu.email %}{% set name = (_cu.email|string)|trim %}{% endif %}
{% if not name %}{% set name = 'Usuario' %}{% endif %}

{# ----------------------------
   7) Metrics safe + progress safe
----------------------------- #}
{% set orders   = (orders_count if orders_count is defined and orders_count is not none else 0)|int %}
{% set favs     = (favorites_count if favorites_count is defined and favorites_count is not none else 0)|int %}
{% set points   = (skyline_points if skyline_points is defined and skyline_points is not none else 0)|int %}
{% set next_pts = (next_level_points if next_level_points is defined and next_level_points is not none else 500)|int %}
{% if next_pts < 1 %}{% set next_pts = 1 %}{% endif %}
{% set _ratio = (points / next_pts) %}
{% if _ratio < 0 %}{% set _ratio = 0 %}{% endif %}
{% if _ratio > 1 %}{% set _ratio = 1 %}{% endif %}
{% set pct = (_ratio * 100)|round(0)|int %}

{# classes: compatible con tu CSS .ss-account / .ss-login / .ss-register #}
{% set _page_class = 'ss-account' %}

<main class="ss-page ss-profile {{ _page_class }}" id="account" role="main" aria-label="Mi cuenta">
  <a class="ss-skip" href="#accountMain">Saltar al contenido</a>

  <section class="container ss-profile__wrap" id="accountMain" tabindex="-1">
    {% if not _is_auth %}
      <header class="ss-hero ss-hero--profile" aria-label="Acceso a cuenta">
        <div class="ss-hero__inner">
          <div class="ss-hero__left">
            <div class="ss-kicker" aria-label="Secci√≥n">
              <span class="ss-kicker__dot" aria-hidden="true"></span>
              <span>MI CUENTA</span>
            </div>

            <h1 class="ss-title">Bienvenido a <span class="ss-title__name">Skyline Store</span> üëã</h1>

            <p class="ss-subtitle">
              Inici√° sesi√≥n o cre√° tu cuenta para acceder a pedidos, puntos, favoritos y beneficios.
            </p>

            {% set login_href = add_q(url_login, 'next', next_after_auth) %}
            {% set reg_href   = add_q(url_register, 'next', next_after_auth) %}

            <div class="ss-btnrow" role="group" aria-label="Acciones principales">
              <a class="ss-btn ss-btn--primary" href="{{ login_href|e }}">Iniciar sesi√≥n</a>
              <a class="ss-btn ss-btn--soft" href="{{ reg_href|e }}">Crear cuenta</a>
              <a class="ss-btn ss-btn--ghost" href="{{ url_shop|e }}">üõí Ver tienda</a>
              <a class="ss-btn ss-btn--warn" href="{{ url_offers|e }}">‚ö° Ofertas</a>
            </div>

            <div class="ss-inline-info" role="list" aria-label="Garant√≠as r√°pidas">
              <div class="ss-inline-info__item" role="listitem"><span class="ss-mini-dot" aria-hidden="true"></span><span>Compras protegidas</span></div>
              <div class="ss-inline-info__item" role="listitem"><span class="ss-mini-dot" aria-hidden="true"></span><span>Pagos seguros</span></div>
              <div class="ss-inline-info__item" role="listitem"><span class="ss-mini-dot" aria-hidden="true"></span><span>Soporte 24/7</span></div>
            </div>
          </div>

          <aside class="ss-card ss-card--points" aria-label="Beneficios" aria-live="polite">
            <div class="ss-card__head">
              <div class="ss-card__eyebrow">Beneficios</div>
              <div class="ss-points" aria-label="Puntos y descuentos">
                <div class="ss-points__value">+</div>
                <div class="ss-points__unit">premium</div>
              </div>
            </div>

            <div class="ss-card__hint">
              Sum√° puntos comprando, guard√° favoritos y recib√≠ ofertas personalizadas.
            </div>

            <div class="ss-divider" aria-hidden="true"></div>

            <div class="ss-points-actions" role="group" aria-label="Acciones r√°pidas">
              <a class="ss-mini-btn" href="{{ url_new|e }}">Ver novedades</a>
              <a class="ss-mini-btn ss-mini-btn--primary" href="{{ url_featured|e }}">Ver destacados</a>
            </div>
          </aside>
        </div>
      </header>
    {% else %}
      <header class="ss-hero ss-hero--profile" aria-label="Resumen de cuenta">
        <div class="ss-hero__inner">
          <div class="ss-hero__left">
            <div class="ss-kicker" aria-label="Secci√≥n">
              <span class="ss-kicker__dot" aria-hidden="true"></span>
              <span>MI CUENTA</span>
            </div>

            <h1 class="ss-title">
              Hola, <span class="ss-title__name">{{ name|e }}</span>
            </h1>

            <p class="ss-subtitle">
              Tu panel premium tipo marketplace: pedidos, puntos, accesos r√°pidos y actividad.
            </p>

            <div class="ss-chiprow" role="list" aria-label="Indicadores r√°pidos">
              {% if orders > 0 %}<span class="ss-chip" role="listitem">Pedidos: <b>{{ orders }}</b></span>{% endif %}
              {% if favs > 0 %}<span class="ss-chip" role="listitem">Favoritos: <b>{{ favs }}</b></span>{% endif %}
              <span class="ss-chip" role="listitem">Nivel: <b>Standard</b></span>
              <span class="ss-chip ss-chip--soft" role="listitem">Soporte: <b>24/7</b></span>
            </div>

            <div class="ss-btnrow" role="group" aria-label="Acciones principales">
              <a class="ss-btn ss-btn--primary" href="{{ url_shop|e }}">üõí Ir a la tienda</a>
              <a class="ss-btn ss-btn--soft" href="{{ url_featured|e }}">üî• Destacados</a>
              <a class="ss-btn ss-btn--warn" href="{{ url_offers|e }}">‚ö° Ofertas</a>
              <a class="ss-btn ss-btn--ghost" href="{{ url_new|e }}">üÜï Novedades</a>
              <a class="ss-btn ss-btn--ghost" href="{{ url_logout|e }}">Salir</a>
            </div>

            <div class="ss-inline-info" role="list" aria-label="Garant√≠as r√°pidas">
              <div class="ss-inline-info__item" role="listitem"><span class="ss-mini-dot" aria-hidden="true"></span><span>Compras protegidas</span></div>
              <div class="ss-inline-info__item" role="listitem"><span class="ss-mini-dot" aria-hidden="true"></span><span>Seguimiento de pedidos</span></div>
              <div class="ss-inline-info__item" role="listitem"><span class="ss-mini-dot" aria-hidden="true"></span><span>Pagos seguros</span></div>
            </div>
          </div>

          <aside class="ss-card ss-card--points" aria-label="Puntos Skyline" aria-live="polite">
            <div class="ss-card__head">
              <div class="ss-card__eyebrow">Puntos Skyline</div>
              <div class="ss-points" aria-label="Puntos acumulados">
                <div class="ss-points__value">{{ points }}</div>
                <div class="ss-points__unit">pts</div>
              </div>
            </div>

            <div class="ss-progress" role="progressbar" aria-label="Progreso al pr√≥ximo nivel"
                 aria-valuemin="0" aria-valuemax="{{ next_pts }}" aria-valuenow="{{ points }}">
              <div class="ss-progress__bar" style="width: {{ pct }}%"></div>
            </div>

            <div class="ss-card__hint">
              <b>{{ points }}</b> / {{ next_pts }} pts para el pr√≥ximo nivel
            </div>

            <div class="ss-divider" aria-hidden="true"></div>

            <div class="ss-points-actions" role="group" aria-label="Acciones de puntos">
              <a class="ss-mini-btn" href="{{ url_shop|e }}">Ganar puntos</a>
              <a class="ss-mini-btn ss-mini-btn--primary" href="{{ url_offers|e }}">Canjear ofertas</a>
            </div>
          </aside>
        </div>
      </header>

      <section class="ss-metrics" aria-label="M√©tricas" role="list">
        {% if orders > 0 %}
          <div class="ss-metric" role="listitem">
            <div class="ss-metric__k">Pedidos</div>
            <div class="ss-metric__v">{{ orders }}</div>
            <div class="ss-metric__d">Compras realizadas</div>
          </div>
        {% endif %}
        {% if favs > 0 %}
          <div class="ss-metric" role="listitem">
            <div class="ss-metric__k">Favoritos</div>
            <div class="ss-metric__v">{{ favs }}</div>
            <div class="ss-metric__d">Guardados</div>
          </div>
        {% endif %}
        {% if points > 0 %}
          <div class="ss-metric" role="listitem">
            <div class="ss-metric__k">Puntos</div>
            <div class="ss-metric__v">{{ points }}</div>
            <div class="ss-metric__d">Beneficios</div>
          </div>
        {% endif %}
        <div class="ss-metric" role="listitem">
          <div class="ss-metric__k">Nivel</div>
          <div class="ss-metric__v">Standard</div>
          <div class="ss-metric__d">Perks & accesos</div>
        </div>
      </section>

      <section class="ss-grid2" aria-label="Paneles de actividad">
        <section class="ss-card" aria-label="Acciones r√°pidas">
          <h2 class="ss-card__title">Acciones r√°pidas</h2>
          <p class="ss-card__subtitle">Atajos para moverte como en un marketplace grande</p>

          <div class="ss-list" role="list">
            <a class="ss-row" href="{{ url_shop|e }}" role="listitem" aria-label="Comprar ahora">
              <div>
                <div class="ss-row__title">Comprar ahora</div>
                <div class="ss-row__desc">Abrir cat√°logo completo</div>
              </div>
              <span class="ss-pill ss-pill--ok" aria-hidden="true">Ir</span>
            </a>

            <a class="ss-row" href="{{ url_offers|e }}" role="listitem" aria-label="Ver ofertas">
              <div>
                <div class="ss-row__title">Ofertas</div>
                <div class="ss-row__desc">Promos por tiempo limitado</div>
              </div>
              <span class="ss-pill ss-pill--wait" aria-hidden="true">Ver</span>
            </a>

            <a class="ss-row" href="{{ url_featured|e }}" role="listitem" aria-label="Abrir destacados">
              <div>
                <div class="ss-row__title">Destacados</div>
                <div class="ss-row__desc">Selecci√≥n premium</div>
              </div>
              <span class="ss-pill ss-pill--info" aria-hidden="true">Abrir</span>
            </a>

            <a class="ss-row" href="{{ url_new|e }}" role="listitem" aria-label="Abrir novedades">
              <div>
                <div class="ss-row__title">Novedades</div>
                <div class="ss-row__desc">Lo √∫ltimo agregado</div>
              </div>
              <span class="ss-pill ss-pill--info" aria-hidden="true">Nuevo</span>
            </a>
          </div>

          <div class="ss-notice" role="status" aria-live="polite">
            Tip: agreg√° productos a favoritos para verlos ac√° r√°pido.
          </div>
        </section>

        <section class="ss-card" aria-label="√öltimos pedidos">
          <h2 class="ss-card__title">√öltimos pedidos</h2>
          {% if orders > 0 %}
            <p class="ss-card__subtitle">Tus pedidos recientes</p>
          {% else %}
            <p class="ss-card__subtitle">Todav√≠a no hay pedidos. Cuando compres, aparecen ac√°.</p>
          {% endif %}

          <div class="ss-list" role="list">
            {% if orders > 0 %}
              <div class="ss-row ss-row--static" role="listitem" aria-label="Pedido reciente">
                <div>
                  <div class="ss-row__title">Pedidos</div>
                  <div class="ss-row__desc">Revis√° tu historial desde la tienda</div>
                </div>
                <span class="ss-pill ss-pill--info" aria-hidden="true">Ver</span>
              </div>
            {% else %}
              <div class="ss-row ss-row--static" role="listitem" aria-label="Sin pedidos">
                <div>
                  <div class="ss-row__title">Sin pedidos</div>
                  <div class="ss-row__desc">Explor√° productos y aprovech√° ofertas</div>
                </div>
                <span class="ss-pill ss-pill--ok" aria-hidden="true">Empezar</span>
              </div>
            {% endif %}
          </div>

          <div class="ss-notice" role="status" aria-live="polite">
            Todo se sincroniza autom√°ticamente cuando el backend de pedidos est√© activo.
          </div>
        </section>
      </section>

      <section class="ss-card ss-card--compact" aria-label="Ayuda y soporte">
        <h2 class="ss-card__title">¬øNecesit√°s ayuda?</h2>
        <p class="ss-card__subtitle">Soporte r√°pido y pol√≠ticas claras para comprar con confianza.</p>
        <div class="ss-btnrow" role="group" aria-label="Acciones de soporte">
          <a class="ss-btn ss-btn--soft" href="{{ url_shop|e }}">Centro de ayuda</a>
          <a class="ss-btn ss-btn--ghost" href="{{ url_offers|e }}">Ver promos</a>
        </div>
      </section>
    {% endif %}
  </section>
</main>
{% endif %}{# end redirect alias #}
{% endblock %}
