{# app/templates/auth/account.html ‚Äî Skyline Store (ULTRA PRO / CSRF SAFE / vFINAL) #}
{% extends "base.html" %}
{% block title %}Mi cuenta | Skyline Store{% endblock %}

{% block extra_head %}
<link rel="preload" as="style" href="{{ url_for('static', filename='css/login.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
<link rel="preload" as="style" href="{{ url_for('static', filename='css/register.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/register.css') }}">

<meta name="robots" content="{{ 'index,follow' if (ENV|default('')|lower == 'production') else 'noindex,nofollow' }}">
<meta name="csrf-token" content="{{ csrf_token_value|default('') }}">

{% set _csp_nonce = csp_nonce|default(nonce|default(g.nonce|default('', true), true), true) %}

<style{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
  .ss-account{max-width:1040px;margin:0 auto;padding:clamp(16px,2vw,26px)}
  .ss-tabs{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 14px}
  .ss-tab{border:1px solid rgba(0,0,0,.12);background:rgba(255,255,255,.7);padding:10px 14px;border-radius:999px;cursor:pointer;transition:transform .12s ease, box-shadow .2s ease, border-color .2s ease}
  .ss-tab.is-active{border-color:rgba(0,0,0,.22);box-shadow:0 14px 34px -24px rgba(0,0,0,.35);transform:translateY(-1px)}
  .ss-panels{display:block}
  .ss-panel{display:none}
  .ss-panel.is-active{display:block}
  .ss-flashes{margin:10px 0 14px;display:grid;gap:8px}
  .ss-flash{border-radius:14px;padding:10px 12px;border:1px solid rgba(0,0,0,.10);background:rgba(255,255,255,.75)}
  .ss-flash.error{border-color:rgba(220,38,38,.25)}
  .ss-flash.success{border-color:rgba(34,197,94,.25)}
  .ss-flash.warning{border-color:rgba(245,158,11,.25)}
  .ss-flash.info{border-color:rgba(59,130,246,.22)}
  .ss-field{display:grid;gap:6px;margin:10px 0}
  .ss-row{display:flex;gap:10px;flex-wrap:wrap}
  .ss-input{width:100%;border:1px solid rgba(0,0,0,.14);border-radius:12px;padding:12px 12px;background:rgba(255,255,255,.9)}
  .ss-input:focus{outline:0;box-shadow:0 0 0 4px rgba(0,0,0,.08)}
  .ss-pw-wrap{display:flex;gap:8px;align-items:center}
  .ss-pw-btn{border-radius:12px;border:1px solid rgba(0,0,0,.12);background:transparent;padding:10px 12px;cursor:pointer}
  .ss-submit[aria-busy="true"]{opacity:.88;cursor:progress}
  .ss-spinner{width:16px;height:16px;border:2px solid currentColor;border-right-color:transparent;border-radius:50%;display:inline-block;vertical-align:-3px;animation:sspin .9s linear infinite}
  .ss-help{font-size:.92rem;opacity:.8}
  .ss-err{display:none;margin-top:6px;border-radius:12px;padding:9px 10px;border:1px solid rgba(220,38,38,.22);background:rgba(254,242,242,.75)}
  .ss-err.is-on{display:block}
  @keyframes sspin{to{transform:rotate(360deg)}}
  @media (prefers-reduced-motion: reduce){
    .ss-tab{transition:none}
    .ss-tab.is-active{transform:none}
    .ss-spinner{animation:none}
  }
</style>
{% endblock %}

{% block content %}

{# ---------- next hardening ---------- #}
{% set _raw_next = (next|default(request.args.get('next',''), true)|string).strip() %}
{% set nxt = _raw_next %}
{% if (not nxt) or (not nxt.startswith('/')) or (nxt.startswith('//')) %}
  {% set nxt = '' %}
{% endif %}

{# ---------- endpoints (prefer real url_for; keep safe fallbacks) ---------- #}
{% set login_action    = url_for('auth.login') if (url_for is defined) else '/auth/login' %}
{% set register_action = url_for('auth.register') if (url_for is defined) else '/auth/register' %}
{% set shop_url        = url_for('shop.shop') if (url_for is defined) else '/shop' %}

{# ---------- initial tab: server hint + query param ---------- #}
{% set qtab = (request.args.get('tab','')|string|lower|trim) %}
{% set initial_tab = active_tab|default('login') %}
{% if qtab in ['login','register'] %}
  {% set initial_tab = qtab %}
{% endif %}

{# ---------- preserve typed values (optional) ---------- #}
{% set _login_email = (request.form.get('email','') if request.method == 'POST' else '')|string %}
{% set _reg_name    = (request.form.get('name','') if request.method == 'POST' else '')|string %}
{% set _reg_email   = (request.form.get('email','') if request.method == 'POST' else '')|string %}

<section class="ss-account" aria-label="Mi cuenta">

  <div class="ss-tabs" role="tablist" aria-label="Acceso">
    <button type="button"
            class="ss-tab {{ 'is-active' if initial_tab == 'login' else '' }}"
            role="tab"
            id="tab-login"
            aria-controls="panel-login"
            aria-selected="{{ 'true' if initial_tab == 'login' else 'false' }}"
            tabindex="{{ '0' if initial_tab == 'login' else '-1' }}"
            data-tab="login">
      Ingresar
    </button>

    <button type="button"
            class="ss-tab {{ 'is-active' if initial_tab == 'register' else '' }}"
            role="tab"
            id="tab-register"
            aria-controls="panel-register"
            aria-selected="{{ 'true' if initial_tab == 'register' else 'false' }}"
            tabindex="{{ '0' if initial_tab == 'register' else '-1' }}"
            data-tab="register">
      Crear cuenta
    </button>
  </div>

  {% set _msgs = get_flashed_messages(with_categories=true) %}
  {% if _msgs %}
    <div class="ss-flashes" aria-live="polite" aria-atomic="true">
      {% for category, msg in _msgs %}
        {% set cat = (category|string|lower|trim) %}
        {% set cat = cat if cat in ['error','warning','success','info'] else 'info' %}
        <div class="ss-flash {{ cat }}" role="alert">{{ msg }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="ss-panels">
    <!-- ================= LOGIN ================= -->
    <div class="ss-panel {{ 'is-active' if initial_tab == 'login' else '' }}"
         id="panel-login"
         role="tabpanel"
         aria-labelledby="tab-login"
         {% if initial_tab != 'login' %}hidden aria-hidden="true"{% else %}aria-hidden="false"{% endif %}>
      <form method="post" action="{{ login_action }}" novalidate autocomplete="off" id="loginForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token_value|default('') }}">
        {% if nxt %}<input type="hidden" name="next" value="{{ nxt|e }}">{% endif %}

        <div style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden" aria-hidden="true">
          <label>Website</label>
          <input type="text" name="website" tabindex="-1" autocomplete="off">
        </div>

        <div class="ss-field">
          <label for="loginEmail">Email</label>
          <input class="ss-input"
                 id="loginEmail"
                 type="email"
                 name="email"
                 value="{{ _login_email|e }}"
                 required maxlength="254"
                 autocomplete="username"
                 inputmode="email"
                 autocapitalize="none"
                 spellcheck="false"
                 placeholder="tu@email.com">
          <div class="ss-err" id="loginErr" role="status" aria-live="polite"></div>
        </div>

        <div class="ss-field">
          <label for="loginPass">Contrase√±a</label>
          <div class="ss-pw-wrap">
            <input class="ss-input"
                   id="loginPass"
                   type="password"
                   name="password"
                   required minlength="8"
                   autocomplete="current-password"
                   placeholder="Tu contrase√±a">
            <button type="button" class="ss-pw-btn" id="toggleLoginPass" aria-label="Mostrar contrase√±a" aria-pressed="false">üëÅ</button>
          </div>
        </div>

        <div class="ss-row" style="justify-content:space-between;align-items:center;margin-top:8px">
          <a href="{{ shop_url }}" style="opacity:.8">Seguir como invitado</a>
          <button class="ss-submit" id="loginSubmit" type="submit">Entrar</button>
        </div>
        <p class="ss-help" style="margin-top:10px">Tip: si ya ten√©s cuenta, entr√° con tu email y contrase√±a.</p>
      </form>
    </div>

    <!-- ================= REGISTER ================= -->
    <div class="ss-panel {{ 'is-active' if initial_tab == 'register' else '' }}"
         id="panel-register"
         role="tabpanel"
         aria-labelledby="tab-register"
         {% if initial_tab != 'register' %}hidden aria-hidden="true"{% else %}aria-hidden="false"{% endif %}>
      <form method="post" action="{{ register_action }}" novalidate autocomplete="off" id="registerForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token_value|default('') }}">
        {% if nxt %}<input type="hidden" name="next" value="{{ nxt|e }}">{% endif %}

        <div style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden" aria-hidden="true">
          <label>Website</label>
          <input type="text" name="website" tabindex="-1" autocomplete="off">
        </div>

        <div class="ss-field">
          <label for="regName">Nombre <span style="opacity:.7">(opcional)</span></label>
          <input class="ss-input" id="regName" type="text" name="name" value="{{ _reg_name|e }}" maxlength="120" autocomplete="name" placeholder="Tu nombre">
        </div>

        <div class="ss-field">
          <label for="regEmail">Email</label>
          <input class="ss-input"
                 id="regEmail"
                 type="email"
                 name="email"
                 value="{{ _reg_email|e }}"
                 required maxlength="254"
                 autocomplete="username"
                 inputmode="email"
                 autocapitalize="none"
                 spellcheck="false"
                 placeholder="tu@email.com">
          <div class="ss-err" id="regErr" role="status" aria-live="polite"></div>
        </div>

        <div class="ss-field">
          <label for="regPass">Contrase√±a</label>
          <div class="ss-pw-wrap">
            <input class="ss-input"
                   id="regPass"
                   type="password"
                   name="password"
                   required minlength="8"
                   autocomplete="new-password"
                   placeholder="M√≠nimo 8 caracteres">
            <button type="button" class="ss-pw-btn" id="toggleRegPass" aria-label="Mostrar contrase√±a" aria-pressed="false">üëÅ</button>
          </div>
        </div>

        <div class="ss-field">
          <label for="regPass2">Confirmar contrase√±a</label>
          <div class="ss-pw-wrap">
            <input class="ss-input"
                   id="regPass2"
                   type="password"
                   name="password2"
                   required minlength="8"
                   autocomplete="new-password"
                   placeholder="Repet√≠ la contrase√±a">
            <button type="button" class="ss-pw-btn" id="toggleRegPass2" aria-label="Mostrar confirmaci√≥n" aria-pressed="false">üëÅ</button>
          </div>
        </div>

        <div class="ss-row" style="justify-content:space-between;align-items:center;margin-top:8px">
          <a href="{{ shop_url }}" style="opacity:.8">Seguir como invitado</a>
          <button class="ss-submit" id="regSubmit" type="submit">Crear cuenta</button>
        </div>
        <p class="ss-help" style="margin-top:10px">Al crear cuenta acept√°s nuestros t√©rminos y pol√≠ticas (los pod√©s ver desde el footer).</p>
      </form>
    </div>
  </div>
</section>

<script{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
(() => {
  "use strict";

  const KEY = "ss_account_tab";

  const tabs = {
    login: document.getElementById("tab-login"),
    register: document.getElementById("tab-register"),
  };
  const panels = {
    login: document.getElementById("panel-login"),
    register: document.getElementById("panel-register"),
  };

  const setPanelHidden = (panel, isHidden) => {
    if (!panel) return;
    if (isHidden) {
      panel.setAttribute("hidden", "");
      panel.setAttribute("aria-hidden", "true");
    } else {
      panel.removeAttribute("hidden");
      panel.setAttribute("aria-hidden", "false");
    }
  };

  const setTab = (t, { persist = true, focus = false } = {}) => {
    if (!panels[t] || !tabs[t]) return;

    Object.keys(tabs).forEach((k) => {
      const isOn = (k === t);
      tabs[k].classList.toggle("is-active", isOn);
      tabs[k].setAttribute("aria-selected", String(isOn));
      tabs[k].setAttribute("tabindex", isOn ? "0" : "-1");
      panels[k].classList.toggle("is-active", isOn);
      setPanelHidden(panels[k], !isOn);
    });

    if (persist) {
      try { localStorage.setItem(KEY, t); } catch (e) {}
      try {
        const u = new URL(window.location.href);
        u.searchParams.set("tab", t);
        window.history.replaceState({}, "", u.toString());
      } catch (e) {}
    }
    if (focus) tabs[t].focus();
  };

  const qp = (() => { try { return new URL(window.location.href).searchParams.get("tab") || ""; } catch (e) { return ""; } })();
  const stored = (() => { try { return localStorage.getItem(KEY) || ""; } catch (e) { return ""; } })();
  const initial =
    (qp === "login" || qp === "register") ? qp :
    ((stored === "login" || stored === "register") ? stored : null);

  if (initial) setTab(initial, { persist: false });

  Object.values(tabs).forEach((btn) => {
    if (!btn) return;
    btn.addEventListener("click", () => {
      const t = btn.dataset.tab;
      if (t === "login" || t === "register") setTab(t, { persist: true });
    });

    btn.addEventListener("keydown", (e) => {
      const order = ["login", "register"];
      const cur = btn.dataset.tab || "";
      const idx = order.indexOf(cur);
      if (idx === -1) return;

      if (e.key === "ArrowRight" || e.key === "ArrowLeft") {
        e.preventDefault();
        const next = order[(idx + (e.key === "ArrowRight" ? 1 : -1) + order.length) % order.length];
        setTab(next, { persist: true, focus: true });
      }
    });
  });

  const bindToggle = (btnId, inputId, onLabel, offLabel) => {
    const b = document.getElementById(btnId);
    const i = document.getElementById(inputId);
    if (!b || !i) return;

    b.addEventListener("click", () => {
      const willShow = i.type === "password";
      i.type = willShow ? "text" : "password";
      b.setAttribute("aria-pressed", String(willShow));
      b.setAttribute("aria-label", willShow ? onLabel : offLabel);
    });
  };
  bindToggle("toggleLoginPass", "loginPass", "Ocultar contrase√±a", "Mostrar contrase√±a");
  bindToggle("toggleRegPass", "regPass", "Ocultar contrase√±a", "Mostrar contrase√±a");
  bindToggle("toggleRegPass2", "regPass2", "Ocultar confirmaci√≥n", "Mostrar confirmaci√≥n");

  const showErr = (el, msg) => {
    if (!el) return;
    if (!msg) {
      el.textContent = "";
      el.classList.remove("is-on");
      return;
    }
    el.textContent = msg;
    el.classList.add("is-on");
  };

  const guardSubmit = (formId, btnId, errId, validateFn, restoreLabel) => {
    const f = document.getElementById(formId);
    const b = document.getElementById(btnId);
    const err = document.getElementById(errId);
    if (!f || !b) return;

    f.addEventListener("submit", (ev) => {
      if (b.disabled) return;

      if (typeof validateFn === "function") {
        const res = validateFn();
        if (res !== true) {
          ev.preventDefault();
          ev.stopPropagation();
          showErr(err, typeof res === "string" ? res : "Revis√° los datos e intent√° de nuevo.");
          return;
        }
      }

      showErr(err, "");
      b.disabled = true;
      b.setAttribute("aria-busy", "true");
      b.dataset._label = b.textContent || restoreLabel || "Enviar";
      b.innerHTML = '<span class="ss-spinner" aria-hidden="true"></span> Enviando...';

      window.setTimeout(() => {
        if (!b.disabled) return;
        b.disabled = false;
        b.removeAttribute("aria-busy");
        b.textContent = b.dataset._label || restoreLabel || "Enviar";
      }, 12000);
    }, { passive: false });
  };

  guardSubmit("loginForm", "loginSubmit", "loginErr", () => {
    const em = (document.getElementById("loginEmail")?.value || "").trim();
    const pw = (document.getElementById("loginPass")?.value || "");
    if (em.length < 6 || !em.includes("@")) return "Ingres√° un email v√°lido.";
    if (pw.length < 8) return "La contrase√±a debe tener al menos 8 caracteres.";
    return true;
  }, "Entrar");

  guardSubmit("registerForm", "regSubmit", "regErr", () => {
    const em = (document.getElementById("regEmail")?.value || "").trim();
    const pw = (document.getElementById("regPass")?.value || "");
    const pw2 = (document.getElementById("regPass2")?.value || "");
    if (em.length < 6 || !em.includes("@")) return "Ingres√° un email v√°lido.";
    if (pw.length < 8) return "La contrase√±a debe tener al menos 8 caracteres.";
    if (pw !== pw2) return "Las contrase√±as no coinciden.";
    return true;
  }, "Crear cuenta");
})();
</script>
{% endblock %}
