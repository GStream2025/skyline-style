{% extends "base.html" %}
{% block title %}Mi cuenta | {{ (APP_NAME or "Skyline Store")|e }}{% endblock %}

{% block extra_head %}
  <link rel="preload" as="style" href="{{ url_for('static', filename='css/account.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/account.css') }}">

  <meta name="robots" content="{{ 'index,follow' if (ENV|default('')|lower == 'production') else 'noindex,nofollow' }}">

  {% set _csp_nonce = (csp_nonce if csp_nonce is defined and csp_nonce else (nonce if nonce is defined and nonce else '')) %}

  {% set _csrf_val = '' %}
  {% if csrf_token is defined and csrf_token %}
    {% if csrf_token is callable %}
      {% set _csrf_val = csrf_token() %}
    {% else %}
      {% set _csrf_val = csrf_token %}
    {% endif %}
  {% elif csrf_token_value is defined and csrf_token_value %}
    {% set _csrf_val = csrf_token_value %}
  {% endif %}
  <meta name="csrf-token" content="{{ (_csrf_val|string)|e }}">
{% endblock %}

{% block content %}

{% set _raw_next = (next|default(request.args.get('next',''), true)|string).strip() %}
{% set nxt = _raw_next if _raw_next.startswith('/') and not _raw_next.startswith('//') else '' %}

{% set qtab = (request.args.get('tab','')|string|lower|trim) %}
{% set initial_tab = (active_tab|default('login')|string|lower|trim) %}
{% if qtab in ['login','register'] %}{% set initial_tab = qtab %}{% endif %}
{% if initial_tab not in ['login','register'] %}{% set initial_tab = 'login' %}{% endif %}

{% set _post_tab = (request.form.get('_tab','') if request.method == 'POST' else '')|string|lower|trim %}
{% set _login_email = (request.form.get('email','') if request.method == 'POST' and _post_tab == 'login' else prefill_email|default('',true))|string %}
{% set _reg_name  = (request.form.get('name','')  if request.method == 'POST' and _post_tab == 'register' else '')|string %}
{% set _reg_email = (request.form.get('email','') if request.method == 'POST' and _post_tab == 'register' else '')|string %}

{% set login_action = '/auth/login' %}
{% set register_action = '/auth/register' %}
{% set account_url = '/auth/account' %}
{% set forgot_url = '/auth/forgot-password' %}
{% set shop_url = (url_for('shop.shop') if url_for is defined else '/shop') %}

<section class="ss-account">
  <div class="auth-wrap">
    <div class="auth-shell">

      <div class="auth-card">
        <div class="auth-brand">
          <span class="auth-brand__dot"></span>
          <div class="auth-brand__title">{{ (APP_NAME or "Skyline Store")|e }}</div>
          <div class="auth-brand__sub">Ingres√° o cre√° tu cuenta</div>
        </div>

        <div class="auth-tabs" role="tablist">
          <button type="button" class="auth-tab" id="tab-login" role="tab"
                  aria-selected="{{ 'true' if initial_tab == 'login' else 'false' }}"
                  tabindex="{{ '0' if initial_tab == 'login' else '-1' }}"
                  data-tab="login">Ingresar</button>

          <button type="button" class="auth-tab" id="tab-register" role="tab"
                  aria-selected="{{ 'true' if initial_tab == 'register' else 'false' }}"
                  tabindex="{{ '0' if initial_tab == 'register' else '-1' }}"
                  data-tab="register">Crear cuenta</button>
        </div>

        {% set _msgs = get_flashed_messages(with_categories=true) %}
        {% if _msgs %}
          <div class="auth-card__pad">
            {% for category, msg in _msgs %}
              {% set cat = (category|string|lower|trim) %}
              {% set cat = cat if cat in ['error','warning','success','info'] else 'info' %}
              <div class="auth-flash {{ cat }}" role="alert">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <div class="auth-card__pad">

          <div id="panel-login" role="tabpanel" {% if initial_tab != 'login' %}hidden{% endif %}>
            <form method="post" action="{{ login_action }}" novalidate id="loginForm">
              <input type="hidden" name="_tab" value="login">
              <input type="hidden" name="csrf_token" value="{{ (_csrf_val|string)|e }}">
              {% if nxt %}<input type="hidden" name="next" value="{{ nxt|e }}">{% endif %}

              <div class="hp-field">
                <input type="text" name="website" tabindex="-1" autocomplete="off">
              </div>

              <div class="auth-field">
                <label>Email</label>
                <input class="auth-input" type="email" name="email"
                       value="{{ _login_email|trim|e }}"
                       required autocomplete="username">
                <div class="field-error" id="loginErr"></div>
              </div>

              <div class="auth-field">
                <label>Contrase√±a</label>
                <div class="ss-pw-wrap">
                  <input class="auth-input" id="loginPass" type="password" name="password"
                         required minlength="8" autocomplete="current-password">
                  <button type="button" class="ss-pw-btn" id="toggleLoginPass" aria-pressed="false">üëÅ</button>
                </div>
              </div>

              <div class="auth-actions">
                <button class="btn-primary" id="loginSubmit" type="submit">Entrar</button>
                <a class="btn-ghost" href="{{ shop_url }}">Seguir como invitado</a>
              </div>

              <div class="auth-links">
                <a href="{{ forgot_url }}">¬øOlvidaste tu contrase√±a?</a>
                <a href="{{ account_url }}?tab=register{% if nxt %}&next={{ nxt|urlencode }}{% endif %}">Crear cuenta</a>
              </div>
            </form>
          </div>

          <div id="panel-register" role="tabpanel" {% if initial_tab != 'register' %}hidden{% endif %}>
            <form method="post" action="{{ register_action }}" novalidate id="registerForm">
              <input type="hidden" name="_tab" value="register">
              <input type="hidden" name="csrf_token" value="{{ (_csrf_val|string)|e }}">
              {% if nxt %}<input type="hidden" name="next" value="{{ nxt|e }}">{% endif %}

              <div class="hp-field">
                <input type="text" name="website" tabindex="-1" autocomplete="off">
              </div>

              <div class="auth-field">
                <label>Nombre</label>
                <input class="auth-input" type="text" name="name"
                       value="{{ _reg_name|trim|e }}" autocomplete="name">
              </div>

              <div class="auth-field">
                <label>Email</label>
                <input class="auth-input" type="email" name="email"
                       value="{{ _reg_email|trim|e }}"
                       required autocomplete="username">
                <div class="field-error" id="regErr"></div>
              </div>

              <div class="auth-field">
                <label>Contrase√±a</label>
                <div class="ss-pw-wrap">
                  <input class="auth-input" id="regPass" type="password" name="password"
                         required minlength="8" autocomplete="new-password">
                  <button type="button" class="ss-pw-btn" id="toggleRegPass" aria-pressed="false">üëÅ</button>
                </div>
              </div>

              <div class="auth-field">
                <label>Confirmar contrase√±a</label>
                <div class="ss-pw-wrap">
                  <input class="auth-input" id="regPass2" type="password" name="password2"
                         required minlength="8" autocomplete="new-password">
                  <button type="button" class="ss-pw-btn" id="toggleRegPass2" aria-pressed="false">üëÅ</button>
                </div>
              </div>

              <div class="auth-field">
                <label>Tipo de cuenta</label>
                <div class="ss-choice">
                  <label><input type="radio" name="role" value="customer" checked> Comprador</label>
                  <label><input type="radio" name="role" value="affiliate"> Afiliado</label>
                </div>
              </div>

              <div class="auth-actions">
                <button class="btn-primary" id="regSubmit" type="submit">Crear cuenta</button>
                <a class="btn-ghost" href="{{ shop_url }}">Seguir como invitado</a>
              </div>

              <div class="auth-links">
                <a href="{{ account_url }}?tab=login{% if nxt %}&next={{ nxt|urlencode }}{% endif %}">Ya tengo cuenta</a>
                <a href="{{ forgot_url }}">Recuperar contrase√±a</a>
              </div>
            </form>
          </div>

        </div>
      </div>

      <aside class="auth-side">
        <h3>Compr√° con confianza</h3>
        <ul>
          <li>Pagos seguros</li>
          <li>Env√≠os r√°pidos</li>
          <li>Ofertas exclusivas</li>
        </ul>
        <a class="btn-ghost" href="{{ shop_url }}">Ir a la tienda</a>
      </aside>

    </div>
  </div>
</section>

<script{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
(() => {
  const tabs = document.querySelectorAll('.auth-tab');
  const panels = {
    login: document.getElementById('panel-login'),
    register: document.getElementById('panel-register')
  };

  const setTab = (t) => {
    tabs.forEach(b => {
      const on = b.dataset.tab === t;
      b.setAttribute('aria-selected', on);
      b.tabIndex = on ? 0 : -1;
      panels[b.dataset.tab].hidden = !on;
    });
    try {
      const u = new URL(location.href);
      u.searchParams.set('tab', t);
      history.replaceState({}, '', u.toString());
    } catch {}
  };

  tabs.forEach(b => b.addEventListener('click', () => setTab(b.dataset.tab)));

  const bindToggle = (btn, inp) => {
    const b = document.getElementById(btn);
    const i = document.getElementById(inp);
    if (!b || !i) return;
    b.addEventListener('click', () => {
      const s = i.type === 'password';
      i.type = s ? 'text' : 'password';
      b.setAttribute('aria-pressed', s);
    });
  };

  bindToggle('toggleLoginPass','loginPass');
  bindToggle('toggleRegPass','regPass');
  bindToggle('toggleRegPass2','regPass2');
})();
</script>

{% endblock %}
