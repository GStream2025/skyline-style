{% extends "base.html" %}
{% block title %}Mi cuenta | {{ (APP_NAME or "Skyline Store")|e }}{% endblock %}

{% block extra_head %}
  <link rel="preload" as="style" href="{{ url_for('static', filename='css/account.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/account.css') }}">

  {% set _env = (ENV|default('production')|string|lower|trim) %}
  <meta name="robots" content="{{ 'index,follow' if _env == 'production' else 'noindex,nofollow' }}">

  {% set _csp_nonce = (csp_nonce if csp_nonce is defined and csp_nonce else (nonce if nonce is defined and nonce else '')) %}

  {% set _csrf_val = '' %}
  {% if csrf_token is defined and csrf_token %}
    {% if csrf_token is callable %}
      {% set _csrf_val = csrf_token() %}
    {% else %}
      {% set _csrf_val = csrf_token %}
    {% endif %}
  {% elif csrf_token_value is defined and csrf_token_value %}
    {% set _csrf_val = csrf_token_value %}
  {% endif %}
  <meta name="csrf-token" content="{{ (_csrf_val|string)|e }}">
{% endblock %}

{% block content %}

{% set _req = (request if request is defined and request else none) %}
{% set _args = (_req.args if _req and _req.args else {}) %}
{% set _raw_next = (next|default((_args.get('next','') if _args else ''), true)|string).strip() %}
{% set nxt = _raw_next if _raw_next.startswith('/') and not _raw_next.startswith('//') and ('\n' not in _raw_next) and ('\r' not in _raw_next) and ('\x00' not in _raw_next) and ('\\' not in _raw_next) else '' %}

{% set qtab = ((_args.get('tab','') if _args else '')|string|lower|trim) %}
{% set initial_tab = (active_tab|default('login')|string|lower|trim) %}
{% if qtab in ['login','register'] %}{% set initial_tab = qtab %}{% endif %}
{% if initial_tab not in ['login','register'] %}{% set initial_tab = 'login' %}{% endif %}

{% set _method = (_req.method if _req else '') %}
{% set _is_post = (_method == 'POST') %}
{% set _form = (_req.form if (_req and _is_post) else {}) %}
{% set _post_tab = ((_form.get('_tab','') if _form else '')|string|lower|trim) %}

{% set _login_email = ((_form.get('email','') if (_form and _post_tab == 'login') else (prefill_email|default('',true)))|string) %}
{% set _reg_name  = ((_form.get('name','') if (_form and _post_tab == 'register') else '')|string) %}
{% set _reg_email = ((_form.get('email','') if (_form and _post_tab == 'register') else '')|string) %}

{% set login_action = '/auth/login' %}
{% set register_action = '/auth/register' %}
{% set account_url = '/auth/account' %}
{% set forgot_url = '/auth/forgot-password' %}

{% set shop_url = '/shop' %}
{% if url_for is defined %}
  {% set shop_url = (url_for('shop.shop') if ('shop.shop' in (view_functions or {})) else '/shop') %}
{% endif %}

{% set _msgs = (get_flashed_messages(with_categories=true) if get_flashed_messages is defined else []) %}

<section class="ss-account" data-page="account">
  <div class="auth-wrap">
    <div class="auth-shell">

      <div class="auth-card" aria-labelledby="authTitle">
        <header class="auth-brand">
          <span class="auth-brand__dot" aria-hidden="true"></span>
          <div class="auth-brand__title" id="authTitle">{{ (APP_NAME or "Skyline Store")|e }}</div>
          <p class="auth-brand__sub">Ingres√° o cre√° tu cuenta para comprar y guardar tus datos.</p>
        </header>

        <nav class="auth-tabs" role="tablist" aria-label="Acceso a cuenta">
          <button type="button" class="auth-tab" id="tab-login" role="tab"
                  aria-controls="panel-login"
                  aria-selected="{{ 'true' if initial_tab == 'login' else 'false' }}"
                  tabindex="{{ '0' if initial_tab == 'login' else '-1' }}"
                  data-tab="login">Ingresar</button>

          <button type="button" class="auth-tab" id="tab-register" role="tab"
                  aria-controls="panel-register"
                  aria-selected="{{ 'true' if initial_tab == 'register' else 'false' }}"
                  tabindex="{{ '0' if initial_tab == 'register' else '-1' }}"
                  data-tab="register">Crear cuenta</button>
        </nav>

        {% if _msgs %}
          <div class="auth-card__pad auth-pad--flash" aria-live="polite" aria-atomic="true">
            {% for category, msg in _msgs %}
              {% set cat = (category|string|lower|trim) %}
              {% set cat = cat if cat in ['error','warning','success','info'] else 'info' %}
              <div class="auth-flash {{ cat }}" role="alert">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <div class="auth-card__pad">
          <section id="panel-login" role="tabpanel" aria-labelledby="tab-login"
                   {% if initial_tab != 'login' %}hidden aria-hidden="true"{% endif %}>
            <form method="post" action="{{ login_action }}" novalidate id="loginForm" class="auth-form" data-auth-form>
              <input type="hidden" name="_tab" value="login">
              <input type="hidden" name="csrf_token" value="{{ (_csrf_val|string)|e }}">
              {% if nxt %}<input type="hidden" name="next" value="{{ nxt|e }}">{% endif %}

              <div class="hp-field" aria-hidden="true">
                <label class="sr-only" for="hp1">Website</label>
                <input id="hp1" type="text" name="website" tabindex="-1" autocomplete="off" inputmode="url">
              </div>

              <div class="auth-field">
                <label for="loginEmail">Email</label>
                <input class="auth-input" id="loginEmail" type="email" name="email"
                       value="{{ _login_email|trim|e }}"
                       required autocomplete="username" inputmode="email"
                       aria-describedby="loginHint loginErr">
                <div class="field-hint" id="loginHint">Us√° el email con el que te registraste.</div>
                <div class="field-error" id="loginErr" role="status" aria-live="polite"></div>
              </div>

              <div class="auth-field">
                <label for="loginPass">Contrase√±a</label>
                <div class="ss-pw-wrap">
                  <input class="auth-input" id="loginPass" type="password" name="password"
                         required minlength="8" autocomplete="current-password">
                  <button type="button" class="ss-pw-btn" id="toggleLoginPass"
                          aria-label="Mostrar u ocultar contrase√±a" aria-pressed="false">üëÅ</button>
                </div>
              </div>

              <div class="auth-actions">
                <button class="btn-primary" id="loginSubmit" type="submit">
                  <span class="btn-label">Entrar</span>
                  <span class="btn-spinner" aria-hidden="true"></span>
                </button>
                <a class="btn-ghost" href="{{ shop_url }}">Seguir como invitado</a>
              </div>

              <div class="auth-links">
                <a href="{{ forgot_url }}">¬øOlvidaste tu contrase√±a?</a>
                <a href="{{ account_url }}?tab=register{% if nxt %}&next={{ nxt|urlencode }}{% endif %}">Crear cuenta</a>
              </div>
            </form>
          </section>

          <section id="panel-register" role="tabpanel" aria-labelledby="tab-register"
                   {% if initial_tab != 'register' %}hidden aria-hidden="true"{% endif %}>
            <form method="post" action="{{ register_action }}" novalidate id="registerForm" class="auth-form" data-auth-form>
              <input type="hidden" name="_tab" value="register">
              <input type="hidden" name="csrf_token" value="{{ (_csrf_val|string)|e }}">
              {% if nxt %}<input type="hidden" name="next" value="{{ nxt|e }}">{% endif %}

              <div class="hp-field" aria-hidden="true">
                <label class="sr-only" for="hp2">Website</label>
                <input id="hp2" type="text" name="website" tabindex="-1" autocomplete="off" inputmode="url">
              </div>

              <div class="auth-field">
                <label for="regName">Nombre</label>
                <input class="auth-input" id="regName" type="text" name="name"
                       value="{{ _reg_name|trim|e }}"
                       autocomplete="name" maxlength="80">
              </div>

              <div class="auth-field">
                <label for="regEmail">Email</label>
                <input class="auth-input" id="regEmail" type="email" name="email"
                       value="{{ _reg_email|trim|e }}"
                       required autocomplete="username" inputmode="email"
                       aria-describedby="regHint regErr">
                <div class="field-hint" id="regHint">Te vamos a enviar confirmaciones y avisos de compra.</div>
                <div class="field-error" id="regErr" role="status" aria-live="polite"></div>
              </div>

              <div class="auth-field">
                <label for="regPass">Contrase√±a</label>
                <div class="ss-pw-wrap">
                  <input class="auth-input" id="regPass" type="password" name="password"
                         required minlength="8" autocomplete="new-password"
                         aria-describedby="pwHint">
                  <button type="button" class="ss-pw-btn" id="toggleRegPass"
                          aria-label="Mostrar u ocultar contrase√±a" aria-pressed="false">üëÅ</button>
                </div>
                <div class="field-hint" id="pwHint">M√≠nimo 8 caracteres.</div>
              </div>

              <div class="auth-field">
                <label for="regPass2">Confirmar contrase√±a</label>
                <div class="ss-pw-wrap">
                  <input class="auth-input" id="regPass2" type="password" name="password2"
                         required minlength="8" autocomplete="new-password">
                  <button type="button" class="ss-pw-btn" id="toggleRegPass2"
                          aria-label="Mostrar u ocultar confirmaci√≥n" aria-pressed="false">üëÅ</button>
                </div>
              </div>

              <fieldset class="auth-field ss-choice" role="group" aria-label="Tipo de cuenta">
                <legend>Tipo de cuenta</legend>
                <label><input type="radio" name="role" value="customer" checked> Comprador</label>
                <label><input type="radio" name="role" value="affiliate"> Afiliado</label>
              </fieldset>

              <div class="auth-actions">
                <button class="btn-primary" id="regSubmit" type="submit">
                  <span class="btn-label">Crear cuenta</span>
                  <span class="btn-spinner" aria-hidden="true"></span>
                </button>
                <a class="btn-ghost" href="{{ shop_url }}">Seguir como invitado</a>
              </div>

              <div class="auth-links">
                <a href="{{ account_url }}?tab=login{% if nxt %}&next={{ nxt|urlencode }}{% endif %}">Ya tengo cuenta</a>
                <a href="{{ forgot_url }}">Recuperar contrase√±a</a>
              </div>
            </form>
          </section>

        </div>
      </div>

      <aside class="auth-side" aria-label="Beneficios Skyline Store">
        <h3>Compr√° con confianza</h3>
        <ul class="auth-perks">
          <li><span aria-hidden="true">üîí</span> Pagos seguros</li>
          <li><span aria-hidden="true">üöö</span> Env√≠os r√°pidos</li>
          <li><span aria-hidden="true">üíé</span> Ofertas exclusivas</li>
        </ul>
        <div class="auth-side__cta">
          <a class="btn-ghost" href="{{ shop_url }}">Ir a la tienda</a>
          <p class="auth-side__note">Pod√©s navegar como invitado y comprar cuando quieras.</p>
        </div>
      </aside>

    </div>
  </div>
</section>

<script{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
(() => {
  const root = document.querySelector('[data-page="account"]') || document;
  const tabs = Array.from(root.querySelectorAll('.auth-tab'));
  const panelLogin = root.querySelector('#panel-login');
  const panelRegister = root.querySelector('#panel-register');
  const panels = { login: panelLogin, register: panelRegister };

  const setTab = (t, focusBtn = true) => {
    tabs.forEach(b => {
      const on = b.dataset.tab === t;
      b.setAttribute('aria-selected', on ? 'true' : 'false');
      b.tabIndex = on ? 0 : -1;
      const p = panels[b.dataset.tab];
      if (p) {
        p.hidden = !on;
        p.setAttribute('aria-hidden', (!on).toString());
      }
      if (on && focusBtn) b.focus({ preventScroll: true });
    });
    try {
      const u = new URL(location.href);
      u.searchParams.set('tab', t);
      history.replaceState({}, '', u.toString());
    } catch {}
  };

  tabs.forEach(b => b.addEventListener('click', () => setTab(b.dataset.tab, false)));

  const order = ['login', 'register'];
  root.querySelector('.auth-tabs')?.addEventListener('keydown', (e) => {
    const cur = document.activeElement?.dataset?.tab;
    if (!cur || !order.includes(cur)) return;

    let idx = order.indexOf(cur);
    if (e.key === 'ArrowRight') idx = (idx + 1) % order.length;
    else if (e.key === 'ArrowLeft') idx = (idx - 1 + order.length) % order.length;
    else if (e.key === 'Home') idx = 0;
    else if (e.key === 'End') idx = order.length - 1;
    else return;

    e.preventDefault();
    setTab(order[idx], true);
  });

  const bindToggle = (btnId, inpId) => {
    const b = root.getElementById ? root.getElementById(btnId) : document.getElementById(btnId);
    const i = root.getElementById ? root.getElementById(inpId) : document.getElementById(inpId);
    const bb = document.getElementById(btnId);
    const ii = document.getElementById(inpId);
    const btn = b || bb;
    const inp = i || ii;
    if (!btn || !inp) return;

    const setState = (show) => {
      inp.type = show ? 'text' : 'password';
      btn.setAttribute('aria-pressed', show ? 'true' : 'false');
      btn.textContent = show ? 'üôà' : 'üëÅ';
    };
    btn.addEventListener('click', () => setState(inp.type === 'password'));
  };

  bindToggle('toggleLoginPass','loginPass');
  bindToggle('toggleRegPass','regPass');
  bindToggle('toggleRegPass2','regPass2');

  const lockForm = (formId, btnId) => {
    const f = document.getElementById(formId);
    const b = document.getElementById(btnId);
    if (!f || !b) return;

    let locked = false;
    f.addEventListener('submit', () => {
      if (locked) return;
      locked = true;
      b.disabled = true;
      b.classList.add('is-loading');
      const lbl = b.querySelector('.btn-label');
      if (lbl) lbl.textContent = (formId === 'loginForm') ? 'Entrando‚Ä¶' : 'Creando‚Ä¶';
      setTimeout(() => {
        locked = false;
        b.disabled = false;
        b.classList.remove('is-loading');
      }, 12000);
    }, { passive: true });
  };

  lockForm('loginForm','loginSubmit');
  lockForm('registerForm','regSubmit');
})();
</script>

{% endblock %}
