{% extends "base.html" %}
{% block title %}Mi cuenta ¬∑ {{ (APP_NAME or "Skyline Store")|e }}{% endblock %}

{% block extra_head %}
<meta name="robots" content="noindex,nofollow">
<meta name="theme-color" content="#2563eb">
{% endblock %}

{% block content %}
{% set _vf = (view_functions if view_functions is defined and view_functions else {}) %}
{% macro safe_url(endpoint, fallback) -%}
  {%- if endpoint and endpoint in _vf -%}{{ url_for(endpoint) }}{%- else -%}{{ fallback }}{%- endif -%}
{%- endmacro %}

{% macro safe_next(path, default_path='/account') -%}
  {%- set p = (path|string|trim) if path is not none else '' -%}
  {%- if not p or not p.startswith('/') or '://' in p or p.startswith('//') -%}
    {{- default_path -}}
  {%- elif p.startswith('/auth/') or p.startswith('/logout') -%}
    {{- default_path -}}
  {%- else -%}
    {{- p -}}
  {%- endif -%}
{%- endmacro %}

{% set url_shop     = safe_url('shop.shop', '/shop') %}
{% if not url_shop or not url_shop.startswith('/') %}{% set url_shop = '/shop' %}{% endif %}
{% set url_offers   = url_shop ~ ('?ofertas=1' if '?' not in url_shop else '&ofertas=1') %}
{% set url_new      = url_shop ~ ('?sort=new' if '?' not in url_shop else '&sort=new') %}
{% set url_featured = '/#destacados' %}

{% set url_login    = safe_url('auth.login', '/auth/login') %}
{% set url_register = safe_url('auth.register', '/auth/register') %}
{% set url_logout   = safe_url('auth.logout', '/auth/logout') %}
{% set url_account  = safe_url('account.dashboard', '/account') %}

{% set next_after_auth = safe_next(request.full_path if request is defined and request.full_path else url_account, url_account) %}
{% if '?' in next_after_auth %}
  {% set next_after_auth = next_after_auth.split('?')[0] %}
{% endif %}

{% set _is_auth = false %}
{% if current_user is defined and current_user and current_user.is_authenticated is defined %}
  {% set _is_auth = current_user.is_authenticated %}
{% elif is_authenticated is defined %}
  {% set _is_auth = is_authenticated %}
{% endif %}

{% set name = (user_name if user_name is defined and user_name else '')|string|trim %}
{% if not name and current_user is defined and current_user %}
  {% if current_user.name is defined and current_user.name %}
    {% set name = (current_user.name|string)|trim %}
  {% endif %}
{% endif %}
{% if not name and current_user is defined and current_user and current_user.email is defined and current_user.email %}
  {% set name = (current_user.email|string)|trim %}
{% endif %}
{% if not name %}{% set name = 'Usuario' %}{% endif %}

{% set orders   = (orders_count if orders_count is defined and orders_count is not none else 0)|int %}
{% set favs     = (favorites_count if favorites_count is defined and favorites_count is not none else 0)|int %}
{% set points   = (skyline_points if skyline_points is defined and skyline_points is not none else 0)|int %}
{% set next_pts = (next_level_points if next_level_points is defined and next_level_points is not none else 500)|int %}
{% if next_pts < 1 %}{% set next_pts = 1 %}{% endif %}
{% set pct = ((points / next_pts) * 100) %}
{% if pct < 0 %}{% set pct = 0 %}{% endif %}
{% if pct > 100 %}{% set pct = 100 %}{% endif %}
{% set pct = pct|round(0)|int %}

<main class="ss-page ss-profile" id="account" role="main" aria-label="Mi cuenta">
  <a class="ss-skip" href="#accountMain">Saltar al contenido</a>

  <section class="container ss-profile__wrap" id="accountMain" tabindex="-1">
    {% if not _is_auth %}
      <header class="ss-hero ss-hero--profile" aria-label="Acceso a cuenta">
        <div class="ss-hero__inner">
          <div class="ss-hero__left">
            <div class="ss-kicker" aria-label="Secci√≥n">
              <span class="ss-kicker__dot" aria-hidden="true"></span>
              <span>MI CUENTA</span>
            </div>

            <h1 class="ss-title">Bienvenido a <span class="ss-title__name">Skyline Store</span> üëã</h1>

            <p class="ss-subtitle">
              Inici√° sesi√≥n o cre√° tu cuenta para acceder a pedidos, puntos, favoritos y beneficios.
            </p>

            <div class="ss-btnrow" role="group" aria-label="Acciones principales">
              <a class="ss-btn ss-btn--primary" href="{{ (url_login ~ '?next=' ~ next_after_auth)|e }}">Iniciar sesi√≥n</a>
              <a class="ss-btn ss-btn--soft" href="{{ (url_register ~ '?next=' ~ next_after_auth)|e }}">Crear cuenta</a>
              <a class="ss-btn ss-btn--ghost" href="{{ url_shop|e }}">üõí Ver tienda</a>
              <a class="ss-btn ss-btn--warn" href="{{ url_offers|e }}">‚ö° Ofertas</a>
            </div>

            <div class="ss-inline-info" role="list" aria-label="Garant√≠as r√°pidas">
              <div class="ss-inline-info__item" role="listitem"><span class="ss-mini-dot" aria-hidden="true"></span><span>Compras protegidas</span></div>
              <div class="ss-inline-info__item" role="listitem"><span class="ss-mini-dot" aria-hidden="true"></span><span>Pagos seguros</span></div>
              <div class="ss-inline-info__item" role="listitem"><span class="ss-mini-dot" aria-hidden="true"></span><span>Soporte 24/7</span></div>
            </div>
          </div>

          <aside class="ss-card ss-card--points" aria-label="Beneficios" aria-live="polite">
            <div class="ss-card__head">
              <div class="ss-card__eyebrow">Beneficios</div>
              <div class="ss-points" aria-label="Puntos y descuentos">
                <div class="ss-points__value">+</div>
                <div class="ss-points__unit">premium</div>
              </div>
            </div>

            <div class="ss-card__hint">
              Sum√° puntos comprando, guard√° favoritos y recib√≠ ofertas personalizadas.
            </div>

            <div class="ss-divider" aria-hidden="true"></div>

            <div class="ss-points-actions" role="group" aria-label="Acciones r√°pidas">
              <a class="ss-mini-btn" href="{{ url_new|e }}">Ver novedades</a>
              <a class="ss-mini-btn ss-mini-btn--primary" href="{{ url_featured|e }}">Ver destacados</a>
            </div>
          </aside>
        </div>
      </header>
    {% else %}
      <header class="ss-hero ss-hero--profile" aria-label="Resumen de cuenta">
        <div class="ss-hero__inner">
          <div class="ss-hero__left">
            <div class="ss-kicker" aria-label="Secci√≥n">
              <span class="ss-kicker__dot" aria-hidden="true"></span>
              <span>MI CUENTA</span>
            </div>

            <h1 class="ss-title">
              Hola, <span class="ss-title__name">{{ name|e }}</span>
            </h1>

            <p class="ss-subtitle">
              Tu panel premium tipo marketplace: pedidos, puntos, accesos r√°pidos y actividad.
            </p>

            <div class="ss-chiprow" role="list" aria-label="Indicadores r√°pidos">
              {% if orders > 0 %}<span class="ss-chip" role="listitem">Pedidos: <b>{{ orders }}</b></span>{% endif %}
              {% if favs > 0 %}<span class="ss-chip" role="listitem">Favoritos: <b>{{ favs }}</b></span>{% endif %}
              <span class="ss-chip" role="listitem">Nivel: <b>Standard</b></span>
              <span class="ss-chip ss-chip--soft" role="listitem">Soporte: <b>24/7</b></span>
            </div>

            <div class="ss-btnrow" role="group" aria-label="Acciones principales">
              <a class="ss-btn ss-btn--primary" href="{{ url_shop|e }}">üõí Ir a la tienda</a>
              <a class="ss-btn ss-btn--soft" href="{{ url_featured|e }}">üî• Destacados</a>
              <a class="ss-btn ss-btn--warn" href="{{ url_offers|e }}">‚ö° Ofertas</a>
              <a class="ss-btn ss-btn--ghost" href="{{ url_new|e }}">üÜï Novedades</a>
              <a class="ss-btn ss-btn--ghost" href="{{ url_logout|e }}">Salir</a>
            </div>

            <div class="ss-inline-info" role="list" aria-label="Garant√≠as r√°pidas">
              <div class="ss-inline-info__item" role="listitem"><span class="ss-mini-dot" aria-hidden="true"></span><span>Compras protegidas</span></div>
              <div class="ss-inline-info__item" role="listitem"><span class="ss-mini-dot" aria-hidden="true"></span><span>Seguimiento de pedidos</span></div>
              <div class="ss-inline-info__item" role="listitem"><span class="ss-mini-dot" aria-hidden="true"></span><span>Pagos seguros</span></div>
            </div>
          </div>

          <aside class="ss-card ss-card--points" aria-label="Puntos Skyline" aria-live="polite">
            <div class="ss-card__head">
              <div class="ss-card__eyebrow">Puntos Skyline</div>
              <div class="ss-points" aria-label="Puntos acumulados">
                <div class="ss-points__value">{{ points }}</div>
                <div class="ss-points__unit">pts</div>
              </div>
            </div>

            <div class="ss-progress" role="progressbar" aria-label="Progreso al pr√≥ximo nivel"
                 aria-valuemin="0" aria-valuemax="{{ next_pts }}" aria-valuenow="{{ points }}">
              <div class="ss-progress__bar" style="width: {{ pct }}%"></div>
            </div>

            <div class="ss-card__hint">
              <b>{{ points }}</b> / {{ next_pts }} pts para el pr√≥ximo nivel
            </div>

            <div class="ss-divider" aria-hidden="true"></div>

            <div class="ss-points-actions" role="group" aria-label="Acciones de puntos">
              <a class="ss-mini-btn" href="{{ url_shop|e }}">Ganar puntos</a>
              <a class="ss-mini-btn ss-mini-btn--primary" href="{{ url_offers|e }}">Canjear ofertas</a>
            </div>
          </aside>
        </div>
      </header>

      <section class="ss-metrics" aria-label="M√©tricas" role="list">
        {% if orders > 0 %}
          <div class="ss-metric" role="listitem">
            <div class="ss-metric__k">Pedidos</div>
            <div class="ss-metric__v">{{ orders }}</div>
            <div class="ss-metric__d">Compras realizadas</div>
          </div>
        {% endif %}
        {% if favs > 0 %}
          <div class="ss-metric" role="listitem">
            <div class="ss-metric__k">Favoritos</div>
            <div class="ss-metric__v">{{ favs }}</div>
            <div class="ss-metric__d">Guardados</div>
          </div>
        {% endif %}
        {% if points > 0 %}
          <div class="ss-metric" role="listitem">
            <div class="ss-metric__k">Puntos</div>
            <div class="ss-metric__v">{{ points }}</div>
            <div class="ss-metric__d">Beneficios</div>
          </div>
        {% endif %}
        <div class="ss-metric" role="listitem">
          <div class="ss-metric__k">Nivel</div>
          <div class="ss-metric__v">Standard</div>
          <div class="ss-metric__d">Perks & accesos</div>
        </div>
      </section>

      <section class="ss-grid2" aria-label="Paneles de actividad">
        <section class="ss-card" aria-label="Acciones r√°pidas">
          <h2 class="ss-card__title">Acciones r√°pidas</h2>
          <p class="ss-card__subtitle">Atajos para moverte como en un marketplace grande</p>

          <div class="ss-list" role="list">
            <a class="ss-row" href="{{ url_shop|e }}" role="listitem" aria-label="Comprar ahora">
              <div>
                <div class="ss-row__title">Comprar ahora</div>
                <div class="ss-row__desc">Abrir cat√°logo completo</div>
              </div>
              <span class="ss-pill ss-pill--ok" aria-hidden="true">Ir</span>
            </a>

            <a class="ss-row" href="{{ url_offers|e }}" role="listitem" aria-label="Ver ofertas">
              <div>
                <div class="ss-row__title">Ofertas</div>
                <div class="ss-row__desc">Promos por tiempo limitado</div>
              </div>
              <span class="ss-pill ss-pill--wait" aria-hidden="true">Ver</span>
            </a>

            <a class="ss-row" href="{{ url_featured|e }}" role="listitem" aria-label="Abrir destacados">
              <div>
                <div class="ss-row__title">Destacados</div>
                <div class="ss-row__desc">Selecci√≥n premium</div>
              </div>
              <span class="ss-pill ss-pill--info" aria-hidden="true">Abrir</span>
            </a>

            <a class="ss-row" href="{{ url_new|e }}" role="listitem" aria-label="Abrir novedades">
              <div>
                <div class="ss-row__title">Novedades</div>
                <div class="ss-row__desc">Lo √∫ltimo agregado</div>
              </div>
              <span class="ss-pill ss-pill--info" aria-hidden="true">Nuevo</span>
            </a>
          </div>

          <div class="ss-notice" role="status" aria-live="polite">
            Tip: agreg√° productos a favoritos para verlos ac√° r√°pido.
          </div>
        </section>

        <section class="ss-card" aria-label="√öltimos pedidos">
          <h2 class="ss-card__title">√öltimos pedidos</h2>
          {% if orders > 0 %}
            <p class="ss-card__subtitle">Tus pedidos recientes</p>
          {% else %}
            <p class="ss-card__subtitle">Todav√≠a no hay pedidos. Cuando compres, aparecen ac√°.</p>
          {% endif %}

          <div class="ss-list" role="list">
            {% if orders > 0 %}
              <div class="ss-row ss-row--static" role="listitem" aria-label="Pedido reciente">
                <div>
                  <div class="ss-row__title">Pedidos</div>
                  <div class="ss-row__desc">Revis√° tu historial desde la tienda</div>
                </div>
                <span class="ss-pill ss-pill--info" aria-hidden="true">Ver</span>
              </div>
            {% else %}
              <div class="ss-row ss-row--static" role="listitem" aria-label="Sin pedidos">
                <div>
                  <div class="ss-row__title">Sin pedidos</div>
                  <div class="ss-row__desc">Explor√° productos y aprovech√° ofertas</div>
                </div>
                <span class="ss-pill ss-pill--ok" aria-hidden="true">Empezar</span>
              </div>
            {% endif %}
          </div>

          <div class="ss-notice" role="status" aria-live="polite">
            Todo se sincroniza autom√°ticamente cuando el backend de pedidos est√© activo.
          </div>
        </section>
      </section>

      <section class="ss-card ss-card--compact" aria-label="Ayuda y soporte">
        <h2 class="ss-card__title">¬øNecesit√°s ayuda?</h2>
        <p class="ss-card__subtitle">Soporte r√°pido y pol√≠ticas claras para comprar con confianza.</p>
        <div class="ss-btnrow" role="group" aria-label="Acciones de soporte">
          <a class="ss-btn ss-btn--soft" href="{{ url_shop|e }}">Centro de ayuda</a>
          <a class="ss-btn ss-btn--ghost" href="{{ url_offers|e }}">Ver promos</a>
        </div>
      </section>
    {% endif %}
  </section>
</main>
{% endblock %}
