{% extends "base.html" %}
{% block title %}Crear cuenta | Skyline Store{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/register.css') }}">
{% endblock %}

{% block content %}
{# ---------------------------------------------------------
   REGISTER ‚Äî Skyline Store (FINAL / NO BREAK)
   ‚úÖ Jinja v√°lido (sin try/except)
   ‚úÖ Flash class sanitizada
   ‚úÖ CSRF ultra-compat (csrf_token() / form.csrf_token / variable csrf_token)
   ‚úÖ Nonce opcional (no rompe si falta)
   ‚úÖ next preservado
   ‚úÖ Links Terms/Privacy seguros (solo si existen endpoints)
   ‚úÖ Accesible + autofill + UX pro
---------------------------------------------------------- #}

{% set nxt = next|default(request.args.get('next','')) %}
{% set post_name = (request.form.get('name','') if request.method=='POST' else '') %}
{% set post_email = (request.form.get('email','') if request.method=='POST' else '') %}
{% set want_aff = (request.form.get('want_affiliate') if request.method=='POST' else '') %}

<section class="ss-reg" aria-label="Crear cuenta">
  <div class="ss-reg__shell">

    <!-- LEFT -->
    <aside class="ss-reg__card ss-reg__left" aria-label="Beneficios">
      <div class="ss-reg__brand">
        <div class="ss-reg__logo" aria-hidden="true"></div>
        <div>
          <b>Skyline Store</b>
          <span>Marketplace profesional</span>
        </div>
      </div>

      <h1>Cre√° tu cuenta</h1>
      <p>
        Acced√© a una plataforma profesional para comprar, gestionar pedidos
        y participar de nuestro programa oficial de afiliados.
      </p>

      <div class="ss-reg__trust" aria-label="Seguridad">
        <span>‚úî Cuenta protegida</span>
        <span>‚úî Verificaci√≥n por email</span>
        <span>‚úî Datos cifrados</span>
        <span>‚úî Soporte real</span>
      </div>
    </aside>

    <!-- RIGHT -->
    <div class="ss-reg__card ss-reg__right" aria-label="Formulario de registro">
      <div class="ss-reg__steps" aria-label="Progreso">
        <div class="ss-reg__step is-active" aria-current="step">Cuenta</div>
        <div class="ss-reg__step">Verificaci√≥n</div>
        <div class="ss-reg__step">Listo</div>
      </div>

      {# FLASH MESSAGES (clase sanitizada) #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            {% set cat = (category|string|lower|trim) %}
            {% set cat = cat if cat in ['error','warning','success','info'] else 'info' %}
            <div class="ss-reg__flash {{ cat }}" role="alert" aria-live="polite" aria-atomic="true">
              {{ msg }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form method="post"
            action="{{ url_for('auth.register') }}"
            class="ss-reg__form"
            id="registerForm"
            novalidate>

        {# CSRF (prioridad: csrf_token() -> form.csrf_token -> variable csrf_token) #}
        {% if csrf_token is defined %}
          {% if csrf_token is callable %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% else %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          {% endif %}
        {% elif form is defined and form.csrf_token is defined %}
          {{ form.csrf_token }}
        {% endif %}

        {# NONCE opcional: si el backend lo exige, mandalo; si no existe no rompe #}
        {% if nonce is defined and nonce %}
          <input type="hidden" name="nonce" value="{{ nonce }}">
        {% endif %}

        {# next seguro #}
        {% if nxt %}
          <input type="hidden" name="next" value="{{ nxt|e }}">
        {% endif %}

        <div class="ss-reg__grid2">
          <div class="ss-reg__field">
            <label for="name">
              <span>Nombre</span>
              <span class="ss-reg__hint" id="nameHint">Opcional</span>
            </label>
            <input class="ss-reg__input"
                   id="name"
                   type="text"
                   name="name"
                   maxlength="120"
                   autocomplete="name"
                   aria-describedby="nameHint"
                   value="{{ post_name }}"
                   placeholder="Nombre (opcional)">
          </div>

          <div class="ss-reg__field">
            <label for="email">
              <span>Email</span>
              <span class="ss-reg__hint" id="emailHint">Requerido</span>
            </label>
            <input class="ss-reg__input"
                   id="email"
                   type="email"
                   name="email"
                   required
                   maxlength="254"
                   autocomplete="email"
                   inputmode="email"
                   autocapitalize="none"
                   spellcheck="false"
                   aria-describedby="emailHint"
                   value="{{ post_email }}"
                   placeholder="Correo electr√≥nico">
          </div>
        </div>

        <div class="ss-reg__grid2">
          <div class="ss-reg__field">
            <label for="password">
              <span>Contrase√±a</span>
              <span class="ss-reg__hint" id="passHint">8+ caracteres</span>
            </label>

            <div class="ss-reg__pass-wrap">
              <input class="ss-reg__input"
                     id="password"
                     type="password"
                     name="password"
                     required
                     minlength="8"
                     maxlength="128"
                     autocomplete="new-password"
                     aria-describedby="passHint"
                     placeholder="Contrase√±a">
              <button type="button"
                      class="ss-reg__pass-toggle"
                      id="togglePass"
                      aria-label="Mostrar contrase√±a"
                      aria-pressed="false">üëÅ</button>
            </div>

            <div class="ss-reg__meter" id="meterBox" aria-hidden="true"><span id="meter"></span></div>
            <div class="ss-reg__rules" id="passRules" aria-live="polite">
              <span id="rLen">‚Ä¢ 8+ caracteres</span>
              <span id="rMix">‚Ä¢ Letras y n√∫meros</span>
              <span id="rUp">‚Ä¢ May√∫scula recomendada</span>
              <span id="rSym">‚Ä¢ S√≠mbolo recomendado</span>
            </div>
          </div>

          <div class="ss-reg__field">
            <label for="password2">
              <span>Confirmar</span>
              <span class="ss-reg__hint" id="pass2Hint">Debe coincidir</span>
            </label>

            <div class="ss-reg__pass-wrap">
              <input class="ss-reg__input"
                     id="password2"
                     type="password"
                     name="password2"
                     required
                     minlength="8"
                     maxlength="128"
                     autocomplete="new-password"
                     aria-describedby="pass2Hint"
                     placeholder="Confirmar contrase√±a">
              <button type="button"
                      class="ss-reg__pass-toggle"
                      id="togglePass2"
                      aria-label="Mostrar confirmaci√≥n"
                      aria-pressed="false">üëÅ</button>
            </div>

            <div class="ss-reg__match" id="matchHint" aria-live="polite">‚Ä¢ Debe coincidir</div>
          </div>
        </div>

        <!-- Affiliate -->
        <div class="ss-reg__aff" aria-label="Programa de afiliados">
          <div class="ss-reg__aff-head">
            <b>Programa de Afiliados</b>

            <label class="ss-reg__switch" for="wantAffiliate">
              <span class="sr-only">Activar afiliados</span>
              <input type="checkbox"
                     name="want_affiliate"
                     id="wantAffiliate"
                     value="1"
                     {% if want_aff %}checked{% endif %}
                     aria-controls="affBody"
                     aria-expanded="{% if want_aff %}true{% else %}false{% endif %}">
              <span class="ss-reg__toggle" aria-hidden="true"></span>
            </label>
          </div>

          <div class="ss-reg__aff-body"
               id="affBody"
               {% if not want_aff %}hidden{% endif %}>
            <div class="ss-reg__grid2" style="padding:0; gap:12px;">
              <div class="ss-reg__field">
                <label for="affiliate_display_name">
                  <span>Nombre p√∫blico</span>
                  <span class="ss-reg__hint">Recomendado</span>
                </label>
                <input class="ss-reg__input"
                       id="affiliate_display_name"
                       type="text"
                       name="affiliate_display_name"
                       maxlength="120"
                       autocomplete="nickname"
                       value="{{ request.form.get('affiliate_display_name','') if request.method=='POST' else '' }}"
                       placeholder="Nombre p√∫blico">
              </div>

              <div class="ss-reg__field">
                <label for="affiliate_instagram">
                  <span>Red / Web</span>
                  <span class="ss-reg__hint">Opcional</span>
                </label>
                <input class="ss-reg__input"
                       id="affiliate_instagram"
                       type="text"
                       name="affiliate_instagram"
                       maxlength="120"
                       value="{{ request.form.get('affiliate_instagram','') if request.method=='POST' else '' }}"
                       placeholder="Instagram / TikTok / Web">
              </div>
            </div>
          </div>

          <noscript>
            <div class="ss-reg__hint" style="margin-top:10px;">
              Tip: para completar afiliados necesit√°s JavaScript activado.
            </div>
          </noscript>
        </div>

        <button class="ss-reg__submit" id="submitBtn" type="submit">
          Crear cuenta
        </button>

        {# Footer links seguros (solo si existen endpoints) #}
        {% set terms_url = None %}
        {% set privacy_url = None %}
        {% if view_functions is defined and ('main.about' in view_functions) %}
          {% set terms_url = url_for('main.about') %}
        {% endif %}
        {% if view_functions is defined and ('main.contact' in view_functions) %}
          {% set privacy_url = url_for('main.contact') %}
        {% endif %}

        <div class="ss-reg__footer">
          Al crear tu cuenta acept√°s
          {% if terms_url %}
            los <a href="{{ terms_url }}">T√©rminos</a>
          {% else %}
            los T√©rminos
          {% endif %}
          y la
          {% if privacy_url %}
            <a href="{{ privacy_url }}">Pol√≠tica de privacidad</a>
          {% else %}
            Pol√≠tica de privacidad
          {% endif %}.
          Nunca compartimos tus datos.
        </div>
      </form>
    </div>

  </div>
</section>

<script defer src="{{ url_for('static', filename='js/register.js') }}"></script>
{% endblock %}
