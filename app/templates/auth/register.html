{% extends "base.html" %}
{% block title %}Crear cuenta | Skyline Store{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/register.css') }}">

  {# +5 mejoras diseÃ±o (safe inline, no rompe CSS existente) #}
  <style>
    .ss-reg__head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px}
    .ss-reg__head h2{margin:0;font-size:1.35rem;letter-spacing:-.02em}
    .ss-reg__head small{display:block;opacity:.75;margin-top:2px}
    .ss-reg__secure{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.12);font-size:.9rem}
    .ss-reg__divider{display:flex;align-items:center;gap:12px;margin:16px 0;opacity:.85}
    .ss-reg__divider:before,.ss-reg__divider:after{content:"";flex:1;height:1px;background:rgba(0,0,0,.12)}
    .ss-reg__divider span{font-size:.85rem}
    .ss-reg__input:focus{outline:0;box-shadow:0 0 0 4px rgba(0,0,0,.08)}
    .ss-reg__flash{border-radius:14px;padding:10px 12px;border:1px solid rgba(0,0,0,.10)}
    .ss-reg__flash.error{border-color:rgba(220,38,38,.25)}
    .ss-reg__flash.success{border-color:rgba(34,197,94,.25)}
    .ss-reg__submit[aria-busy="true"]{opacity:.85;cursor:progress}
    .ss-reg__spinner{width:16px;height:16px;border:2px solid currentColor;border-right-color:transparent;border-radius:50%;display:inline-block;vertical-align:-3px;animation:sspin .9s linear infinite}
    @keyframes sspin{to{transform:rotate(360deg)}}
    @media (max-width:520px){
      .ss-reg__head h2{font-size:1.25rem}
      .ss-reg__divider{margin:12px 0}
    }
  </style>
{% endblock %}

{% block content %}
{# ---------------------------------------------------------
   REGISTER â€” Skyline Store (ULTRA PRO / NO BREAK Â· FINAL)
   âœ… CSRF Ãºnico y compatible
   âœ… next preservado
   âœ… Flash sanitizado
   âœ… UX premium alineado con login
---------------------------------------------------------- #}

{% set nxt = next|default(request.args.get('next','')) %}
{% set post_name = request.form.get('name','') %}
{% set post_email = request.form.get('email','') %}
{% set want_aff = request.form.get('want_affiliate','') %}

<section class="ss-reg" aria-label="Crear cuenta">
  <div class="ss-reg__shell">

    <!-- LEFT -->
    <aside class="ss-reg__card ss-reg__left" aria-label="Beneficios">
      <div class="ss-reg__brand">
        <div class="ss-reg__logo" aria-hidden="true"></div>
        <div>
          <b>Skyline Store</b>
          <span>Marketplace premium</span>
        </div>
      </div>

      <h1>CreÃ¡ tu cuenta</h1>
      <p>
        ComprÃ¡ mÃ¡s rÃ¡pido, gestionÃ¡ pedidos y accedÃ© a beneficios
        exclusivos y a nuestro programa de afiliados.
      </p>

      <div class="ss-reg__trust">
        <span>âœ” Cuenta protegida</span>
        <span>âœ” VerificaciÃ³n por email</span>
        <span>âœ” Datos cifrados</span>
        <span>âœ” Soporte real</span>
      </div>
    </aside>

    <!-- RIGHT -->
    <div class="ss-reg__card ss-reg__right" aria-label="Formulario de registro">

      <div class="ss-reg__head">
        <div>
          <h2>Crear cuenta</h2>
          <small>Solo toma unos segundos</small>
        </div>
        <span class="ss-reg__secure" aria-label="ConexiÃ³n segura">ðŸ”’ Seguro</span>
      </div>

      <div class="ss-reg__steps" aria-label="Progreso">
        <div class="ss-reg__step is-active" aria-current="step">Cuenta</div>
        <div class="ss-reg__step">VerificaciÃ³n</div>
        <div class="ss-reg__step">Listo</div>
      </div>

      {# FLASH #}
      {% for category, msg in get_flashed_messages(with_categories=true) %}
        {% set cat = category|string|lower %}
        {% set cat = cat if cat in ['error','warning','success','info'] else 'info' %}
        <div class="ss-reg__flash {{ cat }}" role="alert">{{ msg }}</div>
      {% endfor %}

      <form method="post"
            action="{{ url_for('auth.register') }}"
            class="ss-reg__form"
            id="registerForm"
            novalidate>

        {# CSRF Ãºnico #}
        {% if csrf_token is callable %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% elif csrf_token is defined %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {% elif form is defined and form.csrf_token is defined %}
          {{ form.csrf_token }}
        {% endif %}

        {% if nxt %}
          <input type="hidden" name="next" value="{{ nxt|e }}">
        {% endif %}

        <div class="ss-reg__grid2">
          <div class="ss-reg__field">
            <label for="name">Nombre <span class="ss-reg__hint">Opcional</span></label>
            <input class="ss-reg__input"
                   id="name"
                   type="text"
                   name="name"
                   maxlength="120"
                   autocomplete="name"
                   value="{{ post_name }}">
          </div>

          <div class="ss-reg__field">
            <label for="email">Email <span class="ss-reg__hint">Requerido</span></label>
            <input class="ss-reg__input"
                   id="email"
                   type="email"
                   name="email"
                   required
                   maxlength="254"
                   autocomplete="email"
                   value="{{ post_email }}">
          </div>
        </div>

        <div class="ss-reg__grid2">
          <div class="ss-reg__field">
            <label for="password">ContraseÃ±a <span class="ss-reg__hint">8+ caracteres</span></label>
            <input class="ss-reg__input"
                   id="password"
                   type="password"
                   name="password"
                   required
                   minlength="8"
                   autocomplete="new-password">
          </div>

          <div class="ss-reg__field">
            <label for="password2">Confirmar</label>
            <input class="ss-reg__input"
                   id="password2"
                   type="password"
                   name="password2"
                   required
                   minlength="8"
                   autocomplete="new-password">
          </div>
        </div>

        <div class="ss-reg__divider"><span>finalizar</span></div>

        <button class="ss-reg__submit" id="submitBtn" type="submit">
          Crear cuenta
        </button>

        <div class="ss-reg__footer">
          Â¿Ya tenÃ©s cuenta?
          <a href="{{ url_for('auth.login') }}">Ingresar</a>
        </div>
      </form>
    </div>

  </div>
</section>

<script defer src="{{ url_for('static', filename='js/register.js') }}"></script>

<script>
(() => {
  const f = document.getElementById("registerForm");
  const b = document.getElementById("submitBtn");
  if (!f || !b) return;
  if (f.dataset.bound) return;
  f.dataset.bound = "1";
  f.addEventListener("submit", () => {
    b.disabled = true;
    b.setAttribute("aria-busy","true");
    b.innerHTML = '<span class="ss-reg__spinner"></span> Creando cuenta...';
  }, { passive:true });
})();
</script>
{% endblock %}
