{% extends "base.html" %}
{% block title %}Crear cuenta | Skyline Store{% endblock %}

{% block extra_head %}
  <link rel="preload" as="style" href="{{ url_for('static', filename='css/register.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/register.css') }}">

  <meta name="robots" content="{{ 'index,follow' if (ENV|default('')|lower == 'production') else 'noindex,nofollow' }}">

  {# ‚úÖ CSRF meta estable (inject_globals -> csrf_token_value) #}
  <meta name="csrf-token" content="{{ csrf_token_value|default('') }}">

  <style>
    .ss-reg{position:relative}
    .ss-reg__shell{animation:popIn .45s ease both}
    @keyframes popIn{from{opacity:0;transform:translateY(12px) scale(.99)}to{opacity:1;transform:none}}

    .ss-reg__head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px}
    .ss-reg__head h2{margin:0;font-size:1.35rem;letter-spacing:-.02em}
    .ss-reg__head small{display:block;opacity:.75;margin-top:2px}

    .ss-reg__secure{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.12);font-size:.9rem;backdrop-filter:saturate(120%) blur(6px)}
    .ss-reg__secure .dot{width:8px;height:8px;border-radius:50%;background:currentColor;opacity:.65}

    .ss-reg__steps{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
    .ss-reg__step{padding:7px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.12);opacity:.8;font-size:.9rem}
    .ss-reg__step.is-active{opacity:1;transform:translateY(-1px);box-shadow:0 10px 24px -18px rgba(0,0,0,.35)}
    @media (prefers-reduced-motion: reduce){.ss-reg__shell{animation:none}.ss-reg__step.is-active{transform:none}}

    .ss-reg__divider{display:flex;align-items:center;gap:12px;margin:16px 0;opacity:.85}
    .ss-reg__divider:before,.ss-reg__divider:after{content:"";flex:1;height:1px;background:rgba(0,0,0,.12)}
    .ss-reg__divider span{font-size:.85rem}

    .ss-reg__flash{border-radius:14px;padding:10px 12px;border:1px solid rgba(0,0,0,.10);margin:10px 0;animation:fadeSlide .35s ease both}
    @keyframes fadeSlide{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}
    .ss-reg__flash.error{border-color:rgba(220,38,38,.25)}
    .ss-reg__flash.success{border-color:rgba(34,197,94,.25)}
    .ss-reg__flash.warning{border-color:rgba(245,158,11,.25)}
    .ss-reg__flash.info{border-color:rgba(59,130,246,.22)}

    .ss-reg__input{transition:box-shadow .2s ease,transform .2s ease,border-color .2s ease}
    .ss-reg__input:focus{outline:0;box-shadow:0 0 0 4px rgba(0,0,0,.08);transform:translateY(-1px)}
    .ss-reg__input[aria-invalid="true"]{border-color:rgba(220,38,38,.35)}

    .ss-reg__pwbar{height:8px;border-radius:999px;background:rgba(0,0,0,.08);overflow:hidden}
    .ss-reg__pwbar > i{display:block;height:100%;width:0%}
    .ss-reg__pwmsg{font-size:.88rem;opacity:.8;margin-top:6px}

    .ss-reg__submit{position:relative;overflow:hidden}
    .ss-reg__submit:after{content:"";position:absolute;inset:0;transform:translateX(-120%);background:linear-gradient(90deg,transparent,rgba(255,255,255,.22),transparent)}
    .ss-reg__submit:hover:after{animation:shine 1.1s ease}
    @keyframes shine{to{transform:translateX(120%)}}

    .ss-reg__submit[aria-busy="true"]{opacity:.88;cursor:progress}
    .ss-reg__spinner{width:16px;height:16px;border:2px solid currentColor;border-right-color:transparent;border-radius:50%;display:inline-block;vertical-align:-3px;animation:sspin .9s linear infinite}
    @keyframes sspin{to{transform:rotate(360deg)}}

    .ss-reg__pw-toggle{border-radius:10px;border:1px solid rgba(0,0,0,.12);padding:8px 10px;background:transparent;cursor:pointer;transition:transform .15s ease}
    .ss-reg__pw-toggle:active{transform:scale(.98)}
    .ss-reg__pw-wrap{display:flex;gap:8px;align-items:center}

    @media (max-width:520px){
      .ss-reg__head h2{font-size:1.25rem}
      .ss-reg__divider{margin:12px 0}
    }
    @media (prefers-reduced-motion: reduce){
      .ss-reg__flash{animation:none}
      .ss-reg__submit:hover:after{animation:none}
      .ss-reg__spinner{animation:none}
      .ss-reg__input:focus{transform:none}
    }
  </style>
{% endblock %}

{% block content %}
{# ---------- SAFE URL RESOLVER (NO-BREAK) ---------- #}
{% macro safe_url(endpoint, fallback='/', **kwargs) -%}
  {%- set vf = (view_functions if view_functions is defined and view_functions else {}) -%}
  {%- if endpoint and endpoint in vf -%}
    {{- url_for(endpoint, **kwargs) -}}
  {%- else -%}
    {{- fallback -}}
  {%- endif -%}
{%- endmacro %}

{# ---------- next safe ---------- #}
{% set _raw_next = (next|default(request.args.get('next',''), true)|string).strip() %}
{% set nxt = _raw_next %}
{% if (not nxt) or (not nxt.startswith('/')) or (nxt.startswith('//')) %}
  {% set nxt = '' %}
{% endif %}

{# ---------- form values ---------- #}
{% set post_name  = (request.form.get('name','') or '') %}
{% set post_email = (request.form.get('email','') or '') %}

{# ---------- endpoints ---------- #}
{% set register_action = safe_url('auth.register', '/auth/register') %}
{% set login_base      = safe_url('auth.login', '/auth/login') %}
{% set login_url       = login_base ~ (('?next=' ~ (nxt|urlencode)) if nxt else '') %}
{% set shop_url        = safe_url('shop.shop', '/shop') %}

<section class="ss-reg" aria-label="Crear cuenta">
  <div class="ss-reg__shell">

    <!-- LEFT -->
    <aside class="ss-reg__card ss-reg__left" aria-label="Beneficios">
      <div class="ss-reg__brand">
        <div class="ss-reg__logo" aria-hidden="true"></div>
        <div>
          <b>Skyline Store</b>
          <span>Marketplace premium</span>
        </div>
      </div>

      <h1>Cre√° tu cuenta</h1>
      <p>
        Compr√° m√°s r√°pido, gestion√° pedidos y acced√© a beneficios exclusivos.
        (Afiliados y recompensas se habilitan por etapas).
      </p>

      <div class="ss-reg__trust" aria-label="Confianza">
        <span>‚úî Cuenta protegida</span>
        <span>‚úî Verificaci√≥n por email</span>
        <span>‚úî Datos cifrados</span>
        <span>‚úî Soporte real</span>
      </div>
    </aside>

    <!-- RIGHT -->
    <div class="ss-reg__card ss-reg__right" aria-label="Formulario de registro">

      <div class="ss-reg__head">
        <div>
          <h2>Crear cuenta</h2>
          <small>Solo toma unos segundos</small>
        </div>
        <span class="ss-reg__secure" aria-label="Conexi√≥n segura">
          <span class="dot" aria-hidden="true"></span> Seguro
        </span>
      </div>

      <div class="ss-reg__steps" aria-label="Progreso">
        <div class="ss-reg__step is-active" aria-current="step">Cuenta</div>
        <div class="ss-reg__step">Verificaci√≥n</div>
        <div class="ss-reg__step">Listo</div>
      </div>

      {# FLASH #}
      {% set _msgs = get_flashed_messages(with_categories=true) %}
      {% if _msgs %}
        {% for category, msg in _msgs %}
          {% set cat = (category|string|lower|trim) %}
          {% set cat = cat if cat in ['error','warning','success','info'] else 'info' %}
          <div class="ss-reg__flash {{ cat }}" role="alert" aria-live="polite" aria-atomic="true">
            {{ msg }}
          </div>
        {% endfor %}
      {% endif %}

      <form method="post"
            action="{{ register_action }}"
            class="ss-reg__form"
            id="registerForm"
            novalidate
            autocomplete="on">

        {# ‚úÖ CSRF hidden definitivo (misma fuente que login) #}
        <input type="hidden" name="csrf_token" value="{{ csrf_token_value|default('') }}">

        {# ‚úÖ NONCE (FIX CR√çTICO): auth_routes.py exige _check_form_nonce("register") #}
        <input type="hidden" name="nonce" value="{{ nonce|default('')|e }}">

        {% if nxt %}
          <input type="hidden" name="next" value="{{ nxt|e }}">
        {% endif %}

        {# Honeypot anti-bot #}
        <div style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden" aria-hidden="true">
          <label>Website</label>
          <input type="text" name="website" tabindex="-1" autocomplete="off">
        </div>

        <div class="ss-reg__grid2">
          <div class="ss-reg__field">
            <label for="name">Nombre <span class="ss-reg__hint">Opcional</span></label>
            <input class="ss-reg__input"
                   id="name"
                   type="text"
                   name="name"
                   maxlength="120"
                   autocomplete="name"
                   value="{{ post_name|e }}">
          </div>

          <div class="ss-reg__field">
            <label for="email">Email <span class="ss-reg__hint">Requerido</span></label>
            <input class="ss-reg__input"
                   id="email"
                   type="email"
                   name="email"
                   required
                   maxlength="254"
                   autocomplete="email"
                   inputmode="email"
                   autocapitalize="none"
                   spellcheck="false"
                   value="{{ post_email|e }}"
                   placeholder="tu@email.com">
          </div>
        </div>

        <div class="ss-reg__grid2">
          <div class="ss-reg__field">
            <label for="password">Contrase√±a <span class="ss-reg__hint">8+ caracteres</span></label>

            <div class="ss-reg__pw-wrap">
              <input class="ss-reg__input"
                     id="password"
                     type="password"
                     name="password"
                     required
                     minlength="8"
                     autocomplete="new-password"
                     placeholder="M√≠nimo 8 caracteres">
              <button type="button"
                      class="ss-reg__pw-toggle"
                      id="togglePass"
                      aria-label="Mostrar contrase√±a"
                      aria-pressed="false">üëÅ</button>
            </div>

            <div class="ss-reg__pwbar" aria-hidden="true"><i id="pwBar"></i></div>
            <div class="ss-reg__pwmsg" id="pwMsg">Us√° 8+ caracteres, combin√° letras y n√∫meros.</div>
          </div>

          <div class="ss-reg__field">
            <label for="password2">Confirmar <span class="ss-reg__hint">Requerido</span></label>

            <div class="ss-reg__pw-wrap">
              <input class="ss-reg__input"
                     id="password2"
                     type="password"
                     name="password2"
                     required
                     minlength="8"
                     autocomplete="new-password"
                     placeholder="Repet√≠ la contrase√±a">
              <button type="button"
                      class="ss-reg__pw-toggle"
                      id="togglePass2"
                      aria-label="Mostrar confirmaci√≥n"
                      aria-pressed="false">üëÅ</button>
            </div>

            <div class="ss-reg__pwmsg" id="pw2Msg" aria-live="polite"></div>
          </div>
        </div>

        <div class="ss-reg__divider"><span>finalizar</span></div>

        <button class="ss-reg__submit" id="submitBtn" type="submit">
          Crear cuenta
        </button>

        <div class="ss-reg__footer">
          ¬øYa ten√©s cuenta?
          <a href="{{ login_url }}">Ingresar</a>
          ¬∑
          <a href="{{ shop_url }}">Seguir como invitado</a>
        </div>
      </form>
    </div>

  </div>
</section>

<script defer src="{{ url_for('static', filename='js/register.js') }}?v=2.1"></script>

<script>
(() => {
  const f = document.getElementById("registerForm");
  const b = document.getElementById("submitBtn");
  const email = document.getElementById("email");
  const p1 = document.getElementById("password");
  const p2 = document.getElementById("password2");
  const t1 = document.getElementById("togglePass");
  const t2 = document.getElementById("togglePass2");
  const bar = document.getElementById("pwBar");
  const msg = document.getElementById("pwMsg");
  const msg2 = document.getElementById("pw2Msg");

  if (!f || !b) return;
  if (f.dataset.bound === "1") return;
  f.dataset.bound = "1";

  const markInvalid = (el, bad) => {
    if (!el) return;
    el.setAttribute("aria-invalid", bad ? "true" : "false");
  };

  const scorePw = (s) => {
    if (!s) return 0;
    let sc = 0;
    if (s.length >= 8) sc++;
    if (s.length >= 12) sc++;
    if (/[A-Z]/.test(s)) sc++;
    if (/[0-9]/.test(s)) sc++;
    if (/[^A-Za-z0-9]/.test(s)) sc++;
    return Math.min(sc, 5);
  };

  const updatePwUI = () => {
    const s = p1 ? p1.value : "";
    const sc = scorePw(s); // 0..5
    if (bar) bar.style.width = (sc * 20) + "%";

    if (msg) {
      if (!s) msg.textContent = "Us√° 8+ caracteres, combin√° letras y n√∫meros.";
      else if (sc <= 1) msg.textContent = "D√©bil: agreg√° m√°s caracteres y n√∫meros.";
      else if (sc <= 3) msg.textContent = "Bien: mejor√° con may√∫sculas o s√≠mbolos.";
      else msg.textContent = "Fuerte: excelente contrase√±a.";
    }

    if (p2 && msg2) {
      if (!p2.value) msg2.textContent = "";
      else if (p2.value === s) msg2.textContent = "‚úÖ Coinciden";
      else msg2.textContent = "‚ö†Ô∏è No coinciden";
    }
  };

  const bindToggle = (btn, input, onLabel, offLabel) => {
    if (!btn || !input) return;
    btn.addEventListener("click", () => {
      const willShow = input.type === "password";
      input.type = willShow ? "text" : "password";
      btn.setAttribute("aria-pressed", String(willShow));
      btn.setAttribute("aria-label", willShow ? onLabel : offLabel);
    });
  };
  bindToggle(t1, p1, "Ocultar contrase√±a", "Mostrar contrase√±a");
  bindToggle(t2, p2, "Ocultar confirmaci√≥n", "Mostrar confirmaci√≥n");

  if (p1) p1.addEventListener("input", updatePwUI, { passive: true });
  if (p2) p2.addEventListener("input", updatePwUI, { passive: true });
  updatePwUI();

  f.addEventListener("submit", (ev) => {
    const em = email ? email.value.trim() : "";
    const pw1 = p1 ? p1.value : "";
    const pw2 = p2 ? p2.value : "";

    const eok = em.length >= 6 && em.includes("@");
    const pOk = pw1.length >= 8;
    const match = pw1 && pw1 === pw2;

    markInvalid(email, !eok);
    markInvalid(p1, !pOk);
    markInvalid(p2, !match);

    if (!eok || !pOk || !match) {
      ev.preventDefault();
      ev.stopPropagation();
      b.disabled = false;
      b.removeAttribute("aria-busy");
      b.textContent = "Crear cuenta";
      if (msg2 && pw2 && !match) msg2.textContent = "‚ö†Ô∏è Las contrase√±as no coinciden";
      return;
    }

    if (b.disabled) return;
    b.disabled = true;
    b.setAttribute("aria-busy","true");
    b.innerHTML = '<span class="ss-reg__spinner" aria-hidden="true"></span> Creando cuenta...';
  }, { passive:false });
})();
</script>
{% endblock %}
