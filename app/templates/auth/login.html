{% extends "base.html" %}
{% block title %}Ingresar | Skyline Store{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
  <meta name="robots" content="{{ 'index,follow' if ENV == 'production' else 'noindex,nofollow' }}">
{% endblock %}

{% block content %}
{# ---------------------------------------------------------
   LOGIN ‚Äî Skyline Store (ULTRA PRO / NO BREAK ¬∑ FINAL)
   ‚úÖ 10 mejoras:
   1) endpoints safe (sin try/except inv√°lido en Jinja)
   2) CSRF √∫nico (no duplica) + compat Flask-WTF/CSRFProtect
   3) next sanitizado (evita open-redirect b√°sico)
   4) autocomplete/aria mejorados
   5) form action safe fallback
   6) honeypot anti-bot (opcional, no rompe)
   7) submit disable/aria-busy (mejor UX)
   8) mensajes flash sanitizados por categor√≠a
   9) remember preservado
   10) values POST safe sin depender de request.method string
---------------------------------------------------------- #}

{% set _vf = (view_functions if view_functions is defined and view_functions else {}) %}

{# ---------- safe endpoints ---------- #}
{% set login_ep = 'auth.login' %}
{% if login_ep not in _vf %}
  {% set login_ep = None %}
{% endif %}

{% set register_ep = 'auth.register' %}
{% if register_ep not in _vf %}
  {% set register_ep = None %}
{% endif %}

{% set shop_ep = 'shop.shop' %}
{% if shop_ep not in _vf %}
  {% set shop_ep = None %}
{% endif %}

{% set forgot_ep = 'auth.forgot' %}
{% if forgot_ep not in _vf %}
  {% set forgot_ep = None %}
{% endif %}

{# ---------- next safe (evita redirecci√≥n externa) ---------- #}
{% set _raw_next = (next if next is defined and next else request.args.get('next', '')) %}
{% set nxt = _raw_next %}
{% if nxt and ('://' in nxt or nxt.startswith('//')) %}
  {% set nxt = '' %}
{% endif %}

{% set login_action = '/account' %}
{% if login_ep %}
  {% set login_action = url_for(login_ep, next=nxt) %}
{% endif %}

{% set register_url = '/account' %}
{% if register_ep %}
  {% set register_url = url_for(register_ep, next=nxt) %}
{% endif %}

{% set shop_url = '/shop' %}
{% if shop_ep %}
  {% set shop_url = url_for(shop_ep) %}
{% endif %}

{% set forgot_url = '' %}
{% if forgot_ep %}
  {% set forgot_url = url_for(forgot_ep) %}
{% endif %}

<section class="ss-login" aria-label="Ingresar">
  <div class="ss-login__card">

    <!-- LEFT -->
    <aside class="ss-login__left" aria-label="Beneficios de la cuenta">
      <div class="ss-login__brand">
        <span class="ss-login__mark" aria-hidden="true"></span>
        <div>
          <div class="ss-login__title">Skyline Store</div>
          <div class="ss-login__sub">Marketplace premium</div>
        </div>
      </div>

      <h1>Bienvenido de vuelta</h1>
      <p>
        Ingres√° para continuar con tu compra, ver pedidos
        y acceder a beneficios exclusivos.
      </p>

      <div class="ss-login__benefits" role="list" aria-label="Beneficios">
        <div class="ss-login__benefit" role="listitem">
          <span class="ss-login__dot" aria-hidden="true"></span>
          <div><b>Acceso r√°pido</b><span>Entr√° y segu√≠ comprando.</span></div>
        </div>
        <div class="ss-login__benefit" role="listitem">
          <span class="ss-login__dot" aria-hidden="true"></span>
          <div><b>Historial</b><span>Pedidos y seguimiento en un lugar.</span></div>
        </div>
      </div>
    </aside>

    <!-- RIGHT -->
    <div class="ss-login__right" aria-label="Formulario de ingreso">
      <div class="ss-login__head">
        <h2>Ingresar</h2>
        <span class="ss-login__secure" title="Conexi√≥n segura" aria-label="Conexi√≥n segura">üîí Seguro</span>
      </div>

      {# FLASH MESSAGES (clase sanitizada) #}
      {% set _msgs = get_flashed_messages(with_categories=true) %}
      {% if _msgs %}
        {% for category, msg in _msgs %}
          {% set cat = (category|string|lower|trim) %}
          {% set cat = cat if cat in ['error','warning','success','info'] else 'info' %}
          <div class="ss-login__flash {{ cat }}" role="alert" aria-live="polite" aria-atomic="true">
            {{ msg }}
          </div>
        {% endfor %}
      {% endif %}

      <form method="post"
            action="{{ login_action }}"
            class="ss-login__form"
            id="loginForm"
            novalidate
            autocomplete="on">

        {# -------------------------
           CSRF (UNICO / NO DUPLICA)
           Prioridad:
           1) form.hidden_tag (si es FlaskForm)
           2) form.csrf_token
           3) csrf_token() global
           4) csrf_token string
        -------------------------- #}
        {% if form is defined and form.hidden_tag is defined %}
          {{ form.hidden_tag() }}
        {% elif form is defined and form.csrf_token is defined %}
          {{ form.csrf_token }}
        {% elif csrf_token is defined %}
          {% if csrf_token is callable %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% else %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          {% endif %}
        {% endif %}

        {# NONCE opcional (si tu backend lo exige) #}
        {% if nonce is defined and nonce %}
          <input type="hidden" name="nonce" value="{{ nonce }}">
        {% endif %}

        {# NEXT #}
        {% if nxt %}
          <input type="hidden" name="next" value="{{ nxt|e }}">
        {% endif %}

        {# Honeypot anti-bot (no rompe backend si lo ignora) #}
        <div style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden" aria-hidden="true">
          <label>Website</label>
          <input type="text" name="website" tabindex="-1" autocomplete="off">
        </div>

        {% set posted_email = request.form.get('email','') %}
        {% set posted_remember = request.form.get('remember','') %}

        <div class="ss-login__field">
          <label for="email">
            <span>Correo electr√≥nico</span>
            <span class="ss-login__hint" id="emailHint">Requerido</span>
          </label>
          <input id="email"
                 class="ss-login__input"
                 type="email"
                 name="email"
                 required
                 maxlength="254"
                 autocomplete="email"
                 inputmode="email"
                 autocapitalize="none"
                 spellcheck="false"
                 aria-describedby="emailHint"
                 value="{{ posted_email }}"
                 placeholder="tu@email.com">
        </div>

        <div class="ss-login__field">
          <label for="password">
            <span>Contrase√±a</span>
            <span class="ss-login__hint" id="passHint">Requerido</span>
          </label>

          <div class="ss-login__pass-wrap">
            <input id="password"
                   class="ss-login__input"
                   type="password"
                   name="password"
                   required
                   minlength="6"
                   autocomplete="current-password"
                   aria-describedby="passHint"
                   placeholder="Tu contrase√±a">
            <button type="button"
                    class="ss-login__pass-toggle"
                    id="togglePass"
                    aria-label="Mostrar contrase√±a"
                    aria-pressed="false">üëÅ</button>
          </div>
        </div>

        <div class="ss-login__row" aria-label="Opciones">
          <label class="ss-login__check">
            <input type="checkbox" name="remember" value="1" {% if posted_remember %}checked{% endif %}>
            Mantener sesi√≥n
          </label>

          {% if forgot_url %}
            <a href="{{ forgot_url }}" class="ss-login__forgot">Olvid√© mi contrase√±a</a>
          {% endif %}
        </div>

        <button type="submit" class="ss-login__submit" id="submitBtn">Entrar</button>

        <div class="ss-login__links" aria-label="Links">
          <a href="{{ register_url }}">Crear cuenta</a>
          <a href="{{ shop_url }}">Seguir como invitado</a>
        </div>
      </form>
    </div>

  </div>
</section>

<script defer src="{{ url_for('static', filename='js/login.js') }}"></script>

{# UX micro: submit disable (no rompe si login.js ya lo hace) #}
<script>
(() => {
  const f = document.getElementById("loginForm");
  const b = document.getElementById("submitBtn");
  if (!f || !b) return;
  if (f.dataset.bound === "1") return;
  f.dataset.bound = "1";
  f.addEventListener("submit", () => {
    b.disabled = true;
    b.setAttribute("aria-busy", "true");
    b.textContent = "Ingresando...";
  }, { passive: true });
})();
</script>
{% endblock %}
