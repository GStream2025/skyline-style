{# app/templates/auth/login.html ‚Äî Skyline Store (ULTRA PRO / NO BREAK ¬∑ v45) #}
{% extends "base.html" %}
{% block title %}Ingresar | Skyline Store{% endblock %}

{% block extra_head %}
  <link rel="preload" as="style" href="{{ url_for('static', filename='css/login.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">

  <meta name="robots" content="{{ 'index,follow' if (ENV|default('')|lower == 'production') else 'noindex,nofollow' }}">

  {# ‚úÖ CSRF: una sola fuente estable (inject_globals -> csrf_token_value) #}
  <meta name="csrf-token" content="{{ csrf_token_value|default('') }}">

  {# ‚úÖ Micro mejoras UI safe (no rompen tu CSS externo) #}
  <style>
    .ss-login{position:relative}
    .ss-login__card{animation:popIn .42s ease both}
    @keyframes popIn{from{opacity:0;transform:translateY(10px) scale(.99)}to{opacity:1;transform:none}}

    .ss-login__head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .ss-login__head h2{margin:0;font-size:1.35rem;letter-spacing:-.02em}
    .ss-login__head small{display:block;opacity:.75;margin-top:2px}

    .ss-login__secure{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.12);font-size:.9rem;backdrop-filter:saturate(120%) blur(6px)}
    .ss-login__secure .dot{width:8px;height:8px;border-radius:50%;background:currentColor;opacity:.7}

    .ss-login__divider{display:flex;align-items:center;gap:12px;margin:14px 0;opacity:.85}
    .ss-login__divider:before,.ss-login__divider:after{content:"";flex:1;height:1px;background:rgba(0,0,0,.12)}
    .ss-login__divider span{font-size:.85rem}

    .ss-login__flash{border-radius:14px;padding:10px 12px;border:1px solid rgba(0,0,0,.10);animation:fadeSlide .35s ease both}
    @keyframes fadeSlide{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}
    .ss-login__flash.error{border-color:rgba(220,38,38,.25)}
    .ss-login__flash.success{border-color:rgba(34,197,94,.25)}
    .ss-login__flash.warning{border-color:rgba(245,158,11,.25)}
    .ss-login__flash.info{border-color:rgba(59,130,246,.25)}

    .ss-login__input{transition:box-shadow .2s ease,transform .2s ease,border-color .2s ease}
    .ss-login__input:focus{outline:0;box-shadow:0 0 0 4px rgba(0,0,0,.08);transform:translateY(-1px)}
    .ss-login__input[aria-invalid="true"]{border-color:rgba(220,38,38,.35)}

    .ss-login__submit{position:relative;overflow:hidden}
    .ss-login__submit:after{content:"";position:absolute;inset:0;transform:translateX(-120%);background:linear-gradient(90deg,transparent,rgba(255,255,255,.22),transparent)}
    .ss-login__submit:hover:after{animation:shine 1.1s ease}
    @keyframes shine{to{transform:translateX(120%)}}
    .ss-login__submit[aria-busy="true"]{opacity:.88;cursor:progress}
    .ss-login__spinner{width:16px;height:16px;border:2px solid currentColor;border-right-color:transparent;border-radius:50%;display:inline-block;vertical-align:-3px;animation:sspin .9s linear infinite}
    @keyframes sspin{to{transform:rotate(360deg)}}

    .ss-login__pass-wrap{display:flex;gap:8px;align-items:center}
    .ss-login__pass-toggle{border-radius:10px;border:1px solid rgba(0,0,0,.12);padding:8px 10px;background:transparent;cursor:pointer;transition:transform .15s ease}
    .ss-login__pass-toggle:active{transform:scale(.98)}

    .ss-login__hint{opacity:.75}
    .ss-login__hint.bad{color:rgba(220,38,38,.92);opacity:1}
    .ss-login__hint.ok{color:rgba(34,197,94,.92);opacity:1}

    @media (prefers-reduced-motion: reduce){
      .ss-login__card,.ss-login__flash{animation:none}
      .ss-login__submit:hover:after{animation:none}
      .ss-login__spinner{animation:none}
      .ss-login__input:focus{transform:none}
    }
    @media (max-width: 520px){
      .ss-login__head h2{font-size:1.25rem}
      .ss-login__divider{margin:12px 0}
    }
  </style>
{% endblock %}

{% block content %}
{# ---------------------------------------------------------
   LOGIN ‚Äî Skyline Store (ULTRA PRO / NO BREAK ¬∑ v45)
   ‚úÖ CSRF √∫nico y estable (csrf_token_value)
   ‚úÖ next hardening (solo paths internos)
   ‚úÖ safe_url (no BuildError)
   ‚úÖ a11y, UX, anti-doble submit, toggle pass
---------------------------------------------------------- #}

{% macro safe_url(endpoint, fallback='/', **kwargs) -%}
  {%- set vf = (view_functions if view_functions is defined and view_functions else {}) -%}
  {%- if endpoint and endpoint in vf -%}
    {{- url_for(endpoint, **kwargs) -}}
  {%- else -%}
    {{- fallback -}}
  {%- endif -%}
{%- endmacro %}

{# next safe #}
{% set _raw_next = (next|default(request.args.get('next',''), true)|string).strip() %}
{% set nxt = _raw_next %}
{% if (not nxt) or (not nxt.startswith('/')) or (nxt.startswith('//')) %}
  {% set nxt = '' %}
{% endif %}

{# urls #}
{% set login_action = safe_url('auth.login', '/auth/login') %}
{% set register_base = safe_url('auth.register', '/auth/register') %}
{% set shop_url = safe_url('shop.shop', '/shop') %}
{% set forgot_url = safe_url('auth.forgot', '') %}

{% if nxt %}
  {% set register_url = register_base ~ '?next=' ~ (nxt|urlencode) %}
{% else %}
  {% set register_url = register_base %}
{% endif %}

<section class="ss-login" aria-label="Ingresar">
  <div class="ss-login__card">

    <aside class="ss-login__left" aria-label="Beneficios de la cuenta">
      <div class="ss-login__brand">
        <span class="ss-login__mark" aria-hidden="true"></span>
        <div>
          <div class="ss-login__title">Skyline Store</div>
          <div class="ss-login__sub">Marketplace premium</div>
        </div>
      </div>

      <h1>Bienvenido de vuelta</h1>
      <p>Ingres√° para continuar con tu compra, ver pedidos y acceder a beneficios exclusivos.</p>

      <div class="ss-login__benefits" role="list" aria-label="Beneficios">
        <div class="ss-login__benefit" role="listitem">
          <span class="ss-login__dot" aria-hidden="true"></span>
          <div><b>Acceso r√°pido</b><span>Entr√° y segu√≠ comprando.</span></div>
        </div>
        <div class="ss-login__benefit" role="listitem">
          <span class="ss-login__dot" aria-hidden="true"></span>
          <div><b>Historial</b><span>Pedidos y seguimiento en un lugar.</span></div>
        </div>
      </div>
    </aside>

    <div class="ss-login__right" aria-label="Formulario de ingreso">
      <div class="ss-login__head">
        <div>
          <h2>Ingresar</h2>
          <small>Acced√© a tu cuenta para comprar m√°s r√°pido.</small>
        </div>
        <span class="ss-login__secure" title="Conexi√≥n segura" aria-label="Conexi√≥n segura">
          <span class="dot" aria-hidden="true"></span> Seguro
        </span>
      </div>

      {% set _msgs = get_flashed_messages(with_categories=true) %}
      {% if _msgs %}
        {% for category, msg in _msgs %}
          {% set cat = (category|string|lower|trim) %}
          {% set cat = cat if cat in ['error','warning','success','info'] else 'info' %}
          <div class="ss-login__flash {{ cat }}" role="alert" aria-live="polite" aria-atomic="true">
            {{ msg }}
          </div>
        {% endfor %}
      {% endif %}

      <form method="post"
            action="{{ login_action }}"
            class="ss-login__form"
            id="loginForm"
            novalidate
            autocomplete="on">

        {# ‚úÖ CSRF hidden definitivo (no dependemos de form.hidden_tag) #}
        <input type="hidden" name="csrf_token" value="{{ csrf_token_value|default('') }}">

        {% if nxt %}
          <input type="hidden" name="next" value="{{ nxt|e }}">
        {% endif %}

        <div style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden" aria-hidden="true">
          <label>Website</label>
          <input type="text" name="website" tabindex="-1" autocomplete="off">
        </div>

        {% set posted_email = (request.form.get('email','') or '') %}
        {% set posted_remember = (request.form.get('remember','') or '') %}

        <div class="ss-login__field">
          <label for="email">
            <span>Correo electr√≥nico</span>
            <span class="ss-login__hint" id="emailHint">Requerido</span>
          </label>
          <input id="email"
                 class="ss-login__input"
                 type="email"
                 name="email"
                 required
                 maxlength="254"
                 autocomplete="email"
                 inputmode="email"
                 autocapitalize="none"
                 spellcheck="false"
                 aria-describedby="emailHint"
                 value="{{ posted_email|e }}"
                 placeholder="tu@email.com">
        </div>

        <div class="ss-login__field">
          <label for="password">
            <span>Contrase√±a</span>
            <span class="ss-login__hint" id="passHint">Requerido</span>
          </label>

          <div class="ss-login__pass-wrap">
            <input id="password"
                   class="ss-login__input"
                   type="password"
                   name="password"
                   required
                   minlength="8"
                   autocomplete="current-password"
                   aria-describedby="passHint"
                   placeholder="Tu contrase√±a">
            <button type="button"
                    class="ss-login__pass-toggle"
                    id="togglePass"
                    aria-label="Mostrar contrase√±a"
                    aria-pressed="false">üëÅ</button>
          </div>
        </div>

        <div class="ss-login__row" aria-label="Opciones">
          <label class="ss-login__check">
            <input type="checkbox" name="remember" value="1" {% if posted_remember %}checked{% endif %}>
            Mantener sesi√≥n
          </label>

          {% if forgot_url %}
            <a href="{{ forgot_url }}" class="ss-login__forgot">Olvid√© mi contrase√±a</a>
          {% endif %}
        </div>

        <button type="submit" class="ss-login__submit" id="submitBtn">
          Entrar
        </button>

        <div class="ss-login__divider" aria-hidden="true"><span>o</span></div>

        <div class="ss-login__links" aria-label="Links">
          <a href="{{ register_url }}">Crear cuenta</a>
          <a href="{{ shop_url }}">Seguir como invitado</a>
        </div>
      </form>
    </div>

  </div>
</section>

{# JS externo PRO #}
<script defer src="{{ url_for('static', filename='js/login.js') }}?v=45"></script>
{% endblock %}
