<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="robots" content="noindex,nofollow">
  <meta name="theme-color" content="#0b1220">
  <title>{{ (APP_NAME or "Skyline Store")|e }} · Iniciar sesión</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="{{ (url_for('static', filename='css/auth-login.css') if url_for is defined else '/static/css/auth-login.css') }}">
</head>

<body class="auth-page">
  <main class="auth-wrap" role="main">
    <section class="auth-card" aria-label="Iniciar sesión">
      <header class="auth-head">
        <div class="auth-brand">
          <div class="auth-logo" aria-hidden="true">S</div>
          <div>
            <h1 class="auth-title">Acceso</h1>
            <p class="auth-subtitle">Ingresá con tu email y contraseña para continuar.</p>
          </div>
        </div>
      </header>

      <div class="auth-body">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="auth-form" role="status" aria-live="polite">
              {% for cat, msg in messages %}
                {% set c = (cat or '')|lower %}
                {% set tone = 'good' if 'success' in c else ('bad' if 'danger' in c or 'error' in c else ('warn' if 'warn' in c else 'info')) %}
                <div class="auth-alert" data-tone="{{ tone }}">
                  <div style="min-width:0">
                    <p class="auth-alert-title">
                      {{ 'Listo' if tone=='good' else ('Atención' if tone=='warn' else ('Error' if tone=='bad' else 'Aviso')) }}
                    </p>
                    <p class="auth-alert-text">{{ msg }}</p>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <form class="auth-form"
              id="loginForm"
              method="post"
              action="{{ (url_for('auth.login_post') if url_for is defined else '/auth/login') }}"
              autocomplete="on"
              novalidate>

          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="next" value="{{ next|default('')|e }}">
          <input type="text" name="website" value="" tabindex="-1" autocomplete="off" aria-hidden="true" style="position:absolute;left:-9999px;opacity:0">

          <div class="auth-row">
            <div class="auth-label">
              <label for="email">Email</label>
              <a href="{{ (url_for('auth.register_get', next=next) if url_for is defined else '/auth/register') }}">Crear cuenta</a>
            </div>
            <div class="auth-field">
              <input class="auth-input"
                     id="email"
                     name="email"
                     type="email"
                     inputmode="email"
                     autocomplete="email"
                     required
                     minlength="5"
                     maxlength="254"
                     placeholder="tu@email.com"
                     value="{{ prefill_email|default('')|e }}">
            </div>
          </div>

          <div class="auth-row">
            <div class="auth-label">
              <label for="password">Contraseña</label>
              <a href="{{ (url_for('auth.forgot_password_get', next=next) if url_for is defined else '/auth/forgot-password') }}">Olvidé mi contraseña</a>
            </div>
            <div class="auth-field">
              <input class="auth-input"
                     id="password"
                     name="password"
                     type="password"
                     autocomplete="current-password"
                     required
                     minlength="8"
                     maxlength="256"
                     placeholder="••••••••">
              <button class="auth-icon-btn" type="button" id="togglePw" aria-label="Mostrar u ocultar contraseña">
                <svg id="eyeOn" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z" stroke="currentColor" stroke-width="1.8"/>
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="1.8"/>
                </svg>
                <svg id="eyeOff" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="display:none">
                  <path d="M3 5l18 14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  <path d="M2 12s3.5-7 10-7c2.1 0 3.9.7 5.4 1.6M22 12s-3.5 7-10 7c-2.2 0-4.1-.7-5.7-1.7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  <path d="M10 10a3 3 0 0 0 4.2 4.2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="auth-inline">
            <label class="auth-check" title="Mantener sesión en este dispositivo">
              <input type="checkbox" id="remember" name="remember" value="1">
              <span>Recordarme</span>
            </label>
            <span class="auth-kbd">/auth/login</span>
          </div>

          <div class="auth-actions">
            <button class="auth-btn primary" id="submitBtn" type="submit">Iniciar sesión</button>
            <a class="auth-btn secondary" href="{{ (url_for('shop.shop') if url_for is defined else '/shop') }}">Seguir comprando</a>
          </div>

          <div class="auth-divider">o</div>

          <div class="auth-meta">
            <a href="{{ (url_for('auth.register_get', next=next) if url_for is defined else '/auth/register') }}">Crear una cuenta</a>
            <a href="{{ (url_for('main.index', _external=False) if url_for is defined else '/') }}">Ir al inicio</a>
          </div>
        </form>
      </div>

      <footer class="auth-foot">
        <span>¿Necesitás ayuda? <a href="{{ (url_for('main.contact', _external=False) if url_for is defined else '/about') }}">Soporte</a></span>
      </footer>
    </section>
  </main>

  <script src="{{ (url_for('static', filename='js/login.js') if url_for is defined else '/static/js/login.js') }}" defer></script>
  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      const form = $("loginForm");
      const email = $("email");
      const pw = $("password");
      const submitBtn = $("submitBtn");
      const togglePw = $("togglePw");
      const eyeOn = $("eyeOn");
      const eyeOff = $("eyeOff");

      const normalizeEmail = (v)=>String(v||"").trim().toLowerCase().slice(0,254);
      const validEmail = (v)=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(normalizeEmail(v));

      const setBusy = (busy)=>{
        if (!submitBtn) return;
        submitBtn.disabled = !!busy;
        if (busy){
          submitBtn.dataset._txt = submitBtn.textContent || "Iniciar sesión";
          submitBtn.textContent = "Ingresando…";
        } else {
          submitBtn.textContent = (submitBtn.dataset._txt || "Iniciar sesión").trim();
        }
      };

      togglePw?.addEventListener("click", ()=>{
        const isPw = pw.type === "password";
        pw.type = isPw ? "text" : "password";
        if (eyeOn) eyeOn.style.display = isPw ? "none" : "";
        if (eyeOff) eyeOff.style.display = isPw ? "" : "none";
        pw.focus({preventScroll:true});
      });

      form?.addEventListener("submit", (ev)=>{
        const e = normalizeEmail(email?.value);
        if (email) email.value = e;
        if (!validEmail(e)){
          ev.preventDefault();
          email?.focus();
          return;
        }
        if (!pw?.value || String(pw.value).length < 8){
          ev.preventDefault();
          pw?.focus();
          return;
        }
        setBusy(true);
        window.setTimeout(()=>setBusy(false), 9000);
      });

      try{
        if (email && !email.value){
          const last = localStorage.getItem("last_email") || "";
          if (last && validEmail(last)) email.value = last;
        }
        email?.addEventListener("input", ()=>{
          const v = normalizeEmail(email.value);
          if (validEmail(v)) localStorage.setItem("last_email", v);
        });
      }catch(e){}

      window.addEventListener("pageshow", ()=>setBusy(false));
    })();
  </script>
</body>
</html>
