{% extends "base.html" %}
{% block title %}Ingresar | Skyline Store{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
{% endblock %}

{% block content %}
{# ---------------------------------------------------------
   LOGIN ‚Äî Skyline Store (ULTRA PRO / NO BREAK)
   - No rompe si falta nonce / forgot route / csrf variants
   - Preserva next seguro
   - Conecta con login.js (loginForm, email, password, togglePass, submitBtn)
---------------------------------------------------------- #}

{% set nxt = next|default(request.args.get('next', '')) %}
<section class="ss-login" aria-label="Ingresar">
  <div class="ss-login__card">

    <!-- LEFT -->
    <aside class="ss-login__left" aria-label="Beneficios de la cuenta">
      <div class="ss-login__brand">
        <span class="ss-login__mark" aria-hidden="true"></span>
        <div>
          <div class="ss-login__title">Skyline Store</div>
          <div class="ss-login__sub">Marketplace premium</div>
        </div>
      </div>

      <h1>Bienvenido de vuelta</h1>
      <p>
        Ingres√° para continuar con tu compra, ver pedidos
        y acceder a beneficios exclusivos.
      </p>

      <div class="ss-login__benefits" role="list" aria-label="Beneficios">
        <div class="ss-login__benefit" role="listitem">
          <span class="ss-login__dot" aria-hidden="true"></span>
          <div><b>Acceso r√°pido</b><span>Entr√° y segu√≠ comprando.</span></div>
        </div>
        <div class="ss-login__benefit" role="listitem">
          <span class="ss-login__dot" aria-hidden="true"></span>
          <div><b>Historial</b><span>Pedidos y seguimiento en un lugar.</span></div>
        </div>
      </div>
    </aside>

    <!-- RIGHT -->
    <div class="ss-login__right" aria-label="Formulario de ingreso">
      <div class="ss-login__head">
        <h2>Ingresar</h2>
        <span class="ss-login__secure" title="Conexi√≥n segura">üîí Seguro</span>
      </div>

      {# FLASH MESSAGES (clase sanitizada) #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            {% set cat = (category|string|lower|trim) %}
            {% set cat = cat if cat in ['error','warning','success','info'] else 'info' %}
            <div class="ss-login__flash {{ cat }}" role="alert" aria-live="polite" aria-atomic="true">
              {{ msg }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form method="post"
            action="{{ url_for('auth.login', next=nxt) }}"
            class="ss-login__form"
            id="loginForm"
            novalidate>

        {# -------------------------
           CSRF (ULTRA COMPAT)
           - Flask-WTF: csrf_token() / form.csrf_token
           - variable csrf_token
        -------------------------- #}
        {% if csrf_token is defined %}
          {% if csrf_token is callable %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% else %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          {% endif %}
        {% elif form is defined and form.csrf_token is defined %}
          {{ form.csrf_token }}
        {% endif %}

        {# -------------------------
           NONCE (si tu backend lo exige)
           - No rompe si no existe
        -------------------------- #}
        {% if nonce is defined and nonce %}
          <input type="hidden" name="nonce" value="{{ nonce }}">
        {% endif %}

        {# NEXT (solo si existe) #}
        {% if nxt %}
          <input type="hidden" name="next" value="{{ nxt|e }}">
        {% endif %}

        <div class="ss-login__field">
          <label for="email">
            <span>Correo electr√≥nico</span>
            <span class="ss-login__hint" id="emailHint">Requerido</span>
          </label>
          <input id="email"
                 class="ss-login__input"
                 type="email"
                 name="email"
                 required
                 maxlength="254"
                 autocomplete="email"
                 inputmode="email"
                 autocapitalize="none"
                 spellcheck="false"
                 aria-describedby="emailHint"
                 value="{{ (request.form.get('email','') if request.method=='POST' else '') }}"
                 placeholder="tu@email.com">
        </div>

        <div class="ss-login__field">
          <label for="password">
            <span>Contrase√±a</span>
            <span class="ss-login__hint" id="passHint">Requerido</span>
          </label>

          <div class="ss-login__pass-wrap">
            <input id="password"
                   class="ss-login__input"
                   type="password"
                   name="password"
                   required
                   autocomplete="current-password"
                   aria-describedby="passHint"
                   placeholder="Tu contrase√±a">
            <button type="button"
                    class="ss-login__pass-toggle"
                    id="togglePass"
                    aria-label="Mostrar contrase√±a"
                    aria-pressed="false">üëÅ</button>
          </div>
        </div>

        <div class="ss-login__row" aria-label="Opciones">
          <label class="ss-login__check">
            <input type="checkbox" name="remember" value="1">
            Mantener sesi√≥n
          </label>

          {# Forgot link: ultra safe (no rompe si no existe la ruta) #}
          {% set forgot_url = None %}
          {% try %}
            {% set forgot_url = url_for('auth.forgot') %}
          {% except %}
            {% set forgot_url = None %}
          {% endtry %}
          {% if forgot_url %}
            <a href="{{ forgot_url }}" class="ss-login__forgot">Olvid√© mi contrase√±a</a>
          {% endif %}
        </div>

        <button type="submit" class="ss-login__submit" id="submitBtn">Entrar</button>

        <div class="ss-login__links" aria-label="Links">
          <a href="{{ url_for('auth.register', next=nxt) }}">Crear cuenta</a>
          <a href="{{ url_for('shop.shop') }}">Seguir como invitado</a>
        </div>
      </form>
    </div>

  </div>
</section>

<script defer src="{{ url_for('static', filename='js/login.js') }}"></script>
{% endblock %}
