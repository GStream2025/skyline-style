{% extends "base.html" %}
{% block title %}Ingresar | Skyline Store{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
{% endblock %}

{% block content %}
<section class="ss-login" aria-label="Ingresar">
  <div class="ss-login__card">

    <!-- LEFT -->
    <aside class="ss-login__left" aria-label="Beneficios de la cuenta">
      <div class="ss-login__brand">
        <span class="ss-login__mark" aria-hidden="true"></span>
        <div>
          <div class="ss-login__title">Skyline Store</div>
          <div class="ss-login__sub">Marketplace premium</div>
        </div>
      </div>

      <h1>Bienvenido de vuelta</h1>
      <p>
        Ingres√° para continuar con tu compra, ver pedidos
        y acceder a beneficios exclusivos.
      </p>

      <div class="ss-login__benefits">
        <div class="ss-login__benefit">
          <span class="ss-login__dot" aria-hidden="true"></span>
          <div><b>Acceso r√°pido</b><span>Entr√° y segu√≠ comprando.</span></div>
        </div>
        <div class="ss-login__benefit">
          <span class="ss-login__dot" aria-hidden="true"></span>
          <div><b>Historial</b><span>Pedidos y seguimiento en un lugar.</span></div>
        </div>
      </div>
    </aside>

    <!-- RIGHT -->
    <div class="ss-login__right" aria-label="Formulario de ingreso">
      <div class="ss-login__head">
        <h2>Ingresar</h2>
        <span class="ss-login__secure" title="Conexi√≥n segura">üîí Seguro</span>
      </div>

      {# FLASH MESSAGES #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="ss-login__flash {{ category|e }}" role="alert" aria-live="polite" aria-atomic="true">
              {{ msg }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form method="post"
            action="{{ url_for('auth.login') }}"
            class="ss-login__form"
            id="loginForm"
            novalidate>

        {# CSRF compatible: csrf_token() (Flask-WTF) o csrf_token variable #}
        {% if csrf_token is defined %}
          {% if csrf_token is callable %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% else %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          {% endif %}
        {% endif %}

        {# ‚úÖ NONCE obligatorio (tu backend lo exige) #}
        <input type="hidden" name="nonce" value="{{ nonce|default('') }}">

        {# NEXT: backend lo sanea con _is_safe_next #}
        {% set nxt = next|default(request.args.get('next','')) %}
        {% if nxt %}
          <input type="hidden" name="next" value="{{ nxt|e }}">
        {% endif %}

        <div class="ss-login__field">
          <label for="email">
            <span>Correo electr√≥nico</span>
            <span class="ss-login__hint" id="emailHint">Requerido</span>
          </label>
          <input id="email"
                 class="ss-login__input"
                 type="email"
                 name="email"
                 required
                 maxlength="254"
                 autocomplete="email"
                 inputmode="email"
                 autocapitalize="none"
                 spellcheck="false"
                 aria-describedby="emailHint"
                 value="{{ request.form.get('email','') if request.method=='POST' else '' }}"
                 placeholder="tu@email.com">
        </div>

        <div class="ss-login__field">
          <label for="password">
            <span>Contrase√±a</span>
            <span class="ss-login__hint" id="passHint">Requerido</span>
          </label>

          <div class="ss-login__pass-wrap">
            <input id="password"
                   class="ss-login__input"
                   type="password"
                   name="password"
                   required
                   autocomplete="current-password"
                   aria-describedby="passHint"
                   placeholder="Tu contrase√±a">
            <button type="button"
                    class="ss-login__pass-toggle"
                    id="togglePass"
                    aria-label="Mostrar contrase√±a"
                    aria-pressed="false">üëÅ</button>
          </div>
        </div>

        <div class="ss-login__row" aria-label="Opciones">
          <label class="ss-login__check">
            <input type="checkbox" name="remember" value="1">
            Mantener sesi√≥n
          </label>

          {% if 'auth.forgot' in current_app.view_functions %}
            <a href="{{ url_for('auth.forgot') }}" class="ss-login__forgot">Olvid√© mi contrase√±a</a>
          {% endif %}
        </div>

        <button type="submit" class="ss-login__submit" id="submitBtn">Entrar</button>

        <div class="ss-login__links" aria-label="Links">
          <a href="{{ url_for('auth.register', next=nxt) }}">Crear cuenta</a>
          <a href="{{ url_for('shop.shop') }}">Seguir como invitado</a>
        </div>
      </form>
    </div>

  </div>
</section>

<script defer src="{{ url_for('static', filename='js/login.js') }}"></script>
{% endblock %}
