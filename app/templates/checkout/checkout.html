{# app/templates/checkout/checkout.html — SKYLINE CHECKOUT ULTRA PRO v3 (LOCKED) #}
{% extends "base.html" %}
{% block title %}Finalizar compra · Skyline Store{% endblock %}

{% block extra_head %}
<meta name="checkout-version" content="skyline-ultra-pro-v3">
<style>
/* =========================================================
 SKYLINE CHECKOUT — ULTRA PRO v3 (LOCKED)
 - Production ready
 - No external deps
 - A11y compliant
 - Backend-safe
========================================================= */

:root{
  --ck-radius:22px;
  --ck-border:rgba(148,163,184,.18);
  --ck-accent:#38bdf8;
  --ck-warn:#f59e0b;
  --ck-err:#ef4444;
}

.ck-wrap{max-width:1180px;margin:auto;padding:20px 16px 80px}
.ck-head{display:flex;justify-content:space-between;gap:14px;flex-wrap:wrap;margin:18px 0}
.ck-title{margin:0;font-weight:1000;font-size:clamp(1.9rem,3vw,2.5rem)}
.ck-sub{margin:.4rem 0 0;opacity:.78;max-width:70ch}

.ck-grid{display:grid;gap:18px}
@media(min-width:980px){.ck-grid{grid-template-columns:1.6fr 1fr}}

.ck-card{
  border-radius:var(--ck-radius);
  border:1px solid var(--ck-border);
  background:rgba(255,255,255,.82);
  box-shadow:0 18px 48px rgba(15,23,42,.14);
}
@media(prefers-color-scheme:dark){
  .ck-card{background:rgba(255,255,255,.06)}
}

.ck-head-card{
  padding:16px 18px;
  border-bottom:1px solid var(--ck-border);
  background:linear-gradient(180deg,rgba(56,189,248,.14),transparent);
}

.ck-body{padding:18px}

.ck-h2{margin:0;font-weight:1000}
.ck-help{font-size:.82rem;opacity:.75}

.ck-error{
  display:none;
  margin-bottom:14px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(239,68,68,.35);
  background:rgba(239,68,68,.1);
  font-weight:900;
}
.ck-error.on{display:block}

.ck-form{display:grid;gap:14px}
.ck-row{display:grid;gap:12px}
@media(min-width:720px){.ck-row.cols2{grid-template-columns:1fr 1fr}}
@media(min-width:980px){.ck-row.cols3{grid-template-columns:1fr 1fr 1fr}}

.ck-label{font-size:.78rem;font-weight:900;margin-bottom:4px}
.ck-input,.ck-textarea{
  width:100%;padding:12px 12px;border-radius:14px;
  border:1px solid rgba(148,163,184,.3);
  background:rgba(255,255,255,.85)
}
@media(prefers-color-scheme:dark){
  .ck-input,.ck-textarea{background:rgba(255,255,255,.06)}
}
.ck-input:focus,.ck-textarea:focus{
  border-color:var(--ck-warn);
  box-shadow:0 0 0 4px rgba(245,158,11,.2)
}
.is-invalid{border-color:var(--ck-err)!important}

.pay-item{
  display:flex;gap:12px;padding:14px;
  border-radius:18px;border:1px solid var(--ck-border);
  cursor:pointer;transition:.15s;
}
.pay-item:hover{transform:translateY(-1px)}
.pay-item:has(input:checked){
  border-color:var(--ck-accent);
  box-shadow:0 0 0 4px rgba(56,189,248,.18)
}

.sum{
  position:sticky;top:18px;
  border-radius:26px;
  background:#0b1120;color:#e5e7eb;
  box-shadow:0 18px 48px rgba(0,0,0,.35)
}
.sum-head{padding:16px;border-bottom:1px solid rgba(148,163,184,.18)}
.sum-body{padding:16px}
.sum-item{display:flex;justify-content:space-between;margin-bottom:10px}
.sum-total{font-size:1.3rem;font-weight:1000;color:#fde68a}

.sum-btn{
  width:100%;padding:14px;border-radius:999px;
  font-weight:1000;border:0;cursor:pointer;
  background:linear-gradient(135deg,#f59e0b,#38bdf8);
  color:#08121f
}
.sum-btn[disabled]{opacity:.6;cursor:not-allowed}
</style>
{% endblock %}

{% block content %}
{% set snap = cart if cart is defined else {} %}
{% set lines = snap.lines if snap.lines is defined else [] %}
{% set total = snap.total if snap.total is defined else "0.00" %}
{% set currency = snap.currency if snap.currency is defined else "UYU" %}

<section class="ck-wrap">
  <div class="ck-head">
    <div>
      <h1 class="ck-title">Finalizar compra</h1>
      <p class="ck-sub">Datos protegidos · Pago seguro · Confirmación inmediata</p>
    </div>
    <span class="ck-badge">Checkout PRO</span>
  </div>

  <div class="ck-grid">

    <!-- LEFT -->
    <div class="ck-card">
      <div class="ck-head-card">
        <h2 class="ck-h2">Datos y pago</h2>
        <p class="ck-help">Completá la información necesaria para procesar tu pedido.</p>
      </div>

      <div class="ck-body">
        <div id="ckErr" class="ck-error" role="alert"></div>

        <form id="checkoutForm" method="post" action="/checkout/start" novalidate>
          <input type="hidden" name="csrf_token" id="csrf_token">

          <div class="ck-row cols2">
            <div>
              <label class="ck-label">Nombre completo</label>
              <input class="ck-input" name="full_name" required>
            </div>
            <div>
              <label class="ck-label">Email</label>
              <input class="ck-input" type="email" name="email" required>
            </div>
          </div>

          <div>
            <label class="ck-label">Dirección</label>
            <input class="ck-input" name="address" required>
          </div>

          <div class="ck-row cols3">
            <input class="ck-input" name="city" placeholder="Ciudad" required>
            <input class="ck-input" name="state" placeholder="Estado" required>
            <input class="ck-input" name="postal" placeholder="CP" required>
          </div>

          <div>
            <label class="ck-label">Método de pago</label>
            <label class="pay-item">
              <input type="radio" name="payment_method" value="mercadopago" checked>
              MercadoPago
            </label>
            <label class="pay-item">
              <input type="radio" name="payment_method" value="paypal">
              PayPal
            </label>
          </div>

          <button class="sum-btn" id="submitBtn">Confirmar y pagar</button>
        </form>
      </div>
    </div>

    <!-- RIGHT -->
    <aside class="sum">
      <div class="sum-head">
        <h2>Resumen</h2>
      </div>
      <div class="sum-body">
        {% for l in lines %}
        <div class="sum-item">
          <span>{{ l.title }}</span>
          <span>{{ l.qty }}×</span>
        </div>
        {% endfor %}
        <hr>
        <div class="sum-item sum-total">
          <span>Total</span>
          <span>{{ currency }} {{ total }}</span>
        </div>
      </div>
    </aside>

  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(()=> {
  const f=document.getElementById('checkoutForm');
  const b=document.getElementById('submitBtn');
  const e=document.getElementById('ckErr');
  let lock=false;

  const csrf=document.querySelector('meta[name="csrf-token"]')?.content;
  if(csrf) document.getElementById('csrf_token').value=csrf;

  f.addEventListener('submit',async(ev)=>{
    if(lock){ev.preventDefault();return;}
    ev.preventDefault();
    e.classList.remove('on');e.textContent='';
    lock=true;b.disabled=true;b.textContent='Procesando…';

    const r=await fetch('/checkout/start',{method:'POST',body:new FormData(f)});
    const j=await r.json();
    if(!j.ok){
      e.textContent=j.error||'Error al procesar';
      e.classList.add('on');
      lock=false;b.disabled=false;b.textContent='Confirmar y pagar';
      return;
    }

    if(j.payment_method==='mercadopago'){
      const m=await fetch('/checkout/mercadopago/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({order_id:j.order_id})});
      const mj=await m.json();
      if(mj.init_point) location.href=mj.init_point;
    }
    if(j.payment_method==='paypal'){
      alert('PayPal listo (SDK)');
    }
  });
})();
</script>
{% endblock %}
