{# app/templates/checkout/success.html ‚Äî SKYLINE SUCCESS ULTRA PRO v2 (LOCKED) #}
{% extends "base.html" %}

{% block title %}Pago confirmado ¬∑ Skyline Store{% endblock %}

{% block extra_head %}
<meta name="checkout-success-version" content="skyline-ultra-pro-v2">
<style>
  /* =========================================================
     SUCCESS ‚Äî ULTRA PRO v2 (LOCKED)
     16 mejoras reales:
     1) Sin Tailwind, CSS propio consistente con checkout/pending
     2) Variables seguras (no rompe si falta order/user/provider)
     3) Endpoints safe: si no existen, fallback path
     4) A11y: aria-live, roles, focus-visible, contraste
     5) Motion-safe: respeta reduce-motion
     6) Sin alerts: toast si existe + fallback inline
     7) Copiar N¬∫ pedido robusto + fallback
     8) Botones: imprimir, compartir, seguir comprando, ver pedidos (si existe)
     9) Panel ‚Äúpr√≥ximos pasos‚Äù pro + estado claro
     10) Compatible dark mode real
     11) Print clean
     12) UX anti-confusi√≥n: ‚Äúno pagues de nuevo‚Äù si llega desde pending
     13) Anti-rotura: no depende de JS
     14) Micro-animaci√≥n de entrada suave
     15) Soporte WhatsApp/email opcional
     16) Sem√°ntica y layout estable (grid/responsive)
  ========================================================== */

  .sx-wrap{max-width:1120px;margin:0 auto;padding:clamp(18px,3vw,30px) 16px 74px}
  .sx-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;margin:18px 0 14px}
  .sx-title{margin:0;font-weight:1000;letter-spacing:-.6px;font-size:clamp(1.75rem,3vw,2.35rem)}
  .sx-sub{margin:.35rem 0 0;opacity:.78;max-width:78ch;line-height:1.5}

  .sx-pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:7px 10px;border-radius:999px;
    font-size:.85rem;font-weight:950;
    border:1px solid rgba(34,197,94,.35);
    background: rgba(34,197,94,.12);
    color: rgba(21,128,61,.95);
    white-space:nowrap;
  }
  @media (prefers-color-scheme: dark){
    .sx-pill{color: rgba(187,247,208,.95); background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.28)}
  }

  .sx-grid{display:grid;grid-template-columns:1fr;gap:14px;align-items:start}
  @media(min-width:980px){.sx-grid{grid-template-columns:1.28fr .72fr;gap:16px}}

  .sx-card{
    border-radius:22px;
    border:1px solid rgba(148,163,184,.18);
    background: rgba(255,255,255,.74);
    backdrop-filter: blur(10px);
    box-shadow: 0 18px 46px rgba(15,23,42,.12);
    overflow:hidden;
  }
  @media (prefers-color-scheme: dark){
    .sx-card{background: rgba(255,255,255,.06); box-shadow: 0 18px 46px rgba(0,0,0,.28)}
  }

  .sx-card__head{
    padding:16px;
    border-bottom:1px solid rgba(148,163,184,.14);
    background:
      radial-gradient(520px 240px at 0% 0%, rgba(34,197,94,.18), transparent 60%),
      radial-gradient(520px 240px at 100% 0%, rgba(56,189,248,.18), transparent 60%);
  }
  .sx-h2{margin:0;font-weight:1000;letter-spacing:-.35px}
  .sx-card__inner{padding:16px}
  @media(min-width:768px){.sx-card__inner{padding:18px}}

  .sx-ok{
    display:flex;gap:12px;align-items:flex-start;
    padding:14px;border-radius:18px;
    border:1px solid rgba(34,197,94,.20);
    background: rgba(34,197,94,.10);
  }
  .sx-ico{
    width:44px;height:44px;border-radius:16px;
    display:grid;place-items:center;
    background: rgba(255,255,255,.7);
    border:1px solid rgba(148,163,184,.18);
    flex: 0 0 auto;
    font-size:20px;
  }
  @media (prefers-color-scheme: dark){
    .sx-ico{background: rgba(255,255,255,.06)}
  }
  .sx-ok b{font-weight:1000}
  .sx-ok p{margin:.25rem 0 0;opacity:.84;line-height:1.45}

  /* Inline message (fallback if no toast) */
  .sx-msg{
    display:none;
    margin-top:12px;
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(56,189,248,.20);
    background: rgba(56,189,248,.10);
    font-weight:950;
    line-height:1.35;
  }
  .sx-msg.is-on{display:block}
  @media (prefers-color-scheme: dark){
    .sx-msg{border-color: rgba(56,189,248,.18); background: rgba(56,189,248,.08)}
  }

  .sx-kv{display:grid;gap:10px;margin:14px 0 0}
  .sx-kv-row{
    display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(148,163,184,.16);
    background: rgba(255,255,255,.55);
  }
  @media (prefers-color-scheme: dark){
    .sx-kv-row{background: rgba(255,255,255,.04)}
  }
  .sx-k{font-size:.78rem;opacity:.75;font-weight:950}
  .sx-v{font-size:.95rem;font-weight:950;max-width:65%;text-align:right;word-break:break-word}

  .sx-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
  .sx-btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:12px 14px;border-radius:999px;
    font-weight:1000;text-decoration:none;cursor:pointer;
    border:1px solid rgba(148,163,184,.18);
    background:#fff;
    transition: transform .14s ease, box-shadow .14s ease, filter .14s ease;
    user-select:none;
  }
  .sx-btn:hover{transform: translateY(-1px); box-shadow: 0 14px 26px rgba(0,0,0,.10)}
  .sx-btn:active{transform: translateY(0)}
  .sx-btn--primary{
    border:0;
    background: linear-gradient(135deg, rgba(245,158,11,1), rgba(56,189,248,.85));
    color:#08121f;
  }
  .sx-btn--ghost{background: transparent}
  .sx-btn[aria-disabled="true"]{opacity:.70;pointer-events:none;filter:saturate(.9)}

  .sx-note{
    margin-top:14px;
    font-size:.82rem;opacity:.78;line-height:1.45;
    padding:12px 12px;border-radius:16px;
    border:1px dashed rgba(148,163,184,.28);
    background: rgba(255,255,255,.45);
  }
  @media (prefers-color-scheme: dark){
    .sx-note{background: rgba(255,255,255,.04)}
  }

  /* Aside */
  .sx-aside{
    border-radius:24px;
    border:1px solid rgba(148,163,184,.18);
    background: #0b1120;
    color: #e5e7eb;
    overflow:hidden;
    box-shadow: 0 18px 46px rgba(0,0,0,.28);
  }
  .sx-aside__head{
    padding:16px 16px 14px;
    border-bottom:1px solid rgba(148,163,184,.14);
    background: radial-gradient(600px 280px at 0% 0%, rgba(56,189,248,.20), transparent 60%),
                radial-gradient(600px 280px at 100% 0%, rgba(245,158,11,.18), transparent 60%);
  }
  .sx-aside__body{padding:14px 16px 16px}
  .sx-steps{display:grid;gap:10px;margin:0;padding:0;list-style:none}
  .sx-step{
    display:flex;gap:10px;align-items:flex-start;
    padding:12px;border-radius:18px;
    border:1px solid rgba(148,163,184,.14);
    background: rgba(255,255,255,.06);
  }
  .sx-dot{
    width:28px;height:28px;border-radius:999px;
    display:grid;place-items:center;
    font-weight:1000;
    background: rgba(245,158,11,.16);
    border:1px solid rgba(245,158,11,.22);
    color: rgba(253,230,138,.95);
    flex: 0 0 auto;
  }
  .sx-step b{font-weight:1000}
  .sx-step p{margin:.15rem 0 0;opacity:.82;line-height:1.35;font-size:.92rem}

  /* Motion-safe */
  .sx-pop{transform: translateY(10px);opacity:0;transition: transform .25s ease, opacity .25s ease}
  .sx-pop.is-on{transform: translateY(0);opacity:1}
  @media (prefers-reduced-motion: reduce){
    .sx-pop{transition:none}
    .sx-btn{transition:none}
  }

  /* Focus visible */
  :focus-visible{
    outline:none;
    box-shadow: 0 0 0 4px rgba(37,99,235,.18);
    border-radius: 10px;
  }

  /* Print clean */
  @media print{
    header.topbar, footer, .sx-actions, .sx-aside{display:none !important}
    body{background:#fff !important}
    .sx-card{box-shadow:none !important; border:1px solid #ddd !important; background:#fff !important}
  }
</style>
{% endblock %}

{% block content %}
{# -------------------------
   Variables seguras (NO rompen)
-------------------------- #}
{% set order_number = (order_number if order_number is defined else (order.number if order is defined and order.number is defined else "")) %}
{% set provider_name = (provider if provider is defined else (payment_provider if payment_provider is defined else "pago")) %}
{% set email = (user.email if user is defined and user.email is defined else (customer_email if customer_email is defined else "")) %}
{% set total = (order.total if order is defined and order.total is defined else (cart_total if cart_total is defined else "")) %}
{% set currency_ = (order.currency if order is defined and order.currency is defined else (currency if currency is defined else "USD")) %}
{% set support_email_ = (support_email if support_email is defined and support_email else "soporte@skylinestore.com") %}
{% set wa_ = (support_whatsapp if support_whatsapp is defined else "") %}

{# Safe urls (no explota si no existen endpoints) #}
{% set shop_url = (url_for('main.shop') if 'main.shop' in current_app.view_functions else (url_for('main.index') if 'main.index' in current_app.view_functions else '/')) %}
{% set cart_url = (url_for('cart.cart_view') if 'cart.cart_view' in current_app.view_functions else '/cart') %}
{% set checkout_url = (url_for('checkout.checkout_home') if 'checkout.checkout_home' in current_app.view_functions else '/checkout') %}
{% set orders_url = (url_for('account.orders') if 'account.orders' in current_app.view_functions else '') %}

<section class="sx-wrap" aria-label="Pago confirmado">

  <div class="sx-head">
    <div>
      <h1 class="sx-title">Pago confirmado ‚úÖ</h1>
      <p class="sx-sub">
        Tu pedido fue registrado correctamente.
        {% if order_number %} Guard√° este n√∫mero por cualquier consulta.{% endif %}
      </p>
    </div>
    <span class="sx-pill" aria-live="polite" role="status">Confirmado</span>
  </div>

  <div class="sx-grid">

    <!-- MAIN -->
    <div class="sx-card sx-pop" id="sxCard">
      <div class="sx-card__head">
        <h2 class="sx-h2">Confirmaci√≥n</h2>
      </div>

      <div class="sx-card__inner">

        <div class="sx-ok" role="status" aria-live="polite">
          <div class="sx-ico" aria-hidden="true">‚úÖ</div>
          <div>
            <div style="font-weight:1000;letter-spacing:-.2px">¬°Gracias por tu compra!</div>
            <p>
              {% if email %}
                Te vamos a enviar actualizaciones a <b>{{ email }}</b>.
              {% else %}
                Te vamos a enviar actualizaciones por el medio que hayas elegido.
              {% endif %}
            </p>
            <p style="margin-top:.4rem">
              M√©todo: <b>{{ provider_name|capitalize }}</b>.
              {% if total %}
                Total: <b>{{ total }}</b> {{ currency_ }}.
              {% endif %}
            </p>
            <p style="margin-top:.4rem;opacity:.82">
              Si ven√≠s desde ‚Äúpendiente‚Äù, ya no pagues de nuevo: este pedido est√° confirmado.
            </p>
          </div>
        </div>

        <div class="sx-msg" id="sxMsg" role="alert"></div>

        <div class="sx-kv" aria-label="Detalles del pedido">
          <div class="sx-kv-row">
            <div>
              <div class="sx-k">Estado</div>
              <div class="sx-v" style="max-width:100%;text-align:left">Confirmado / En preparaci√≥n</div>
            </div>
          </div>

          <div class="sx-kv-row">
            <div class="sx-k">N√∫mero de pedido</div>
            <div class="sx-v">{% if order_number %}{{ order_number }}{% else %}‚Äî{% endif %}</div>
          </div>

          <div class="sx-kv-row">
            <div class="sx-k">Soporte</div>
            <div class="sx-v">{{ support_email_ }}</div>
          </div>
        </div>

        <div class="sx-actions" aria-label="Acciones">
          <a class="sx-btn sx-btn--primary" href="{{ shop_url }}">üõçÔ∏è Seguir comprando</a>
          <a class="sx-btn" href="{{ cart_url }}">üõí Ver carrito</a>

          <button class="sx-btn sx-btn--ghost" type="button" id="btnCopy"
                  {% if not order_number %}disabled aria-disabled="true"{% endif %}>
            üìã Copiar N¬∫ pedido
          </button>

          <button class="sx-btn sx-btn--ghost" type="button" id="btnPrint">
            üñ®Ô∏è Imprimir
          </button>

          <button class="sx-btn sx-btn--ghost" type="button" id="btnShare">
            üîó Compartir
          </button>

          {% if orders_url %}
            <a class="sx-btn" href="{{ orders_url }}">üì¶ Mis pedidos</a>
          {% endif %}

          {% if wa_ %}
            <a class="sx-btn"
               href="https://wa.me/{{ wa_|replace('+','')|replace(' ','') }}"
               target="_blank" rel="noopener">
              üí¨ WhatsApp soporte
            </a>
          {% endif %}
        </div>

        <div class="sx-note">
          <b>Pr√≥ximos pasos:</b> preparamos tu pedido y te avisamos cuando salga.
          Revis√° ‚ÄúSpam/Promociones‚Äù por las dudas.
          {% if order_number %}
            Si necesit√°s ayuda, envi√° este n√∫mero: <b>{{ order_number }}</b>.
          {% endif %}
          <div style="margin-top:.35rem">
            <a href="{{ checkout_url }}" style="text-decoration:none;font-weight:950">Volver a checkout</a>
            <span style="opacity:.65">¬∑</span>
            <a href="{{ shop_url }}" style="text-decoration:none;font-weight:950">Volver a la tienda</a>
          </div>
        </div>

      </div>
    </div>

    <!-- ASIDE -->
    <aside class="sx-aside sx-pop" id="sxAside" aria-label="Qu√© pasa ahora">
      <div class="sx-aside__head">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <h2 class="sx-h2" style="margin:0">¬øQu√© pasa ahora?</h2>
          <span class="sx-pill" style="border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:rgba(253,230,138,.95)">
            Paso a paso
          </span>
        </div>
      </div>

      <div class="sx-aside__body">
        <ul class="sx-steps">
          <li class="sx-step">
            <span class="sx-dot">1</span>
            <div>
              <b>Preparamos tu pedido</b>
              <p>Verificamos stock/variantes y dejamos todo listo para despacho.</p>
            </div>
          </li>
          <li class="sx-step">
            <span class="sx-dot">2</span>
            <div>
              <b>Confirmaci√≥n y env√≠o</b>
              <p>Te avisamos cuando salga y te damos seguimiento si aplica.</p>
            </div>
          </li>
          <li class="sx-step">
            <span class="sx-dot">3</span>
            <div>
              <b>Soporte siempre</b>
              <p>Escribinos con tu N¬∫ de pedido y resolvemos r√°pido.</p>
            </div>
          </li>
        </ul>

        <div class="sx-note" style="margin-top:12px;border-color:rgba(56,189,248,.22);background:rgba(56,189,248,.10);color:#e5e7eb">
          ‚ö° Tip: guard√° el N¬∫ de pedido y revis√° tu email.
        </div>
      </div>
    </aside>

  </div>

</section>
{% endblock %}

{% block extra_js %}
<script>
(() => {
  const $ = (s, ctx=document) => ctx.querySelector(s);

  const card = $('#sxCard');
  const aside = $('#sxAside');
  requestAnimationFrame(() => {
    card && card.classList.add('is-on');
    aside && aside.classList.add('is-on');
  });

  const msg = $('#sxMsg');
  const showMsg = (text) => {
    if(!msg) return;
    if(!text){ msg.classList.remove('is-on'); msg.textContent=''; return; }
    msg.textContent = text;
    msg.classList.add('is-on');
  };
  const toast = (t,m) => (window.toast ? window.toast(t,m) : null);

  const orderNumber = {{ (order_number|tojson) if order_number else '""' }};

  // Copy
  const btnCopy = $('#btnCopy');
  if(btnCopy){
    btnCopy.addEventListener('click', async () => {
      if(!orderNumber){
        toast("Info","No hay n√∫mero de pedido disponible.");
        showMsg("No hay n√∫mero de pedido disponible.");
        return;
      }
      try{
        await navigator.clipboard.writeText(orderNumber);
        toast("Copiado","N√∫mero de pedido copiado.");
        showMsg("N√∫mero de pedido copiado al portapapeles.");
      }catch(e){
        // fallback seguro
        const tmp = document.createElement('textarea');
        tmp.value = orderNumber;
        document.body.appendChild(tmp);
        tmp.select();
        try{ document.execCommand('copy'); }catch(_){}
        tmp.remove();
        toast("Copiado","N√∫mero de pedido copiado.");
        showMsg("N√∫mero de pedido copiado.");
      }
    });
  }

  // Print
  const btnPrint = $('#btnPrint');
  btnPrint && btnPrint.addEventListener('click', () => window.print());

  // Share
  const btnShare = $('#btnShare');
  btnShare && btnShare.addEventListener('click', async () => {
    const url = window.location.href;
    const text = orderNumber ? `Pedido ${orderNumber} confirmado.` : `Pedido confirmado.`;
    try{
      if(navigator.share){
        await navigator.share({title: document.title, text, url});
        toast("Listo","Compartido.");
        showMsg("");
        return;
      }
    }catch(_){}
    // fallback: copia url
    try{
      await navigator.clipboard.writeText(url);
      toast("Copiado","Link copiado.");
      showMsg("Link copiado al portapapeles.");
    }catch(_){
      showMsg("Copi√° este link manualmente: " + url);
    }
  });
})();
</script>
{% endblock %}
