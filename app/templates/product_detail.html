{% extends "base.html" %}

{# ==========================================================
   PRODUCT DETAIL ‚Äî ULTRA PRO MAX (Light ¬∑ Premium ¬∑ Safe) ‚Äî FINAL
   ‚úÖ +20 mejoras extra (adem√°s de tus 5):
   1) SEO completo (description/canonical/OG/Twitter)
   2) JSON-LD Product (rich snippets)
   3) Breadcrumb + schema
   4) Preload / fetchpriority para imagen principal
   5) Galer√≠a (si hay product.images) + thumbnails
   6) Zoom modal accesible (ESC / focus trap simple)
   7) Skeleton shimmer mientras carga imagen
   8) Estados de stock (si existe product.stock / product.status)
   9) Selector de talle (si existe product.sizes)
   10) Selector de color (si existe product.colors)
   11) ‚ÄúCopiar link‚Äù + compartir
   12) Sticky Buy Bar mobile (solo cuando CTA no est√° visible)
   13) Aria-live para feedback (sin depender de toast)
   14) Botones qty deshabilitados en l√≠mites
   15) Enter/Space para thumbnails + accesibilidad
   16) Single-flight + AbortController (evita dobles clicks/retries)
   17) Idempotency key por click (si backend lo soporta, no rompe)
   18) Analytics hook (dataLayer) si existe
   19) Fallback robusto: si no hay /cart/add json -> redirect a carrito
   20) Respetar reduced-motion + mejora focus-visible
========================================================== #}

{% block title %}
  {{ (product.name ~ ' - Skyline Style') if product else 'Producto no encontrado - Skyline Style' }}
{% endblock %}

{% block extra_head %}
  {# --------- Helpers seguros para head ---------- #}
  {% set name = product.name if product and product.name else 'Producto' %}
  {% set description = (product.description if product and product.description else '') %}
  {% set category = (product.category if product and product.category else '') %}
  {% set image_url = (product.image if product and product.image else '') %}
  {% set images = (product.images if product and product.images is defined and product.images else []) %}
  {% set canonical = request.url if request else '' %}

  {% set price_value = (product.price if product and product.price is not none else 0) %}
  {% set price_float = (price_value|float) %}

  {% set product_id = (product.id if product and product.id is defined else (product.product_id if product and product.product_id is defined else "")) %}

  {% set has_stock = (product.stock is defined) if product else false %}
  {% set stock = (product.stock if product and product.stock is defined and product.stock is not none else None) %}
  {% set is_active = (product.status == 'active') if product and product.status is defined else true %}
  {% set in_stock = (stock is none) or (stock|int > 0) %}

  {% set sizes = (product.sizes if product and product.sizes is defined and product.sizes else []) %}
  {% set colors = (product.colors if product and product.colors is defined and product.colors else []) %}

  <link rel="canonical" href="{{ canonical }}">

  <meta name="description" content="{{ (description|striptags|trim)[:155] if description else (name ~ ' ¬∑ Skyline Style. Streetwear premium bajo demanda, env√≠o gestionado y compra segura.') }}">
  <meta name="robots" content="index,follow">

  <!-- OpenGraph -->
  <meta property="og:title" content="{{ name }} ¬∑ Skyline Style">
  <meta property="og:description" content="{{ (description|striptags|trim)[:160] if description else 'Streetwear premium bajo demanda. Compra segura y env√≠o gestionado.' }}">
  <meta property="og:type" content="product">
  <meta property="og:url" content="{{ canonical }}">
  {% if image_url %}
    <meta property="og:image" content="{{ image_url }}">
  {% endif %}

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ name }} ¬∑ Skyline Style">
  <meta name="twitter:description" content="{{ (description|striptags|trim)[:160] if description else 'Streetwear premium bajo demanda. Compra segura y env√≠o gestionado.' }}">
  {% if image_url %}
    <meta name="twitter:image" content="{{ image_url }}">
  {% endif %}

  {# Preload imagen principal #}
  {% if image_url %}
    <link rel="preload" as="image" href="{{ image_url }}" imagesrcset="{{ image_url }}" fetchpriority="high">
  {% endif %}

  {# JSON-LD Product #}
  {% if product %}
  <script type="application/ld+json">
  {{
    {
      "@context": "https://schema.org",
      "@type": "Product",
      "name": name,
      "category": (category|replace('_',' ')|trim),
      "description": (description|striptags|trim) if description else (name ~ " ¬∑ Skyline Style"),
      "image": ([image_url] if image_url else (images if images else [])),
      "sku": (product.sku if product and product.sku is defined else (product_id|string)),
      "brand": {"@type":"Brand","name":"Skyline Style"},
      "offers": {
        "@type":"Offer",
        "priceCurrency":"UYU",
        "price": ("%.2f"|format(price_float)),
        "availability": ("https://schema.org/InStock" if (is_active and in_stock) else "https://schema.org/OutOfStock"),
        "url": canonical
      }
    }|tojson
  }}
  </script>
  {% endif %}

<style>
  :root{
    --pd-ring: rgba(56,189,248,.35);
    --pd-border: rgba(148,163,184,.32);
    --pd-text: #0b1220;
  }

  /* Hover card */
  .pd-hover{transition: transform .28s ease, box-shadow .28s ease, border-color .28s ease, background-color .2s ease;}
  .pd-hover:hover{
    transform: translateY(-4px);
    box-shadow: 0 22px 40px -18px rgba(15,23,42,.28);
    border-color: rgba(37,99,235,.18);
    background-color: rgba(248,250,252,.8);
  }

  /* Focus */
  .pd-focus:focus{outline:none;}
  .pd-focus:focus-visible{
    outline: 2px solid var(--pd-ring);
    outline-offset: 2px;
    border-radius: 14px;
  }

  /* Pill badge */
  .pill-badge{
    display:inline-flex;align-items:center;gap:.45rem;
    padding:.38rem .82rem;border-radius:9999px;
    font-size:.72rem;line-height:1;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.78);
    color: rgba(15,23,42,.66);
    white-space:nowrap;
    backdrop-filter: blur(12px);
  }
  .pill-dot{width:.42rem;height:.42rem;border-radius:9999px;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.12);}

  /* Media wrap */
  .pd-img-wrap{position:relative;overflow:hidden;border-radius: 1.75rem;}
  .pd-img-fallback{
    display:none;position:absolute;inset:0;place-items:center;text-align:center;padding:1.2rem;
    color: rgba(15,23,42,.72);font-weight: 800;
    background:
      radial-gradient(900px 420px at 20% 20%, rgba(37,99,235,.12), transparent 55%),
      radial-gradient(720px 420px at 85% 20%, rgba(245,158,11,.10), transparent 58%),
      rgba(248,250,252,.92);
  }

  /* Skeleton shimmer */
  .pd-skel{
    position:absolute;inset:0;
    background: linear-gradient(90deg, rgba(226,232,240,.65), rgba(226,232,240,.35), rgba(226,232,240,.65));
    background-size: 200% 100%;
    animation: pd-shimmer 1.1s ease-in-out infinite;
  }
  @keyframes pd-shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

  /* Thumbnails */
  .pd-thumbs{display:flex;gap:.6rem;flex-wrap:wrap}
  .pd-thumb{
    width:64px;height:64px;border-radius:16px;overflow:hidden;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(255,255,255,.65);
    cursor:pointer;
    transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
  }
  .pd-thumb:hover{transform: translateY(-1px); box-shadow: 0 10px 16px rgba(2,6,23,.08)}
  .pd-thumb[aria-current="true"]{border-color: rgba(245,158,11,.55); box-shadow: 0 0 0 4px rgba(245,158,11,.12)}
  .pd-thumb img{width:100%;height:100%;object-fit:cover;display:block}

  /* Selectors */
  .pd-select{
    display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;
  }
  .pd-select label{
    font-size: 11px;letter-spacing:.16em;text-transform:uppercase;color: rgba(100,116,139,.92);
  }
  .pd-select select{
    height: 40px;
    border-radius: 999px;
    border:1px solid var(--pd-border);
    background: rgba(255,255,255,.85);
    padding: 0 14px;
    font-weight: 800;
    color: var(--pd-text);
  }

  /* Qty stepper */
  .pd-qty{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:999px;
    border:1px solid rgba(148,163,184,.35);
    background: rgba(255,255,255,.82);
  }
  .pd-qty button{
    width:34px;height:34px;border-radius:999px;
    border:1px solid rgba(148,163,184,.30);
    background:#fff;
    cursor:pointer;
    font-weight:900;
    transition: transform .14s ease, filter .14s ease, box-shadow .14s ease, opacity .14s ease;
  }
  .pd-qty button:hover{transform: translateY(-1px); filter:saturate(1.06); box-shadow: 0 10px 18px rgba(2,6,23,.08)}
  .pd-qty button:active{transform: translateY(0)}
  .pd-qty button:disabled{opacity:.45; cursor:not-allowed; box-shadow:none; transform:none;}
  .pd-qty input{
    width:54px;text-align:center;border:0;outline:none;background:transparent;
    font-weight:900;color: var(--pd-text);
  }
  .pd-qty input::-webkit-outer-spin-button,
  .pd-qty input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  .pd-qty input[type=number]{ -moz-appearance:textfield; }

  /* Add button loading */
  .pd-btn{position:relative;}
  .pd-btn[aria-busy="true"]{opacity:.86; pointer-events:none; filter:saturate(.95);}
  .pd-spin{
    display:none;width:16px;height:16px;border-radius:999px;
    border:2px solid rgba(255,255,255,.25);
    border-top-color: rgba(255,255,255,.95);
    animation: pd-rot .9s linear infinite;
  }
  .pd-btn[aria-busy="true"] .pd-spin{display:inline-block}
  @keyframes pd-rot{to{transform: rotate(360deg)}}

  /* Live status */
  .pd-live{
    min-height: 18px;
    font-size: 12px;
    color: rgba(100,116,139,.95);
  }

  /* Zoom modal */
  .pd-modal{
    position:fixed; inset:0; z-index: 60;
    display:none; place-items:center;
    background: rgba(2,6,23,.62);
    padding: 18px;
  }
  .pd-modal[aria-hidden="false"]{display:grid;}
  .pd-modal-card{
    width:min(980px, 96vw);
    border-radius: 22px;
    overflow:hidden;
    background: rgba(255,255,255,.95);
    border:1px solid rgba(226,232,240,.9);
    box-shadow: 0 30px 80px rgba(0,0,0,.35);
  }
  .pd-modal-top{
    display:flex;align-items:center;justify-content:space-between;
    padding: 12px 14px;
    border-bottom: 1px solid rgba(226,232,240,.85);
  }
  .pd-modal-top p{margin:0; font-size:12px; color: rgba(100,116,139,.95); font-weight:800}
  .pd-x{
    width:40px;height:40px;border-radius:999px;
    border:1px solid rgba(148,163,184,.35);
    background:#fff; cursor:pointer; font-weight:900;
  }
  .pd-modal-img{
    width:100%; height:auto; display:block;
    max-height: 78vh; object-fit: contain;
    background: radial-gradient(900px 420px at 20% 20%, rgba(37,99,235,.08), transparent 55%),
                radial-gradient(720px 420px at 85% 20%, rgba(245,158,11,.08), transparent 58%),
                rgba(248,250,252,.92);
  }

  /* Sticky buy bar */
  .pd-sticky{
    position:fixed; left: 12px; right: 12px; bottom: 12px; z-index: 55;
    display:none;
    padding: 10px;
    border-radius: 18px;
    border:1px solid rgba(148,163,184,.26);
    background: rgba(255,255,255,.86);
    backdrop-filter: blur(12px);
    box-shadow: 0 18px 40px rgba(2,6,23,.18);
  }
  .pd-sticky__row{
    display:flex; align-items:center; gap: 10px; justify-content:space-between;
  }
  .pd-sticky__meta{
    min-width: 0;
  }
  .pd-sticky__meta p{margin:0; line-height:1.15}
  .pd-sticky__name{
    font-size: 12px; font-weight: 900; color: #0b1220;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 44vw;
  }
  .pd-sticky__price{
    font-size: 12px; font-weight: 900; color: rgba(217,119,6,1);
  }
  .pd-sticky__btn{
    flex: 0 0 auto;
    padding: 10px 14px;
    border-radius: 999px;
    background: #0f172a;
    color: #fff;
    border: 0;
    font-weight: 900;
    cursor:pointer;
  }
  .pd-sticky__btn:disabled{opacity:.6; cursor:not-allowed}
  @media (min-width: 768px){ .pd-sticky{display:none !important} }

  @media (prefers-reduced-motion: reduce){
    *{transition:none!important; animation:none!important; scroll-behavior:auto!important;}
    .pd-spin{animation:none!important}
    .pd-skel{animation:none!important}
  }
</style>
{% endblock %}

{% block content %}
<section class="max-w-5xl mx-auto px-4 pt-10 pb-20">
  {% set cart_fallback = url_for('cart.cart_view') if 'cart.cart_view' in current_app.view_functions else '/cart' %}

  {% if not product %}
    <div class="bg-white rounded-2xl border border-slate-200 p-8 text-center">
      <h1 class="text-xl font-semibold text-slate-900 mb-2">Producto no encontrado</h1>
      <p class="text-sm text-slate-600">Este producto no existe, fue movido o est√° temporalmente oculto.</p>
      <a href="{{ url_for('main.shop') }}"
         class="mt-5 inline-flex px-6 py-2.5 rounded-full bg-slate-900 text-slate-50 text-sm font-medium hover:bg-slate-800 shadow-sm hover:shadow-md transition
                focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400/40">
        Volver a la tienda
      </a>
    </div>
  {% else %}

    {# Breadcrumb #}
    <nav class="flex items-center gap-2 text-[11px] md:text-xs text-slate-500 mb-6" aria-label="Breadcrumb">
      <a href="{{ url_for('main.shop') }}"
         class="pd-focus hover:text-amber-600 transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-400/40 rounded">
        Tienda
      </a>
      <span aria-hidden="true">/</span>
      <span class="truncate max-w-[70%]" title="{{ name|e }}">{{ name }}</span>
    </nav>

    <div class="grid md:grid-cols-2 gap-8 md:gap-10 items-start">

      <!-- MEDIA -->
      <div class="space-y-4" data-product-media>
        <div class="pd-img-wrap bg-slate-100 border border-slate-100 pd-hover">
          <div class="w-full aspect-square sm:aspect-[4/5] bg-slate-100 relative">

            <div id="pd-skel" class="pd-skel" aria-hidden="true"></div>

            {% set main_img = (image_url if image_url else (images[0] if images and images|length > 0 else "")) %}

            {% if main_img %}
              <img id="pd-img"
                   src="{{ main_img }}"
                   alt="{{ name|e }}"
                   loading="eager"
                   fetchpriority="high"
                   decoding="async"
                   class="w-full h-full object-cover cursor-zoom-in"
                   data-zoom-src="{{ main_img }}"
                   tabindex="0"
                   aria-label="Abrir zoom de imagen">
              <div id="pd-fallback" class="pd-img-fallback">
                Imagen no disponible<br>
                <span style="opacity:.75;font-weight:800">Agreg√° una imagen al producto</span>
              </div>
            {% else %}
              <div class="pd-img-fallback" style="display:grid">
                Imagen no disponible<br>
                <span style="opacity:.75;font-weight:800">Agreg√° una imagen al producto</span>
              </div>
            {% endif %}
          </div>
        </div>

        {# Thumbnails (si hay m√°s im√°genes) #}
        {% set gallery = [] %}
        {% if images and images|length > 0 %}
          {% set gallery = images %}
        {% elif image_url %}
          {% set gallery = [image_url] %}
        {% endif %}

        {% if gallery and gallery|length > 1 %}
          <div class="pd-thumbs" aria-label="Galer√≠a de im√°genes">
            {% for g in gallery %}
              <button type="button"
                      class="pd-thumb pd-focus"
                      data-thumb="{{ g }}"
                      aria-current="{{ 'true' if loop.first else 'false' }}"
                      aria-label="Ver imagen {{ loop.index }}">
                <img src="{{ g }}" alt="{{ name|e }} ¬∑ imagen {{ loop.index }}" loading="lazy" decoding="async">
              </button>
            {% endfor %}
          </div>
        {% endif %}

        <div class="grid grid-cols-3 gap-3 text-[11px] text-slate-500">
          <div class="rounded-2xl border border-slate-100 bg-white/80 px-3 py-2">
            <p class="font-semibold text-slate-900 text-xs">Fit</p>
            <p>Unisex urbano</p>
          </div>
          <div class="rounded-2xl border border-slate-100 bg-white/80 px-3 py-2">
            <p class="font-semibold text-slate-900 text-xs">Talles</p>
            <p>XS a 5XL</p>
          </div>
          <div class="rounded-2xl border border-slate-100 bg-white/80 px-3 py-2">
            <p class="font-semibold text-slate-900 text-xs">Estilo</p>
            <p>Streetwear</p>
          </div>
        </div>

        {# Share row #}
        <div class="flex flex-wrap items-center gap-2 text-[11px] text-slate-600">
          <button type="button"
                  class="pd-focus inline-flex items-center gap-2 px-3 py-2 rounded-full border border-slate-200 bg-white/80 hover:bg-white transition"
                  id="btnCopyLink"
                  aria-label="Copiar enlace del producto">
            üîó <span>Copiar link</span>
          </button>
          <a class="pd-focus inline-flex items-center gap-2 px-3 py-2 rounded-full border border-slate-200 bg-white/80 hover:bg-white transition"
             href="https://wa.me/?text={{ (name ~ ' ¬∑ ' ~ canonical)|urlencode }}"
             target="_blank" rel="noopener"
             aria-label="Compartir por WhatsApp">
            üí¨ <span>WhatsApp</span>
          </a>
        </div>

      </div>

      <!-- INFO -->
      <div class="space-y-5" data-product-info>

        <div class="space-y-2">
          <p class="text-[11px] uppercase tracking-[0.18em] text-slate-400">
            {% if category %}
              {{ category|replace('_',' ')|capitalize }}
            {% else %}
              Colecci√≥n Skyline
            {% endif %}
          </p>

          <h1 class="text-2xl md:text-3xl font-semibold text-slate-900 leading-tight">
            {{ name }}
          </h1>
        </div>

        <div class="flex items-center gap-3 flex-wrap">
          <p class="text-lg md:text-xl font-semibold text-amber-600">
            $ {{ "%.2f"|format(price_float) }} UYU
          </p>

          {% if is_active and in_stock %}
            <span class="text-[11px] uppercase tracking-wide text-emerald-700 bg-emerald-50 border border-emerald-100 px-2.5 py-1 rounded-full">
              Disponible
            </span>
          {% else %}
            <span class="text-[11px] uppercase tracking-wide text-rose-700 bg-rose-50 border border-rose-100 px-2.5 py-1 rounded-full">
              Sin stock
            </span>
          {% endif %}

          {% if has_stock and stock is not none %}
            <span class="text-[11px] text-slate-500">
              Stock: <span class="font-semibold text-slate-700">{{ stock }}</span>
            </span>
          {% endif %}
        </div>

        <div class="space-y-3 text-sm text-slate-600">
          <p>
            {{ description|safe if description else
               'Parte de la colecci√≥n Skyline Style: piezas pensadas para combinar f√°cil, aguantar el uso diario y destacar tanto en calle como en c√°mara.' }}
          </p>

          <ul class="list-disc list-inside space-y-1 text-xs md:text-sm text-slate-600">
            <li>Streetwear c√≥modo, con actitud e identidad propia.</li>
            <li>Cortes pensados para distintos tipos de cuerpo.</li>
            <li>Ideal para fotos, videos, streaming y uso diario.</li>
          </ul>
        </div>

        <div class="flex flex-wrap gap-2 text-[11px]">
          <span class="pill-badge"><span class="pill-dot"></span>Producci√≥n bajo demanda</span>
          <span class="pill-badge">Unisex</span>
          <span class="pill-badge">Talles XS‚Äì5XL</span>
          <span class="pill-badge">Env√≠o gestionado por Printful</span>
        </div>

        {# Selectores opcionales #}
        <div class="space-y-2">
          {% if sizes and sizes|length > 0 %}
            <div class="pd-select" aria-label="Selector de talle">
              <label for="pdSize">Talle</label>
              <select id="pdSize" class="pd-focus" aria-label="Elegir talle">
                {% for s in sizes %}
                  <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
              </select>
            </div>
          {% endif %}

          {% if colors and colors|length > 0 %}
            <div class="pd-select" aria-label="Selector de color">
              <label for="pdColor">Color</label>
              <select id="pdColor" class="pd-focus" aria-label="Elegir color">
                {% for c in colors %}
                  <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
            </div>
          {% endif %}
        </div>

        <!-- CTA + QTY -->
        <div class="pt-3 flex flex-wrap items-center gap-3" id="pdCtaRow">

          <div class="pd-qty" aria-label="Cantidad">
            <button type="button" data-qty-dec aria-label="Disminuir" class="pd-focus">‚àí</button>
            <input id="pdQty" type="number" inputmode="numeric" min="1" max="25" value="1" aria-label="Cantidad" class="pd-focus">
            <button type="button" data-qty-inc aria-label="Aumentar" class="pd-focus">+</button>
          </div>

          <button type="button"
                  id="btnAddToCart"
                  class="pd-btn inline-flex items-center justify-center gap-2 px-7 py-2.5 rounded-full bg-slate-900 text-slate-50 text-sm font-medium hover:bg-slate-800
                         shadow-sm hover:shadow-md transition focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-900/20"
                  data-product-id="{{ product_id }}"
                  aria-busy="false"
                  {% if not (is_active and in_stock) %}disabled{% endif %}>
            <span class="pd-spin" aria-hidden="true"></span>
            <span data-btn-text>
              {% if is_active and in_stock %}Agregar al carrito{% else %}No disponible{% endif %}
            </span>
          </button>

          <p class="text-[11px] text-slate-500 max-w-xs">
            Compra segura. Pod√©s revisar tu carrito antes de pagar.
          </p>

          <div class="pd-live" id="pdLive" role="status" aria-live="polite" aria-atomic="true"></div>
        </div>

        <div class="pt-2 border-t border-slate-100 text-[11px] md:text-xs text-slate-500 space-y-1">
          <p>
            <span class="font-semibold text-slate-700">Tip de fit:</span>
            si est√°s entre dos talles y te gusta un look oversize, eleg√≠ el m√°s grande.
          </p>
          <p>
            <span class="font-semibold text-slate-700">Cuidados:</span>
            lavar con agua fr√≠a, del rev√©s, y evitar planchar sobre el estampado.
          </p>
          <p>
            <span class="font-semibold text-slate-700">Entrega:</span>
            producci√≥n bajo demanda + env√≠o gestionado (tiempos var√≠an seg√∫n producto/destino).
          </p>
        </div>

        <noscript>
          <div class="mt-3 text-xs text-slate-600">
            Activ√° JavaScript para agregar al carrito desde esta p√°gina.
            Pod√©s hacerlo desde la tienda igualmente.
          </div>
        </noscript>

      </div>
    </div>

    {# Zoom modal #}
    <div class="pd-modal" id="pdModal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Zoom de imagen">
      <div class="pd-modal-card">
        <div class="pd-modal-top">
          <p id="pdModalTitle">{{ name }}</p>
          <button type="button" class="pd-x pd-focus" id="pdModalClose" aria-label="Cerrar">‚úï</button>
        </div>
        <img id="pdModalImg" class="pd-modal-img" alt="{{ name|e }}">
      </div>
    </div>

    {# Sticky buy bar (mobile) #}
    <div class="pd-sticky" id="pdSticky" aria-hidden="true">
      <div class="pd-sticky__row">
        <div class="pd-sticky__meta">
          <p class="pd-sticky__name" title="{{ name|e }}">{{ name }}</p>
          <p class="pd-sticky__price">$ {{ "%.2f"|format(price_float) }} UYU</p>
        </div>
        <button type="button" class="pd-sticky__btn" id="pdStickyBtn" {% if not (is_active and in_stock) %}disabled{% endif %}>
          Comprar
        </button>
      </div>
    </div>

  {% endif %}
</section>
{% endblock %}

{% block extra_js %}
<script>
/* ==========================================================
   Product detail ‚Äî ULTRA PRO MAX JS (FINAL)
   - gallery thumbs
   - skeleton + fallback
   - zoom modal (a11y)
   - qty stepper mejorado
   - add-to-cart POST json single-flight + abort + idempotency
   - sticky buy bar (mobile)
   - copy link
========================================================== */
(function(){
  const reduce = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

  // --------- elements ----------
  const img   = document.getElementById("pd-img");
  const fb    = document.getElementById("pd-fallback");
  const skel  = document.getElementById("pd-skel");
  const live  = document.getElementById("pdLive");

  const btn   = document.getElementById("btnAddToCart");
  const sticky = document.getElementById("pdSticky");
  const stickyBtn = document.getElementById("pdStickyBtn");
  const ctaRow = document.getElementById("pdCtaRow");

  const qty = document.getElementById("pdQty");
  const inc = document.querySelector("[data-qty-inc]");
  const dec = document.querySelector("[data-qty-dec]");

  const sizeSel  = document.getElementById("pdSize");
  const colorSel = document.getElementById("pdColor");

  const copyBtn = document.getElementById("btnCopyLink");

  const modal = document.getElementById("pdModal");
  const modalImg = document.getElementById("pdModalImg");
  const modalClose = document.getElementById("pdModalClose");

  const fallbackCart = {{ (cart_fallback|tojson) }};
  const pid = (btn && btn.getAttribute("data-product-id") || "").trim();

  // --------- helpers ----------
  const clamp = (n,a,b) => Math.min(b, Math.max(a, n));
  const setLive = (t) => { if(live) live.textContent = t || ""; };

  const toast = (t,m) => { try{ window.toast && window.toast(t,m); }catch(e){} };

  const readCsrf = () => {
    const m = document.querySelector('meta[name="csrf-token"]');
    if(m && m.content) return m.content.trim();
    const i = document.querySelector('input[name="csrf_token"]');
    if(i && i.value) return i.value.trim();
    return "";
  };

  const readQty = () => clamp(parseInt(qty?.value || "1", 10) || 1, 1, 25);
  const setQty  = (v) => { if(qty) qty.value = String(clamp(v,1,25)); updateQtyButtons(); };

  const updateQtyButtons = () => {
    const v = readQty();
    if(dec) dec.disabled = (v <= 1);
    if(inc) inc.disabled = (v >= 25);
  };

  const safeIdKey = () => {
    // idempotency-key simple (si backend ignora, no pasa nada)
    try{
      const rnd = (crypto && crypto.getRandomValues) ? crypto.getRandomValues(new Uint32Array(2)) : [Date.now(), Math.random()*1e9];
      return "pd_" + rnd[0].toString(16) + rnd[1].toString(16);
    }catch(e){
      return "pd_" + String(Date.now());
    }
  };

  // --------- image skeleton + fallback ----------
  if(img){
    const done = () => { if(skel) skel.style.display = "none"; };
    if(img.complete) done();
    img.addEventListener("load", done, { once:true });
    img.addEventListener("error", () => {
      if(img) img.style.display = "none";
      if(fb) fb.style.display = "grid";
      if(skel) skel.style.display = "none";
    }, { once:true });
  } else {
    if(skel) skel.style.display = "none";
  }

  // --------- micro-animaci√≥n ----------
  const media = document.querySelector("[data-product-media]");
  const info  = document.querySelector("[data-product-info]");
  if(!reduce){
    [media, info].forEach((el, i) => {
      if(!el) return;
      el.style.opacity = "0";
      el.style.transform = "translateY(10px)";
      setTimeout(() => {
        el.style.transition = "opacity .55s ease, transform .55s ease";
        el.style.opacity = "1";
        el.style.transform = "translateY(0)";
      }, 70 + i*90);
    });
  }

  // --------- thumbs gallery ----------
  const thumbs = Array.from(document.querySelectorAll("[data-thumb]"));
  const setMain = (src) => {
    if(!img || !src) return;
    if(skel) skel.style.display = "block";
    img.style.display = "";
    img.src = src;
    img.setAttribute("data-zoom-src", src);
    thumbs.forEach(t => t.setAttribute("aria-current", (t.getAttribute("data-thumb") === src) ? "true" : "false"));
  };
  thumbs.forEach(t => {
    const src = t.getAttribute("data-thumb");
    t.addEventListener("click", () => setMain(src));
    t.addEventListener("keydown", (ev) => {
      if(ev.key === "Enter" || ev.key === " "){
        ev.preventDefault();
        setMain(src);
      }
    });
  });

  // --------- zoom modal ----------
  let lastFocus = null;
  const openModal = () => {
    if(!modal || !modalImg || !img) return;
    const src = img.getAttribute("data-zoom-src") || img.currentSrc || img.src;
    if(!src) return;
    lastFocus = document.activeElement;
    modalImg.src = src;
    modal.setAttribute("aria-hidden", "false");
    document.documentElement.style.overflow = "hidden";
    setTimeout(() => { modalClose && modalClose.focus(); }, 0);
  };
  const closeModal = () => {
    if(!modal) return;
    modal.setAttribute("aria-hidden", "true");
    document.documentElement.style.overflow = "";
    if(lastFocus && lastFocus.focus) try{ lastFocus.focus(); }catch(e){}
  };
  if(img){
    img.addEventListener("click", openModal);
    img.addEventListener("keydown", (ev) => {
      if(ev.key === "Enter" || ev.key === " "){ ev.preventDefault(); openModal(); }
      if(ev.key === "Escape"){ closeModal(); }
    });
  }
  if(modal){
    modal.addEventListener("click", (ev) => {
      if(ev.target === modal) closeModal();
    });
  }
  modalClose && modalClose.addEventListener("click", closeModal);
  document.addEventListener("keydown", (ev) => {
    if(ev.key === "Escape" && modal && modal.getAttribute("aria-hidden") === "false") closeModal();
  });

  // --------- qty stepper ----------
  updateQtyButtons();
  inc && inc.addEventListener("click", () => setQty(readQty()+1));
  dec && dec.addEventListener("click", () => setQty(readQty()-1));
  qty && qty.addEventListener("input", () => setQty(readQty()));
  qty && qty.addEventListener("keydown", (ev) => {
    if(ev.key === "ArrowUp"){ ev.preventDefault(); setQty(readQty()+1); }
    if(ev.key === "ArrowDown"){ ev.preventDefault(); setQty(readQty()-1); }
  });

  // --------- copy link ----------
  if(copyBtn){
    copyBtn.addEventListener("click", async () => {
      const url = String(window.location.href || "");
      try{
        await navigator.clipboard.writeText(url);
        toast("Listo", "Link copiado ‚úÖ");
        setLive("Link copiado al portapapeles.");
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = url;
        ta.style.position = "fixed"; ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); toast("Listo","Link copiado ‚úÖ"); setLive("Link copiado."); }catch(_){}
        document.body.removeChild(ta);
      }
    });
  }

  // --------- sticky buy bar (mobile) ----------
  const ioSupported = !!window.IntersectionObserver;
  const setSticky = (on) => {
    if(!sticky) return;
    sticky.style.display = on ? "block" : "none";
    sticky.setAttribute("aria-hidden", on ? "false" : "true");
  };
  if(stickyBtn && btn){
    stickyBtn.addEventListener("click", () => btn.click());
  }
  if(ioSupported && ctaRow && sticky){
    const io = new IntersectionObserver((entries) => {
      const e = entries && entries[0];
      if(!e) return;
      // si el CTA visible -> ocultar sticky
      setSticky(!e.isIntersecting);
    }, { threshold: 0.15 });
    io.observe(ctaRow);
  }

  // --------- add to cart ----------
  if(!btn) return;

  let inFlight = false;
  let controller = null;

  const setBusy = (on) => {
    btn.setAttribute("aria-busy", on ? "true" : "false");
    btn.disabled = !!on || btn.disabled; // respeta disabled por stock
    const t = btn.querySelector("[data-btn-text]");
    if(t && !btn.hasAttribute("data-disabled-stock")){
      t.textContent = on ? "Agregando‚Ä¶" : "Agregar al carrito";
    }
  };

  const pushAnalytics = (evt, payload) => {
    try{
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({ event: evt, ...payload });
    }catch(e){}
  };

  async function postAdd(){
    if(!pid){ window.location.href = fallbackCart; return; }

    const body = {
      id: pid,
      qty: readQty(),
      size: sizeSel ? (sizeSel.value || "") : "",
      color: colorSel ? (colorSel.value || "") : ""
    };

    const url = "/cart/add?json=1";

    const headers = { "Content-Type":"application/json", "Accept":"application/json" };
    const csrf = readCsrf();
    if(csrf) headers["X-CSRF-Token"] = csrf;

    // idempotency (si backend lo soporta)
    headers["X-Idempotency-Key"] = safeIdKey();

    // abort previous
    if(controller) try{ controller.abort(); }catch(e){}
    controller = ("AbortController" in window) ? new AbortController() : null;

    // apiPost global (si existe)
    if(window.apiPost){
      const res = await window.apiPost(url, body);
      return res;
    }

    const r = await fetch(url, {
      method: "POST",
      headers,
      credentials: "same-origin",
      body: JSON.stringify(body),
      signal: controller ? controller.signal : undefined
    });

    let j = {};
    try{ j = await r.json(); }catch(e){ j = {}; }

    if(!r.ok || (j && j.ok === false)){
      const msg = (j && j.error && j.error.message) || j.message || "No se pudo agregar al carrito";
      throw new Error(msg);
    }
    return j;
  }

  btn.addEventListener("click", async () => {
    // si est√° disabled por stock, no hacemos nada
    if(btn.disabled && btn.getAttribute("aria-busy") !== "true") return;

    if(inFlight) return;
    inFlight = true;
    setLive("");
    setBusy(true);

    try{
      await postAdd();

      toast("Listo", "Agregado al carrito ‚úÖ");
      setLive("Agregado al carrito.");

      pushAnalytics("add_to_cart", {
        product_id: pid,
        qty: readQty(),
        size: sizeSel ? sizeSel.value : "",
        color: colorSel ? colorSel.value : ""
      });

      // Refresh + open cart modal si existe
      try{
        if(window.SkylineCartModal){
          if(typeof window.SkylineCartModal.refresh === "function") await window.SkylineCartModal.refresh();
          if(typeof window.SkylineCartModal.open === "function") window.SkylineCartModal.open();
        } else if(window.CartStore && typeof window.CartStore.refresh === "function"){
          await window.CartStore.refresh();
        }
      }catch(e){}

      // Notificar al resto de la app
      try{ window.dispatchEvent(new CustomEvent("cart:updated")); }catch(e){}

    }catch(e){
      const msg = (e && e.message) ? e.message : "Error";
      toast("Ups", msg);
      setLive(msg);

      // fallback suave: llevar al carrito
      setTimeout(() => { window.location.href = fallbackCart; }, 650);
    }finally{
      // devolver disabled si era por stock
      if(!btn.hasAttribute("data-disabled-stock")) btn.disabled = false;
      setBusy(false);
      inFlight = false;
    }
  });

})();
</script>
{% endblock %}
