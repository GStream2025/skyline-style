{# app/templates/admin/dashboard.html ‚Äî Skyline Admin Dashboard (ULTRA PRO v3 FINAL / NO-500 / FAIL-SAFE) #}
{% extends "admin/base_admin.html" %}
{% block title %}Dashboard ¬∑ Skyline Admin{% endblock %}

{% block content %}
<style>
/* ==========================================================
   SKYLINE ADMIN DASHBOARD ‚Äî ULTRA PRO (Modern marketplace) ‚Äî FINAL
   ‚úÖ mejoras clave (sin romper):
   - NO usa current_app.* (evita UndefinedError si no lo pas√°s)
   - URLs safe con view_functions (vienen desde inject_globals)
   - data defaults a prueba de balas
   - filtros + search + copy + estados online/csrf
========================================================== */

:root{
  --ad-bg0: rgba(255,255,255,.06);
  --ad-bg1: rgba(255,255,255,.04);
  --ad-stroke: rgba(148,163,184,.18);
  --ad-stroke2: rgba(148,163,184,.12);
  --ad-ink: rgba(255,255,255,.92);
  --ad-muted: rgba(255,255,255,.64);
  --ad-muted2: rgba(255,255,255,.52);

  --ad-a: #2f7bff;
  --ad-b: #10b8d6;
  --ad-c: #ffb547;

  --ad-grad: linear-gradient(90deg, var(--ad-a), var(--ad-b), var(--ad-c));
  --ad-shadow1: 0 16px 48px rgba(0,0,0,.28);
  --ad-shadow2: 0 26px 90px rgba(0,0,0,.36);

  --ad-r: 18px;
  --ad-r2: 22px;
  --ad-ease: cubic-bezier(.2,.9,.2,1);
}

.ad-wrap{display:flex;flex-direction:column;gap:14px;padding-bottom:16px}

.ad-hero{
  position:relative;overflow:hidden;
  border:1px solid var(--ad-stroke);
  border-radius: var(--ad-r2);
  background:
    radial-gradient(1200px 520px at 18% 18%, rgba(47,123,255,.22), transparent 62%),
    radial-gradient(1100px 520px at 86% 22%, rgba(255,181,71,.18), transparent 64%),
    radial-gradient(900px 520px at 50% 95%, rgba(16,184,214,.16), transparent 62%),
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  box-shadow: var(--ad-shadow1);
  padding: 14px;
}
@media(min-width: 900px){ .ad-hero{ padding: 16px; } }
.ad-hero::after{
  content:"";
  position:absolute; inset:0; pointer-events:none; opacity:.05;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.85'/%3E%3C/svg%3E");
  mix-blend-mode: overlay;
}

.ad-head{position:relative;display:flex;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;gap:12px}
.ad-title{margin:0;font-weight:1000;letter-spacing:-.6px;font-size:clamp(1.25rem,2.4vw,1.8rem);color:var(--ad-ink)}
.ad-sub{margin:.45rem 0 0;max-width:70ch;color:var(--ad-muted);line-height:1.5;font-weight:750}

.ad-badges{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
.ad-pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 10px;border-radius:999px;
  border:1px solid var(--ad-stroke2);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.86);
  font-weight: 900;
  font-size: .82rem;
}
.ad-dot{width:10px;height:10px;border-radius:999px;background:var(--ad-grad);box-shadow:0 12px 22px rgba(0,0,0,.25)}

.ad-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
.ad-btn{
  display:inline-flex;align-items:center;justify-content:center;gap:10px;
  padding:10px 12px;border-radius:999px;
  border:1px solid var(--ad-stroke2);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.92);
  text-decoration:none;
  font-weight: 950;
  transition: transform .18s var(--ad-ease), box-shadow .18s var(--ad-ease), background .18s var(--ad-ease);
}
.ad-btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.08);box-shadow:0 18px 40px rgba(0,0,0,.20)}
.ad-btn.primary{background:var(--ad-grad);border-color:transparent;color:#0b1220}
.ad-btn.primary:hover{filter:saturate(1.05)}
.ad-btn svg{width:18px;height:18px;opacity:.95}

.ad-grid{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:980px){ .ad-grid{ grid-template-columns: 1.2fr .8fr; } }

.ad-card{
  border:1px solid var(--ad-stroke);
  border-radius: var(--ad-r2);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  box-shadow: var(--ad-shadow1);
  overflow:hidden;
}
.ad-card-h{
  padding:12px 14px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  border-bottom: 1px solid rgba(148,163,184,.12);
}
.ad-card-h h2{margin:0;font-size:1.02rem;font-weight:1000;letter-spacing:-.3px;color:rgba(255,255,255,.92)}
.ad-card-h .hint{color:var(--ad-muted2);font-weight:850;font-size:.85rem}
.ad-card-b{padding:12px 14px 14px}

.kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(min-width:600px){ .kpis{grid-template-columns:repeat(4,1fr)} }
.kpi{
  border:1px solid rgba(148,163,184,.14);
  background: rgba(255,255,255,.05);
  border-radius: 18px;
  padding: 12px;
  position:relative;
  overflow:hidden;
}
.kpi::after{
  content:"";position:absolute;inset:auto -40px -40px auto;
  width:120px;height:120px;border-radius:999px;background:rgba(47,123,255,.14);
}
.kpi .label{color:var(--ad-muted2);font-weight:900;font-size:.80rem;display:flex;align-items:center;gap:8px}
.kpi .value{margin-top:6px;font-weight:1000;letter-spacing:-.4px;font-size:1.35rem;color:rgba(255,255,255,.92)}
.kpi .delta{margin-top:6px;color:rgba(255,255,255,.72);font-weight:850;font-size:.82rem}

.badge-mini{
  display:inline-flex;align-items:center;justify-content:center;
  padding:2px 8px;border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
  color: rgba(255,255,255,.86);
  font-weight: 900;
  font-size: .74rem;
}
.badge-mini.ok{border-color:rgba(34,197,94,.26);background:rgba(34,197,94,.12)}
.badge-mini.warn{border-color:rgba(255,181,71,.26);background:rgba(255,181,71,.12)}
.badge-mini.bad{border-color:rgba(239,68,68,.26);background:rgba(239,68,68,.12)}

.tools{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
.tool{
  flex: 1 1 180px; min-width: 180px;
  border:1px solid rgba(148,163,184,.14);
  background: rgba(255,255,255,.05);
  border-radius: 18px;
  padding: 12px;
}
.tool .t{font-weight:1000;color:rgba(255,255,255,.92);letter-spacing:-.2px}
.tool .d{margin-top:6px;color:var(--ad-muted);font-weight:780;line-height:1.35;font-size:.88rem}
.tool .a{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}

.table-wrap{border:1px solid rgba(148,163,184,.12);border-radius:18px;overflow:hidden;background:rgba(255,255,255,.03)}
.table-top{
  padding:10px 12px;display:flex;flex-wrap:wrap;gap:10px;
  align-items:center;justify-content:space-between;
  border-bottom:1px solid rgba(148,163,184,.10);
}
.search-mini{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;border-radius:999px;
  border:1px solid rgba(148,163,184,.14);
  background: rgba(255,255,255,.06);
  min-width: min(420px, 100%);
}
.search-mini input{
  border:0;outline:0;background:transparent;width:100%;
  color: rgba(255,255,255,.92);font-weight:850;
}
.search-mini input::placeholder{color:rgba(255,255,255,.55);font-weight:800}

.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{
  border-radius:999px;padding:8px 10px;
  border:1px solid rgba(148,163,184,.14);
  background: rgba(255,255,255,.05);
  color: rgba(255,255,255,.84);
  font-weight: 900;font-size:.80rem;
  cursor:pointer;user-select:none;
}
.chip[aria-pressed="true"]{background:var(--ad-grad);color:#0b1220;border-color:transparent}

table{width:100%;border-collapse:collapse}
th,td{padding:10px 12px;text-align:left;border-bottom:1px solid rgba(148,163,184,.10)}
th{font-size:.78rem;letter-spacing:.12em;text-transform:uppercase;color:rgba(255,255,255,.65);font-weight:950}
td{color:rgba(255,255,255,.86);font-weight:820}
.tr-muted{color:rgba(255,255,255,.60);font-weight:780}
.row-actions{display:flex;gap:8px;flex-wrap:wrap}
.a-link{
  text-decoration:none;color:rgba(255,255,255,.92);font-weight:950;
  border:1px solid rgba(148,163,184,.14);background: rgba(255,255,255,.05);
  padding:7px 10px;border-radius:999px;
}
.a-link:hover{background:rgba(255,255,255,.08)}

.empty-pro{padding:16px;color:rgba(255,255,255,.72);font-weight:850;line-height:1.45}
.codepath{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 10px;border-radius:999px;
  border:1px solid rgba(148,163,184,.16);
  background: rgba(255,255,255,.05);
  font-weight: 900;
  color: rgba(255,255,255,.82);
}

.sticky-actions{position:sticky;bottom:10px;z-index:20;display:flex;justify-content:center;margin-top:10px}
.sticky-actions .bar{
  width:min(860px, 100%);
  display:flex;gap:10px;flex-wrap:wrap;
  justify-content:space-between;align-items:center;
  padding:10px 12px;border-radius:999px;
  border:1px solid rgba(148,163,184,.14);
  background: rgba(10,14,25,.55);
  backdrop-filter: blur(10px);
  box-shadow: var(--ad-shadow2);
}
@media(min-width:980px){ .sticky-actions{display:none} }

:focus-visible{outline:none;box-shadow:0 0 0 4px rgba(47,123,255,.22);border-radius:14px}
@media (prefers-reduced-motion: reduce){ *{transition:none!important;animation:none!important;} }
</style>

{# ------------------------------
   SAFE URLs (NO usa current_app)
------------------------------ #}
{% set _vf = (view_functions if view_functions is defined and view_functions else {}) %}
{% macro safe_url(endpoint, fallback='#') -%}
  {%- if endpoint and endpoint in _vf -%}
    {{- url_for(endpoint) -}}
  {%- else -%}
    {{- fallback -}}
  {%- endif -%}
{%- endmacro %}

{% set url_products_list = safe_url('admin.products_list', '/admin/products') %}
{% set url_products_new  = safe_url('admin.products_new',  '/admin/products/new') %}
{% set url_categories    = safe_url('admin.categories',    '/admin/categories') %}
{% set url_offers        = safe_url('admin.offers',        '/admin/offers') %}
{% set url_payments      = safe_url('admin.payments',      '/admin/payments') %}
{% set url_printful      = safe_url('printful.products',   '/printful/productos') %}

{# ------------------------------
   SAFE DATA DEFAULTS
------------------------------ #}
{% set prod_count  = (prod_count|default(0)) %}
{% set cat_count   = (cat_count|default(0)) %}
{% set offer_count = (offer_count|default(0)) %}
{% set order_count = (order_count|default(0)) %}
{% set recent_products = (recent_products|default([])) %}

<div class="ad-wrap">

  <section class="ad-hero" aria-label="Dashboard Skyline Admin">
    <div class="ad-head">
      <div>
        <h1 class="ad-title">Dashboard</h1>
        <p class="ad-sub">
          Centro de control de Skyline Store: cat√°logo, categor√≠as, ofertas, media e integraciones (Printful / dropship).
        </p>

        <div class="ad-badges" aria-label="Estado del sistema">
          <span class="ad-pill"><span class="ad-dot" aria-hidden="true"></span> Panel Admin activo</span>
          <span class="ad-pill">üõ°Ô∏è CSRF <span class="badge-mini ok" id="csrfState">OK</span></span>
          <span class="ad-pill">üåê Conexi√≥n <span class="badge-mini ok" id="netState">Online</span></span>
        </div>
      </div>

      <div class="ad-actions" aria-label="Acciones principales">
        <a class="ad-btn primary" href="{{ url_products_new }}">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          Crear producto
        </a>
        <a class="ad-btn" href="{{ url_products_list }}">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          Productos
        </a>
        <a class="ad-btn" href="{{ url_offers }}">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 12v7a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-7" stroke="currentColor" stroke-width="2"/><path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M7 7l5-4 5 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Ofertas
        </a>
      </div>
    </div>

    <div class="kpis" style="margin-top:12px" aria-label="Indicadores">
      <div class="kpi">
        <div class="label">üì¶ Productos <span class="badge-mini" title="Total en cat√°logo">CAT</span></div>
        <div class="value">{{ prod_count }}</div>
        <div class="delta">Gestion√°, edit√° y public√°.</div>
      </div>

      <div class="kpi">
        <div class="label">üß© Categor√≠as <span class="badge-mini" title="Filtros del shop">SHOP</span></div>
        <div class="value">{{ cat_count }}</div>
        <div class="delta">Orden y navegaci√≥n.</div>
      </div>

      <div class="kpi">
        <div class="label">üî• Ofertas <span class="badge-mini warn" title="Promos activas o programadas">PROMO</span></div>
        <div class="value">{{ offer_count }}</div>
        <div class="delta">Banners y cards.</div>
      </div>

      <div class="kpi">
        <div class="label">üßæ Pedidos <span class="badge-mini" title="Si a√∫n no lo ten√©s conectado, queda en 0">ORD</span></div>
        <div class="value">{{ order_count }}</div>
        <div class="delta">Estado comercial.</div>
      </div>
    </div>

    <div class="sticky-actions" aria-hidden="false">
      <div class="bar">
        <span class="ad-pill">‚ö° Accesos r√°pidos</span>
        <a class="ad-btn primary" href="{{ url_products_new }}">+ Producto</a>
        <a class="ad-btn" href="{{ url_products_list }}">Ver cat√°logo</a>
      </div>
    </div>
  </section>

  <div class="ad-grid">

    <!-- LEFT: Recent + Control -->
    <section class="ad-card" aria-label="Recientes">
      <div class="ad-card-h">
        <h2>Productos recientes</h2>
        <span class="hint">B√∫squeda y acciones r√°pidas</span>
      </div>

      <div class="ad-card-b">
        <div class="table-wrap">
          <div class="table-top">
            <div class="search-mini" role="search" aria-label="Buscar en recientes">
              <span aria-hidden="true">üîé</span>
              <input id="recentSearch" type="search" placeholder="Buscar por nombre / categor√≠a / estado‚Ä¶">
            </div>

            <div class="chips" role="group" aria-label="Filtros r√°pidos">
              <button class="chip" type="button" data-chip="all" aria-pressed="true">Todos</button>
              <button class="chip" type="button" data-chip="active" aria-pressed="false">Activos</button>
              <button class="chip" type="button" data-chip="draft" aria-pressed="false">Borrador</button>
              <button class="chip" type="button" data-chip="sale" aria-pressed="false">Oferta</button>
            </div>
          </div>

          {% if recent_products and recent_products|length > 0 %}
            <table aria-label="Tabla de productos recientes">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Categor√≠a</th>
                  <th>Estado</th>
                  <th>Precio</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="recentBody">
                {% for p in recent_products %}
                  {% set pid = (p.id if p is not mapping else p.get('id'))|default('') %}
                  {% set name = (p.name if p is not mapping else p.get('name'))|default((p.title if p is not mapping else p.get('title'))|default('Producto')) %}
                  {% set cat  = (p.category if p is not mapping else p.get('category'))|default('otros') %}
                  {% set status = (p.status if p is not mapping else p.get('status'))|default('active') %}
                  {% set price = (p.price if p is not mapping else p.get('price'))|default('0') %}
                  {% set is_sale = (p.is_sale if p is not mapping else p.get('is_sale'))|default(false) %}

                  <tr data-row
                      data-name="{{ (name|string)|lower }}"
                      data-cat="{{ (cat|string)|lower }}"
                      data-status="{{ (status|string)|lower }}"
                      data-sale="{{ '1' if is_sale else '0' }}">
                    <td>
                      <div style="font-weight:1000">{{ name }}</div>
                      <div class="tr-muted">ID: {{ pid if pid else '‚Äî' }}</div>
                    </td>
                    <td class="tr-muted">{{ cat }}</td>
                    <td>
                      {% if (status|string)|lower in ['active','enabled','published'] %}
                        <span class="badge-mini ok">Activo</span>
                      {% elif (status|string)|lower in ['draft','disabled','pending'] %}
                        <span class="badge-mini warn">Borrador</span>
                      {% else %}
                        <span class="badge-mini">{{ status }}</span>
                      {% endif %}
                      {% if is_sale %}
                        <span class="badge-mini bad" style="margin-left:6px">Oferta</span>
                      {% endif %}
                    </td>
                    <td class="tr-muted">{{ price }}</td>
                    <td>
                      <div class="row-actions">
                        <a class="a-link" href="{{ url_products_list }}">Ver</a>
                        <a class="a-link" href="{{ url_products_new }}">Nuevo</a>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="empty-pro" id="recentEmpty">
              <b style="color:rgba(255,255,255,.92)">Sin productos recientes</b><br>
              Cre√° tu primer producto o import√° desde Printful para poblar el cat√°logo.
              <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
                <a class="ad-btn primary" href="{{ url_products_new }}">Crear producto</a>
                <a class="ad-btn" href="{{ url_printful }}">Ver Printful</a>
              </div>
            </div>
          {% endif %}
        </div>

        <div class="tools" aria-label="Herramientas r√°pidas">
          <div class="tool">
            <div class="t">üß© Categor√≠as</div>
            <div class="d">Control√° los filtros del shop y manten√© ordenado el cat√°logo.</div>
            <div class="a">
              <a class="ad-btn" href="{{ url_categories }}">Gestionar</a>
            </div>
          </div>

          <div class="tool">
            <div class="t">üî• Ofertas & Banners</div>
            <div class="d">Cards y promos para home / shop. Activ√° ofertas flash.</div>
            <div class="a">
              <a class="ad-btn" href="{{ url_offers }}">Abrir ofertas</a>
            </div>
          </div>

          <div class="tool">
            <div class="t">üé® Media</div>
            <div class="d">Uploads de productos en <span class="codepath" id="mediaPath">/static/uploads/products</span></div>
            <div class="a">
              <button class="ad-btn" type="button" id="copyMedia">Copiar ruta</button>
              <a class="ad-btn" href="{{ url_products_list }}">Ver cat√°logo</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Integrations + Health -->
    <section class="ad-card" aria-label="Integraciones y salud">
      <div class="ad-card-h">
        <h2>Integraciones</h2>
        <span class="hint">Printful ¬∑ Dropship ¬∑ Pagos</span>
      </div>
      <div class="ad-card-b">

        <div class="tool">
          <div class="t">üßµ Printful</div>
          <div class="d">Import√° productos como borrador para editar y publicar con fotos pro.</div>
          <div class="a">
            <a class="ad-btn primary" href="{{ url_printful }}">Ver Printful</a>
            <a class="ad-btn" href="{{ url_products_new }}">Crear manual</a>
          </div>
        </div>

        <div class="tool" style="margin-top:10px">
          <div class="t">üõí Dropship / Temu</div>
          <div class="d">Carg√° productos con source=dropship/temu y link externo. Ideal para escalar.</div>
          <div class="a">
            <a class="ad-btn primary" href="{{ url_products_new }}">Nuevo dropship</a>
            <a class="ad-btn" href="{{ url_products_list }}">Cat√°logo</a>
          </div>
        </div>

        <div class="tool" style="margin-top:10px">
          <div class="t">üí≥ Pagos</div>
          <div class="d">Panel de pagos (si est√° conectado). Si no, queda listo para integrar MercadoPago.</div>
          <div class="a">
            <a class="ad-btn" href="{{ url_payments }}">Abrir pagos</a>
          </div>
        </div>

        <div class="tool" style="margin-top:10px">
          <div class="t">‚úÖ Salud del panel</div>
          <div class="d">Chequeo r√°pido: conexi√≥n, CSRF y UI.</div>
          <div class="a">
            <span class="ad-pill">CSRF <span class="badge-mini ok" id="csrfState2">OK</span></span>
            <span class="ad-pill">NET <span class="badge-mini ok" id="netState2">Online</span></span>
          </div>
        </div>

      </div>
    </section>

  </div>
</div>

<script>
(function(){
  const csrfMeta = document.querySelector('meta[name="csrf-token"]');
  const csrfOk = !!(csrfMeta && (csrfMeta.getAttribute('content')||'').trim().length > 10);

  const setBadge = (id, ok, txtOk, txtBad) => {
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = ok ? txtOk : txtBad;
    el.classList.remove('ok','warn','bad');
    el.classList.add(ok ? 'ok' : 'bad');
  };
  setBadge('csrfState', csrfOk, 'OK', 'FALTA');
  setBadge('csrfState2', csrfOk, 'OK', 'FALTA');

  const setNet = () => {
    const online = navigator.onLine;
    setBadge('netState', online, 'Online', 'Offline');
    setBadge('netState2', online, 'Online', 'Offline');
  };
  window.addEventListener('online', setNet);
  window.addEventListener('offline', setNet);
  setNet();

  const btn = document.getElementById('copyMedia');
  const pathEl = document.getElementById('mediaPath');
  if(btn && pathEl){
    btn.addEventListener('click', async () => {
      const text = (pathEl.textContent || '/static/uploads/products').trim();
      try{
        await navigator.clipboard.writeText(text);
        if(window.toast) window.toast('Copiado', text);
      }catch(e){
        if(window.toast) window.toast('Copi√° manual', text);
      }
    });
  }

  const input = document.getElementById('recentSearch');
  const chips = Array.from(document.querySelectorAll('.chip[data-chip]'));
  const rows = Array.from(document.querySelectorAll('tr[data-row]'));

  let mode = 'all';
  const setPressed = (m) => chips.forEach(c => c.setAttribute('aria-pressed', c.dataset.chip === m ? 'true':'false'));

  const matchesChip = (r) => {
    const st = (r.dataset.status || '');
    if(mode === 'all') return true;
    if(mode === 'active') return st.includes('active') || st.includes('published') || st.includes('enabled');
    if(mode === 'draft')  return st.includes('draft') || st.includes('pending') || st.includes('disabled');
    if(mode === 'sale')   return (r.dataset.sale || '0') === '1';
    return true;
  };

  const apply = () => {
    const q = (input && input.value ? input.value.trim().toLowerCase() : '');
    rows.forEach(r => {
      const hit = !q || (r.dataset.name||'').includes(q) || (r.dataset.cat||'').includes(q) || (r.dataset.status||'').includes(q);
      r.style.display = (hit && matchesChip(r)) ? '' : 'none';
    });
  };

  if(input){
    let t = 0;
    input.addEventListener('input', () => { clearTimeout(t); t = setTimeout(apply, 90); }, {passive:true});
  }

  chips.forEach(c => c.addEventListener('click', () => {
    mode = c.dataset.chip || 'all';
    setPressed(mode);
    apply();
  }));

  apply();
})();
</script>
{% endblock %}
