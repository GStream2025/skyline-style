{# app/templates/admin/payments.html ‚Äî Skyline Admin Payments (ULTRA PRO MAX / FINAL / NO BREAK) #}
{% extends "admin/base_admin.html" %}
{% block title %}Pagos ¬∑ Skyline Admin{% endblock %}

{% block extra_head %}
<style>
  /* =========================================================
    Skyline Admin ¬∑ Payments (ULTRA PRO MAX)
    Mejoras (30+ reales):
    1) Accesibilidad: focus visible, aria-live, labels/ids consistentes
    2) Soporte reduce-motion
    3) Mejor sem√°ntica: main/section/fieldset
    4) Mejor validaci√≥n client: number/url/email con patrones y clamp
    5) Debounce de b√∫squeda
    6) Ctrl/Cmd+K
    7) Guardado AJAX robusto + fallback
    8) Manejo de errores 419/403/HTML redirect
    9) Dirty tracking por card + reset al guardar
    10) ‚ÄúGuardar todo‚Äù global + ‚ÄúReset‚Äù por card
    11) ‚ÄúCopiar‚Äù para campos url/email
    12) ‚ÄúAbrir link‚Äù si es URL
    13) Resumen real de activos/listos/incompletos leyendo data-ready
    14) Indicador ‚ÄúRecomendado‚Äù visible
    15) Mejor contraste light/dark
    16) M√°s tolerante con decimales (fee/min/max)
    17) Toast con tipos y auto-close controlado
    18) Mensajes inline sin romper layout
    19) Evita enviar Enter en search
    20) Evita doble submit
    21) Updates ‚Äú√öltima actualizaci√≥n‚Äù desde respuesta
    22) Resalta errores backend (si vienen)
    23) Maneja schema vac√≠o sin ‚Äúromper‚Äù
    24) Mantiene estado por proveedor (data-enabled/data-ready)
    25) Anti XSS b√°sico: |e en valores impresos
    26) Mejor UX en m√≥viles (min-width, grid adaptativo)
    27) Mejoras de estilo: sombras, pills, estados
    28) Bot√≥n ‚ÄúVer checkout‚Äù + ‚ÄúGuardar todo‚Äù
    29) Evita toast spam (cola simple)
    30) No depende de librer√≠as
  ========================================================= */

  :root{
    --p-bg: rgba(255,255,255,.05);
    --p-bd: rgba(148,163,184,.16);
    --p-bd2: rgba(148,163,184,.22);
    --p-tx: rgba(226,232,240,.92);
    --p-muted: rgba(226,232,240,.72);
    --p-shadow: 0 16px 40px rgba(0,0,0,.18);
    --p-r: 18px;
    --p-r2: 14px;

    --ok: rgba(34,197,94,.90);
    --ok-bg: rgba(34,197,94,.10);
    --warn: rgba(245,158,11,.92);
    --warn-bg: rgba(245,158,11,.10);
    --bad: rgba(239,68,68,.92);
    --bad-bg: rgba(239,68,68,.10);
    --info: rgba(56,189,248,.92);
    --info-bg: rgba(56,189,248,.10);

    --focus: 0 0 0 4px rgba(56,189,248,.16);
  }
  :root[data-theme="light"]{
    --p-bg: rgba(0,0,0,.02);
    --p-bd: rgba(2,6,23,.10);
    --p-bd2: rgba(2,6,23,.14);
    --p-tx: rgba(2,6,23,.92);
    --p-muted: rgba(2,6,23,.68);
    --p-shadow: 0 14px 30px rgba(0,0,0,.08);

    --ok-bg: rgba(34,197,94,.08);
    --warn-bg: rgba(245,158,11,.08);
    --bad-bg: rgba(239,68,68,.08);
    --info-bg: rgba(37,99,235,.06);
    --focus: 0 0 0 4px rgba(37,99,235,.14);
  }

  @media (prefers-reduced-motion: reduce){
    *{ scroll-behavior:auto !important; transition:none !important; animation:none !important; }
  }

  /* ---- Layout header ---- */
  .pay-wrap{ display:block; }
  .pay-head{
    display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;
    margin-bottom:14px;
  }
  .pay-title{
    margin:.2rem 0 0;
    font-weight:1000;
    letter-spacing:-.6px;
    line-height:1.1;
  }
  .pay-sub{ margin:.45rem 0 0; max-width:80ch; color: var(--p-muted); line-height:1.55; }

  .pay-tools{
    display:flex;align-items:center;gap:10px;flex-wrap:wrap; justify-content:flex-end;
  }
  .mini{
    padding:8px 10px;border-radius:12px;
    border:1px dashed var(--p-bd2);
    background: rgba(255,255,255,.04);
    color: var(--p-muted);
    opacity:.95;
    font-size:.92rem;
  }
  :root[data-theme="light"] .mini{ background: rgba(0,0,0,.02); }

  .search{
    display:flex;align-items:center;gap:8px;
    border:1px solid var(--p-bd);
    background: rgba(255,255,255,.04);
    border-radius: 999px;
    padding: 8px 12px;
    min-width: min(420px, 92vw);
  }
  :root[data-theme="light"] .search{ background: rgba(0,0,0,.02); }
  .search input{
    width:100%;
    border:0; outline:0; background: transparent;
    color: var(--p-tx);
    font-weight:800;
  }
  .search input::placeholder{ color: var(--p-muted); font-weight:800; opacity:.8; }

  .top-actions{
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    justify-content:flex-end;
  }
  .btn-ghost{
    display:inline-flex;gap:8px;align-items:center;
    border-radius: 12px;
    border:1px solid var(--p-bd2);
    background: rgba(255,255,255,.06);
    padding: 9px 12px;
    font-weight:1000;
    color: var(--p-tx);
    cursor:pointer;
    text-decoration:none;
    user-select:none;
  }
  .btn-ghost:active{ transform: translateY(1px); }
  .btn-ghost:focus{ outline:none; box-shadow: var(--focus); }

  /* ---- Grid + cards ---- */
  .pay-grid{
    display:grid;
    grid-template-columns: 1fr;
    gap:14px;
  }
  @media(min-width:980px){ .pay-grid{ grid-template-columns: 1fr 1fr; } }

  .card{
    border:1px solid var(--p-bd);
    border-radius: var(--p-r);
    padding:14px;
    background: var(--p-bg);
    box-shadow: var(--p-shadow);
    position: relative;
    overflow:hidden;
  }
  .card::before{
    content:"";
    position:absolute; inset:-2px;
    background: radial-gradient(900px 260px at 15% -10%, rgba(56,189,248,.18), transparent 55%),
                radial-gradient(900px 260px at 90% 0%, rgba(34,197,94,.14), transparent 55%);
    opacity:.55;
    pointer-events:none;
  }
  :root[data-theme="light"] .card::before{
    opacity:.35;
    background: radial-gradient(900px 260px at 15% -10%, rgba(37,99,235,.12), transparent 55%),
                radial-gradient(900px 260px at 90% 0%, rgba(34,197,94,.10), transparent 55%);
  }

  .card-inner{ position:relative; z-index:1; }

  .card-top{
    display:flex;justify-content:space-between;align-items:flex-start;gap:10px;
    margin-bottom:10px;
  }
  .card-title{
    display:flex;align-items:center;gap:10px;
    font-weight:1000;letter-spacing:-.3px;
    color: var(--p-tx);
  }
  .card-ic{
    width:36px;height:36px;border-radius:12px;
    display:grid;place-items:center;
    background: rgba(255,255,255,.08);
    border:1px solid var(--p-bd2);
  }
  :root[data-theme="light"] .card-ic{ background: rgba(0,0,0,.03); }

  .card-desc{ margin:0; color: var(--p-muted); line-height:1.55; }

  /* ---- Status pill ---- */
  .pill-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px; }
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    border-radius:999px;
    padding:6px 10px;
    border:1px solid var(--p-bd2);
    background: rgba(255,255,255,.04);
    color: var(--p-muted);
    font-weight:900;
    font-size:.86rem;
    user-select:none;
  }
  .pill .dot{ width:10px;height:10px;border-radius:999px; background: rgba(148,163,184,.55); }
  .pill.ok{ border-color: rgba(34,197,94,.35); background: var(--ok-bg); color: var(--p-tx); }
  .pill.ok .dot{ background: var(--ok); }
  .pill.warn{ border-color: rgba(245,158,11,.35); background: var(--warn-bg); color: var(--p-tx); }
  .pill.warn .dot{ background: var(--warn); }
  .pill.bad{ border-color: rgba(239,68,68,.35); background: var(--bad-bg); color: var(--p-tx); }
  .pill.bad .dot{ background: var(--bad); }
  .pill.info{ border-color: rgba(56,189,248,.35); background: var(--info-bg); color: var(--p-tx); }
  .pill.info .dot{ background: var(--info); }

  /* ---- Toggle ---- */
  .toggle{
    display:inline-flex;align-items:center;gap:10px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid var(--p-bd2);
    background: rgba(255,255,255,.06);
    font-weight:1000;
    white-space:nowrap;
    color: var(--p-tx);
    user-select:none;
  }
  :root[data-theme="light"] .toggle{ background: rgba(0,0,0,.02); }

  .switch{ position:relative;width:46px;height:26px;flex:0 0 auto; display:inline-block; }
  .switch input{ display:none; }
  .track{
    position:absolute;inset:0;border-radius:999px;
    background: rgba(148,163,184,.25);
    transition: all .18s ease;
    border:1px solid var(--p-bd2);
  }
  .thumb{
    position:absolute;top:3px;left:3px;
    width:20px;height:20px;border-radius:999px;
    background: rgba(255,255,255,.92);
    transition: all .18s ease;
    box-shadow: 0 8px 18px rgba(0,0,0,.25);
  }
  .switch input:checked + .track{
    background: rgba(34,197,94,.26);
    border-color: rgba(34,197,94,.35);
  }
  .switch input:checked + .track .thumb{ left:23px; }

  /* ---- Form fields ---- */
  .fields{ display:grid; gap:10px; margin-top:12px; }
  .fields label{ font-weight:1000; color: var(--p-tx); }
  .fields input, .fields textarea, .fields select{
    width:100%;
    border-radius: 14px;
    border:1px solid var(--p-bd);
    background: rgba(255,255,255,.03);
    color: var(--p-tx);
    padding: 10px 12px;
    outline: none;
    transition: box-shadow .15s ease, border-color .15s ease, transform .05s ease;
  }
  :root[data-theme="light"] .fields input,
  :root[data-theme="light"] .fields textarea,
  :root[data-theme="light"] .fields select{ background: rgba(0,0,0,.02); }

  .fields textarea{ min-height: 98px; resize: vertical; }
  .fields input:focus, .fields textarea:focus, .fields select:focus{
    border-color: rgba(56,189,248,.40);
    box-shadow: var(--focus);
  }

  .hint{
    font-size:.9rem;
    color: var(--p-muted);
    margin-top:6px;
    line-height:1.45;
  }

  .invalid{
    border-color: rgba(239,68,68,.55) !important;
    box-shadow: 0 0 0 4px rgba(239,68,68,.14) !important;
  }

  .inline-msg{
    margin-top:8px;
    border:1px solid var(--p-bd2);
    background: rgba(255,255,255,.04);
    border-radius: 14px;
    padding: 10px 12px;
    color: var(--p-muted);
    line-height:1.45;
  }
  .inline-msg.bad{ border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.07); color: var(--p-tx); }
  .inline-msg.ok{ border-color: rgba(34,197,94,.30); background: rgba(34,197,94,.07); color: var(--p-tx); }

  /* ---- Provider actions ---- */
  .card-actions{
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    margin-top:12px;
  }
  .btn-save-mini{
    display:inline-flex;gap:8px;align-items:center;
    border-radius: 12px;
    border:1px solid var(--p-bd2);
    background: rgba(255,255,255,.06);
    padding: 9px 12px;
    font-weight:1000;
    color: var(--p-tx);
    cursor:pointer;
  }
  .btn-save-mini:active{ transform: translateY(1px); }
  .btn-save-mini[disabled]{ opacity:.6; cursor:not-allowed; }

  .btn-mini2{
    display:inline-flex;gap:8px;align-items:center;
    border-radius: 12px;
    border:1px solid var(--p-bd2);
    background: rgba(255,255,255,.03);
    padding: 9px 12px;
    font-weight:1000;
    color: var(--p-tx);
    cursor:pointer;
  }

  .muted-line{ color: var(--p-muted); font-weight:900; font-size:.92rem; }

  /* ---- Footer actions ---- */
  .safe-note{
    margin-top:12px;
    border:1px solid rgba(56,189,248,.28);
    background: var(--info-bg);
    border-radius: 16px;
    padding: 12px;
    color: var(--p-tx);
    opacity: .98;
  }

  .actions{
    display:flex;gap:10px;flex-wrap:wrap;
    margin-top:14px;
    align-items:center;
  }

  /* ---- Toast ---- */
  .toast{
    position: fixed;
    right: 16px;
    bottom: 16px;
    width: min(420px, calc(100vw - 32px));
    border-radius: 16px;
    border:1px solid var(--p-bd2);
    background: rgba(2,6,23,.82);
    color: rgba(226,232,240,.96);
    padding: 12px 12px;
    box-shadow: 0 18px 55px rgba(0,0,0,.35);
    display:none;
    z-index: 9999;
    backdrop-filter: blur(10px);
  }
  :root[data-theme="light"] .toast{
    background: rgba(255,255,255,.86);
    color: rgba(2,6,23,.92);
    box-shadow: 0 16px 44px rgba(0,0,0,.16);
  }
  .toast.show{ display:block; }
  .toast .trow{ display:flex; gap:10px; align-items:flex-start; }
  .toast .ticon{ width:28px;height:28px;border-radius:10px; display:grid;place-items:center; flex:0 0 auto; border:1px solid var(--p-bd2); background: rgba(255,255,255,.04); }
  .toast .ttitle{ font-weight:1000; margin:0; }
  .toast .tmsg{ margin:2px 0 0; color: var(--p-muted); line-height:1.45; }
  .toast .tx{ margin-left:auto; border:0; background:transparent; color: inherit; font-weight:1000; cursor:pointer; }

  .svg{ width:18px;height:18px; display:block; }

  /* util */
  .sr-only{
    position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
  }
</style>
{% endblock %}

{% block content %}
<main class="pay-wrap" aria-label="Configuraci√≥n de pagos">
  <header class="pay-head">
    <div>
      <h1 class="pay-title">Pagos</h1>
      <p class="pay-sub">
        Activ√° m√©todos de cobro y complet√° los datos. El checkout mostrar√° solo lo que est√© <b>Activo</b> y <b>Listo</b>.
      </p>

      <div class="pill-row" aria-label="Resumen de m√©todos">
        <span class="pill" id="pillCount"><span class="dot"></span> <span>0 activos</span></span>
        <span class="pill ok" id="pillReady"><span class="dot"></span> <span>0 listos</span></span>
        <span class="pill warn" id="pillNeeds"><span class="dot"></span> <span>0 incompletos</span></span>
      </div>
    </div>

    <div class="pay-tools">
      <div class="search" role="search" aria-label="Buscar m√©todo">
        <span aria-hidden="true">üîé</span>
        <input id="q" type="search" placeholder="Buscar: mp, paypal, wise, transferencia‚Ä¶" autocomplete="off" />
      </div>

      <div class="top-actions">
        <button type="button" class="btn-ghost" id="btnSaveAll" title="Guardar todos los cambios">
          üíæ Guardar todo
        </button>
        <button type="button" class="btn-ghost" id="btnShowOnlyActive" title="Alternar ver solo activos">
          ‚úÖ Solo activos
        </button>
        <div class="mini" title="Regla de oro">
          üîí Peg√° links p√∫blicos / instrucciones ¬∑ No pegues tokens/secretos
        </div>
      </div>
    </div>
  </header>

  <div class="pay-grid" id="grid">
    {% for p in providers %}
      {% set code = p.code %}
      {% set enabled = p.enabled %}
      {% set ready = p.ready if p.ready is defined else false %}
      {% set errors = p.errors if p.errors is defined else [] %}
      {% set schema = p.schema if p.schema is defined else [] %}

      <section class="card pay-card"
               data-code="{{ code|e }}"
               data-name="{{ (p.name or code)|lower|e }}"
               data-enabled="{{ '1' if enabled else '0' }}"
               data-ready="{{ '1' if ready else '0' }}"
               aria-label="M√©todo {{ (p.name or code)|e }}">
        <div class="card-inner">
          <div class="card-top">
            <div style="min-width:0">
              <div class="card-title">
                <span class="card-ic" aria-hidden="true">
                  <svg class="svg" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Z" stroke="currentColor" stroke-width="2" opacity=".8"/>
                    <path d="M7.5 12c1.2-2.4 2.8-3.6 4.5-3.6S15.3 9.6 16.5 12c-1.2 2.4-2.8 3.6-4.5 3.6S8.7 14.4 7.5 12Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round" opacity=".9"/>
                  </svg>
                </span>
                <span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                  {{ (p.name or code)|e }}
                </span>
                {% if p.recommended %}
                  <span class="pill info" title="M√©todo recomendado">
                    <span class="dot"></span> Recomendado
                  </span>
                {% endif %}
              </div>

              <p class="card-desc">
                C√≥digo: <b>{{ code|e }}</b>
                {% if p.country %} ¬∑ Pa√≠s: <b>{{ p.country|e }}</b>{% endif %}
                {% if p.kind %} ¬∑ Tipo: <b>{{ p.kind|e }}</b>{% endif %}
              </p>

              <div class="pill-row" aria-label="Estado del m√©todo">
                {% if enabled and ready %}
                  <span class="pill ok"><span class="dot"></span> Listo para checkout</span>
                {% elif enabled and not ready %}
                  <span class="pill warn"><span class="dot"></span> Activo pero incompleto</span>
                {% else %}
                  <span class="pill"><span class="dot"></span> Desactivado</span>
                {% endif %}

                {% if errors and errors|length %}
                  <span class="pill bad" title="{{ errors|join(' | ')|e }}"><span class="dot"></span> {{ errors|length }} faltantes</span>
                {% endif %}
              </div>
            </div>

            <label class="toggle" title="Activar m√©todo" aria-label="Activar {{ code|e }}">
              <span>Activo</span>
              <span class="switch">
                <input type="checkbox" class="js-enabled" {% if enabled %}checked{% endif %} aria-label="Toggle activo">
                <span class="track"><span class="thumb"></span></span>
              </span>
            </label>
          </div>

          <form class="js-form" method="post"
                action="{{ url_for('admin_payments.admin_payments_save', code=code) }}"
                novalidate
                data-code="{{ code|e }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="enabled" value="0">
            <input type="hidden" name="recommended" value="{{ '1' if p.recommended else '0' }}">

            <fieldset class="fields" aria-label="Configuraci√≥n {{ code|e }}">
              <div style="display:grid;gap:10px;grid-template-columns: 1fr; align-items:end;">
                <div style="display:grid;gap:10px;grid-template-columns: 1fr 1fr;">
                  <div>
                    <label for="{{ code }}__sort_order">Orden</label>
                    <input id="{{ code }}__sort_order"
                           name="sort_order"
                           value="{{ (p.sort_order if p.sort_order is not none else 100)|e }}"
                           type="number"
                           inputmode="numeric"
                           min="-9999"
                           max="9999"
                           step="1"
                           placeholder="10">
                    <div class="hint">Menor = m√°s arriba en checkout.</div>
                  </div>
                  <div>
                    <label for="{{ code }}__recommended">Recomendado</label>
                    <select id="{{ code }}__recommended" name="recommended" class="js-recommended">
                      <option value="0" {% if not p.recommended %}selected{% endif %}>No</option>
                      <option value="1" {% if p.recommended %}selected{% endif %}>S√≠</option>
                    </select>
                    <div class="hint">Solo si est√° <b>Activo</b>.</div>
                  </div>
                </div>
              </div>

              <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr;">
                <div>
                  <label for="{{ code }}__fee_percent">Fee % (info)</label>
                  <input id="{{ code }}__fee_percent"
                         name="fee_percent"
                         value="{{ (p.fee_percent if p.fee_percent is not none else 0)|e }}"
                         type="number"
                         inputmode="decimal"
                         min="0"
                         max="99"
                         step="0.01"
                         placeholder="0">
                  <div class="hint">Solo informativo (no cobra).</div>
                </div>
                <div>
                  <label for="{{ code }}__eta_minutes">ETA (min)</label>
                  <input id="{{ code }}__eta_minutes"
                         name="eta_minutes"
                         value="{{ (p.eta_minutes if p.eta_minutes is not none else 0)|e }}"
                         type="number"
                         inputmode="numeric"
                         min="0"
                         max="999999"
                         step="1"
                         placeholder="0">
                  <div class="hint">Tiempo de confirmaci√≥n estimado.</div>
                </div>
              </div>

              <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr;">
                <div>
                  <label for="{{ code }}__min_amount">M√≠nimo</label>
                  <input id="{{ code }}__min_amount"
                         name="min_amount"
                         value="{{ (p.min_amount if p.min_amount is not none else 0)|e }}"
                         type="number"
                         inputmode="decimal"
                         min="0"
                         step="0.01"
                         placeholder="0">
                </div>
                <div>
                  <label for="{{ code }}__max_amount">M√°ximo (0 = sin)</label>
                  <input id="{{ code }}__max_amount"
                         name="max_amount"
                         value="{{ (p.max_amount if p.max_amount is not none else 0)|e }}"
                         type="number"
                         inputmode="decimal"
                         min="0"
                         step="0.01"
                         placeholder="0">
                </div>
              </div>

              <div>
                <label for="{{ code }}__notes">Notas (opcional)</label>
                <input id="{{ code }}__notes"
                       name="notes"
                       value="{{ (p.notes or '')|e }}"
                       placeholder="Ej: cuotas, QR, horarios, condiciones..."
                       autocomplete="off"
                       maxlength="500">
                <div class="hint">Se muestra como ayuda en checkout (si lo quer√©s).</div>
              </div>

              {% if schema and schema|length %}
                <div style="border-top:1px solid var(--p-bd); padding-top:10px; margin-top:2px;">
                  <div class="muted-line">Configuraci√≥n del m√©todo</div>
                  <div class="hint">Complet√° lo obligatorio. Lo sensible se guarda enmascarado en el admin.</div>
                </div>

                {% for f in schema %}
                  {% set k = f.key %}
                  {% set typ = (f.type or 'text') %}
                  {% set req = f.required %}
                  {% set val = '' %}
                  {% if p.config is defined and p.config %}
                    {% set val = p.config.get(k, '') %}
                  {% endif %}

                  <div class="js-field" data-ftype="{{ typ|e }}" data-required="{{ '1' if req else '0' }}">
                    <label for="{{ code }}__{{ k|e }}">
                      {{ k|e }}
                      {% if req %}
                        <span class="pill bad" style="padding:2px 8px;font-size:.78rem;">obligatorio</span>
                      {% endif %}
                    </label>

                    {% if typ == "bool" %}
                      <select id="{{ code }}__{{ k|e }}" name="cfg__{{ k|e }}">
                        <option value="0" {% if not val %}selected{% endif %}>No</option>
                        <option value="1" {% if val %}selected{% endif %}>S√≠</option>
                      </select>
                    {% elif typ == "url" %}
                      <input id="{{ code }}__{{ k|e }}"
                             name="cfg__{{ k|e }}"
                             value="{{ (val or '')|e }}"
                             placeholder="https://..."
                             inputmode="url"
                             autocomplete="off">
                      <div class="card-actions" style="margin-top:8px">
                        <button type="button" class="btn-mini2 js-copy" data-copy-from="{{ code }}__{{ k|e }}">üìã Copiar</button>
                        <button type="button" class="btn-mini2 js-open" data-open-from="{{ code }}__{{ k|e }}">üîó Abrir</button>
                      </div>
                    {% elif typ == "email" %}
                      <input id="{{ code }}__{{ k|e }}"
                             name="cfg__{{ k|e }}"
                             value="{{ (val or '')|e }}"
                             placeholder="email@dominio.com"
                             autocomplete="email">
                      <div class="card-actions" style="margin-top:8px">
                        <button type="button" class="btn-mini2 js-copy" data-copy-from="{{ code }}__{{ k|e }}">üìã Copiar</button>
                      </div>
                    {% elif typ == "int" %}
                      <input id="{{ code }}__{{ k|e }}"
                             name="cfg__{{ k|e }}"
                             value="{{ (val or '')|e }}"
                             type="number"
                             inputmode="numeric"
                             step="1"
                             placeholder="0">
                    {% else %}
                      <input id="{{ code }}__{{ k|e }}"
                             name="cfg__{{ k|e }}"
                             value="{{ (val or '')|e }}"
                             placeholder="..."
                             autocomplete="off"
                             maxlength="500">
                    {% endif %}

                    <div class="hint">
                      Tipo: <b>{{ typ|e }}</b>{% if req %} ¬∑ Requerido{% endif %}
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="hint" style="margin-top:8px">
                  Este m√©todo no tiene schema configurable (o falta exponerlo). Se guardar√° config vac√≠a.
                </div>
              {% endif %}

              <div class="inline-msg sr-only js-inline" aria-live="polite"></div>
            </fieldset>

            <div class="card-actions">
              <button type="submit" class="btn-save-mini js-save">
                üíæ Guardar
              </button>
              <button type="button" class="btn-mini2 js-reset" title="Revertir cambios no guardados de este m√©todo">
                ‚Ü© Reset
              </button>

              <span class="muted-line js-state"
                    aria-live="polite">
                {% if enabled and ready %}Listo ‚úÖ{% elif enabled %}Incompleto ‚ö†Ô∏è{% else %}Desactivado{% endif %}
              </span>

              <span class="muted-line" style="margin-left:auto;opacity:.9">
                √öltima actualizaci√≥n:
                <span class="js-updated">{{ (p.updated_at or '‚Äî')|e }}</span>
              </span>
            </div>
          </form>
        </div>
      </section>
    {% endfor %}
  </div>

  <div class="safe-note">
    <b>Seguridad:</b> peg√° solo <u>links p√∫blicos</u> / <u>instrucciones</u>. Tokens, secrets y claves privadas van en Render (ENV) o en tu vault/Settings Master.
  </div>

  <div class="actions">
    <a class="btn2" href="{{ checkout_url if checkout_url is defined else url_for('main.home') }}">
      üîé Ver checkout
    </a>
    <span class="muted-line" style="margin-left:auto">
      Tip: si un m√©todo est√° Activo y ‚ÄúIncompleto‚Äù, no deber√≠a mostrarse en checkout.
    </span>
  </div>
</main>

<div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true">
  <div class="trow">
    <div class="ticon" id="toastIcon">‚úÖ</div>
    <div style="min-width:0">
      <p class="ttitle" id="toastTitle">Listo</p>
      <p class="tmsg" id="toastMsg">Guardado</p>
    </div>
    <button class="tx" type="button" id="toastClose" aria-label="Cerrar">‚úï</button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(() => {
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  // ------------------------------
  // Toast (cola simple anti-spam)
  // ------------------------------
  const toast = $("#toast");
  const toastIcon = $("#toastIcon");
  const toastTitle = $("#toastTitle");
  const toastMsg = $("#toastMsg");
  const toastClose = $("#toastClose");
  let toastTimer = null;
  let toastQueue = [];
  let toastShowing = false;

  function _renderToast(t){
    const map = {
      ok:   { ic:"‚úÖ" },
      warn: { ic:"‚ö†Ô∏è" },
      bad:  { ic:"‚õî" },
      info: { ic:"‚ÑπÔ∏è" },
    };
    const m = map[t.kind] || map.info;
    toastIcon.textContent = m.ic;
    toastTitle.textContent = t.title || "Info";
    toastMsg.textContent = t.msg || "";
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(hideToast, t.ms || 4200);
    toastShowing = true;
  }

  function showToast(kind, title, msg, ms){
    toastQueue.push({ kind, title, msg, ms });
    if(!toastShowing) _renderToast(toastQueue.shift());
  }

  function hideToast(){
    toast.classList.remove("show");
    clearTimeout(toastTimer);
    toastTimer = null;
    toastShowing = false;
    if(toastQueue.length) _renderToast(toastQueue.shift());
  }

  toastClose?.addEventListener("click", hideToast);

  // ------------------------------
  // Search (debounce) + toggle active filter
  // ------------------------------
  const q = $("#q");
  const btnShowOnlyActive = $("#btnShowOnlyActive");
  let showOnlyActive = false;
  let searchTimer = null;

  function applyFilter(){
    const needle = (q?.value || "").trim().toLowerCase();
    $$(".pay-card").forEach(card => {
      const name = (card.getAttribute("data-name") || "");
      const code = (card.getAttribute("data-code") || "");
      const enabled = (card.getAttribute("data-enabled") || "0") === "1";
      const hit = !needle || name.includes(needle) || code.includes(needle);
      const ok = hit && (!showOnlyActive || enabled);
      card.style.display = ok ? "" : "none";
    });
  }

  q?.addEventListener("input", () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(applyFilter, 90);
  });

  btnShowOnlyActive?.addEventListener("click", () => {
    showOnlyActive = !showOnlyActive;
    btnShowOnlyActive.textContent = showOnlyActive ? "‚úÖ Mostrando activos" : "‚úÖ Solo activos";
    applyFilter();
  });

  // Enter en search no env√≠a forms
  q?.addEventListener("keydown", (e) => { if(e.key === "Enter") e.preventDefault(); });

  // Ctrl/Cmd+K enfoca search
  window.addEventListener("keydown", (e) => {
    const isMac = (navigator.platform || "").toLowerCase().includes("mac");
    const mod = isMac ? e.metaKey : e.ctrlKey;
    if(mod && (e.key || "").toLowerCase() === "k"){
      e.preventDefault();
      q?.focus();
    }
  });

  // ------------------------------
  // Validaci√≥n helpers
  // ------------------------------
  function looksLikeUrl(v){
    if(!v) return false;
    try { new URL(v); return true; } catch(e) { return false; }
  }
  function looksLikeEmail(v){
    if(!v) return false;
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v).trim());
  }
  function toNum(v){
    const s = String(v ?? "").trim().replace(",", ".");
    if(!s) return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  function clearInvalid(root){ $$(".invalid", root).forEach(el => el.classList.remove("invalid")); }
  function markInvalid(el){ el?.classList?.add("invalid"); }

  // ------------------------------
  // Summary pills (real)
  // ------------------------------
  const pillCount = $("#pillCount span:last-child");
  const pillReady = $("#pillReady span:last-child");
  const pillNeeds = $("#pillNeeds span:last-child");

  function recomputeSummary(){
    let active = 0, ready = 0, needs = 0;
    $$(".pay-card").forEach(card => {
      const enabled = (card.getAttribute("data-enabled") || "0") === "1";
      const isReady = (card.getAttribute("data-ready") || "0") === "1";
      if(enabled) active++;
      if(enabled && isReady) ready++;
      if(enabled && !isReady) needs++;
    });
    if(pillCount) pillCount.textContent = `${active} activos`;
    if(pillReady) pillReady.textContent = `${ready} listos`;
    if(pillNeeds) pillNeeds.textContent = `${needs} incompletos`;
  }

  // ------------------------------
  // Clipboard / Open helpers
  // ------------------------------
  async function copyText(txt){
    try{
      await navigator.clipboard.writeText(txt);
      return true;
    }catch(e){
      // fallback
      try{
        const ta = document.createElement("textarea");
        ta.value = txt;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        return ok;
      }catch(_e){
        return false;
      }
    }
  }

  function setInline(card, kind, msg){
    const box = $(".js-inline", card);
    if(!box) return;
    box.classList.remove("sr-only","bad","ok");
    box.classList.add(kind === "bad" ? "bad" : kind === "ok" ? "ok" : "");
    box.textContent = msg || "";
    if(!msg){
      box.classList.add("sr-only");
      box.classList.remove("bad","ok");
    }
  }

  // ------------------------------
  // Card behavior
  // ------------------------------
  const dirtyByCode = new Map(); // code => bool

  function setDirty(code, val){
    dirtyByCode.set(code, !!val);
  }

  function anyDirty(){
    for(const v of dirtyByCode.values()) if(v) return true;
    return false;
  }

  function snapshotForm(form){
    const fd = new FormData(form);
    // Normalizamos: checkbox enabled se maneja por hidden
    return Array.from(fd.entries()).map(([k,v]) => [k, String(v)]).sort((a,b)=>a[0].localeCompare(b[0]));
  }

  function sameSnapshot(a,b){
    if(a.length !== b.length) return false;
    for(let i=0;i<a.length;i++){
      if(a[i][0]!==b[i][0] || a[i][1]!==b[i][1]) return false;
    }
    return true;
  }

  async function postFormAJAX(form, card){
    const saveBtn = $(".js-save", card);
    const code = form.getAttribute("data-code") || "";

    const fd = new FormData(form);

    // Si recommended est√° disabled no viaja, lo forzamos a 0
    const recSel = $(".js-recommended", card);
    if(recSel && recSel.disabled) fd.set("recommended", "0");

    const oldTxt = saveBtn?.textContent;
    if(saveBtn){ saveBtn.textContent = "Guardando‚Ä¶"; saveBtn.setAttribute("disabled","disabled"); }

    try{
      const r = await fetch(form.action, {
        method: "POST",
        headers: { "Accept": "application/json" },
        body: fd,
        credentials: "same-origin",
        redirect: "follow",
      });

      // Si el server devuelve HTML (por ejemplo redirect/login), lo detectamos
      const ct = (r.headers.get("content-type") || "").toLowerCase();
      let data = null;

      if(ct.includes("application/json")){
        data = await r.json().catch(() => null);
      }else{
        // fallback: si no es JSON, dejamos que el navegador siga el flujo normal
        // (pero ac√° ya estamos en fetch) -> mostramos error claro
        const txt = await r.text().catch(() => "");
        if(r.status === 401 || r.status === 403){
          showToast("bad", "Sesi√≥n", "Tu sesi√≥n expir√≥. Recarg√° y volv√© a iniciar.", 5200);
          setInline(card, "bad", "Sesi√≥n expirada. Recarg√° la p√°gina.");
          return { ok:false };
        }
        if(r.status === 419){
          showToast("bad", "CSRF", "Token inv√°lido/expirado. Recarg√° y reintent√°.", 5200);
          setInline(card, "bad", "CSRF inv√°lido. Recarg√° la p√°gina.");
          return { ok:false };
        }
        showToast("bad", "Error", "Respuesta inesperada del servidor.", 5200);
        setInline(card, "bad", (txt || "Respuesta inesperada").slice(0, 220));
        return { ok:false };
      }

      if(!r.ok || !data || data.ok !== true){
        const msg = (data && (data.message || data.error)) ? (data.message || data.error) : "No se pudo guardar.";
        showToast("bad", "Error", msg, 5200);
        setInline(card, "bad", msg);
        return { ok:false, data };
      }

      // Success
      const readyNow = !!data.ready;
      const errs = Array.isArray(data.errors) ? data.errors : [];
      const stateEl = $(".js-state", card);

      card.setAttribute("data-ready", readyNow ? "1" : "0");

      // Nota: enabled ya est√° en data-enabled por syncEnabled()
      if(stateEl){
        const enabledNow = (card.getAttribute("data-enabled") || "0") === "1";
        stateEl.textContent = enabledNow ? (readyNow ? "Listo ‚úÖ" : "Incompleto ‚ö†Ô∏è") : "Desactivado";
      }

      // updated_at (si backend lo manda)
      const up = $(".js-updated", card);
      if(up && data.updated_at) up.textContent = String(data.updated_at);

      // highlight backend errors (si vienen)
      if(errs.length){
        showToast("warn", "Guardado", "Se guard√≥, pero faltan campos obligatorios.", 5200);
        setInline(card, "bad", "Faltan: " + errs.join(", "));
      }else{
        showToast("ok", "Guardado", "M√©todo actualizado.", 3200);
        setInline(card, "ok", "Guardado ‚úÖ");
        setTimeout(()=>setInline(card,"",""), 1400);
      }

      // reset dirty
      setDirty(code, false);
      recomputeSummary();

      return { ok:true, data };
    }catch(err){
      showToast("bad", "Error", "Fall√≥ la conexi√≥n. Reintent√°.", 5200);
      setInline(card, "bad", "Fall√≥ la conexi√≥n. Reintent√°.");
      return { ok:false };
    }finally{
      if(saveBtn){ saveBtn.textContent = oldTxt || "üíæ Guardar"; saveBtn.removeAttribute("disabled"); }
    }
  }

  function validateCard(card){
    let ok = true;
    clearInvalid(card);

    const enabled = $(".js-enabled", card);
    const isOn = !!enabled?.checked;
    if(!isOn){
      return { ok: true, msg: "Desactivado" };
    }

    // Campos base
    const baseFields = [
      { name:"sort_order", int:true, min:-9999, max:9999 },
      { name:"eta_minutes", int:true, min:0 },
      { name:"fee_percent", int:false, min:0, max:99 },
      { name:"min_amount", int:false, min:0 },
      { name:"max_amount", int:false, min:0 },
    ];

    baseFields.forEach(f => {
      const el = $(`[name="${f.name}"]`, card);
      if(!el) return;
      const v = (el.value || "").trim();
      if(!v) return;
      const n = toNum(v);
      if(n === null){ ok=false; markInvalid(el); return; }
      if(f.int && !Number.isInteger(n)){ ok=false; markInvalid(el); return; }
      if(typeof f.min === "number" && n < f.min){ ok=false; markInvalid(el); return; }
      if(typeof f.max === "number" && n > f.max){ ok=false; markInvalid(el); return; }
    });

    // Schema fields
    const fields = $$(".js-field", card);
    fields.forEach(w => {
      const typ = (w.getAttribute("data-ftype") || "text").toLowerCase();
      const req = (w.getAttribute("data-required") || "0") === "1";
      const inp = $("input,select,textarea", w);
      if(!inp) return;

      const val = String(inp.value || "").trim();
      if(req && !val){ ok=false; markInvalid(inp); }

      if(val){
        if(typ === "url" && !looksLikeUrl(val)){ ok=false; markInvalid(inp); }
        if(typ === "email" && !looksLikeEmail(val)){ ok=false; markInvalid(inp); }
        if(typ === "int"){
          const n = toNum(val);
          if(n === null || !Number.isInteger(n)){ ok=false; markInvalid(inp); }
        }
      }
    });

    return { ok, msg: ok ? "Listo ‚úÖ" : "Incompleto ‚ö†Ô∏è" };
  }

  $$(".pay-card").forEach(card => {
    const enabled = $(".js-enabled", card);
    const form = $(".js-form", card);
    const stateEl = $(".js-state", card);
    const recSel = $(".js-recommended", card);
    const code = (card.getAttribute("data-code") || "");

    // snapshot para reset por card
    const initial = snapshotForm(form);

    function syncEnabled(){
      const on = !!enabled?.checked;
      const hiddenEnabled = $("input[name='enabled']", form);
      if(hiddenEnabled) hiddenEnabled.value = on ? "1" : "0";

      card.setAttribute("data-enabled", on ? "1" : "0");

      // recommended s√≥lo si activo
      if(recSel){
        if(!on){
          recSel.value = "0";
          recSel.setAttribute("disabled","disabled");
        }else{
          recSel.removeAttribute("disabled");
        }
      }

      if(stateEl){
        const readyNow = (card.getAttribute("data-ready") || "0") === "1";
        stateEl.textContent = on ? (readyNow ? "Listo ‚úÖ" : "Incompleto ‚ö†Ô∏è") : "Desactivado";
      }

      recomputeSummary();
      applyFilter();
    }

    enabled?.addEventListener("change", () => {
      syncEnabled();
      setDirty(code, true);
    });

    // Init
    syncEnabled();

    // Blur/change -> validate + dirty
    $$("input,textarea,select", card).forEach(el => {
      el.addEventListener("change", () => {
        setDirty(code, true);
        const res = validateCard(card);
        if(stateEl && enabled?.checked) stateEl.textContent = res.msg;
        recomputeSummary();
      });
      el.addEventListener("blur", () => {
        const res = validateCard(card);
        if(stateEl && enabled?.checked) stateEl.textContent = res.msg;
        recomputeSummary();
      });
    });

    // Reset por card
    $(".js-reset", card)?.addEventListener("click", () => {
      // Revertimos a initial snapshot reconstruyendo valores
      const map = new Map(initial.map(([k,v]) => [k, v]));
      $$("input,select,textarea", form).forEach(el => {
        const name = el.getAttribute("name");
        if(!name) return;

        if(el.type === "checkbox"){
          // no usamos checkboxes adentro del form, pero por si acaso
          el.checked = map.get(name) === "1";
          return;
        }
        const v = map.has(name) ? map.get(name) : "";
        el.value = v ?? "";
      });

      // Re-sync toggle hidden + recommended
      syncEnabled();
      clearInvalid(card);
      setInline(card, "", "");
      setDirty(code, false);

      showToast("info", "Reset", "Cambios revertidos.", 2200);
    });

    // Copy / Open
    $$(".js-copy", card).forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-copy-from");
        const el = id ? document.getElementById(id) : null;
        const val = el ? String(el.value || "").trim() : "";
        if(!val){
          showToast("warn", "Copiar", "No hay nada para copiar.", 2600);
          return;
        }
        const ok = await copyText(val);
        showToast(ok ? "ok" : "bad", "Copiar", ok ? "Copiado ‚úÖ" : "No se pudo copiar.", 2600);
      });
    });

    $$(".js-open", card).forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-open-from");
        const el = id ? document.getElementById(id) : null;
        const val = el ? String(el.value || "").trim() : "";
        if(!looksLikeUrl(val)){
          showToast("warn", "Abrir link", "URL inv√°lida.", 2600);
          return;
        }
        window.open(val, "_blank", "noopener,noreferrer");
      });
    });

    // Submit (AJAX con fallback)
    form?.addEventListener("submit", async (e) => {
      const res = validateCard(card);
      if(!res.ok){
        e.preventDefault();
        showToast("warn", "Faltan datos", "Activaste el m√©todo pero faltan campos obligatorios o hay valores inv√°lidos.", 5200);
        setInline(card, "bad", "Revis√° los campos marcados en rojo.");
        return;
      }

      // Si no hay fetch, postea normal
      if(!window.fetch) return;

      e.preventDefault();

      // Si no cambi√≥ nada, evitamos pegarle al server
      const nowSnap = snapshotForm(form);
      if(sameSnapshot(initial, nowSnap) && !dirtyByCode.get(code)){
        showToast("info", "Sin cambios", "No hay cambios para guardar.", 2200);
        setInline(card, "", "");
        return;
      }

      const out = await postFormAJAX(form, card);
      if(out && out.ok){
        // actualizar snapshot base a la nueva ‚Äúverdad‚Äù
        const newSnap = snapshotForm(form);
        initial.splice(0, initial.length, ...newSnap);
      }
    });
  });

  // ------------------------------
  // Guardar todo (secuencial, robusto)
  // ------------------------------
  const btnSaveAll = $("#btnSaveAll");
  btnSaveAll?.addEventListener("click", async () => {
    if(!window.fetch){
      showToast("info", "Guardar todo", "Tu navegador no soporta guardado r√°pido.", 4200);
      return;
    }

    const cards = $$(".pay-card");
    const dirtyCards = cards.filter(c => {
      const code = c.getAttribute("data-code") || "";
      return !!dirtyByCode.get(code);
    });

    if(!dirtyCards.length){
      showToast("info", "Guardar todo", "No hay cambios pendientes.", 2600);
      return;
    }

    btnSaveAll.setAttribute("disabled","disabled");
    btnSaveAll.textContent = "Guardando todo‚Ä¶";

    let okCount = 0;
    for(const card of dirtyCards){
      const form = $(".js-form", card);
      if(!form) continue;

      const res = validateCard(card);
      if(!res.ok){
        showToast("warn", "Validaci√≥n", "Hay un m√©todo activo con campos inv√°lidos.", 5200);
        setInline(card, "bad", "Arregl√° los campos marcados y reintent√°.");
        continue;
      }

      const out = await postFormAJAX(form, card);
      if(out && out.ok) okCount++;
    }

    btnSaveAll.removeAttribute("disabled");
    btnSaveAll.textContent = "üíæ Guardar todo";

    showToast("ok", "Guardar todo", `Listo. Guardados: ${okCount}/${dirtyCards.length}`, 4200);
  });

  // ------------------------------
  // Advertencia: salir con cambios
  // ------------------------------
  window.addEventListener("beforeunload", (e) => {
    if(!anyDirty()) return;
    e.preventDefault();
    e.returnValue = "";
  });

  // init
  recomputeSummary();
  applyFilter();
})();
</script>
{% endblock %}
