{# app/templates/admin/payments.html ‚Äî Skyline Admin Payments (ULTRA PRO / FINAL / NO BREAK) #}
{% extends "admin/base_admin.html" %}
{% block title %}Pagos ¬∑ Skyline Admin{% endblock %}

{% block extra_head %}
<style>
  /* =========================================================
    Skyline Admin ¬∑ Payments (ULTRA PRO)
    - Responsive + accesible
    - Estados: ready / needs-config / disabled
    - Validaci√≥n inline + toast
    - UI moderna tipo marketplace
  ========================================================= */

  :root{
    --p-bg: rgba(255,255,255,.05);
    --p-bd: rgba(148,163,184,.16);
    --p-bd2: rgba(148,163,184,.22);
    --p-tx: rgba(226,232,240,.92);
    --p-muted: rgba(226,232,240,.72);
    --p-shadow: 0 16px 40px rgba(0,0,0,.18);
    --p-r: 18px;
    --p-r2: 14px;

    --ok: rgba(34,197,94,.90);
    --ok-bg: rgba(34,197,94,.10);
    --warn: rgba(245,158,11,.92);
    --warn-bg: rgba(245,158,11,.10);
    --bad: rgba(239,68,68,.92);
    --bad-bg: rgba(239,68,68,.10);
    --info: rgba(56,189,248,.92);
    --info-bg: rgba(56,189,248,.10);

    --focus: 0 0 0 4px rgba(56,189,248,.16);
  }
  :root[data-theme="light"]{
    --p-bg: rgba(0,0,0,.02);
    --p-bd: rgba(2,6,23,.10);
    --p-bd2: rgba(2,6,23,.14);
    --p-tx: rgba(2,6,23,.92);
    --p-muted: rgba(2,6,23,.68);
    --p-shadow: 0 14px 30px rgba(0,0,0,.08);

    --ok-bg: rgba(34,197,94,.08);
    --warn-bg: rgba(245,158,11,.08);
    --bad-bg: rgba(239,68,68,.08);
    --info-bg: rgba(37,99,235,.06);
    --focus: 0 0 0 4px rgba(37,99,235,.14);
  }

  /* ---- Layout header ---- */
  .pay-wrap{ display:block; }
  .pay-head{
    display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;
    margin-bottom:14px;
  }
  .pay-title{
    margin:.2rem 0 0;
    font-weight:1000;
    letter-spacing:-.6px;
    line-height:1.1;
  }
  .pay-sub{ margin:.45rem 0 0; max-width:80ch; color: var(--p-muted); line-height:1.55; }

  .pay-tools{
    display:flex;align-items:center;gap:10px;flex-wrap:wrap; justify-content:flex-end;
  }
  .mini{
    padding:8px 10px;border-radius:12px;
    border:1px dashed var(--p-bd2);
    background: rgba(255,255,255,.04);
    color: var(--p-muted);
    opacity:.95;
    font-size:.92rem;
  }
  :root[data-theme="light"] .mini{ background: rgba(0,0,0,.02); }

  .search{
    display:flex;align-items:center;gap:8px;
    border:1px solid var(--p-bd);
    background: rgba(255,255,255,.04);
    border-radius: 999px;
    padding: 8px 12px;
    min-width: 260px;
  }
  :root[data-theme="light"] .search{ background: rgba(0,0,0,.02); }
  .search input{
    width:100%;
    border:0; outline:0; background: transparent;
    color: var(--p-tx);
    font-weight:800;
  }
  .search input::placeholder{ color: var(--p-muted); font-weight:800; opacity:.8; }

  /* ---- Grid + cards ---- */
  .pay-grid{
    display:grid;
    grid-template-columns: 1fr;
    gap:14px;
  }
  @media(min-width:980px){ .pay-grid{ grid-template-columns: 1fr 1fr; } }

  .card{
    border:1px solid var(--p-bd);
    border-radius: var(--p-r);
    padding:14px;
    background: var(--p-bg);
    box-shadow: var(--p-shadow);
    position: relative;
    overflow:hidden;
  }
  .card::before{
    content:"";
    position:absolute; inset:-2px;
    background: radial-gradient(900px 260px at 15% -10%, rgba(56,189,248,.18), transparent 55%),
                radial-gradient(900px 260px at 90% 0%, rgba(34,197,94,.14), transparent 55%);
    opacity:.55;
    pointer-events:none;
  }
  :root[data-theme="light"] .card::before{
    opacity:.35;
    background: radial-gradient(900px 260px at 15% -10%, rgba(37,99,235,.12), transparent 55%),
                radial-gradient(900px 260px at 90% 0%, rgba(34,197,94,.10), transparent 55%);
  }

  .card-inner{ position:relative; z-index:1; }

  .card-top{
    display:flex;justify-content:space-between;align-items:flex-start;gap:10px;
    margin-bottom:10px;
  }
  .card-title{
    display:flex;align-items:center;gap:10px;
    font-weight:1000;letter-spacing:-.3px;
    color: var(--p-tx);
  }
  .card-ic{
    width:36px;height:36px;border-radius:12px;
    display:grid;place-items:center;
    background: rgba(255,255,255,.08);
    border:1px solid var(--p-bd2);
  }
  :root[data-theme="light"] .card-ic{ background: rgba(0,0,0,.03); }

  .card-desc{ margin:0; color: var(--p-muted); line-height:1.55; }

  /* ---- Status pill ---- */
  .pill-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px; }
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    border-radius:999px;
    padding:6px 10px;
    border:1px solid var(--p-bd2);
    background: rgba(255,255,255,.04);
    color: var(--p-muted);
    font-weight:900;
    font-size:.86rem;
    user-select:none;
  }
  .pill .dot{ width:10px;height:10px;border-radius:999px; background: rgba(148,163,184,.55); }
  .pill.ok{ border-color: rgba(34,197,94,.35); background: var(--ok-bg); color: var(--p-tx); }
  .pill.ok .dot{ background: var(--ok); }
  .pill.warn{ border-color: rgba(245,158,11,.35); background: var(--warn-bg); color: var(--p-tx); }
  .pill.warn .dot{ background: var(--warn); }
  .pill.bad{ border-color: rgba(239,68,68,.35); background: var(--bad-bg); color: var(--p-tx); }
  .pill.bad .dot{ background: var(--bad); }

  /* ---- Toggle ---- */
  .toggle{
    display:inline-flex;align-items:center;gap:10px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid var(--p-bd2);
    background: rgba(255,255,255,.06);
    font-weight:1000;
    white-space:nowrap;
    color: var(--p-tx);
    user-select:none;
  }
  :root[data-theme="light"] .toggle{ background: rgba(0,0,0,.02); }

  .switch{ position:relative;width:46px;height:26px;flex:0 0 auto; display:inline-block; }
  .switch input{ display:none; }
  .track{
    position:absolute;inset:0;border-radius:999px;
    background: rgba(148,163,184,.25);
    transition: all .18s ease;
    border:1px solid var(--p-bd2);
  }
  .thumb{
    position:absolute;top:3px;left:3px;
    width:20px;height:20px;border-radius:999px;
    background: rgba(255,255,255,.92);
    transition: all .18s ease;
    box-shadow: 0 8px 18px rgba(0,0,0,.25);
  }
  .switch input:checked + .track{
    background: rgba(34,197,94,.26);
    border-color: rgba(34,197,94,.35);
  }
  .switch input:checked + .track .thumb{ left:23px; }

  /* ---- Form fields ---- */
  .fields{ display:grid; gap:10px; margin-top:12px; }
  .fields label{ font-weight:1000; color: var(--p-tx); }
  .fields input, .fields textarea, .fields select{
    width:100%;
    border-radius: 14px;
    border:1px solid var(--p-bd);
    background: rgba(255,255,255,.03);
    color: var(--p-tx);
    padding: 10px 12px;
    outline: none;
    transition: box-shadow .15s ease, border-color .15s ease, transform .05s ease;
  }
  :root[data-theme="light"] .fields input,
  :root[data-theme="light"] .fields textarea,
  :root[data-theme="light"] .fields select{ background: rgba(0,0,0,.02); }

  .fields textarea{ min-height: 98px; resize: vertical; }
  .fields input:focus, .fields textarea:focus, .fields select:focus{
    border-color: rgba(56,189,248,.40);
    box-shadow: var(--focus);
  }

  .hint{
    font-size:.9rem;
    color: var(--p-muted);
    margin-top:6px;
    line-height:1.45;
  }

  .invalid{
    border-color: rgba(239,68,68,.55) !important;
    box-shadow: 0 0 0 4px rgba(239,68,68,.14) !important;
  }

  /* ---- Provider actions ---- */
  .card-actions{
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    margin-top:12px;
  }
  .btn-save-mini{
    display:inline-flex;gap:8px;align-items:center;
    border-radius: 12px;
    border:1px solid var(--p-bd2);
    background: rgba(255,255,255,.06);
    padding: 9px 12px;
    font-weight:1000;
    color: var(--p-tx);
    cursor:pointer;
  }
  .btn-save-mini:active{ transform: translateY(1px); }

  .muted-line{ color: var(--p-muted); font-weight:900; font-size:.92rem; }

  /* ---- Footer actions ---- */
  .safe-note{
    margin-top:12px;
    border:1px solid rgba(56,189,248,.28);
    background: var(--info-bg);
    border-radius: 16px;
    padding: 12px;
    color: var(--p-tx);
    opacity: .98;
  }

  .actions{
    display:flex;gap:10px;flex-wrap:wrap;
    margin-top:14px;
    align-items:center;
  }

  /* ---- Toast ---- */
  .toast{
    position: fixed;
    right: 16px;
    bottom: 16px;
    width: min(420px, calc(100vw - 32px));
    border-radius: 16px;
    border:1px solid var(--p-bd2);
    background: rgba(2,6,23,.82);
    color: rgba(226,232,240,.96);
    padding: 12px 12px;
    box-shadow: 0 18px 55px rgba(0,0,0,.35);
    display:none;
    z-index: 9999;
    backdrop-filter: blur(10px);
  }
  :root[data-theme="light"] .toast{
    background: rgba(255,255,255,.86);
    color: rgba(2,6,23,.92);
    box-shadow: 0 16px 44px rgba(0,0,0,.16);
  }
  .toast.show{ display:block; }
  .toast .trow{ display:flex; gap:10px; align-items:flex-start; }
  .toast .ticon{ width:28px;height:28px;border-radius:10px; display:grid;place-items:center; flex:0 0 auto; border:1px solid var(--p-bd2); background: rgba(255,255,255,.04); }
  .toast .ttitle{ font-weight:1000; margin:0; }
  .toast .tmsg{ margin:2px 0 0; color: var(--p-muted); line-height:1.45; }
  .toast .tx{ margin-left:auto; border:0; background:transparent; color: inherit; font-weight:1000; cursor:pointer; }

  .svg{ width:18px;height:18px; display:block; }
</style>
{% endblock %}

{% block content %}
<div class="pay-wrap">
  <div class="pay-head">
    <div>
      <h1 class="pay-title">Pagos</h1>
      <p class="pay-sub">
        Activ√° m√©todos de cobro y complet√° los datos. El checkout mostrar√° solo lo que est√© <b>Activo</b> y listo.
      </p>
      <div class="pill-row" aria-label="Resumen">
        <span class="pill" id="pillCount"><span class="dot"></span> <span>0 activos</span></span>
        <span class="pill ok" id="pillReady"><span class="dot"></span> <span>0 listos</span></span>
        <span class="pill warn" id="pillNeeds"><span class="dot"></span> <span>0 incompletos</span></span>
      </div>
    </div>

    <div class="pay-tools">
      <div class="search" role="search" aria-label="Buscar m√©todo">
        <span aria-hidden="true">üîé</span>
        <input id="q" type="search" placeholder="Buscar: mp, paypal, wise, transferencia‚Ä¶" autocomplete="off">
      </div>

      <div class="mini" title="Regla de oro">
        üîí Peg√° links p√∫blicos / instrucciones ¬∑ No pegues tokens/secretos
      </div>
    </div>
  </div>

  {# Guardado r√°pido por proveedor via fetch (misma ruta) #}
  <div class="pay-grid" id="grid">

    {% for p in providers %}
    {% set code = p.code %}
    {% set enabled = p.enabled %}
    {% set ready = p.ready if p.ready is defined else false %}
    {% set errors = p.errors if p.errors is defined else [] %}
    {% set schema = p.schema if p.schema is defined else [] %}

    <section class="card pay-card" data-code="{{ code }}" data-name="{{ (p.name or code) | lower }}">
      <div class="card-inner">
        <div class="card-top">
          <div style="min-width:0">
            <div class="card-title">
              <span class="card-ic" aria-hidden="true">
                <svg class="svg" viewBox="0 0 24 24" fill="none">
                  <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Z" stroke="currentColor" stroke-width="2" opacity=".8"/>
                  <path d="M7.5 12c1.2-2.4 2.8-3.6 4.5-3.6S15.3 9.6 16.5 12c-1.2 2.4-2.8 3.6-4.5 3.6S8.7 14.4 7.5 12Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round" opacity=".9"/>
                </svg>
              </span>
              <span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                {{ p.name or code }}
              </span>
            </div>
            <p class="card-desc">
              C√≥digo: <b>{{ code }}</b>{% if p.country %} ¬∑ Pa√≠s: <b>{{ p.country }}</b>{% endif %}{% if p.kind %} ¬∑ Tipo: <b>{{ p.kind }}</b>{% endif %}
            </p>

            <div class="pill-row" aria-label="Estado del m√©todo">
              {% if enabled and ready %}
                <span class="pill ok"><span class="dot"></span> Listo para checkout</span>
              {% elif enabled and not ready %}
                <span class="pill warn"><span class="dot"></span> Activo pero incompleto</span>
              {% else %}
                <span class="pill"><span class="dot"></span> Desactivado</span>
              {% endif %}
              {% if errors and errors|length %}
                <span class="pill bad" title="{{ errors|join(' | ') }}"><span class="dot"></span> {{ errors|length }} faltantes</span>
              {% endif %}
            </div>
          </div>

          <label class="toggle" title="Activar m√©todo">
            <span>Activo</span>
            <span class="switch">
              <input type="checkbox" class="js-enabled" {% if enabled %}checked{% endif %}>
              <span class="track"><span class="thumb"></span></span>
            </span>
          </label>
        </div>

        <form class="js-form" method="post" action="{{ url_for('admin_payments.admin_payments_save', code=code) }}" novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="enabled" value="0">
          <input type="hidden" name="recommended" value="0">

          <div class="fields">

            <div style="display:grid;gap:10px;grid-template-columns: 1fr; align-items:end;">
              <div style="display:grid;gap:10px;grid-template-columns: 1fr 1fr;">
                <div>
                  <label>Orden</label>
                  <input name="sort_order" value="{{ p.sort_order if p.sort_order is not none else 100 }}" inputmode="numeric" placeholder="10">
                  <div class="hint">Menor = m√°s arriba en checkout.</div>
                </div>
                <div>
                  <label>Recomendado</label>
                  <select name="recommended" class="js-recommended">
                    <option value="0" {% if not p.recommended %}selected{% endif %}>No</option>
                    <option value="1" {% if p.recommended %}selected{% endif %}>S√≠</option>
                  </select>
                  <div class="hint">Solo si est√° <b>Activo</b>.</div>
                </div>
              </div>
            </div>

            <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr;">
              <div>
                <label>Fee % (info)</label>
                <input name="fee_percent" value="{{ p.fee_percent if p.fee_percent is not none else 0 }}" inputmode="numeric" placeholder="0">
                <div class="hint">Solo informativo (no cobra).</div>
              </div>
              <div>
                <label>ETA (min)</label>
                <input name="eta_minutes" value="{{ p.eta_minutes if p.eta_minutes is not none else 0 }}" inputmode="numeric" placeholder="0">
                <div class="hint">Tiempo de confirmaci√≥n estimado.</div>
              </div>
            </div>

            <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr;">
              <div>
                <label>M√≠nimo</label>
                <input name="min_amount" value="{{ p.min_amount if p.min_amount is not none else 0 }}" inputmode="numeric" placeholder="0">
              </div>
              <div>
                <label>M√°ximo (0 = sin)</label>
                <input name="max_amount" value="{{ p.max_amount if p.max_amount is not none else 0 }}" inputmode="numeric" placeholder="0">
              </div>
            </div>

            <div>
              <label>Notas (opcional)</label>
              <input name="notes" value="{{ p.notes or '' }}" placeholder="Ej: cuotas, QR, horarios, condiciones..." autocomplete="off">
              <div class="hint">Se muestra como ayuda en checkout (si lo quer√©s).</div>
            </div>

            {% if schema and schema|length %}
            <div style="border-top:1px solid var(--p-bd); padding-top:10px; margin-top:2px;">
              <div class="muted-line">Configuraci√≥n del m√©todo</div>
              <div class="hint">Complet√° lo obligatorio. Lo sensible se guarda enmascarado en el admin.</div>
            </div>

            {% for f in schema %}
              {% set k = f.key %}
              {% set typ = (f.type or 'text') %}
              {% set req = f.required %}
              {% set val = '' %}
              {% if p.config is defined and p.config %}
                {% set val = p.config.get(k, '') %}
              {% endif %}

              <div>
                <label for="{{ code }}__{{ k }}">
                  {{ k }}{% if req %} <span class="pill bad" style="padding:2px 8px;font-size:.78rem;">obligatorio</span>{% endif %}
                </label>

                {% if typ == "bool" %}
                  <select id="{{ code }}__{{ k }}" name="cfg__{{ k }}">
                    <option value="0" {% if not val %}selected{% endif %}>No</option>
                    <option value="1" {% if val %}selected{% endif %}>S√≠</option>
                  </select>
                {% elif typ == "url" %}
                  <input id="{{ code }}__{{ k }}" name="cfg__{{ k }}" value="{{ val or '' }}" placeholder="https://..." inputmode="url" autocomplete="off">
                {% elif typ == "email" %}
                  <input id="{{ code }}__{{ k }}" name="cfg__{{ k }}" value="{{ val or '' }}" placeholder="email@dominio.com" autocomplete="email">
                {% elif typ == "int" %}
                  <input id="{{ code }}__{{ k }}" name="cfg__{{ k }}" value="{{ val or '' }}" inputmode="numeric" placeholder="0">
                {% else %}
                  <input id="{{ code }}__{{ k }}" name="cfg__{{ k }}" value="{{ val or '' }}" placeholder="..." autocomplete="off">
                {% endif %}

                <div class="hint">
                  Tipo: <b>{{ typ }}</b>{% if req %} ¬∑ Requerido{% endif %}
                </div>
              </div>
            {% endfor %}
            {% else %}
              <div class="hint" style="margin-top:8px">
                Este m√©todo no tiene schema configurable (o falta exponerlo). Se guardar√° config vac√≠a.
              </div>
            {% endif %}

          </div>

          <div class="card-actions">
            <button type="submit" class="btn-save-mini js-save">
              üíæ Guardar
            </button>
            <span class="muted-line js-state">
              {% if enabled and ready %}Listo ‚úÖ{% elif enabled %}Incompleto ‚ö†Ô∏è{% else %}Desactivado{% endif %}
            </span>
            <span class="muted-line" style="margin-left:auto;opacity:.9">
              √öltima actualizaci√≥n: {{ p.updated_at or '‚Äî' }}
            </span>
          </div>
        </form>
      </div>
    </section>
    {% endfor %}

  </div>

  <div class="safe-note">
    <b>Seguridad:</b> peg√° solo <u>links p√∫blicos</u> / <u>instrucciones</u>. Tokens, secrets y claves privadas van en Render (ENV) o en tu vault/Settings Master.
  </div>

  <div class="actions">
    <a class="btn2" href="{{ checkout_url if checkout_url is defined else url_for('main.home') }}">
      üîé Ver checkout
    </a>
    <span class="muted-line" style="margin-left:auto">
      Tip: si un m√©todo est√° Activo y ‚ÄúIncompleto‚Äù, no deber√≠a mostrarse en checkout.
    </span>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite">
  <div class="trow">
    <div class="ticon" id="toastIcon">‚úÖ</div>
    <div style="min-width:0">
      <p class="ttitle" id="toastTitle">Listo</p>
      <p class="tmsg" id="toastMsg">Guardado</p>
    </div>
    <button class="tx" type="button" id="toastClose" aria-label="Cerrar">‚úï</button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(() => {
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const toast = $("#toast");
  const toastIcon = $("#toastIcon");
  const toastTitle = $("#toastTitle");
  const toastMsg = $("#toastMsg");
  const toastClose = $("#toastClose");
  let toastTimer = null;

  function showToast(kind, title, msg){
    // kind: ok|warn|bad|info
    const map = {
      ok: { ic:"‚úÖ" },
      warn: { ic:"‚ö†Ô∏è" },
      bad: { ic:"‚õî" },
      info: { ic:"‚ÑπÔ∏è" },
    };
    const m = map[kind] || map.info;
    toastIcon.textContent = m.ic;
    toastTitle.textContent = title || "Info";
    toastMsg.textContent = msg || "";
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove("show"), 4200);
  }

  toastClose?.addEventListener("click", () => toast.classList.remove("show"));

  // ===== Mejora #1: Search/filter =====
  const q = $("#q");
  q?.addEventListener("input", () => {
    const needle = (q.value || "").trim().toLowerCase();
    $$(".pay-card").forEach(card => {
      const name = (card.getAttribute("data-name") || "");
      const code = (card.getAttribute("data-code") || "");
      const hit = !needle || name.includes(needle) || code.includes(needle);
      card.style.display = hit ? "" : "none";
    });
  });

  // ===== helpers validation =====
  function looksLikeUrl(v){
    if(!v) return false;
    try { new URL(v); return true; } catch(e) { return false; }
  }
  function looksLikeEmail(v){
    if(!v) return false;
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.trim());
  }

  function clearInvalid(root){
    $$(".invalid", root).forEach(el => el.classList.remove("invalid"));
  }
  function markInvalid(el){
    el?.classList?.add("invalid");
  }

  // ===== Mejora #2: Summary pills (activos/listos/incompletos) =====
  const pillCount = $("#pillCount span:last-child");
  const pillReady = $("#pillReady span:last-child");
  const pillNeeds = $("#pillNeeds span:last-child");

  function recomputeSummary(){
    let active = 0, ready = 0, needs = 0;
    $$(".pay-card").forEach(card => {
      const enabled = $(".js-enabled", card)?.checked;
      const state = ($(".js-state", card)?.textContent || "").toLowerCase();
      if(enabled) active++;
      if(enabled && state.includes("listo")) ready++;
      if(enabled && state.includes("incompleto")) needs++;
    });
    if(pillCount) pillCount.textContent = `${active} activos`;
    if(pillReady) pillReady.textContent = `${ready} listos`;
    if(pillNeeds) pillNeeds.textContent = `${needs} incompletos`;
  }

  // ===== Mejora #3: Toggle ‚ÄúActivo‚Äù sincroniza hidden input enabled =====
  $$(".pay-card").forEach(card => {
    const enabled = $(".js-enabled", card);
    const form = $(".js-form", card);
    const stateEl = $(".js-state", card);
    const recSel = $(".js-recommended", card);

    function syncEnabled(){
      const on = !!enabled?.checked;
      const hiddenEnabled = $("input[name='enabled']", form);
      if(hiddenEnabled) hiddenEnabled.value = on ? "1" : "0";

      // Mejora #4: recommended s√≥lo si activo (UX)
      if(recSel){
        if(!on){
          recSel.value = "0";
          recSel.setAttribute("disabled","disabled");
        }else{
          recSel.removeAttribute("disabled");
        }
      }

      if(stateEl){
        stateEl.textContent = on ? "Incompleto ‚ö†Ô∏è" : "Desactivado";
      }
      recomputeSummary();
    }

    enabled?.addEventListener("change", syncEnabled);
    syncEnabled();

    // ===== Mejora #5: Validaci√≥n inline por tipo (url/email/int) + requeridos =====
    function validateCard(){
      let ok = true;
      clearInvalid(card);

      const isOn = !!enabled?.checked;
      if(!isOn){
        return { ok: true, msg: "Desactivado" };
      }

      // Required: todo input con label que tenga pill obligatorio cerca => simple heuristic
      // (adem√°s, validamos url/email seg√∫n placeholder/type)
      const inputs = $$("input[name^='cfg__'], select[name^='cfg__'], textarea[name^='cfg__']", card);

      inputs.forEach(inp => {
        const name = inp.getAttribute("name") || "";
        const val = (inp.value || "").trim();
        const parent = inp.closest("div");
        const isRequired = !!(parent && $(".pill.bad", parent)); // "obligatorio"

        if(isRequired && !val){
          ok = false; markInvalid(inp);
        }

        const ph = (inp.getAttribute("placeholder") || "").toLowerCase();
        if(val){
          if(ph.includes("https://") && !looksLikeUrl(val)){
            ok = false; markInvalid(inp);
          }
          if((inp.getAttribute("autocomplete") || "") === "email" && !looksLikeEmail(val)){
            ok = false; markInvalid(inp);
          }
          if(inp.getAttribute("inputmode") === "numeric" && !/^\d+$/.test(val)){
            ok = false; markInvalid(inp);
          }
        }
      });

      // Campos base: numeric
      ["sort_order","fee_percent","eta_minutes","min_amount","max_amount"].forEach(n => {
        const el = $(`[name="${n}"]`, card);
        if(el){
          const v = (el.value || "").trim();
          if(v && !/^\d+$/.test(v)){ ok = false; markInvalid(el); }
        }
      });

      return { ok, msg: ok ? "Listo ‚úÖ" : "Incompleto ‚ö†Ô∏è" };
    }

    // Actualiza state en blur
    $$("input,textarea,select", card).forEach(el => {
      el.addEventListener("blur", () => {
        const res = validateCard();
        if(stateEl && enabled?.checked){
          stateEl.textContent = res.msg;
        }
        recomputeSummary();
      });
    });

    // ===== Mejora #6: Guardado por AJAX (sin recargar), con fallback normal =====
    form?.addEventListener("submit", async (e) => {
      const res = validateCard();
      if(!res.ok){
        e.preventDefault();
        showToast("warn", "Faltan datos", "Activaste el m√©todo pero faltan campos obligatorios o hay valores inv√°lidos.");
        return;
      }

      // Si el navegador no soporta fetch, que postee normal
      if(!window.fetch) return;

      e.preventDefault();

      // Preparar payload
      const fd = new FormData(form);
      // sync recommended (si select est√° disabled, no viaja, lo forzamos)
      if(recSel && recSel.disabled){
        fd.set("recommended","0");
      }

      const saveBtn = $(".js-save", card);
      const oldTxt = saveBtn?.textContent;
      if(saveBtn){ saveBtn.textContent = "Guardando‚Ä¶"; saveBtn.setAttribute("disabled","disabled"); }

      try{
        const r = await fetch(form.action, {
          method: "POST",
          headers: { "Accept": "application/json" },
          body: fd,
          credentials: "same-origin",
        });
        const data = await r.json().catch(() => ({}));

        if(!r.ok || !data || data.ok !== true){
          const msg = data?.message || data?.error || "No se pudo guardar.";
          showToast("bad", "Error", msg);
          if(saveBtn){ saveBtn.textContent = oldTxt || "Guardar"; saveBtn.removeAttribute("disabled"); }
          return;
        }

        // ===== Mejora #7: UI update post-save (ready/errors) =====
        const readyNow = !!data.ready;
        if(stateEl){
          stateEl.textContent = enabled.checked ? (readyNow ? "Listo ‚úÖ" : "Incompleto ‚ö†Ô∏è") : "Desactivado";
        }

        const errs = (data.errors || []);
        if(errs.length){
          showToast("warn", "Guardado", "Se guard√≥, pero faltan campos obligatorios. Revis√° lo marcado.");
          // resaltar algo si hay invalids
        }else{
          showToast("ok", "Guardado", "M√©todo actualizado y listo para checkout.");
        }

        recomputeSummary();
      }catch(err){
        showToast("bad", "Error", "Fall√≥ la conexi√≥n. Reintent√°.");
      }finally{
        if(saveBtn){ saveBtn.textContent = oldTxt || "üíæ Guardar"; saveBtn.removeAttribute("disabled"); }
      }
    });
  });

  // ===== Mejora #8: Ctrl/Cmd+K enfoca search (UX pro) =====
  window.addEventListener("keydown", (e) => {
    const isMac = navigator.platform.toLowerCase().includes("mac");
    const mod = isMac ? e.metaKey : e.ctrlKey;
    if(mod && (e.key || "").toLowerCase() === "k"){
      e.preventDefault();
      q?.focus();
    }
  });

  // ===== Mejora #9: Enter en search no env√≠a forms =====
  q?.addEventListener("keydown", (e) => {
    if(e.key === "Enter") e.preventDefault();
  });

  // init pills
  recomputeSummary();

  // ===== Mejora #10: Advertencia si intent√°s salir con cambios no guardados =====
  let dirty = false;
  $$(".pay-card input, .pay-card textarea, .pay-card select").forEach(el => {
    el.addEventListener("change", () => { dirty = true; });
  });
  window.addEventListener("beforeunload", (e) => {
    if(!dirty) return;
    e.preventDefault();
    e.returnValue = "";
  });
})();
</script>
{% endblock %}
