{# app/templates/admin/product_edit.html â€” PRODUCT EDITOR ULTRA PRO (FINAL) #}
{% extends "admin/base_admin.html" %}

{% block title %}
  {% if product %}
    Editar Â· {{ product.title if product.title is defined else product.name }}
  {% else %}
    Nuevo producto
  {% endif %}
{% endblock %}

{% block content %}

<h1 style="margin:.2rem 0 0;font-weight:1000;letter-spacing:-.5px">
  {% if product %}Editar producto{% else %}Nuevo producto{% endif %}
</h1>

<p class="muted" style="margin:.45rem 0 1rem">
  GestiÃ³n completa del producto: contenido, precio, stock, categorÃ­a, origen e imagen.
</p>

<form method="post"
      enctype="multipart/form-data"
      action="{% if product %}{{ url_for('admin.products_update', product_id=product.id) }}{% else %}{{ url_for('admin.products_create') }}{% endif %}">

  <!-- ================= DATOS BÃSICOS ================= -->
  <section class="row cols2">
    <div>
      <label>TÃ­tulo</label>
      <input name="title"
             required
             value="{{ product.title if product and product.title is defined else (product.name if product else '') }}">
    </div>

    <div>
      <label>Slug (URL)</label>
      <input name="slug"
             value="{{ product.slug if product and product.slug is defined else '' }}"
             placeholder="auto si lo dejÃ¡s vacÃ­o">
      <p class="muted" style="font-size:.85rem;margin-top:4px">
        Se genera automÃ¡ticamente si lo dejÃ¡s vacÃ­o.
      </p>
    </div>
  </section>

  <section class="row">
    <div>
      <label>DescripciÃ³n</label>
      <textarea name="description"
                placeholder="DescripciÃ³n completa, detalles, especificacionesâ€¦">{{ product.description if product and product.description is defined else '' }}</textarea>
    </div>
  </section>

  <!-- ================= PRECIO / STOCK ================= -->
  <section class="row cols3">
    <div>
      <label>Precio</label>
      <input name="price" type="number" step="0.01"
             value="{{ product.price if product and product.price is defined else 0 }}">
    </div>

    <div>
      <label>Stock</label>
      <input name="stock" type="number"
             value="{{ product.stock if product and product.stock is defined else 0 }}">
    </div>

    <div>
      <label>Estado</label>
      {% set st = product.status if product and product.status is defined else 'active' %}
      <select name="status">
        <option value="active" {% if st == 'active' %}selected{% endif %}>Activo</option>
        <option value="draft" {% if st == 'draft' %}selected{% endif %}>Borrador</option>
        <option value="hidden" {% if st == 'hidden' %}selected{% endif %}>Oculto</option>
      </select>
    </div>
  </section>

  <!-- ================= CATEGORÃA / ORIGEN ================= -->
  <section class="row cols3">
    <div>
      <label>CategorÃ­a</label>
      <select name="category_id">
        <option value="">(sin categorÃ­a)</option>
        {% for c in categories %}
          <option value="{{ c.id }}"
                  {% if product and product.category_id is defined and product.category_id == c.id %}selected{% endif %}>
            {{ c.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Origen del producto</label>
      {% set src = product.source if product and product.source is defined else 'manual' %}
      <select name="source">
        <option value="manual" {% if src == 'manual' %}selected{% endif %}>Manual</option>
        <option value="printful" {% if src == 'printful' %}selected{% endif %}>Printful</option>
        <option value="dropship" {% if src == 'dropship' %}selected{% endif %}>Dropshipping</option>
        <option value="temu" {% if src == 'temu' %}selected{% endif %}>Temu</option>
      </select>
    </div>

    <div>
      <label>Link externo (opcional)</label>
      <input name="external_url"
             placeholder="https://proveedor.com/producto"
             value="{{ product.external_url if product and product.external_url is defined else '' }}">
    </div>
  </section>

  <!-- ================= IMAGEN ================= -->
  <section class="row cols2" style="align-items:start">
    <div>
      <label>Imagen del producto</label>
      <input name="image" type="file" accept=".png,.jpg,.jpeg,.webp">
      <p class="muted" style="margin:.5rem 0 0;font-size:.85rem">
        Se guarda en <code>/static/uploads/products</code>
      </p>
    </div>

    <div>
      <label>Vista previa</label>
      <div style="border:1px solid rgba(148,163,184,.16);
                  border-radius:16px;
                  padding:10px;
                  background:rgba(255,255,255,.04);
                  display:flex;
                  gap:12px;
                  align-items:center">

        <div style="width:72px;height:72px;
                    border-radius:14px;
                    overflow:hidden;
                    border:1px solid rgba(148,163,184,.16);
                    background:rgba(255,255,255,.06);
                    display:grid;place-items:center">
          {% if product and product.image_url %}
            <img src="{{ product.image_url }}"
                 alt="Imagen producto"
                 style="width:100%;height:100%;object-fit:cover">
          {% else %}
            <span class="muted" style="font-size:.8rem">Sin imagen</span>
          {% endif %}
        </div>

        <div class="muted" style="font-size:.9rem;word-break:break-all">
          {% if product and product.image_url %}
            <div style="font-weight:950;color:#e5e7eb">Imagen cargada</div>
            {{ product.image_url }}
          {% else %}
            No hay imagen asignada
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <!-- ================= ACCIONES ================= -->
  <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
    <button class="btn" type="submit">ðŸ’¾ Guardar producto</button>
    <a class="btn2" href="{{ url_for('admin.products_list') }}">â¬… Volver</a>

    {% if product %}
      <button class="btn2"
              type="submit"
              formaction="{{ url_for('admin.products_delete', product_id=product.id) }}"
              formmethod="post"
              onclick="return confirm('Â¿Eliminar este producto definitivamente?')">
        ðŸ—‘ Eliminar
      </button>
    {% endif %}
  </div>

</form>

{% endblock %}
