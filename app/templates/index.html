{# app/templates/index.html â€” Skyline Store (PRO v15.1 Â· +10 mejoras Â· NO-500)
   âœ… VISIBLES: hero full overlay tipo referencia, topTrust 4, badges, CTA, cards, grid, separadores, sticky, toTop
   âœ… NO-500: safe urls / safe vars / safe fallbacks
   âœ… Cache-bust real: HOME_CSS_VER con fallback a "15"
#}
{% extends "base.html" %}

{% block title %}{{ meta_title | default("Skyline Store Â· Tech + Streetwear premium", true) }}{% endblock %}

{% block extra_head %}
  {# ---------------- SAFE env/request ---------------- #}
  {% set _env = (ENV if ENV is defined and ENV else 'production')|string|lower|trim %}
  {% set _req = (request if request is defined and request else none) %}
  {% set _base_url = (_req.base_url if _req and _req.base_url else '/') %}
  {% set _root = (_req.url_root if _req and _req.url_root else '/') %}

  {# ---------------- Assets ---------------- #}
  {% set hero_img = url_for('static', filename='img/banners/hero_home.png') %}
  {% set og_img_local = url_for('static', filename='img/og.png') %}
  {% set og_img = (og_image if og_image is defined and og_image else og_img_local) %}

  {% set _desc = (meta_description | default('Moda urbana premium, accesorios y tecnologÃ­a.', true))|string %}
  <meta name="description" content="{{ _desc|trim|e }}">
  <meta name="robots" content="{{ 'index,follow' if _env == 'production' else 'noindex,nofollow' }}">

  <link rel="canonical" href="{{ _base_url }}">
  <meta property="og:url" content="{{ _base_url }}">
  <meta property="og:site_name" content="Skyline Store">
  <meta name="theme-color" content="#2563eb">

  {% set _t = (meta_title | default('Skyline Store Â· Tech + Streetwear premium', true))|string %}
  <meta property="og:title" content="{{ _t|e }}">
  <meta property="og:description" content="{{ (meta_description | default('ComprÃ¡ fÃ¡cil, rÃ¡pido y seguro.', true))|string|trim|e }}">
  <meta property="og:type" content="website">
  <meta property="og:image" content="{{ og_img }}">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="preload" as="image" href="{{ hero_img }}" fetchpriority="high">

  {# âœ… Cache-bust REAL (si no definÃ­s HOME_CSS_VER, usa 15) #}
  {% set _home_css_ver = (HOME_CSS_VER if HOME_CSS_VER is defined and HOME_CSS_VER else '15')|string|trim %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}?v={{ _home_css_ver|e }}">

  {# CSP nonce #}
  {% set _csp_nonce = (csp_nonce if csp_nonce is defined and csp_nonce else (nonce if nonce is defined and nonce else '')) %}

  <script type="application/ld+json"{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
  {
    "@context":"https://schema.org",
    "@graph":[
      {"@type":"Organization","name":"Skyline Store","url":"{{ _root|e }}","logo":"{{ url_for('static', filename='img/og.png', _external=True) }}"},
      {"@type":"WebSite","name":"Skyline Store","url":"{{ _root|e }}",
        "potentialAction":{"@type":"SearchAction","target":"{{ (_root ~ 'shop?q={search_term_string}')|e }}","query-input":"required name=search_term_string"}
      },
      {"@type":"WebPage","name":"{{ _t|e }}","url":"{{ _base_url|e }}",
        "primaryImageOfPage":{"@type":"ImageObject","url":"{{ hero_img|e }}"}
      }
    ]
  }
  </script>
{% endblock %}

{% block content %}
  {# ---------------- SAFE routing ---------------- #}
  {% set _vf = (view_functions if view_functions is defined and view_functions else {}) %}

  {% set shop_url = (url_for('shop.shop') if 'shop.shop' in _vf else '/shop') %}
  {% set offers_url = shop_url ~ ('?ofertas=1' if '?' not in shop_url else '&ofertas=1') %}

  {% set account_url = (url_for('main.account') if 'main.account' in _vf else ('/account' if '/account' else '/auth/account')) %}
  {% set account_login_url = account_url ~ ('?tab=login' if '?' not in account_url else '&tab=login') %}
  {% set account_register_url = account_url ~ ('?tab=register' if '?' not in account_url else '&tab=register') %}

  {# si tu base tiene un buscador en header, esto al menos baja a tienda/categorÃ­as #}
  {% set search_anchor = '#hpCats' %}

  {% set featured_list = (featured if featured is defined and featured else []) %}
  {% set _hero_overlay = "linear-gradient(90deg, rgba(255,255,255,.92) 0%, rgba(255,255,255,.82) 46%, rgba(255,255,255,.35) 72%, rgba(255,255,255,0) 100%)" %}

  <div class="hp hp-v15" id="hp" role="main" aria-label="Inicio Skyline Store">

    {# ==========================================================
       TOP TRUST (4 items) â€” como referencia
    ========================================================== #}
    <section class="hp-top" aria-label="Beneficios">
      <div class="hp-wrap">
        <ul class="hp-topTrust" role="list">
          <li class="hp-topTrust__item" role="listitem"><span class="hp-ico" aria-hidden="true">ðŸ”’</span><div><b>Pago protegido</b><small>Soporte y respaldo</small></div></li>
          <li class="hp-topTrust__item" role="listitem"><span class="hp-ico" aria-hidden="true">ðŸšš</span><div><b>EnvÃ­os con tracking</b><small>Seguimiento del pedido</small></div></li>
          <li class="hp-topTrust__item" role="listitem"><span class="hp-ico" aria-hidden="true">âš¡</span><div><b>Compra rÃ¡pida</b><small>Checkout optimizado</small></div></li>
          <li class="hp-topTrust__item" role="listitem"><span class="hp-ico" aria-hidden="true">ðŸ’¬</span><div><b>Soporte 24/7</b><small>AtenciÃ³n dedicada</small></div></li>
        </ul>
      </div>
    </section>

    {# ==========================================================
       HERO â€” replicando referencia (overlay + imagen grande)
    ========================================================== #}
    <section class="hp-hero hp-heroFull" aria-labelledby="hpTitle"
      style="--hero-url:url('{{ hero_img }}'); --hero-overlay: {{ _hero_overlay }};">
      <div class="hp-wrap hp-hero__grid">

        <div class="hp-hero__copy">
          <div class="hp-kickerRow">
            <span class="hp-kicker">SKYLINE STORE</span>
            <span class="hp-verified" aria-label="Verificado">Verificado</span>
            <span class="hp-pill" data-pill data-target="{{ search_anchor }}" role="button" tabindex="0" aria-label="Ir a categorÃ­as">CategorÃ­as</span>
            <span class="hp-pill" data-pill data-target="#hpGrid" role="button" tabindex="0" aria-label="Ir a destacados">Destacados</span>
          </div>

          <h1 id="hpTitle" class="hp-title">
            Tech + Streetwear <span class="hp-grad">premium</span>
          </h1>

          <p class="hp-sub">
            Una selecciÃ³n real de <b>moda urbana</b>, <b>accesorios</b> y <b>tecnologÃ­a</b>.
            ComprÃ¡ seguro, con soporte y experiencia de marca.
          </p>

          <div class="hp-mini" role="list" aria-label="Diferenciales">
            <div class="hp-mini__item" role="listitem"><b>Curado</b><span>Productos elegidos</span></div>
            <div class="hp-mini__item" role="listitem"><b>Ofertas</b><span>Promos reales</span></div>
            <div class="hp-mini__item" role="listitem"><b>Drops</b><span>Marca propia</span></div>
          </div>

          <div class="hp-ctas" role="group" aria-label="Acciones principales">
            <a href="{{ shop_url }}" class="btn primary">Explorar tienda</a>
            <a href="{{ offers_url }}" class="btn ghost">Ver ofertas</a>
            <a href="{{ account_login_url }}" class="btn soft" aria-label="Ingresar o crear cuenta">Mi cuenta</a>
          </div>

          <div class="hp-chips" aria-label="GarantÃ­as" role="list">
            <span class="hp-chip" role="listitem">âœ… Soporte post-compra</span>
            <span class="hp-chip" role="listitem">âœ… Seguimiento del pedido</span>
            <span class="hp-chip" role="listitem">âœ… PolÃ­ticas claras</span>
          </div>
        </div>

        <div class="hp-hero__media" aria-label="Imagen principal">
          <figure class="hp-heroCard is-heroFull" data-reveal style="--hero-url:url('{{ hero_img }}');">
            <div class="hp-heroGlow" aria-hidden="true"></div>

            <img
              src="{{ hero_img }}"
              alt="Skyline Store: tecnologÃ­a y streetwear premium"
              width="1600"
              height="900"
              loading="eager"
              decoding="async"
              fetchpriority="high"
              class="hp-heroImg"
              onerror="this.onerror=null; this.src='{{ hero_img }}'; this.style.opacity='.01'; this.closest('.hp-heroCard')?.classList.add('is-fallback');">

            <figcaption class="hp-heroCap">
              <b>Curado por calidad</b>
              <span>Productos elegidos + ofertas reales</span>
            </figcaption>
          </figure>

          <div class="hp-stats" aria-label="Indicadores de confianza" role="list">
            <div class="hp-stat" role="listitem"><b>Marketplace</b><span>CatÃ¡logo en crecimiento</span></div>
            <div class="hp-stat" role="listitem"><b>Marca propia</b><span>Streetwear Skyline</span></div>
            <div class="hp-stat" role="listitem"><b>Compra segura</b><span>Soporte y polÃ­ticas claras</span></div>
          </div>
        </div>

      </div>
    </section>

    {# ==========================================================
       TRUST CARDS (con tus PNG)
    ========================================================== #}
    <section class="hp-trust" aria-label="Confianza y seguridad">
      <div class="hp-wrap hp-trust__grid">
        {% set trust = [
          {'img':'img/banners/service_payment.png','title':'Pago seguro','desc':'Transacciones protegidas y soporte'},
          {'img':'img/banners/service_shipping.png','title':'EnvÃ­o con tracking','desc':'Seguimiento de tu pedido'},
          {'img':'img/banners/service_support.png','title':'Soporte real','desc':'AtenciÃ³n y ayuda post-compra'}
        ] %}
        {% for t in trust %}
          <article class="hp-trustCard" data-reveal aria-label="{{ t.title|e }}">
            <div class="hp-trustCard__img" aria-hidden="true">
              <img src="{{ url_for('static', filename=t.img) }}" alt="" loading="lazy" decoding="async" class="hp-trustIcon">
            </div>
            <div class="hp-trustCard__meta">
              <b>{{ t.title|e }}</b>
              <span>{{ t.desc|e }}</span>
            </div>
          </article>
        {% endfor %}
      </div>
    </section>

    {# ==========================================================
       CATEGORIES â€” tipo marketplace
    ========================================================== #}
    <section class="hp-cats" aria-labelledby="hpCats" id="hpCats">
      <div class="hp-wrap">
        <div class="hp-secHead">
          <div>
            <h2>ElegÃ­ una categorÃ­a</h2>
            <p>Accesos directos tipo marketplace.</p>
          </div>
          <a class="hp-linkMore" href="{{ shop_url }}">Ver todo â†’</a>
        </div>

        {% set cats = [
          {'label':'Ropa urbana','img':'img/banners/cat_women.png','href': shop_url ~ ('?categoria=ropa' if '?' not in shop_url else '&categoria=ropa')},
          {'label':'Accesorios','img':'img/banners/cat_accessories.png','href': shop_url ~ ('?categoria=accesorios' if '?' not in shop_url else '&categoria=accesorios')},
          {'label':'TecnologÃ­a','img':'img/banners/cat_tech.png','href': shop_url ~ ('?categoria=tecnologia' if '?' not in shop_url else '&categoria=tecnologia')},
          {'label':'Ofertas','img':'img/banners/promo_week.png','href': offers_url}
        ] %}

        <div class="hp-catsGrid" role="list">
          {% for c in cats %}
            <a class="hp-catCard" data-reveal href="{{ c.href }}" aria-label="{{ c.label|e }}" role="listitem">
              <div class="hp-catCard__media" aria-hidden="true">
                <img src="{{ url_for('static', filename=c.img) }}" alt="" loading="lazy" decoding="async" class="hp-catImg"
                     onerror="this.onerror=null; this.src='{{ hero_img }}'; this.style.opacity='.92';">
              </div>
              <div class="hp-catCard__overlay">
                <b>{{ c.label|e }}</b>
                <span>Explorar â†’</span>
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    </section>

    {# ==========================================================
       FEATURED
    ========================================================== #}
    <section class="hp-featured" aria-labelledby="hpFeat" id="hpGrid">
      <div class="hp-wrap">
        <div class="hp-secHead">
          <div>
            <h2 id="hpFeat">Destacados</h2>
            <p>SelecciÃ³n recomendada para arrancar.</p>
          </div>
          <a class="hp-linkMore" href="{{ offers_url }}">Ofertas â†’</a>
        </div>

        <div class="hp-products" {% if featured_list|length > 0 %}role="list"{% endif %}>
          {% if featured_list|length == 0 %}
            <div class="hp-empty" aria-live="polite">
              <b>Estamos armando los destacados</b>
              <p>Mientras tanto, explorÃ¡ el catÃ¡logo completo y mirÃ¡ las ofertas.</p>
              <div class="hp-empty__actions" role="group" aria-label="Acciones recomendadas">
                <a class="btn primary" href="{{ shop_url }}">Ir a la tienda</a>
                <a class="btn ghost" href="{{ offers_url }}">Ver ofertas</a>
                <a class="btn soft" href="{{ account_register_url }}">Crear cuenta</a>
              </div>
            </div>
          {% else %}
            {% for p in featured_list %}
              {% set p_title = (p.title if p and p.title is defined and p.title else (p.get('title') if p is mapping and p.get('title') else 'Producto'))|string %}
              {% set p_href  = (p.href  if p and p.href  is defined and p.href  else (p.get('href')  if p is mapping and p.get('href')  else shop_url))|string %}
              {% set p_img   = (p.img   if p and p.img   is defined and p.img   else (p.get('img')   if p is mapping and p.get('img')   else hero_img))|string %}

              <article class="hp-prod" data-reveal aria-label="{{ p_title|e }}" role="listitem">
                <a class="hp-prod__img" href="{{ p_href|e }}" aria-label="{{ p_title|e }}">
                  <img src="{{ p_img|e }}" alt="{{ p_title|e }}" loading="lazy" decoding="async" class="hp-prodImg"
                       onerror="this.onerror=null; this.src='{{ hero_img }}'; this.style.opacity='.92';">
                </a>

                <div class="hp-prod__meta">
                  <b class="hp-prod__title">{{ p_title|e }}</b>
                  <div class="hp-prod__price" aria-label="Precio">
                    {% with product=p %}{% include "components/price.html" ignore missing %}{% endwith %}
                  </div>
                  <div class="hp-prod__micro" aria-label="Beneficios del producto">
                    <span class="hp-microChip">âš¡ EnvÃ­o rÃ¡pido</span>
                    <span class="hp-microChip">ðŸ”’ Pago seguro</span>
                  </div>
                </div>

                <div class="hp-prod__actions" role="group" aria-label="Acciones del producto">
                  <a class="btn primary" href="{{ p_href|e }}">Ver</a>
                  <a class="btn ghost" href="{{ shop_url }}">MÃ¡s</a>
                </div>
              </article>
            {% endfor %}
          {% endif %}
        </div>
      </div>
    </section>

    {# ==========================================================
       CTA FINAL
    ========================================================== #}
    <section class="hp-cta" aria-label="Llamado a la acciÃ³n final">
      <div class="hp-wrap hp-cta__inner" data-reveal>
        <div>
          <h2 class="hp-cta__title">ComprÃ¡ con confianza</h2>
          <p class="hp-cta__sub">Marketplace + marca propia. EnvÃ­os con seguimiento y soporte real.</p>
        </div>
        <div class="hp-cta__btns" role="group" aria-label="Acciones finales">
          <a class="btn primary" href="{{ shop_url }}">Empezar ahora</a>
          <a class="btn soft" href="{{ account_register_url }}">Crear cuenta</a>
        </div>
      </div>
    </section>

    {# ==========================================================
       Sticky + ToTop
    ========================================================== #}
    <div class="hp-sticky" id="hpSticky" role="region" aria-label="Barra fija de ofertas">
      <div class="hp-sticky__txt">
        <b>Skyline Store</b>
        <span>ExplorÃ¡ ofertas premium</span>
      </div>
      <a href="{{ offers_url }}" class="hp-sticky__btn" aria-label="Ir a ofertas">Comprar</a>
    </div>

    <button id="toTop" type="button" class="to-top" aria-label="Volver arriba" hidden>â†‘</button>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="{{ url_for('static', filename='js/home.js') }}?v=15" defer></script>

  {# âœ… Patch NO-500 + UX (no rompe si faltan nodos) #}
  <script{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
  (function(){
    "use strict";
    const root = document.getElementById("hp");
    if(!root) return;

    // pills: click + teclado
    root.querySelectorAll("[data-pill][data-target]").forEach(el=>{
      const go = () => {
        const sel = el.getAttribute("data-target");
        if(!sel) return;
        const node = document.querySelector(sel);
        if(node) node.scrollIntoView({behavior:"smooth", block:"start"});
        else window.location.href = "{{ shop_url|e }}";
      };
      el.addEventListener("click", go);
      el.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" || e.key === " "){ e.preventDefault(); go(); }
      });
    });

    // sticky + toTop: activa cuando el hero sale
    const sticky = document.getElementById("hpSticky");
    const toTop = document.getElementById("toTop");
    const hero = root.querySelector(".hp-hero");
    const setOn = (on)=>{
      if(sticky) sticky.classList.toggle("is-on", !!on);
      if(toTop){
        toTop.hidden = !on;
        toTop.style.display = on ? "inline-flex" : "none";
      }
    };

    if(toTop){
      toTop.addEventListener("click", ()=> window.scrollTo({top:0, behavior:"smooth"}));
    }

    if("IntersectionObserver" in window && hero){
      const io = new IntersectionObserver((entries)=>{
        const e = entries[0];
        setOn(!e.isIntersecting);
      }, {threshold: 0.15});
      io.observe(hero);
    } else {
      // fallback bÃ¡sico
      window.addEventListener("scroll", ()=>{
        setOn(window.scrollY > 420);
      }, {passive:true});
    }
  })();
  </script>
{% endblock %}
