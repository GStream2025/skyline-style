{# app/templates/index.html ‚Äî Skyline Store (ULTRA PRO v16.1 ¬∑ +20 MEJORAS ¬∑ NO-500 ¬∑ ‚ÄúSE APLICA S√ç O S√ç‚Äù)
   ‚úÖ FIX CLAVE: clase hp-v161 + cache-bust 161 (si no, se ve ‚Äúigual‚Äù)
   ‚úÖ NO-500: request/env safe, urls safe, fallbacks robustos
   ‚úÖ SEO: canonical robusto + OG/Twitter completos + preconnect/preload correctos
   ‚úÖ PERF: prefetch shop, dns-prefetch, fetchpriority, lazy/decoding, reduce CLS
   ‚úÖ A11y: aria mejorado + skip targets + roles correctos
   ‚úÖ JS: pills/sticky/toTop robusto + reduced-motion + no doble init
   ‚úÖ COMPAT: no rompe si faltan endpoints/blueprints/components/price
#}
{% extends "base.html" %}

{% block title %}{{ meta_title | default("Skyline Store ¬∑ Tech + Streetwear premium", true) }}{% endblock %}

{% block extra_head %}
  {# ---------------- SAFE env/request ---------------- #}
  {% set _env = (ENV if ENV is defined and ENV else 'production')|string|lower|trim %}
  {% set _req = (request if request is defined and request else none) %}

  {# base_url/canonical robusto: evita querystring y evita None #}
  {% set _base_url = (_req.base_url if _req and _req.base_url else '/') %}
  {% set _root = (_req.url_root if _req and _req.url_root else '/') %}

  {# ---------------- Assets ---------------- #}
  {% set hero_img = url_for('static', filename='img/banners/hero_home.png') %}
  {% set og_img_local = url_for('static', filename='img/og.png') %}
  {% set og_img = (og_image if og_image is defined and og_image else og_img_local) %}

  {# SEO safe strings #}
  {% set _desc = (meta_description | default('Moda urbana premium, accesorios y tecnolog√≠a.', true))|string|trim %}
  {% set _t = (meta_title | default('Skyline Store ¬∑ Tech + Streetwear premium', true))|string|trim %}

  <meta name="description" content="{{ _desc|e }}">
  <meta name="robots" content="{{ 'index,follow' if _env == 'production' else 'noindex,nofollow' }}">

  <link rel="canonical" href="{{ _base_url|e }}">
  <meta property="og:url" content="{{ _base_url|e }}">
  <meta property="og:site_name" content="Skyline Store">
  <meta name="theme-color" content="#2563eb">

  <meta property="og:title" content="{{ _t|e }}">
  <meta property="og:description" content="{{ (meta_description | default('Compr√° f√°cil, r√°pido y seguro.', true))|string|trim|e }}">
  <meta property="og:type" content="website">
  <meta property="og:image" content="{{ og_img|e }}">
  <meta property="og:image:alt" content="Skyline Store ¬∑ Tech + Streetwear premium">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ _t|e }}">
  <meta name="twitter:description" content="{{ _desc|e }}">
  <meta name="twitter:image" content="{{ og_img|e }}">

  {# PERF: preload hero (LCP) + preconnect/dns-prefetch #}
  <link rel="preload" as="image" href="{{ hero_img|e }}" fetchpriority="high">
  <link rel="preconnect" href="{{ _root|e }}">
  <link rel="dns-prefetch" href="{{ _root|e }}">

  {# ‚úÖ Cache-bust REAL (default 161) ‚Äî SI NO CAMBIAS ESTO, se ve igual por cache #}
  {% set _home_css_ver = (HOME_CSS_VER if HOME_CSS_VER is defined and HOME_CSS_VER else '161')|string|trim %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}?v={{ _home_css_ver|e }}">

  {# PERF: prefetch tienda (mejora navegaci√≥n) #}
  <link rel="prefetch" href="{{ url_for('shop.shop') if (view_functions is defined and view_functions and 'shop.shop' in view_functions) else '/shop' }}">

  {# CSP nonce #}
  {% set _csp_nonce = (csp_nonce if csp_nonce is defined and csp_nonce else (nonce if nonce is defined and nonce else '')) %}

  <script type="application/ld+json"{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
  {
    "@context":"https://schema.org",
    "@graph":[
      {"@type":"Organization","name":"Skyline Store","url":"{{ _root|e }}","logo":"{{ url_for('static', filename='img/og.png', _external=True) }}"},
      {"@type":"WebSite","name":"Skyline Store","url":"{{ _root|e }}",
        "potentialAction":{"@type":"SearchAction","target":"{{ (_root ~ 'shop?q={search_term_string}')|e }}","query-input":"required name=search_term_string"}
      },
      {"@type":"WebPage","name":"{{ _t|e }}","url":"{{ _base_url|e }}",
        "primaryImageOfPage":{"@type":"ImageObject","url":"{{ hero_img|e }}"}
      }
    ]
  }
  </script>
{% endblock %}

{% block content %}
  {# ---------------- SAFE routing ---------------- #}
  {% set _vf = (view_functions if view_functions is defined and view_functions else {}) %}

  {% set shop_url = (url_for('shop.shop') if 'shop.shop' in _vf else '/shop') %}
  {% set offers_url = shop_url ~ ('?ofertas=1' if '?' not in shop_url else '&ofertas=1') %}

  {# ‚úÖ FIX real de account_url (robusto multi-blueprint) #}
  {% set account_url =
      (url_for('main.account') if 'main.account' in _vf
        else (url_for('account.account') if 'account.account' in _vf
          else (url_for('cuenta.account') if 'cuenta.account' in _vf
            else '/account')))
  %}
  {% set account_login_url = account_url ~ ('?tab=login' if '?' not in account_url else '&tab=login') %}
  {% set account_register_url = account_url ~ ('?tab=register' if '?' not in account_url else '&tab=register') %}

  {% set search_anchor = '#hpCats' %}
  {% set featured_list = (featured if featured is defined and featured else []) %}

  {# overlay tipo referencia (texto a la izquierda + imagen fuerte) #}
  {% set _hero_overlay =
    "linear-gradient(90deg, rgba(255,255,255,.94) 0%, rgba(255,255,255,.86) 46%, rgba(255,255,255,.42) 72%, rgba(255,255,255,0) 100%)"
  %}

  {# ‚úÖ FIX CLAVE: hp-v161 fuerza tu CSS v16.1 ‚Äî SIN ESTO SE VE ‚ÄúIGUAL‚Äù #}
  <div class="hp hp-v15 hp-v161" id="hp" role="main" aria-label="Inicio Skyline Store">

    {# ==========================================================
       TOP TRUST (4 items)
    ========================================================== #}
    <section class="hp-top" aria-label="Beneficios">
      <div class="hp-wrap">
        <ul class="hp-topTrust" role="list">
          <li class="hp-topTrust__item" role="listitem"><span class="hp-ico" aria-hidden="true">üîí</span><div><b>Pago protegido</b><small>Soporte y respaldo</small></div></li>
          <li class="hp-topTrust__item" role="listitem"><span class="hp-ico" aria-hidden="true">üöö</span><div><b>Env√≠os con tracking</b><small>Seguimiento del pedido</small></div></li>
          <li class="hp-topTrust__item" role="listitem"><span class="hp-ico" aria-hidden="true">‚ö°</span><div><b>Compra r√°pida</b><small>Checkout optimizado</small></div></li>
          <li class="hp-topTrust__item" role="listitem"><span class="hp-ico" aria-hidden="true">üí¨</span><div><b>Soporte 24/7</b><small>Atenci√≥n dedicada</small></div></li>
        </ul>
      </div>
    </section>

    {# ==========================================================
       HERO FULL ‚Äî replica referencia (fondo grande + overlay)
    ========================================================== #}
    <section class="hp-hero hp-heroFull" aria-labelledby="hpTitle"
      style="--hero-url:url('{{ hero_img }}'); --hero-overlay: {{ _hero_overlay }};">
      <div class="hp-wrap hp-hero__grid">

        <div class="hp-hero__copy">
          <div class="hp-kickerRow">
            <span class="hp-kicker">SKYLINE STORE</span>
            <span class="hp-verified" aria-label="Verificado">Verificado</span>
            <span class="hp-pill" data-pill data-target="{{ search_anchor }}" role="button" tabindex="0" aria-label="Ir a categor√≠as">Categor√≠as</span>
            <span class="hp-pill" data-pill data-target="#hpGrid" role="button" tabindex="0" aria-label="Ir a destacados">Destacados</span>
          </div>

          <h1 id="hpTitle" class="hp-title">
            Tech + Streetwear <span class="hp-grad">premium</span>
          </h1>

          <p class="hp-sub">
            Una selecci√≥n real de <b>moda urbana</b>, <b>accesorios</b> y <b>tecnolog√≠a</b>.
            Compr√° seguro, con soporte y experiencia de marca.
          </p>

          <div class="hp-mini" role="list" aria-label="Diferenciales">
            <div class="hp-mini__item" role="listitem"><b>Curado</b><span>Productos elegidos</span></div>
            <div class="hp-mini__item" role="listitem"><b>Ofertas</b><span>Promos reales</span></div>
            <div class="hp-mini__item" role="listitem"><b>Drops</b><span>Marca propia</span></div>
          </div>

          <div class="hp-ctas" role="group" aria-label="Acciones principales">
            <a href="{{ shop_url }}" class="btn primary">Explorar tienda</a>
            <a href="{{ offers_url }}" class="btn ghost">Ver ofertas</a>
            <a href="{{ account_login_url }}" class="btn soft" aria-label="Ingresar o crear cuenta">Mi cuenta</a>
          </div>

          <div class="hp-chips" aria-label="Garant√≠as" role="list">
            <span class="hp-chip" role="listitem">‚úÖ Soporte post-compra</span>
            <span class="hp-chip" role="listitem">‚úÖ Seguimiento del pedido</span>
            <span class="hp-chip" role="listitem">‚úÖ Pol√≠ticas claras</span>
          </div>
        </div>

        <div class="hp-hero__media" aria-label="Imagen principal">
          <figure class="hp-heroCard is-heroFull" data-reveal style="--hero-url:url('{{ hero_img }}');">
            <div class="hp-heroGlow" aria-hidden="true"></div>

            <img
              src="{{ hero_img }}"
              alt="Skyline Store: tecnolog√≠a y streetwear premium"
              width="1600"
              height="900"
              loading="eager"
              decoding="async"
              fetchpriority="high"
              class="hp-heroImg"
              onerror="this.onerror=null; this.remove(); this.closest('.hp-heroCard')?.classList.add('is-fallback');">

            <figcaption class="hp-heroCap">
              <b>Curado por calidad</b>
              <span>Productos elegidos + ofertas reales</span>
            </figcaption>
          </figure>

          <div class="hp-stats" aria-label="Indicadores de confianza" role="list">
            <div class="hp-stat" role="listitem"><b>Marketplace</b><span>Cat√°logo en crecimiento</span></div>
            <div class="hp-stat" role="listitem"><b>Marca propia</b><span>Streetwear Skyline</span></div>
            <div class="hp-stat" role="listitem"><b>Compra segura</b><span>Soporte y pol√≠ticas claras</span></div>
          </div>
        </div>

      </div>
    </section>

    {# ==========================================================
       TRUST CARDS
    ========================================================== #}
    <section class="hp-trust" aria-label="Confianza y seguridad">
      <div class="hp-wrap hp-trust__grid">
        {% set trust = [
          {'img':'img/banners/service_payment.png','title':'Pago seguro','desc':'Transacciones protegidas y soporte'},
          {'img':'img/banners/service_shipping.png','title':'Env√≠o con tracking','desc':'Seguimiento de tu pedido'},
          {'img':'img/banners/service_support.png','title':'Soporte real','desc':'Atenci√≥n y ayuda post-compra'}
        ] %}
        {% for t in trust %}
          <article class="hp-trustCard" data-reveal aria-label="{{ t.title|e }}">
            <div class="hp-trustCard__img" aria-hidden="true">
              <img src="{{ url_for('static', filename=t.img) }}" alt="" loading="lazy" decoding="async" class="hp-trustIcon">
            </div>
            <div class="hp-trustCard__meta">
              <b>{{ t.title|e }}</b>
              <span>{{ t.desc|e }}</span>
            </div>
          </article>
        {% endfor %}
      </div>
    </section>

    {# ==========================================================
       CATEGORIES
    ========================================================== #}
    <section class="hp-cats" aria-labelledby="hpCats" id="hpCats">
      <div class="hp-wrap">
        <div class="hp-secHead">
          <div>
            <h2 id="hpCats">Eleg√≠ una categor√≠a</h2>
            <p>Accesos directos tipo marketplace.</p>
          </div>
          <a class="hp-linkMore" href="{{ shop_url }}">Ver todo ‚Üí</a>
        </div>

        {% set cats = [
          {'label':'Ropa urbana','img':'img/banners/cat_women.png','href': shop_url ~ ('?categoria=ropa' if '?' not in shop_url else '&categoria=ropa')},
          {'label':'Accesorios','img':'img/banners/cat_accessories.png','href': shop_url ~ ('?categoria=accesorios' if '?' not in shop_url else '&categoria=accesorios')},
          {'label':'Tecnolog√≠a','img':'img/banners/cat_tech.png','href': shop_url ~ ('?categoria=tecnologia' if '?' not in shop_url else '&categoria=tecnologia')},
          {'label':'Ofertas','img':'img/banners/promo_week.png','href': offers_url}
        ] %}

        <div class="hp-catsGrid" role="list">
          {% for c in cats %}
            <a class="hp-catCard" data-reveal href="{{ c.href }}" aria-label="{{ c.label|e }}" role="listitem">
              <div class="hp-catCard__media" aria-hidden="true">
                <img src="{{ url_for('static', filename=c.img) }}" alt="" loading="lazy" decoding="async" class="hp-catImg"
                     onerror="this.onerror=null; this.src='{{ hero_img }}'; this.style.opacity='.92';">
              </div>
              <div class="hp-catCard__overlay">
                <b>{{ c.label|e }}</b>
                <span>Explorar ‚Üí</span>
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    </section>

    {# ==========================================================
       FEATURED
    ========================================================== #}
    <section class="hp-featured" aria-labelledby="hpFeat" id="hpGrid">
      <div class="hp-wrap">
        <div class="hp-secHead">
          <div>
            <h2 id="hpFeat">Destacados</h2>
            <p>Selecci√≥n recomendada para arrancar.</p>
          </div>
          <a class="hp-linkMore" href="{{ offers_url }}">Ofertas ‚Üí</a>
        </div>

        <div class="hp-products" {% if featured_list|length > 0 %}role="list"{% endif %}>
          {% if featured_list|length == 0 %}
            <div class="hp-empty" aria-live="polite">
              <b>Estamos armando los destacados</b>
              <p>Mientras tanto, explor√° el cat√°logo completo y mir√° las ofertas.</p>
              <div class="hp-empty__actions" role="group" aria-label="Acciones recomendadas">
                <a class="btn primary" href="{{ shop_url }}">Ir a la tienda</a>
                <a class="btn ghost" href="{{ offers_url }}">Ver ofertas</a>
                <a class="btn soft" href="{{ account_register_url }}">Crear cuenta</a>
              </div>
            </div>
          {% else %}
            {% for p in featured_list %}
              {% set p_title = (p.title if p and p.title is defined and p.title else (p.get('title') if p is mapping and p.get('title') else 'Producto'))|string %}
              {% set p_href  = (p.href  if p and p.href  is defined and p.href  else (p.get('href')  if p is mapping and p.get('href')  else shop_url))|string %}
              {% set p_img   = (p.img   if p and p.img   is defined and p.img   else (p.get('img')   if p is mapping and p.get('img')   else hero_img))|string %}

              <article class="hp-prod" data-reveal aria-label="{{ p_title|e }}" role="listitem">
                <a class="hp-prod__img" href="{{ p_href|e }}" aria-label="{{ p_title|e }}">
                  <img src="{{ p_img|e }}" alt="{{ p_title|e }}" loading="lazy" decoding="async" class="hp-prodImg"
                       onerror="this.onerror=null; this.src='{{ hero_img }}'; this.style.opacity='.92';">
                </a>

                <div class="hp-prod__meta">
                  <b class="hp-prod__title">{{ p_title|e }}</b>
                  <div class="hp-prod__price" aria-label="Precio">
                    {% with product=p %}{% include "components/price.html" ignore missing %}{% endwith %}
                  </div>
                  <div class="hp-prod__micro" aria-label="Beneficios del producto">
                    <span class="hp-microChip">‚ö° Env√≠o r√°pido</span>
                    <span class="hp-microChip">üîí Pago seguro</span>
                  </div>
                </div>

                <div class="hp-prod__actions" role="group" aria-label="Acciones del producto">
                  <a class="btn primary" href="{{ p_href|e }}">Ver</a>
                  <a class="btn ghost" href="{{ shop_url }}">M√°s</a>
                </div>
              </article>
            {% endfor %}
          {% endif %}
        </div>
      </div>
    </section>

    {# ==========================================================
       CTA FINAL
    ========================================================== #}
    <section class="hp-cta" aria-label="Llamado a la acci√≥n final">
      <div class="hp-wrap hp-cta__inner" data-reveal>
        <div>
          <h2 class="hp-cta__title">Compr√° con confianza</h2>
          <p class="hp-cta__sub">Marketplace + marca propia. Env√≠os con seguimiento y soporte real.</p>
        </div>
        <div class="hp-cta__btns" role="group" aria-label="Acciones finales">
          <a class="btn primary" href="{{ shop_url }}">Empezar ahora</a>
          <a class="btn soft" href="{{ account_register_url }}">Crear cuenta</a>
        </div>
      </div>
    </section>

    {# ==========================================================
       Sticky + ToTop
    ========================================================== #}
    <div class="hp-sticky" id="hpSticky" role="region" aria-label="Barra fija de ofertas">
      <div class="hp-sticky__txt">
        <b>Skyline Store</b>
        <span>Explor√° ofertas premium</span>
      </div>
      <a href="{{ offers_url }}" class="hp-sticky__btn" aria-label="Ir a ofertas">Comprar</a>
    </div>

    <button id="toTop" type="button" class="to-top" aria-label="Volver arriba" hidden>‚Üë</button>
  </div>
{% endblock %}

{% block extra_js %}
  {# ‚úÖ Cache-bust JS (161) ‚Äî evita que quede el home.js viejo #}
  <script src="{{ url_for('static', filename='js/home.js') }}?v=161" defer></script>

  {# ‚úÖ Patch NO-500 + UX (robusto) #}
  <script{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
  (function(){
    "use strict";

    // anti doble init
    if (window.__SS_HP_PATCH_161__) return;
    window.__SS_HP_PATCH_161__ = true;

    const root = document.getElementById("hp");
    if(!root) return;

    const reducedMotion = !!(window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches);

    // pills: click + teclado
    root.querySelectorAll("[data-pill][data-target]").forEach(function(el){
      const go = function(){
        const sel = el.getAttribute("data-target");
        if(!sel) return;

        const node = sel.charAt(0) === "#"
          ? document.getElementById(sel.slice(1))
          : document.querySelector(sel);

        if(node){
          try{
            node.scrollIntoView({behavior: reducedMotion ? "auto" : "smooth", block:"start"});
          }catch(_){
            node.scrollIntoView(true);
          }
        } else {
          window.location.href = "{{ shop_url|e }}";
        }
      };

      el.addEventListener("click", go);
      el.addEventListener("keydown", function(e){
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          go();
        }
      });
    });

    // sticky + toTop
    const sticky = document.getElementById("hpSticky");
    const toTop = document.getElementById("toTop");
    const hero = root.querySelector(".hp-hero");

    const setOn = function(on){
      if(sticky) sticky.classList.toggle("is-on", !!on);
      if(toTop){
        toTop.hidden = !on;
        toTop.style.display = on ? "inline-flex" : "none";
      }
    };

    if(toTop){
      toTop.addEventListener("click", function(){
        try{
          window.scrollTo({top:0, behavior: reducedMotion ? "auto" : "smooth"});
        }catch(_){
          window.scrollTo(0,0);
        }
      });
    }

    if("IntersectionObserver" in window && hero){
      const io = new IntersectionObserver(function(entries){
        const e = entries && entries[0];
        if(!e) return;
        setOn(!e.isIntersecting);
      }, {threshold: 0.12});
      io.observe(hero);
    } else {
      window.addEventListener("scroll", function(){ setOn((window.scrollY||0) > 420); }, {passive:true});
    }
  })();
  </script>
{% endblock %}
