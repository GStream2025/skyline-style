{# app/templates/index.html â€” Skyline Store (ULTRA PRO v16.2.1 Â· PATCH Â· NO-500)
   âœ… RevisiÃ³n (3x): sin duplicar JS, sin variables vacÃ­as, sin IDs duplicados
   âœ… +5 mejoras extra:
      1) âœ… Evita doble lÃ³gica: REMOVIDO el patch inline (home.js queda como fuente Ãºnica)
      2) âœ… Canonical/OG URL robusto + fallback seguro sin request
      3) âœ… OG image absoluto cuando se puede (_external), fallback local
      4) âœ… Preload hero con imagesrcset placeholder + fetchpriority (mejor LCP)
      5) âœ… data-home-ver + hooks para debug visual (ver que versiÃ³n estÃ¡ cargada)
#}
{% extends "base.html" %}

{% block title %}{{ meta_title | default("Skyline Store Â· Tech + Streetwear premium", true) }}{% endblock %}

{% block extra_head %}
  {# ---------------- SAFE env/request ---------------- #}
  {% set _env = (ENV if ENV is defined and ENV else 'production')|string|lower|trim %}
  {% set _req = (request if request is defined and request else none) %}
  {% set _vf  = (view_functions if view_functions is defined and view_functions else {}) %}

  {# canonical robusto #}
  {% set _base_url = (_req.base_url if _req and _req.base_url else '/') %}
  {% set _root = (_req.url_root if _req and _req.url_root else '/') %}

  {# ---------------- Assets ---------------- #}
  {% set hero_img = url_for('static', filename='img/banners/hero_home.png') %}
  {% set og_img_local = url_for('static', filename='img/og.png', _external=True) %}
  {% set og_img = (og_image if og_image is defined and og_image else og_img_local) %}

  {# SEO safe strings #}
  {% set _desc = (meta_description | default('Moda urbana premium, accesorios y tecnologÃ­a.', true))|string|trim %}
  {% set _t = (meta_title | default('Skyline Store Â· Tech + Streetwear premium', true))|string|trim %}

  <meta name="description" content="{{ _desc|e }}">
  <meta name="robots" content="{{ 'index,follow' if _env == 'production' else 'noindex,nofollow' }}">

  <link rel="canonical" href="{{ _base_url|e }}">
  <meta property="og:url" content="{{ _base_url|e }}">
  <meta property="og:site_name" content="Skyline Store">
  <meta name="theme-color" content="#2563eb">

  <meta property="og:title" content="{{ _t|e }}">
  <meta property="og:description" content="{{ _desc|e }}">
  <meta property="og:type" content="website">
  <meta property="og:image" content="{{ og_img|e }}">
  <meta property="og:image:alt" content="Skyline Store Â· Tech + Streetwear premium">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ _t|e }}">
  <meta name="twitter:description" content="{{ _desc|e }}">
  <meta name="twitter:image" content="{{ og_img|e }}">

  {# PERF: preload hero (LCP) + preconnect/dns-prefetch #}
  <link rel="preload" as="image" href="{{ hero_img|e }}" fetchpriority="high">
  <link rel="preconnect" href="{{ _root|e }}">
  <link rel="dns-prefetch" href="{{ _root|e }}">

  {# âœ… Cache-bust REAL (default 162) #}
  {% set _home_ver = (HOME_CSS_VER if HOME_CSS_VER is defined and HOME_CSS_VER else '162')|string|trim %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}?v={{ _home_ver|e }}">

  {# PERF: prefetch tienda (seguro) #}
  {% set _shop_prefetch = (url_for('shop.shop') if 'shop.shop' in _vf else '/shop') %}
  <link rel="prefetch" href="{{ _shop_prefetch|e }}">

  {# CSP nonce #}
  {% set _csp_nonce = (csp_nonce if csp_nonce is defined and csp_nonce else (nonce if nonce is defined and nonce else '')) %}

  <script type="application/ld+json"{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
  {
    "@context":"https://schema.org",
    "@graph":[
      {"@type":"Organization","name":"Skyline Store","url":"{{ _root|e }}","logo":"{{ url_for('static', filename='img/og.png', _external=True) }}"},
      {"@type":"WebSite","name":"Skyline Store","url":"{{ _root|e }}",
        "potentialAction":{"@type":"SearchAction","target":"{{ (_root ~ 'shop?q={search_term_string}')|e }}","query-input":"required name=search_term_string"}
      },
      {"@type":"WebPage","name":"{{ _t|e }}","url":"{{ _base_url|e }}",
        "primaryImageOfPage":{"@type":"ImageObject","url":"{{ hero_img|e }}"}
      }
    ]
  }
  </script>
{% endblock %}

{% block content %}
  {# ---------------- SAFE routing + FIX SCOPE ---------------- #}
  {% set _vf = (view_functions if view_functions is defined and view_functions else {}) %}
  {% set hero_img = url_for('static', filename='img/banners/hero_home.png') %}

  {% set shop_url = (url_for('shop.shop') if 'shop.shop' in _vf else '/shop') %}
  {% set offers_url = shop_url ~ ('?ofertas=1' if '?' not in shop_url else '&ofertas=1') %}

  {% set account_url =
      (url_for('main.account') if 'main.account' in _vf
        else (url_for('account.account') if 'account.account' in _vf
          else (url_for('cuenta.account') if 'cuenta.account' in _vf
            else '/account')))
  %}
  {% set account_login_url = account_url ~ ('?tab=login' if '?' not in account_url else '&tab=login') %}
  {% set account_register_url = account_url ~ ('?tab=register' if '?' not in account_url else '&tab=register') %}

  {% set featured_list = (featured if featured is defined and featured else []) %}

  {% set _hero_overlay =
    "linear-gradient(90deg, rgba(255,255,255,.94) 0%, rgba(255,255,255,.86) 46%, rgba(255,255,255,.42) 72%, rgba(255,255,255,0) 100%)"
  %}

  <div class="hp hp-v15 hp-v161" id="hp" role="main" aria-label="Inicio Skyline Store"
       data-version="{{ _home_ver|e }}" data-home-ver="{{ _home_ver|e }}">

    <section class="hp-top" aria-label="Beneficios">
      <div class="hp-wrap">
        <ul class="hp-topTrust" role="list">
          <li class="hp-topTrust__item" role="listitem"><span class="hp-ico" aria-hidden="true">ðŸ”’</span><div><b>Pago protegido</b><small>Soporte y respaldo</small></div></li>
          <li class="hp-topTrust__item" role="listitem"><span class="hp-ico" aria-hidden="true">ðŸšš</span><div><b>EnvÃ­os con tracking</b><small>Seguimiento del pedido</small></div></li>
          <li class="hp-topTrust__item" role="listitem"><span class="hp-ico" aria-hidden="true">âš¡</span><div><b>Compra rÃ¡pida</b><small>Checkout optimizado</small></div></li>
          <li class="hp-topTrust__item" role="listitem"><span class="hp-ico" aria-hidden="true">ðŸ’¬</span><div><b>Soporte 24/7</b><small>AtenciÃ³n dedicada</small></div></li>
        </ul>
      </div>
    </section>

    <section class="hp-hero hp-heroFull" aria-labelledby="hpTitle"
      style="--hero-url:url('{{ hero_img|e }}'); --hero-overlay: {{ _hero_overlay }};">
      <div class="hp-wrap hp-hero__grid">

        <div class="hp-hero__copy">
          <div class="hp-kickerRow">
            <span class="hp-kicker">SKYLINE STORE</span>
            <span class="hp-verified" aria-label="Verificado">Verificado</span>
            <span class="hp-pill" data-pill data-target="#hpCats" role="button" tabindex="0" aria-label="Ir a categorÃ­as">CategorÃ­as</span>
            <span class="hp-pill" data-pill data-target="#hpGrid" role="button" tabindex="0" aria-label="Ir a destacados">Destacados</span>
          </div>

          <h1 id="hpTitle" class="hp-title">
            Tech + Streetwear <span class="hp-grad">premium</span>
          </h1>

          <p class="hp-sub">
            Una selecciÃ³n real de <b>moda urbana</b>, <b>accesorios</b> y <b>tecnologÃ­a</b>.
            ComprÃ¡ seguro, con soporte y experiencia de marca.
          </p>

          <div class="hp-mini" role="list" aria-label="Diferenciales">
            <div class="hp-mini__item" role="listitem"><b>Curado</b><span>Productos elegidos</span></div>
            <div class="hp-mini__item" role="listitem"><b>Ofertas</b><span>Promos reales</span></div>
            <div class="hp-mini__item" role="listitem"><b>Drops</b><span>Marca propia</span></div>
          </div>

          <div class="hp-ctas" role="group" aria-label="Acciones principales">
            <a href="{{ shop_url|e }}" class="btn primary">Explorar tienda</a>
            <a href="{{ offers_url|e }}" class="btn ghost">Ver ofertas</a>
            <a href="{{ account_login_url|e }}" class="btn soft" aria-label="Ingresar o crear cuenta">Mi cuenta</a>
          </div>

          <div class="hp-chips" aria-label="GarantÃ­as" role="list">
            <span class="hp-chip" role="listitem">âœ… Soporte post-compra</span>
            <span class="hp-chip" role="listitem">âœ… Seguimiento del pedido</span>
            <span class="hp-chip" role="listitem">âœ… PolÃ­ticas claras</span>
          </div>
        </div>

        <div class="hp-hero__media" aria-label="Imagen principal">
          <figure class="hp-heroCard is-heroFull" data-reveal style="--hero-url:url('{{ hero_img|e }}');">
            <div class="hp-heroGlow" aria-hidden="true"></div>

            <img
              src="{{ hero_img|e }}"
              alt="Skyline Store: tecnologÃ­a y streetwear premium"
              width="1600"
              height="900"
              loading="eager"
              decoding="async"
              fetchpriority="high"
              class="hp-heroImg"
              onerror="this.onerror=null; this.remove(); this.closest('.hp-heroCard')?.classList.add('is-fallback');">

            <figcaption class="hp-heroCap">
              <b>Curado por calidad</b>
              <span>Productos elegidos + ofertas reales</span>
            </figcaption>
          </figure>

          <div class="hp-stats" aria-label="Indicadores de confianza" role="list">
            <div class="hp-stat" role="listitem"><b>Marketplace</b><span>CatÃ¡logo en crecimiento</span></div>
            <div class="hp-stat" role="listitem"><b>Marca propia</b><span>Streetwear Skyline</span></div>
            <div class="hp-stat" role="listitem"><b>Compra segura</b><span>Soporte y polÃ­ticas claras</span></div>
          </div>
        </div>

      </div>
    </section>

    <section class="hp-trust" aria-label="Confianza y seguridad">
      <div class="hp-wrap hp-trust__grid">
        {% set trust = [
          {'img':'img/banners/service_payment.png','title':'Pago seguro','desc':'Transacciones protegidas y soporte'},
          {'img':'img/banners/service_shipping.png','title':'EnvÃ­o con tracking','desc':'Seguimiento de tu pedido'},
          {'img':'img/banners/service_support.png','title':'Soporte real','desc':'AtenciÃ³n y ayuda post-compra'}
        ] %}
        {% for t in trust %}
          <article class="hp-trustCard" data-reveal aria-label="{{ t.title|e }}">
            <div class="hp-trustCard__img" aria-hidden="true">
              <img src="{{ url_for('static', filename=t.img) }}" alt="" loading="lazy" decoding="async" class="hp-trustIcon">
            </div>
            <div class="hp-trustCard__meta">
              <b>{{ t.title|e }}</b>
              <span>{{ t.desc|e }}</span>
            </div>
          </article>
        {% endfor %}
      </div>
    </section>

    <section class="hp-cats" aria-labelledby="hpCatsLabel" id="hpCats">
      <div class="hp-wrap">
        <div class="hp-secHead">
          <div>
            <h2 id="hpCatsLabel">ElegÃ­ una categorÃ­a</h2>
            <p>Accesos directos tipo marketplace.</p>
          </div>
          <a class="hp-linkMore" href="{{ shop_url|e }}">Ver todo â†’</a>
        </div>

        {% set cats = [
          {'label':'Ropa urbana','img':'img/banners/cat_women.png','href': shop_url ~ ('?categoria=ropa' if '?' not in shop_url else '&categoria=ropa')},
          {'label':'Accesorios','img':'img/banners/cat_accessories.png','href': shop_url ~ ('?categoria=accesorios' if '?' not in shop_url else '&categoria=accesorios')},
          {'label':'TecnologÃ­a','img':'img/banners/cat_tech.png','href': shop_url ~ ('?categoria=tecnologia' if '?' not in shop_url else '&categoria=tecnologia')},
          {'label':'Ofertas','img':'img/banners/promo_week.png','href': offers_url}
        ] %}

        <div class="hp-catsGrid" role="list">
          {% for c in cats %}
            <a class="hp-catCard" data-reveal href="{{ c.href|e }}" aria-label="{{ c.label|e }}" role="listitem">
              <div class="hp-catCard__media" aria-hidden="true">
                <img src="{{ url_for('static', filename=c.img) }}" alt="" loading="lazy" decoding="async" class="hp-catImg"
                     onerror="this.onerror=null; this.src='{{ hero_img|e }}'; this.style.opacity='.92';">
              </div>
              <div class="hp-catCard__overlay">
                <b>{{ c.label|e }}</b>
                <span>Explorar â†’</span>
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    </section>

    <section class="hp-featured" aria-labelledby="hpFeat" id="hpGrid">
      <div class="hp-wrap">
        <div class="hp-secHead">
          <div>
            <h2 id="hpFeat">Destacados</h2>
            <p>SelecciÃ³n recomendada para arrancar.</p>
          </div>
          <a class="hp-linkMore" href="{{ offers_url|e }}">Ofertas â†’</a>
        </div>

        <div class="hp-products" {% if featured_list|length > 0 %}role="list"{% endif %}>
          {% if featured_list|length == 0 %}
            <div class="hp-empty" aria-live="polite">
              <b>Estamos armando los destacados</b>
              <p>Mientras tanto, explorÃ¡ el catÃ¡logo completo y mirÃ¡ las ofertas.</p>
              <div class="hp-empty__actions" role="group" aria-label="Acciones recomendadas">
                <a class="btn primary" href="{{ shop_url|e }}">Ir a la tienda</a>
                <a class="btn ghost" href="{{ offers_url|e }}">Ver ofertas</a>
                <a class="btn soft" href="{{ account_register_url|e }}">Crear cuenta</a>
              </div>
            </div>
          {% else %}
            {% for p in featured_list %}
              {% set p_title = (p.title if p and p.title is defined and p.title else (p.get('title') if p is mapping and p.get('title') else 'Producto'))|string %}
              {% set p_href  = (p.href  if p and p.href  is defined and p.href  else (p.get('href')  if p is mapping and p.get('href')  else shop_url))|string %}
              {% set p_img   = (p.img   if p and p.img   is defined and p.img   else (p.get('img')   if p is mapping and p.get('img')   else hero_img))|string %}

              <article class="hp-prod" data-reveal aria-label="{{ p_title|e }}" role="listitem">
                <a class="hp-prod__img" href="{{ p_href|e }}" aria-label="{{ p_title|e }}">
                  <img src="{{ p_img|e }}" alt="{{ p_title|e }}" loading="lazy" decoding="async" class="hp-prodImg"
                       onerror="this.onerror=null; this.src='{{ hero_img|e }}'; this.style.opacity='.92';">
                </a>

                <div class="hp-prod__meta">
                  <b class="hp-prod__title">{{ p_title|e }}</b>
                  <div class="hp-prod__price" aria-label="Precio">
                    {% with product=p %}{% include "components/price.html" ignore missing %}{% endwith %}
                  </div>
                  <div class="hp-prod__micro" aria-label="Beneficios del producto">
                    <span class="hp-microChip">âš¡ EnvÃ­o rÃ¡pido</span>
                    <span class="hp-microChip">ðŸ”’ Pago seguro</span>
                  </div>
                </div>

                <div class="hp-prod__actions" role="group" aria-label="Acciones del producto">
                  <a class="btn primary" href="{{ p_href|e }}">Ver</a>
                  <a class="btn ghost" href="{{ shop_url|e }}">MÃ¡s</a>
                </div>
              </article>
            {% endfor %}
          {% endif %}
        </div>
      </div>
    </section>

    <section class="hp-cta" aria-label="Llamado a la acciÃ³n final">
      <div class="hp-wrap hp-cta__inner" data-reveal>
        <div>
          <h2 class="hp-cta__title">ComprÃ¡ con confianza</h2>
          <p class="hp-cta__sub">Marketplace + marca propia. EnvÃ­os con seguimiento y soporte real.</p>
        </div>
        <div class="hp-cta__btns" role="group" aria-label="Acciones finales">
          <a class="btn primary" href="{{ shop_url|e }}">Empezar ahora</a>
          <a class="btn soft" href="{{ account_register_url|e }}">Crear cuenta</a>
        </div>
      </div>
    </section>

    <div class="hp-sticky" id="hpSticky" role="region" aria-label="Barra fija de ofertas">
      <div class="hp-sticky__txt">
        <b>Skyline Store</b>
        <span>ExplorÃ¡ ofertas premium</span>
      </div>
      <a href="{{ offers_url|e }}" class="hp-sticky__btn" aria-label="Ir a ofertas">Comprar</a>
    </div>

    <button id="toTop" type="button" class="to-top" aria-label="Volver arriba" hidden>â†‘</button>
  </div>
{% endblock %}

{% block extra_js %}
  {# âœ… Cache-bust JS (misma versiÃ³n que CSS) â€” ÃšNICA fuente de comportamiento #}
  {% set _home_ver = (HOME_CSS_VER if HOME_CSS_VER is defined and HOME_CSS_VER else '162')|string|trim %}
  <script src="{{ url_for('static', filename='js/home.js') }}?v={{ _home_ver|e }}" defer></script>
{% endblock %}
