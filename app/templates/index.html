{% extends "base.html" %}

{% block title %}{{ (meta_title if meta_title is defined and meta_title else "Skyline Store ¬∑ Tech + Streetwear premium")|e }}{% endblock %}

{% block extra_head %}
  {% set _env = (ENV if ENV is defined and ENV else 'production')|string|lower|trim %}
  {% set _req = (request if request is defined and request else none) %}
  {% set _args = (_req.args if _req and _req.args else {}) %}
  {% set _path = (_req.path if _req and _req.path else '') %}
  {% set _vf  = (view_functions if view_functions is defined and view_functions else {}) %}
  {% set _home_ver = (HOME_CSS_VER if HOME_CSS_VER is defined and HOME_CSS_VER else (ASSET_VER if ASSET_VER is defined and ASSET_VER else '165'))|string|trim %}
  {% set _nonce = (csp_nonce if csp_nonce is defined and csp_nonce else (nonce if nonce is defined and nonce else '')) %}

  {% macro safe_static(f) -%}
    {%- if url_for is defined -%}{{ url_for('static', filename=f) ~ '?v=' ~ _home_ver }}{%- else -%}{{ '/static/' ~ f }}{%- endif -%}
  {%- endmacro %}

  {% set _canonical = (_req.base_url if _req and _req.base_url else 'https://skyline-style.onrender.com/') %}
  {% set _root = (_req.url_root if _req and _req.url_root else 'https://skyline-style.onrender.com/') %}
  {% set _root_abs = (_root if _root and _root.startswith('http') else 'https://skyline-style.onrender.com/') %}

  {% set hero_png = (url_for('static', filename='img/banners/hero_home.png') if url_for is defined else '/static/img/banners/hero_home.png') %}
  {% set hero_webp = (url_for('static', filename='img/banners/hero_home.webp') if url_for is defined else hero_png) %}
  {% set og_img_local = (url_for('static', filename='img/og.png', _external=True) if url_for is defined else (_root_abs ~ 'static/img/og.png')) %}
  {% set og_img = (og_image if og_image is defined and og_image else og_img_local) %}

  {% set _desc = (meta_description if meta_description is defined and meta_description else 'Moda urbana premium, accesorios y tecnolog√≠a.')|string|trim %}
  {% set _t = (meta_title if meta_title is defined and meta_title else 'Skyline Store ¬∑ Tech + Streetwear premium')|string|trim %}

  {% set _shop_url = (url_for('shop.shop') if url_for is defined and 'shop.shop' in _vf else '/shop') %}
  {% if not _shop_url or not _shop_url.startswith('/') %}{% set _shop_url = '/shop' %}{% endif %}
  {% set _shop_abs = (_root_abs ~ _shop_url.lstrip('/')) %}

  {% set _hero_abs = hero_png %}
  {% if _hero_abs and _hero_abs.startswith('/') %}{% set _hero_abs = (_root_abs ~ _hero_abs.lstrip('/')) %}{% endif %}

  <meta name="description" content="{{ _desc|e }}">
  <meta name="robots" content="{{ 'index,follow' if _env == 'production' else 'noindex,nofollow' }}">
  <meta name="theme-color" content="#2563eb">
  <meta name="color-scheme" content="light dark">
  <meta name="referrer" content="strict-origin-when-cross-origin">

  <link rel="canonical" href="{{ _canonical|e }}">
  <meta property="og:url" content="{{ _canonical|e }}">
  <meta property="og:site_name" content="Skyline Store">
  <meta property="og:title" content="{{ _t|e }}">
  <meta property="og:description" content="{{ _desc|e }}">
  <meta property="og:type" content="website">
  {% if og_img %}<meta property="og:image" content="{{ og_img|e }}">{% endif %}
  <meta property="og:image:alt" content="Skyline Store ¬∑ Tech + Streetwear premium">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ _t|e }}">
  <meta name="twitter:description" content="{{ _desc|e }}">
  {% if og_img %}<meta name="twitter:image" content="{{ og_img|e }}">{% endif %}

  <link rel="dns-prefetch" href="//skyline-style.onrender.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://skyline-style.onrender.com" crossorigin>

  <link rel="preload" as="image" href="{{ hero_webp|e }}" fetchpriority="high" imagesizes="(max-width: 900px) 92vw, 720px">
  <link rel="preload" as="image" href="{{ hero_png|e }}" fetchpriority="high" imagesizes="(max-width: 900px) 92vw, 720px">

  <link rel="stylesheet" href="{{ safe_static('css/home.css')|e }}">

  <link rel="prefetch" href="{{ _shop_url|e }}" as="document">

  <script type="application/ld+json"{% if _nonce %} nonce="{{ _nonce|e }}"{% endif %}>
  {
    "@context":"https://schema.org",
    "@graph":[
      {"@type":"Organization","name":"Skyline Store","url":"{{ _root_abs|e }}","logo":"{{ (url_for('static', filename='img/og.png', _external=True) if url_for is defined else (_root_abs ~ 'static/img/og.png'))|e }}"},
      {"@type":"WebSite","name":"Skyline Store","url":"{{ _root_abs|e }}",
        "potentialAction":{"@type":"SearchAction","target":"{{ (_shop_abs ~ '?q={search_term_string}')|e }}","query-input":"required name=search_term_string"}
      },
      {"@type":"WebPage","name":"{{ _t|e }}","url":"{{ _canonical|e }}",
        "primaryImageOfPage":{"@type":"ImageObject","url":"{{ _hero_abs|e }}"}
      }
    ]
  }
  </script>

  <style{% if _nonce %} nonce="{{ _nonce|e }}"{% endif %}>
    :root{color-scheme:light dark}
    html,body{background:#f6f8fc;color:#0b1220}
    @media (prefers-color-scheme: dark){html,body{background:#070b14;color:#e5e7eb}}
    .hp :focus-visible{outline:none;box-shadow:0 0 0 4px rgba(37,99,235,.18);border-radius:14px}
    .hp .btn:focus-visible{box-shadow:0 0 0 4px rgba(56,189,248,.22)}
  </style>
{% endblock %}

{% block content %}
  {% set _env = (ENV if ENV is defined and ENV else 'production')|string|lower|trim %}
  {% set _vf = (view_functions if view_functions is defined and view_functions else {}) %}
  {% set _home_ver = (HOME_CSS_VER if HOME_CSS_VER is defined and HOME_CSS_VER else (ASSET_VER if ASSET_VER is defined and ASSET_VER else '165'))|string|trim %}

  {% set hero_png = (url_for('static', filename='img/banners/hero_home.png') if url_for is defined else '/static/img/banners/hero_home.png') %}
  {% set hero_webp = (url_for('static', filename='img/banners/hero_home.webp') if url_for is defined else hero_png) %}

  {% set shop_url = (url_for('shop.shop') if url_for is defined and 'shop.shop' in _vf else '/shop') %}
  {% if not shop_url or not shop_url.startswith('/') %}{% set shop_url = '/shop' %}{% endif %}
  {% set offers_url = shop_url ~ ('?sort=new&available=1' if '?' not in shop_url else '&sort=new&available=1') %}

  {% set account_url =
      (url_for('auth.account') if url_for is defined and 'auth.account' in _vf
        else (url_for('main.account') if url_for is defined and 'main.account' in _vf
          else '/auth/account'))
  %}
  {% set account_login_url = account_url ~ ('?tab=login' if '?' not in account_url else '&tab=login') %}
  {% set account_register_url = account_url ~ ('?tab=register' if '?' not in account_url else '&tab=register') %}

  {% set featured_list = (featured if featured is defined and featured else []) %}
  {% if featured_list is none %}{% set featured_list = [] %}{% endif %}

  {% set _hero_overlay = "linear-gradient(90deg, rgba(255,255,255,.98) 0%, rgba(255,255,255,.92) 46%, rgba(255,255,255,.58) 73%, rgba(255,255,255,0) 100%)" %}
  {% set _hero_overlay_dark = "linear-gradient(90deg, rgba(2,6,23,.92) 0%, rgba(2,6,23,.78) 46%, rgba(2,6,23,.30) 73%, rgba(2,6,23,0) 100%)" %}

  <div class="hp hp-v15 hp-v161" id="hp" role="main" aria-label="Inicio Skyline Store" data-home-ver="{{ _home_ver|e }}" data-env="{{ _env|e }}">
    <section class="hp-top" aria-label="Beneficios">
      <div class="hp-wrap">
        <ul class="hp-topTrust" role="list">
          <li class="hp-topTrust__item" role="listitem">
            <span class="hp-ico" aria-hidden="true">üîí</span>
            <div><b>Pago protegido</b><small>Soporte y respaldo</small></div>
          </li>
          <li class="hp-topTrust__item" role="listitem">
            <span class="hp-ico" aria-hidden="true">üöö</span>
            <div><b>Env√≠os con tracking</b><small>Seguimiento del pedido</small></div>
          </li>
          <li class="hp-topTrust__item" role="listitem">
            <span class="hp-ico" aria-hidden="true">‚Ü©Ô∏è</span>
            <div><b>Devoluciones claras</b><small>Pol√≠ticas simples</small></div>
          </li>
          <li class="hp-topTrust__item" role="listitem">
            <span class="hp-ico" aria-hidden="true">‚ö°</span>
            <div><b>Ofertas reales</b><small>Promos y drops</small></div>
          </li>
        </ul>
      </div>
    </section>

    <section class="hp-hero hp-heroFull" aria-labelledby="hpTitle"
             style="--hero-url:url('{{ hero_png|e }}'); --hero-overlay: {{ _hero_overlay }}; --hero-overlay-dark: {{ _hero_overlay_dark }};">
      <div class="hp-wrap hp-hero__grid">
        <div class="hp-hero__copy">
          <div class="hp-kickerRow">
            <span class="hp-kicker">SKYLINE STORE</span>
            <span class="hp-verified" aria-label="Verificado">Verificado</span>
            <button class="hp-pill" type="button" data-pill data-target="#hpCats" aria-controls="hpCats" aria-expanded="false">Categor√≠as</button>
            <button class="hp-pill" type="button" data-pill data-target="#hpGrid" aria-controls="hpGrid" aria-expanded="false">Destacados</button>
            <a class="hp-pill hp-pill--link" href="{{ offers_url|e }}" aria-label="Ver ofertas">Ofertas</a>
          </div>

          <h1 id="hpTitle" class="hp-title">Tech + Streetwear <span class="hp-grad">premium</span></h1>

          <p class="hp-sub">
            Una selecci√≥n real de <b>moda urbana</b>, <b>accesorios</b> y <b>tecnolog√≠a</b>.
            Compr√° seguro, con soporte y experiencia de marca.
          </p>

          <div class="hp-mini" role="list" aria-label="Diferenciales">
            <div class="hp-mini__item" role="listitem"><b>Curado</b><span>Productos elegidos</span></div>
            <div class="hp-mini__item" role="listitem"><b>Env√≠o</b><span>Tracking y soporte</span></div>
            <div class="hp-mini__item" role="listitem"><b>Marca</b><span>Drops Skyline</span></div>
            <div class="hp-mini__item" role="listitem"><b>Pagos</b><span>Protecci√≥n</span></div>
          </div>

          <div class="hp-ctas" role="group" aria-label="Acciones principales">
            <a href="{{ shop_url|e }}" class="btn primary">Explorar tienda</a>
            <a href="{{ offers_url|e }}" class="btn ghost">Ver ofertas</a>
            <a href="{{ account_register_url|e }}" class="btn soft">Crear cuenta</a>
          </div>

          <div class="hp-chips" aria-label="Garant√≠as" role="list">
            <span class="hp-chip" role="listitem">‚úÖ Soporte post-compra</span>
            <span class="hp-chip" role="listitem">‚úÖ Seguimiento del pedido</span>
            <span class="hp-chip" role="listitem">‚úÖ Devoluciones claras</span>
          </div>

          <nav class="hp-miniLinks" aria-label="Cuenta">
            <a href="{{ account_login_url|e }}" class="hp-link">Entrar</a>
            <span aria-hidden="true">¬∑</span>
            <a href="{{ account_register_url|e }}" class="hp-link">Crear cuenta</a>
            <span aria-hidden="true">¬∑</span>
            <a href="{{ shop_url|e }}" class="hp-link">Cat√°logo</a>
          </nav>
        </div>

        <div class="hp-hero__media" aria-label="Imagen principal">
          <figure class="hp-heroCard is-heroFull" data-reveal>
            <div class="hp-heroGlow" aria-hidden="true"></div>
            <picture>
              <source srcset="{{ hero_webp|e }}" type="image/webp">
              <img src="{{ hero_png|e }}" alt="Skyline Store: tecnolog√≠a y streetwear premium" width="1600" height="900"
                   sizes="(max-width: 900px) 92vw, 720px" loading="eager" decoding="async" fetchpriority="high"
                   referrerpolicy="no-referrer-when-downgrade" class="hp-heroImg"
                   onerror="this.onerror=null; try{ this.closest('.hp-heroCard') && this.closest('.hp-heroCard').classList.add('is-fallback'); }catch(e){}">
            </picture>
            <figcaption class="hp-heroCap">
              <b>Curado por calidad</b>
              <span>Productos elegidos + ofertas reales</span>
            </figcaption>
          </figure>

          <div class="hp-stats" aria-label="Indicadores de confianza" role="list">
            <div class="hp-stat" role="listitem"><b>Marketplace</b><span>Cat√°logo en crecimiento</span></div>
            <div class="hp-stat" role="listitem"><b>Marca propia</b><span>Streetwear Skyline</span></div>
            <div class="hp-stat" role="listitem"><b>Compra segura</b><span>Soporte y pol√≠ticas claras</span></div>
            <div class="hp-stat" role="listitem"><b>Ofertas</b><span>Promos y drops</span></div>
          </div>
        </div>
      </div>
    </section>

    <section class="hp-trust" aria-label="Confianza y seguridad">
      <div class="hp-wrap hp-trust__grid">
        {% set trust = [
          {'img':'img/banners/service_payment.png','title':'Pago seguro','desc':'Transacciones protegidas y soporte'},
          {'img':'img/banners/service_shipping.png','title':'Env√≠o con tracking','desc':'Seguimiento de tu pedido'},
          {'img':'img/banners/service_support.png','title':'Soporte real','desc':'Atenci√≥n y ayuda post-compra'},
          {'img':'img/banners/service_quality.png','title':'Calidad curada','desc':'Selecci√≥n premium y transparente'}
        ] %}
        {% for t in trust %}
          <article class="hp-trustCard" data-reveal aria-label="{{ t.title|e }}">
            <div class="hp-trustCard__img" aria-hidden="true">
              <img src="{{ url_for('static', filename=t.img) }}" alt="" loading="lazy" decoding="async" class="hp-trustIcon"
                   onerror="this.onerror=null; this.style.display='none';">
            </div>
            <div class="hp-trustCard__meta">
              <b>{{ t.title|e }}</b>
              <span>{{ t.desc|e }}</span>
            </div>
          </article>
        {% endfor %}
      </div>
    </section>

    <section class="hp-cats" aria-labelledby="hpCatsLabel" id="hpCats">
      <div class="hp-wrap">
        <div class="hp-secHead">
          <div>
            <h2 id="hpCatsLabel">Eleg√≠ una categor√≠a</h2>
            <p>Accesos directos tipo marketplace.</p>
          </div>
          <a class="hp-linkMore" href="{{ shop_url|e }}">Ver todo ‚Üí</a>
        </div>

        {% set cats = [
          {'label':'Ropa urbana','img':'img/banners/cat_women.png','href': shop_url ~ ('?categoria=ropa' if '?' not in shop_url else '&categoria=ropa')},
          {'label':'Accesorios','img':'img/banners/cat_accessories.png','href': shop_url ~ ('?categoria=accesorios' if '?' not in shop_url else '&categoria=accesorios')},
          {'label':'Tecnolog√≠a','img':'img/banners/cat_tech.png','href': shop_url ~ ('?categoria=tecnologia' if '?' not in shop_url else '&categoria=tecnologia')},
          {'label':'Ofertas','img':'img/banners/promo_week.png','href': offers_url}
        ] %}

        <div class="hp-catsGrid" role="list">
          {% for c in cats %}
            <a class="hp-catCard" data-reveal href="{{ c.href|e }}" aria-label="{{ c.label|e }}" role="listitem">
              <div class="hp-catCard__media" aria-hidden="true">
                <img src="{{ url_for('static', filename=c.img) }}" alt="" loading="lazy" decoding="async" class="hp-catImg"
                     onerror="this.onerror=null; this.src='{{ hero_png|e }}'; this.style.opacity='.92';">
              </div>
              <div class="hp-catCard__overlay">
                <b>{{ c.label|e }}</b>
                <span>Explorar ‚Üí</span>
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    </section>

    <section class="hp-featured" aria-labelledby="hpFeat" id="hpGrid">
      <div class="hp-wrap">
        <div class="hp-secHead">
          <div>
            <h2 id="hpFeat">Destacados</h2>
            <p>Selecci√≥n recomendada para arrancar.</p>
          </div>
          <a class="hp-linkMore" href="{{ offers_url|e }}">Ofertas ‚Üí</a>
        </div>

        <div class="hp-products" role="list">
          {% if featured_list|length == 0 %}
            <div class="hp-empty" aria-live="polite">
              <b>Estamos armando los destacados</b>
              <p>Mientras tanto, explor√° el cat√°logo completo y mir√° las ofertas.</p>
              <div class="hp-empty__actions" role="group" aria-label="Acciones recomendadas">
                <a class="btn primary" href="{{ shop_url|e }}">Ir a la tienda</a>
                <a class="btn ghost" href="{{ offers_url|e }}">Ver ofertas</a>
                <a class="btn soft" href="{{ account_register_url|e }}">Crear cuenta</a>
              </div>
            </div>
          {% else %}
            {% for p in featured_list %}
              {% set p_title = (p.title if p and p.title is defined and p.title else (p.get('title') if p is mapping and p.get('title') else 'Producto'))|string %}
              {% set p_href  = (p.href  if p and p.href  is defined and p.href  else (p.get('href')  if p is mapping and p.get('href')  else shop_url))|string %}
              {% set p_img   = (p.img   if p and p.img   is defined and p.img   else (p.get('img')   if p is mapping and p.get('img')   else hero_png))|string %}

              <article class="hp-prod" data-reveal aria-label="{{ p_title|e }}" role="listitem">
                <a class="hp-prod__img" href="{{ p_href|e }}" aria-label="{{ p_title|e }}">
                  <img src="{{ p_img|e }}" alt="{{ p_title|e }}" loading="lazy" decoding="async" class="hp-prodImg"
                       onerror="this.onerror=null; this.src='{{ hero_png|e }}'; this.style.opacity='.92';">
                </a>

                <div class="hp-prod__meta">
                  <b class="hp-prod__title">{{ p_title|e }}</b>
                  <div class="hp-prod__price" aria-label="Precio">
                    {% with product=p %}{% include "components/price.html" ignore missing %}{% endwith %}
                  </div>
                  <div class="hp-prod__micro" aria-label="Beneficios del producto">
                    <span class="hp-microChip">‚ö° Env√≠o r√°pido</span>
                    <span class="hp-microChip">üîí Pago seguro</span>
                    <span class="hp-microChip">‚Ü©Ô∏è Devoluciones</span>
                  </div>
                </div>

                <div class="hp-prod__actions" role="group" aria-label="Acciones del producto">
                  <a class="btn primary" href="{{ p_href|e }}">Ver</a>
                  <a class="btn ghost" href="{{ shop_url|e }}">M√°s</a>
                </div>
              </article>
            {% endfor %}
          {% endif %}
        </div>
      </div>
    </section>

    <section class="hp-cta" aria-label="Llamado a la acci√≥n final">
      <div class="hp-wrap hp-cta__inner" data-reveal>
        <div>
          <h2 class="hp-cta__title">Compr√° con confianza</h2>
          <p class="hp-cta__sub">Marketplace + marca propia. Env√≠os con seguimiento y soporte real.</p>
        </div>
        <div class="hp-cta__btns" role="group" aria-label="Acciones finales">
          <a class="btn primary" href="{{ shop_url|e }}">Empezar ahora</a>
          <a class="btn soft" href="{{ account_register_url|e }}">Crear cuenta</a>
        </div>
      </div>
    </section>

    <div class="hp-sticky" id="hpSticky" role="region" aria-label="Barra fija de ofertas" aria-live="polite">
      <div class="hp-sticky__txt">
        <b>Skyline Store</b>
        <span>Explor√° ofertas premium</span>
      </div>
      <a href="{{ offers_url|e }}" class="hp-sticky__btn" aria-label="Ir a ofertas">Comprar</a>
    </div>

    <button id="toTop" type="button" class="to-top" aria-label="Volver arriba" hidden>‚Üë</button>
  </div>
{% endblock %}

{% block extra_js %}
  {% set _home_ver = (HOME_CSS_VER if HOME_CSS_VER is defined and HOME_CSS_VER else (ASSET_VER if ASSET_VER is defined and ASSET_VER else '165'))|string|trim %}
  <script src="{{ url_for('static', filename='js/home.js') }}?v={{ _home_ver|e }}" defer></script>

  <script{% if csp_nonce is defined and csp_nonce %} nonce="{{ csp_nonce|e }}"{% elif nonce is defined and nonce %} nonce="{{ nonce|e }}"{% endif %} defer>
  (() => {
    const root = document.getElementById('hp');
    if (!root) return;

    const prefersReduced = !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);

    const scrollToTarget = (sel) => {
      const el = sel ? document.querySelector(sel) : null;
      if (!el) return;
      const y = el.getBoundingClientRect().top + (window.pageYOffset || 0) - 92;
      window.scrollTo({ top: Math.max(0, y), behavior: prefersReduced ? 'auto' : 'smooth' });
    };

    root.querySelectorAll('[data-pill][data-target]').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-target');
        root.querySelectorAll('[data-pill]').forEach(b => b.setAttribute('aria-expanded','false'));
        btn.setAttribute('aria-expanded','true');
        scrollToTarget(target);
        window.setTimeout(() => btn.setAttribute('aria-expanded','false'), 800);
      }, { passive:true });
    });

    const toTop = document.getElementById('toTop');
    if (toTop) {
      const onScroll = () => { toTop.hidden = !((window.scrollY || 0) > 700); };
      window.addEventListener('scroll', onScroll, { passive:true });
      onScroll();
      toTop.addEventListener('click', () => window.scrollTo({ top:0, behavior: prefersReduced ? 'auto' : 'smooth' }));
    }

    try{
      const st = document.getElementById('hpSticky');
      if (st){
        const onS = () => st.classList.toggle('is-on', (window.scrollY || 0) > 520);
        window.addEventListener('scroll', onS, { passive:true });
        onS();
      }
    }catch(_){}
  })();
  </script>
{% endblock %}
