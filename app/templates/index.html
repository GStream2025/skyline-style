{# app/templates/index.html ‚Äî Skyline Store (PRO v12 ¬∑ ULTRA PREMIUM ¬∑ NO-500)
   - Base.html carga skyline-pro.css (global)
   - Index.html SOLO carga home.css (home-specific)
   - Fail-safe endpoints + data fallbacks
#}
{% extends "base.html" %}

{% block title %}{{ meta_title | default("Skyline Store ¬∑ Tech + Streetwear premium", true) }}{% endblock %}

{% block extra_head %}
  {# ---------------- SAFE env/request ---------------- #}
  {% set _env = (ENV if ENV is defined and ENV else 'production')|string|lower|trim %}
  {% set _req = (request if request is defined and request else none) %}

  {# ---------------- Assets ---------------- #}
  {% set hero_img = url_for('static', filename='img/banners/hero_home.png') %}
  {% set og_img = (og_image if og_image is defined and og_image else url_for('static', filename='img/og.png', _external=True)) %}

  <meta name="description" content="{{ meta_description | default('Moda urbana premium, accesorios y tecnolog√≠a.', true) }}">
  <meta name="robots" content="{{ 'index,follow' if _env == 'production' else 'noindex,nofollow' }}">

  {% if _req and _req.base_url %}
    <link rel="canonical" href="{{ _req.base_url }}">
    <meta property="og:url" content="{{ _req.base_url }}">
  {% else %}
    <link rel="canonical" href="/">
    <meta property="og:url" content="/">
  {% endif %}

  <meta property="og:title" content="{{ meta_title | default('Skyline Store ¬∑ Tech + Streetwear premium', true) }}">
  <meta property="og:description" content="{{ meta_description | default('Compr√° f√°cil, r√°pido y seguro.', true) }}">
  <meta property="og:type" content="website">
  <meta property="og:image" content="{{ og_img }}">
  <meta name="twitter:card" content="summary_large_image">

  {# Perf #}
  <link rel="preload" as="image" href="{{ hero_img }}" fetchpriority="high">

  {# Home CSS cache-bust seguro #}
  {% set _home_css_ver = (HOME_CSS_VER if HOME_CSS_VER is defined and HOME_CSS_VER else '')|string|trim %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}{% if _home_css_ver %}?v={{ _home_css_ver|e }}{% endif %}">

  {# CSP nonce (si base define nonce/csp_nonce) #}
  {% set _csp_nonce = (csp_nonce if csp_nonce is defined and csp_nonce else (nonce if nonce is defined and nonce else '')) %}

  <script type="application/ld+json"{% if _csp_nonce %} nonce="{{ _csp_nonce|e }}"{% endif %}>
  {
    "@context":"https://schema.org",
    "@graph":[
      {"@type":"Organization","name":"Skyline Store","url":"{{ (_req.url_root if _req and _req.url_root else '/') }}","logo":"{{ url_for('static', filename='img/og.png', _external=True) }}"},
      {"@type":"WebSite","name":"Skyline Store","url":"{{ (_req.url_root if _req and _req.url_root else '/') }}",
        "potentialAction":{"@type":"SearchAction","target":"{{ (_req.url_root if _req and _req.url_root else '/') }}shop?q={search_term_string}","query-input":"required name=search_term_string"}
      },
      {"@type":"WebPage","name":"{{ meta_title | default('Skyline Store ¬∑ Tech + Streetwear premium', true) }}","url":"{{ (_req.base_url if _req and _req.base_url else '/') }}"}
    ]
  }
  </script>
{% endblock %}

{% block content %}
  {# ============================================================
     SAFE RESOLVERS (NO-500)
  ============================================================ #}
  {% set _vf = (view_functions if view_functions is defined and view_functions else {}) %}

  {% set shop_url = (url_for('shop.shop') if 'shop.shop' in _vf else '/shop') %}

  {# Account URL safe (prioridad: main.account) #}
  {% set ns = namespace(account_url='/account', found=false) %}
  {% for ep in ['main.account','account.account_home','auth.login','auth.register'] %}
    {% if (not ns.found) and (ep in _vf) %}
      {% set ns.account_url = url_for(ep) %}
      {% set ns.found = true %}
    {% endif %}
  {% endfor %}
  {% set account_url = ns.account_url %}
  {% set account_login_url = account_url ~ ('?tab=login' if '?' not in account_url else '&tab=login') %}
  {% set account_register_url = account_url ~ ('?tab=register' if '?' not in account_url else '&tab=register') %}

  {% set offers_url = shop_url ~ ('?ofertas=1' if '?' not in shop_url else '&ofertas=1') %}
  {% set offers_fallback = shop_url ~ ('?q=oferta' if '?' not in shop_url else '&q=oferta') %}

  {% set featured_list = (featured if featured is defined and featured else []) %}

  <main class="hp" id="hp" role="main" aria-label="Inicio Skyline Store">

    {# ================= TOP TRUST (convertido a ‚Äúsellos‚Äù pro) ================= #}
    <section class="hp-top" aria-label="Beneficios">
      <div class="hp-wrap">
        <ul class="hp-topTrust" role="list">
          <li class="hp-topTrust__item">
            <span class="hp-ico" aria-hidden="true">üîí</span>
            <div><b>Pago protegido</b><small>Protecci√≥n & soporte</small></div>
          </li>
          <li class="hp-topTrust__item">
            <span class="hp-ico" aria-hidden="true">üöö</span>
            <div><b>Tracking real</b><small>Seguimiento del pedido</small></div>
          </li>
          <li class="hp-topTrust__item">
            <span class="hp-ico" aria-hidden="true">‚ö°</span>
            <div><b>Compra r√°pida</b><small>Checkout optimizado</small></div>
          </li>
        </ul>
      </div>
    </section>

    {# ================= HERO (grid firme + hero image robusto) ================= #}
    <section class="hp-hero" aria-labelledby="hpTitle">
      <div class="hp-wrap hp-hero__grid">

        <div class="hp-hero__copy">
          <div class="hp-kickerRow">
            <span class="hp-kicker">SKYLINE STORE</span>
            <span class="hp-verified" aria-label="Verificado">Verificado</span>
          </div>

          <h1 id="hpTitle" class="hp-title">
            Tech + Streetwear <span class="hp-grad">premium</span>
          </h1>

          <p class="hp-sub">
            Selecci√≥n real de <b>moda urbana</b>, <b>accesorios</b> y <b>tecnolog√≠a</b>.
            Compr√° seguro, con soporte y experiencia de marca.
          </p>

          <div class="hp-ctas" role="group" aria-label="Acciones principales">
            <a href="{{ shop_url }}" class="btn primary">Explorar tienda</a>
            <a href="{{ offers_url }}" class="btn ghost">Ver ofertas</a>
            <a href="{{ account_login_url }}" class="btn soft">Mi cuenta</a>
          </div>

          <div class="hp-chips" aria-label="Garant√≠as" role="list">
            <span class="hp-chip" role="listitem">‚úÖ Soporte real</span>
            <span class="hp-chip" role="listitem">‚úÖ Env√≠os con tracking</span>
            <span class="hp-chip" role="listitem">‚úÖ Pagos protegidos</span>
          </div>

          <noscript>
            <div class="hp-noscript">
              <b>Modo b√°sico</b>
              <p>Tu navegador tiene JavaScript desactivado. Pod√©s navegar igual:</p>
              <div class="hp-ctas">
                <a href="{{ shop_url }}" class="btn primary">Ir a la tienda</a>
                <a href="{{ account_login_url }}" class="btn soft">Ingresar / Crear cuenta</a>
              </div>
              <p class="small" style="margin-top:.6rem;opacity:.8">
                Si ‚ÄúOfertas‚Äù no carga, prob√°:
                <a href="{{ offers_fallback }}" class="btn ghost" style="display:inline-flex;margin-top:.4rem">Ofertas (alternativo)</a>
              </p>
            </div>
          </noscript>
        </div>

        <div class="hp-hero__media" aria-label="Imagen principal">
          {# IMPORTANT: usamos background + img. Si el img falla, el background queda. #}
          <figure class="hp-heroCard" style="--hero-url:url('{{ hero_img }}');">
            <img
              src="{{ hero_img }}"
              alt="Skyline Store: tecnolog√≠a y streetwear premium"
              width="1600"
              height="900"
              loading="eager"
              decoding="async"
              fetchpriority="high"
              class="hp-heroImg"
              onerror="this.remove(); this.closest('.hp-heroCard')?.classList.add('is-fallback');">
            <figcaption class="hp-heroCap">
              <b>Curado por calidad</b>
              <span>Productos elegidos + ofertas reales</span>
            </figcaption>
          </figure>

          <div class="hp-stats" aria-label="Indicadores de confianza" role="list">
            <div class="hp-stat" role="listitem">
              <b>Marketplace</b>
              <span>M√°s de 100 productos y creciendo</span>
            </div>
            <div class="hp-stat" role="listitem">
              <b>Marca propia</b>
              <span>Streetwear Skyline (drops)</span>
            </div>
            <div class="hp-stat" role="listitem">
              <b>Compra segura</b>
              <span>Pol√≠ticas claras</span>
            </div>
          </div>
        </div>

      </div>
    </section>

    {# ================= TRUST CARDS (m√°s pro, menos ‚Äúbloques gordos‚Äù) ================= #}
    <section class="hp-trust" aria-label="Confianza y seguridad">
      <div class="hp-wrap hp-trust__grid">
        {% set trust = [
          {'img':'img/banners/service_payment.png','title':'Pago seguro','desc':'Transacciones protegidas y soporte'},
          {'img':'img/banners/service_shipping.png','title':'Env√≠o con tracking','desc':'Seguimiento de tu pedido'},
          {'img':'img/banners/service_support.png','title':'Soporte real','desc':'Atenci√≥n y ayuda post-compra'}
        ] %}

        {% for t in trust %}
          <article class="hp-trustCard" aria-label="{{ t.title }}">
            <div class="hp-trustCard__img" aria-hidden="true">
              <img
                src="{{ url_for('static', filename=t.img) }}"
                alt=""
                loading="lazy"
                decoding="async"
                class="hp-trustIcon">
            </div>
            <div class="hp-trustCard__meta">
              <b>{{ t.title }}</b>
              <span>{{ t.desc }}</span>
            </div>
          </article>
        {% endfor %}
      </div>
    </section>

    {# ================= CATEGORIES (arreglado: recorte/centrado) ================= #}
    <section class="hp-cats" aria-labelledby="hpCats">
      <div class="hp-wrap">
        <div class="hp-secHead">
          <h2 id="hpCats">Categor√≠as</h2>
          <p>Encontr√° r√°pido lo que busc√°s con accesos directos.</p>
        </div>

        {% set cats = [
          {'label':'Ropa urbana','img':'img/banners/cat_women.png','href': shop_url ~ ('?categoria=ropa' if '?' not in shop_url else '&categoria=ropa')},
          {'label':'Accesorios','img':'img/banners/cat_accessories.png','href': shop_url ~ ('?categoria=accesorios' if '?' not in shop_url else '&categoria=accesorios')},
          {'label':'Tecnolog√≠a','img':'img/banners/cat_tech.png','href': shop_url ~ ('?categoria=tecnologia' if '?' not in shop_url else '&categoria=tecnologia')},
          {'label':'Ofertas','img':'img/banners/promo_week.png','href': offers_url}
        ] %}

        <div class="hp-catsGrid" role="list">
          {% for c in cats %}
            <a class="hp-catCard" href="{{ c.href }}" aria-label="{{ c.label }}" role="listitem">
              <div class="hp-catCard__media" aria-hidden="true">
                <img
                  src="{{ url_for('static', filename=c.img) }}"
                  alt=""
                  loading="lazy"
                  decoding="async"
                  class="hp-catImg">
              </div>
              <div class="hp-catCard__overlay">
                <b>{{ c.label }}</b>
                <span>Explorar ‚Üí</span>
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    </section>

    {# ================= FEATURED ================= #}
    <section class="hp-featured" aria-labelledby="hpFeat">
      <div class="hp-wrap">
        <div class="hp-secHead">
          <h2 id="hpFeat">Destacados</h2>
          <p>Selecci√≥n recomendada. Lo mejor para empezar.</p>
        </div>

        <div class="hp-products">
          {% if featured_list|length == 0 %}
            <div class="hp-empty card" aria-live="polite">
              <b>Sin destacados por ahora</b>
              <p>Pod√©s explorar todo el cat√°logo y volver m√°s tarde.</p>
              <div class="hp-empty__actions" role="group" aria-label="Acciones recomendadas">
                <a class="btn primary" href="{{ shop_url }}">Ir a la tienda</a>
                <a class="btn soft" href="{{ account_register_url }}">Crear cuenta</a>
              </div>
            </div>
          {% else %}
            {% for p in featured_list %}
              {% set p_title = (p.title if p and p.title is defined and p.title else (p.get('title') if p is mapping and p.get('title') else 'Producto')) %}
              {% set p_href  = (p.href  if p and p.href  is defined and p.href  else (p.get('href')  if p is mapping and p.get('href')  else shop_url)) %}
              {% set p_img   = (p.img   if p and p.img   is defined and p.img   else (p.get('img')   if p is mapping and p.get('img')   else hero_img)) %}
              {% set p_tag   = (p.tag   if p and p.tag   is defined and p.tag   else (p.get('tag')   if p is mapping and p.get('tag')   else '')) %}
              {% set p_badge = (p.badge if p and p.badge is defined and p.badge else (p.get('badge') if p is mapping and p.get('badge') else '')) %}
              {% set p_rating = (p.rating if p and p.rating is defined and p.rating else (p.get('rating') if p is mapping and p.get('rating') else '')) %}

              <article class="hp-prod" aria-label="{{ p_title }}">
                {% if p_badge or p_tag %}
                  <div class="hp-badges" aria-hidden="true">
                    {% if p_badge %}<span class="hp-badge hp-badge--sale">{{ p_badge }}</span>{% endif %}
                    {% if p_tag %}<span class="hp-badge">{{ p_tag }}</span>{% endif %}
                  </div>
                {% endif %}

                <a class="hp-prod__img" href="{{ p_href }}" aria-label="{{ p_title }}">
                  <img src="{{ p_img }}" alt="{{ p_title }}" loading="lazy" decoding="async" class="hp-prodImg">
                </a>

                <div class="hp-prod__meta">
                  <div class="hp-prod__top">
                    <b class="hp-prod__title">{{ p_title }}</b>
                    {% if p_rating %}
                      <span class="hp-rating" aria-label="Rating {{ p_rating }}"><i aria-hidden="true">‚òÖ</i> {{ p_rating }}</span>
                    {% endif %}
                  </div>

                  <div class="hp-prod__price" aria-label="Precio">
                    {% with product=p %}
                      {% include "components/price.html" ignore missing %}
                    {% endwith %}
                  </div>

                  <div class="hp-prod__micro" aria-label="Beneficios del producto">
                    <span class="hp-microChip">‚ö° Env√≠o r√°pido</span>
                    <span class="hp-microChip">üîí Pago seguro</span>
                  </div>
                </div>

                <div class="hp-prod__actions" role="group" aria-label="Acciones del producto">
                  <a class="btn primary" href="{{ p_href }}">Ver</a>
                  <a class="btn ghost" href="{{ shop_url }}">M√°s</a>
                </div>
              </article>
            {% endfor %}
          {% endif %}
        </div>
      </div>
    </section>

    {# ================= FINAL CTA ================= #}
    <section class="hp-cta" aria-label="Llamado a la acci√≥n final">
      <div class="hp-wrap hp-cta__inner">
        <div>
          <h2 class="hp-cta__title">Compr√° con confianza</h2>
          <p class="hp-cta__sub">Marketplace + marca propia. Env√≠os con seguimiento y soporte real.</p>
        </div>
        <div class="hp-cta__btns" role="group" aria-label="Acciones finales">
          <a class="btn primary" href="{{ shop_url }}">Empezar ahora</a>
          <a class="btn soft" href="{{ account_register_url }}">Crear cuenta</a>
        </div>
      </div>
    </section>

    {# Sticky + ToTop (si tu home.js los usa) #}
    <div class="hp-sticky" id="hpSticky" aria-live="polite">
      <div class="hp-sticky__txt">
        <b>Skyline Store</b>
        <span>Explor√° ofertas premium</span>
      </div>
      <a href="{{ offers_url }}" class="hp-sticky__btn">Comprar</a>
    </div>

    <button id="toTop" type="button" class="to-top" aria-label="Volver arriba">‚Üë</button>
  </main>
{% endblock %}

{% block extra_js %}
  <script src="{{ url_for('static', filename='js/home.js') }}" defer></script>
{% endblock %}
