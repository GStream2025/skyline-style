{% extends "base.html" %}
{% block title %}Mi cuenta | Skyline Store{% endblock %}

{% block extra_head %}
  {# 1) Preload CSS + fallback real #}
  <link rel="preload" as="style" href="{{ url_for('static', filename='css/account.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/account.css') }}">

  {# 2) SEO b√°sico seguro #}
  <meta name="robots" content="index,follow">
  <meta name="description" content="Ingres√° o cre√° tu cuenta en Skyline Store para ver pedidos, guardar favoritos y acceder a beneficios exclusivos.">

  {# 3) CSRF meta global para JS (sirve para fetch en login/register si lo necesit√°s) #}
  {% if csrf_token is defined and csrf_token is callable %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
  {% else %}
    <meta name="csrf-token" content="">
  {% endif %}
{% endblock %}

{% block content %}
{# ============================================================
   4) SAFE NEXT: evita open-redirect y cosas raras
============================================================ #}
{% set raw_next = next|default(request.args.get('next',''), true) %}
{% set nxt = (raw_next|string).strip() %}
{% if not nxt or not nxt.startswith('/') or nxt.startswith('//') %}
  {% set nxt = '' %}
{% endif %}

{# ============================================================
   5) SAFE URL RESOLVER (NO BREAK si falta un endpoint)
   - url_for puede explotar con BuildError si ruta no existe
============================================================ #}
{% macro safe_url(endpoint, fallback='/', **kwargs) -%}
  {%- if endpoint in (view_functions if view_functions is defined and view_functions else {}) -%}
    {{- url_for(endpoint, **kwargs) -}}
  {%- else -%}
    {{- fallback -}}
  {%- endif -%}
{%- endmacro %}

{% set shop_url     = safe_url('shop.shop', '/shop') %}
{% set login_url    = safe_url('auth.login', '/auth/login', next=nxt) %}
{% set register_url = safe_url('auth.register', '/auth/register', next=nxt) %}
{% set about_url    = safe_url('main.about', '/about') %}
{% set contact_url  = safe_url('main.contact', about_url) %}

{# ============================================================
   6) Feature flags sin romper (config puede no estar en template)
============================================================ #}
{% set cfg = (config if config is defined and config else {}) %}
{% set enable_google = (cfg.get('ENABLE_GOOGLE_OAUTH', '0')|string|lower) in ['1','true','yes','y','on'] %}
{% set enable_apple  = (cfg.get('ENABLE_APPLE_OAUTH',  '0')|string|lower) in ['1','true','yes','y','on'] %}

{% set vf = (view_functions if view_functions is defined and view_functions else {}) %}
{% set has_google = enable_google and ('auth.google' in vf) %}
{% set has_apple  = enable_apple  and ('auth.apple'  in vf) %}

<section class="ss-account"
  aria-label="Acceso a tu cuenta"
  data-next="{{ nxt|e }}"
  data-login-url="{{ login_url }}"
  data-register-url="{{ register_url }}"
>
  <div class="ss-account__bg" aria-hidden="true">
    <span class="blob b1"></span>
    <span class="blob b2"></span>
    <span class="grid"></span>
  </div>

  <div class="ss-account__container">

    <!-- Left / Hero -->
    <aside class="ss-account__hero" aria-label="Beneficios de tener cuenta">
      <header class="brand" role="banner" aria-label="Skyline Store">
        <div class="logo-mark" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none">
            <path d="M4 14.5 12 4l8 10.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7.5 14.5 12 9l4.5 5.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity=".7"/>
            <path d="M6 20h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="brand-text">
          <div class="brand-name">Skyline Store</div>
          <div class="brand-tag">Marketplace premium de Tech + Streetwear</div>
        </div>
      </header>

      <h1>Entr√° a tu cuenta</h1>
      <p class="lead">
        Compr√° m√°s r√°pido, guard√° favoritos, segu√≠ pedidos y acced√© a promos exclusivas.
        Todo optimizado para una experiencia tipo marketplace.
      </p>

      <ul class="perks" role="list" aria-label="Beneficios">
        <li>
          <span class="perk-ic" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
              <path d="M20 7 10.5 16.5 7 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10Z" stroke="currentColor" stroke-width="2" opacity=".7"/>
            </svg>
          </span>
          Checkout m√°s r√°pido y seguro
        </li>
        <li>
          <span class="perk-ic" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
              <path d="M12 8v4l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z" stroke="currentColor" stroke-width="2" opacity=".7"/>
            </svg>
          </span>
          Historial y seguimiento de pedidos
        </li>
        <li>
          <span class="perk-ic" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
              <path d="M12 3l3 6 6 .9-4.5 4.4 1 6.2L12 17.8 6.5 20.5l1-6.2L3 9.9 9 9l3-6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </span>
          Acceso a cupones y drops exclusivos
        </li>
      </ul>

      <div class="trust" aria-label="Confianza y soporte">
        <div class="trust-item"><span class="t-dot" aria-hidden="true"></span> Pago seguro</div>
        <div class="trust-item"><span class="t-dot" aria-hidden="true"></span> Env√≠os r√°pidos</div>
        <div class="trust-item"><span class="t-dot" aria-hidden="true"></span> Soporte real</div>
      </div>
    </aside>

    <!-- Right / Card -->
    <section class="ss-account__card" aria-label="Opciones de acceso">
      <header class="card-head">
        <div>
          <div class="card-title">Continuar</div>
          <div class="card-sub">Inici√° sesi√≥n o cre√° tu cuenta</div>
        </div>
        <span class="secure-pill" title="Conexi√≥n segura" aria-label="Conexi√≥n segura">
          <span class="dot" aria-hidden="true"></span> Seguro
        </span>
      </header>

      {# 7) Flash messages accesibles #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="ss-account__flashwrap" role="status" aria-live="polite" aria-atomic="true">
            {% for c,m in messages %}
              <div class="ss-account__flash {{ c|e }}">{{ m }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- Tabs -->
      <div class="tabs" role="tablist" aria-label="Acciones">
        <button class="tab is-active" id="tab-login" type="button" role="tab"
                aria-selected="true" aria-controls="panel-login" tabindex="0">
          Iniciar sesi√≥n
        </button>
        <button class="tab" id="tab-register" type="button" role="tab"
                aria-selected="false" aria-controls="panel-register" tabindex="-1">
          Crear cuenta
        </button>
      </div>

      <!-- Panel: Login -->
      <div class="panel" id="panel-login" role="tabpanel" aria-labelledby="tab-login">
        <div class="actions">
          <a class="btn primary" href="{{ login_url }}" rel="nofollow">
            <span class="btn-ic" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
                <path d="M10 17l5-5-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M15 12H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M21 21V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".7"/>
              </svg>
            </span>
            Iniciar sesi√≥n
            <span class="btn-meta">Ya tengo cuenta</span>
          </a>
        </div>

        {% if has_google or has_apple %}
          <div class="divider" aria-hidden="true"><span>o</span></div>

          <div class="social" aria-label="Inicio r√°pido">
            {% if has_google %}
              <a class="btn ghost" href="{{ url_for('auth.google', next=nxt) }}" rel="nofollow">
                <span class="btn-ic" aria-hidden="true">G</span>
                Continuar con Google
                <span class="btn-meta">1 click</span>
              </a>
            {% endif %}
            {% if has_apple %}
              <a class="btn ghost" href="{{ url_for('auth.apple', next=nxt) }}" rel="nofollow">
                <span class="btn-ic" aria-hidden="true">Ô£ø</span>
                Continuar con Apple
                <span class="btn-meta">1 click</span>
              </a>
            {% endif %}
          </div>
        {% endif %}

        <div class="divider" aria-hidden="true"><span>o</span></div>

        <div class="secondary">
          <a class="link" href="{{ shop_url }}">Seguir como invitado</a>
          <div class="fineprint">
            Al continuar acept√°s nuestros
            <a class="link2" href="{{ about_url }}">t√©rminos</a>
            y
            <a class="link2" href="{{ contact_url }}">soporte</a>.
          </div>
        </div>
      </div>

      <!-- Panel: Register -->
      <div class="panel is-hidden" id="panel-register" role="tabpanel" aria-labelledby="tab-register">
        <div class="actions">
          <a class="btn primary" href="{{ register_url }}" rel="nofollow">
            <span class="btn-ic" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke="currentColor" stroke-width="2"/>
                <path d="M19 8v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M16 11h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>
            Crear cuenta
            <span class="btn-meta">R√°pido, 1 minuto</span>
          </a>

          <div class="mini-note" role="note">
            üéÅ Al registrarte desbloque√°s cupones, favoritos y seguimiento de pedidos.
          </div>
        </div>

        <div class="divider" aria-hidden="true"><span>o</span></div>

        <div class="secondary">
          <a class="link" href="{{ login_url }}">Ya tengo cuenta ‚Üí iniciar sesi√≥n</a>
          <div class="fineprint">
            Al continuar acept√°s nuestros
            <a class="link2" href="{{ about_url }}">t√©rminos</a>
            y
            <a class="link2" href="{{ contact_url }}">soporte</a>.
          </div>
        </div>
      </div>

    </section>
  </div>

  <!-- 8) Sticky -->
  <div class="ss-account__sticky" id="accSticky" aria-hidden="true">
    <div class="inner">
      <div class="t">
        <b id="accStickyTitle">Continuar</b>
        <span id="accStickySub">Entr√° o cre√° tu cuenta</span>
      </div>
      <a class="go" id="accStickyBtn" href="{{ login_url }}">Entrar ‚Üí</a>
    </div>
  </div>

  {# 9) No-JS fallback #}
  <noscript>
    <div class="ss-account__noscript">
      Activ√° JavaScript para ver los tabs. Igual pod√©s
      <a href="{{ login_url }}">iniciar sesi√≥n</a> o
      <a href="{{ register_url }}">crear cuenta</a>.
    </div>
  </noscript>
</section>

{# 10) JS externo defer + cache-bust real #}
<script defer src="{{ url_for('static', filename='js/account.js') }}?v=2"></script>
{% endblock %}
