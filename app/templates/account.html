{% extends "base.html" %}
{% block title %}Mi cuenta | Skyline Store{% endblock %}

{% block content %}
{% set nxt = next|default('') %}

{# Flags de producci√≥n (no rompe si no us√°s social login) #}
{% set enable_google = (config.get('ENABLE_GOOGLE_OAUTH', '0')|string|lower) in ['1','true','yes','y','on'] %}
{% set enable_apple  = (config.get('ENABLE_APPLE_OAUTH',  '0')|string|lower) in ['1','true','yes','y','on'] %}

<section class="ss-account" aria-label="Acceso a tu cuenta">
  <div class="ss-account__bg" aria-hidden="true">
    <span class="blob b1"></span>
    <span class="blob b2"></span>
    <span class="grid"></span>
  </div>

  <div class="ss-account__container">

    <!-- Left / Hero -->
    <aside class="ss-account__hero" aria-label="Beneficios de tener cuenta">
      <header class="brand" role="banner" aria-label="Skyline Store">
        <div class="logo-mark" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none">
            <path d="M4 14.5 12 4l8 10.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7.5 14.5 12 9l4.5 5.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity=".7"/>
            <path d="M6 20h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="brand-text">
          <div class="brand-name">Skyline Store</div>
          <div class="brand-tag">Marketplace premium de Tech + Streetwear</div>
        </div>
      </header>

      <h1>Entr√° a tu cuenta</h1>
      <p class="lead">
        Compr√° m√°s r√°pido, guard√° favoritos, segu√≠ pedidos y acced√© a promos exclusivas.
        Todo optimizado para una experiencia tipo marketplace.
      </p>

      <ul class="perks" role="list" aria-label="Beneficios">
        <li>
          <span class="perk-ic" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
              <path d="M20 7 10.5 16.5 7 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10Z" stroke="currentColor" stroke-width="2" opacity=".7"/>
            </svg>
          </span>
          Checkout m√°s r√°pido y seguro
        </li>
        <li>
          <span class="perk-ic" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
              <path d="M12 8v4l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0Z" stroke="currentColor" stroke-width="2" opacity=".7"/>
            </svg>
          </span>
          Historial y seguimiento de pedidos
        </li>
        <li>
          <span class="perk-ic" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
              <path d="M12 3l3 6 6 .9-4.5 4.4 1 6.2L12 17.8 6.5 20.5l1-6.2L3 9.9 9 9l3-6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </span>
          Acceso a cupones y drops exclusivos
        </li>
      </ul>

      <div class="trust" aria-label="Confianza y soporte">
        <div class="trust-item"><span class="t-dot" aria-hidden="true"></span> Pago seguro</div>
        <div class="trust-item"><span class="t-dot" aria-hidden="true"></span> Env√≠os r√°pidos</div>
        <div class="trust-item"><span class="t-dot" aria-hidden="true"></span> Soporte real</div>
      </div>
    </aside>

    <!-- Right / Card -->
    <section class="ss-account__card" aria-label="Opciones de acceso">
      <header class="card-head">
        <div>
          <div class="card-title">Continuar</div>
          <div class="card-sub">Inici√° sesi√≥n o cre√° tu cuenta</div>
        </div>
        <span class="secure-pill" title="Conexi√≥n segura">
          <span class="dot" aria-hidden="true"></span> Seguro
        </span>
      </header>

      <!-- Tabs -->
      <div class="tabs" role="tablist" aria-label="Acciones">
        <button class="tab is-active" id="tab-login" type="button" role="tab"
                aria-selected="true" aria-controls="panel-login" tabindex="0">
          Iniciar sesi√≥n
        </button>
        <button class="tab" id="tab-register" type="button" role="tab"
                aria-selected="false" aria-controls="panel-register" tabindex="-1">
          Crear cuenta
        </button>
      </div>

      <!-- Panel: Login -->
      <div class="panel" id="panel-login" role="tabpanel" aria-labelledby="tab-login">
        <div class="actions">
          <a class="btn primary" href="{{ url_for('auth.login', next=nxt) }}">
            <span class="btn-ic" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
                <path d="M10 17l5-5-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M15 12H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M21 21V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".7"/>
              </svg>
            </span>
            Iniciar sesi√≥n
            <span class="btn-meta">Ya tengo cuenta</span>
          </a>
        </div>

        {% if enable_google or enable_apple %}
          <div class="divider" aria-hidden="true"><span>o</span></div>

          <div class="social" aria-label="Inicio r√°pido">
            {% if enable_google %}
              <a class="btn ghost" href="{{ url_for('auth.google', next=nxt) }}">
                <span class="btn-ic" aria-hidden="true">G</span>
                Continuar con Google
                <span class="btn-meta">1 click</span>
              </a>
            {% endif %}
            {% if enable_apple %}
              <a class="btn ghost" href="{{ url_for('auth.apple', next=nxt) }}">
                <span class="btn-ic" aria-hidden="true">Ô£ø</span>
                Continuar con Apple
                <span class="btn-meta">1 click</span>
              </a>
            {% endif %}
          </div>
        {% endif %}

        <div class="divider" aria-hidden="true"><span>o</span></div>

        <div class="secondary">
          <a class="link" href="{{ url_for('shop.shop') }}">Seguir como invitado</a>
          <div class="fineprint">
            Al continuar acept√°s nuestros
            <a class="link2" href="{{ url_for('main.about') }}">t√©rminos</a>
            y
            <a class="link2" href="{{ url_for('main.contact') }}">soporte</a>.
          </div>
        </div>
      </div>

      <!-- Panel: Register -->
      <div class="panel is-hidden" id="panel-register" role="tabpanel" aria-labelledby="tab-register">
        <div class="actions">
          <a class="btn primary" href="{{ url_for('auth.register', next=nxt) }}">
            <span class="btn-ic" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke="currentColor" stroke-width="2"/>
                <path d="M19 8v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M16 11h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>
            Crear cuenta
            <span class="btn-meta">R√°pido, 1 minuto</span>
          </a>

          <div class="mini-note" role="note">
            üéÅ Al registrarte desbloque√°s cupones, favoritos y seguimiento de pedidos.
          </div>
        </div>

        <div class="divider" aria-hidden="true"><span>o</span></div>

        <div class="secondary">
          <a class="link" href="{{ url_for('auth.login', next=nxt) }}">Ya tengo cuenta ‚Üí iniciar sesi√≥n</a>
          <div class="fineprint">
            Al continuar acept√°s nuestros
            <a class="link2" href="{{ url_for('main.about') }}">t√©rminos</a>
            y
            <a class="link2" href="{{ url_for('main.contact') }}">soporte</a>.
          </div>
        </div>
      </div>

    </section>
  </div>

  <!-- Mobile sticky helper (no rompe) -->
  <div class="ss-account__sticky" id="accSticky" aria-hidden="true">
    <div class="inner">
      <div class="t">
        <b id="accStickyTitle">Continuar</b>
        <span id="accStickySub">Entr√° o cre√° tu cuenta</span>
      </div>
      <a class="go" id="accStickyBtn" href="{{ url_for('auth.login', next=nxt) }}">Entrar ‚Üí</a>
    </div>
  </div>
</section>

<style>
/* ==========================================================
   Skyline Store ‚Äî Account (ULTRA PRO v2)
   ‚úÖ 100% scoped a .ss-account
   ‚úÖ dark auto + consistent focus ring + premium spacing
========================================================== */

.ss-account{
  --bg0:#ffffff;
  --bg1:#f7f8fb;
  --ink:#0b1220;
  --muted: rgba(11,18,32,.66);

  --a:#2563eb;
  --b:#06b6d4;
  --c:#f59e0b;
  --g:#22c55e;

  --stroke: rgba(15,23,42,.10);
  --stroke2: rgba(15,23,42,.08);
  --ring: 0 0 0 4px rgba(37,99,235,.18);

  --shadow1: 0 12px 40px rgba(2,6,23,.14);
  --shadow2: 0 26px 90px rgba(2,6,23,.18);

  --glass: rgba(255,255,255,.72);
  --glass2: rgba(255,255,255,.88);

  position: relative;
  min-height: calc(100vh - 120px);
  padding: clamp(22px, 3vw, 36px) 14px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:
    radial-gradient(circle at 0% 0%, rgba(37,99,235,.10), transparent 42%),
    radial-gradient(circle at 100% 0%, rgba(6,182,212,.08), transparent 46%),
    radial-gradient(circle at 50% 100%, rgba(245,158,11,.08), transparent 48%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}

@media (prefers-color-scheme: dark){
  .ss-account{
    --bg0:#070b14;
    --bg1:#0b1020;
    --ink:#eef2ff;
    --muted: rgba(238,242,255,.70);

    --stroke: rgba(148,163,184,.18);
    --stroke2: rgba(148,163,184,.12);
    --ring: 0 0 0 4px rgba(6,182,212,.18);

    --shadow1: 0 12px 40px rgba(0,0,0,.38);
    --shadow2: 0 34px 110px rgba(0,0,0,.55);

    --glass: rgba(9,12,24,.64);
    --glass2: rgba(9,12,24,.80);
  }
}

/* BG */
.ss-account__bg{ position:absolute; inset:0; overflow:hidden; pointer-events:none; }
.ss-account__bg .grid{
  position:absolute; inset:-2px;
  background:
    radial-gradient(circle at 20% 10%, rgba(56,189,248,.14), transparent 35%),
    radial-gradient(circle at 80% 20%, rgba(250,204,21,.12), transparent 38%),
    radial-gradient(circle at 40% 90%, rgba(244,114,182,.10), transparent 42%),
    linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0));
  filter: saturate(1.10);
  opacity: .95;
}
.ss-account__bg .blob{
  position:absolute; width:520px; height:520px; border-radius:999px;
  filter: blur(58px); opacity:.33; transform: translate3d(0,0,0);
}
.ss-account__bg .b1{
  left:-160px; top:-180px;
  background: radial-gradient(circle at 30% 30%, rgba(56,189,248,.9), rgba(56,189,248,0));
}
.ss-account__bg .b2{
  right:-180px; bottom:-200px;
  background: radial-gradient(circle at 40% 40%, rgba(250,204,21,.85), rgba(250,204,21,0));
}

.ss-account__container{
  position: relative;
  width: min(1100px, 100%);
  display:grid;
  gap: 18px;
  grid-template-columns: 1.12fr .88fr;
  align-items: stretch;
}

/* Left hero (glass) */
.ss-account__hero{
  padding: clamp(18px, 2.5vw, 26px);
  border-radius: 22px;
  background: linear-gradient(135deg, var(--glass2), var(--glass));
  border: 1px solid var(--stroke2);
  box-shadow: var(--shadow2);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  color: var(--ink);
  overflow:hidden;
  position:relative;
}
.ss-account__hero::before{
  content:"";
  position:absolute; inset:-40%;
  background:
    radial-gradient(circle at 25% 20%, rgba(37,99,235,.14), transparent 55%),
    radial-gradient(circle at 75% 25%, rgba(6,182,212,.12), transparent 55%),
    radial-gradient(circle at 50% 85%, rgba(245,158,11,.10), transparent 55%);
  filter: blur(20px);
  opacity: .95;
  pointer-events:none;
}
.ss-account__hero > *{ position:relative; }

.brand{ display:flex; align-items:center; gap:12px; margin-bottom: 12px; }
.logo-mark{
  width:42px; height:42px; border-radius: 14px;
  display:grid; place-items:center;
  background: linear-gradient(135deg, rgba(37,99,235,.22), rgba(6,182,212,.16));
  border: 1px solid var(--stroke2);
  color: var(--ink);
}
.brand-name{ font-weight: 1000; letter-spacing: .2px; }
.brand-tag{ color: var(--muted); font-size: .95rem; margin-top:2px; font-weight: 850; }

.ss-account__hero h1{
  font-size: clamp(1.7rem, 2.6vw, 2.35rem);
  margin: 10px 0 6px;
  line-height: 1.12;
  letter-spacing: -.6px;
}
.ss-account__hero .lead{
  color: var(--muted);
  margin: 0 0 16px;
  max-width: 60ch;
  line-height: 1.55;
  font-weight: 850;
}

.perks{ list-style:none; padding:0; margin: 14px 0 0; display:grid; gap: 10px; }
.perks li{
  display:flex; align-items:flex-start; gap:10px;
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(255,255,255,.60);
  border: 1px solid var(--stroke2);
}
@media (prefers-color-scheme: dark){
  .perks li{ background: rgba(255,255,255,.06); }
}
.perk-ic{
  width:34px; height:34px; border-radius: 12px;
  display:grid; place-items:center;
  background: rgba(255,255,255,.70);
  border: 1px solid var(--stroke2);
  flex: 0 0 auto;
}
@media (prefers-color-scheme: dark){
  .perk-ic{ background: rgba(255,255,255,.06); }
}

.trust{
  display:flex; flex-wrap:wrap; gap:10px;
  margin-top: 16px;
  padding-top: 14px;
  border-top: 1px solid var(--stroke2);
}
.trust-item{
  display:inline-flex; align-items:center; gap:8px;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid var(--stroke2);
  background: rgba(255,255,255,.60);
  font-weight: 950;
  font-size: .92rem;
  color: var(--muted);
}
@media (prefers-color-scheme: dark){
  .trust-item{ background: rgba(255,255,255,.06); }
}
.t-dot{
  width:9px; height:9px; border-radius:999px;
  background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(6,182,212,.88));
  box-shadow: 0 0 0 4px rgba(37,99,235,.14);
}

/* Right card */
.ss-account__card{
  border-radius: 22px;
  background: rgba(255,255,255,.90);
  border: 1px solid var(--stroke2);
  box-shadow: var(--shadow1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  padding: 18px;
  display:flex;
  flex-direction: column;
  gap: 12px;
}
@media (prefers-color-scheme: dark){
  .ss-account__card{ background: rgba(9,12,24,.70); }
}

.card-head{ display:flex; align-items:flex-start; justify-content: space-between; gap: 10px; }
.card-title{ font-weight: 1000; font-size: 1.25rem; color: var(--ink); }
.card-sub{ color: var(--muted); font-weight: 850; font-size:.95rem; margin-top:2px; }

.secure-pill{
  display:inline-flex; align-items:center; gap:8px;
  padding: 7px 10px; border-radius: 999px; font-size:.85rem;
  background: rgba(34,197,94,.12);
  border: 1px solid rgba(34,197,94,.22);
  color: var(--ink);
  white-space: nowrap;
  font-weight: 1000;
}
.secure-pill .dot{
  width:8px; height:8px; border-radius: 999px;
  background: rgba(34,197,94,.95);
  box-shadow: 0 0 0 4px rgba(34,197,94,.18);
}

/* Tabs */
.tabs{
  position:relative;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  margin-top: 4px;
}
.tab{
  border: 1px solid var(--stroke2);
  background: rgba(255,255,255,.88);
  border-radius: 14px;
  padding: 10px 12px;
  font-weight: 1000;
  color: var(--muted);
  cursor:pointer;
  transition: transform .12s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
}
@media (prefers-color-scheme: dark){
  .tab{ background: rgba(255,255,255,.06); }
}
.tab:hover{ transform: translateY(-1px); }
.tab:focus-visible{ outline:none; box-shadow: var(--ring); }
.tab.is-active{
  color:#fff;
  border-color: transparent;
  background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(6,182,212,.88));
  box-shadow: 0 14px 30px rgba(2,6,23,.14);
}

/* Panels */
.panel{ display:block; }
.panel.is-hidden{ display:none; }

.actions{ display:grid; gap: 12px; }
.social{ display:grid; gap: 10px; }

/* Buttons */
.btn{
  position: relative;
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 14px 14px;
  border-radius: 16px;
  text-decoration:none;
  border: 1px solid transparent;
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease, filter .12s ease;
  user-select:none;
  outline: none;
}
.btn:hover{ transform: translateY(-1px); filter:saturate(1.03); }
.btn:active{ transform: translateY(0px); }
.btn:focus-visible{ box-shadow: var(--ring); border-color: rgba(37,99,235,.25); }

.btn .btn-ic{
  width:38px; height:38px; border-radius: 14px;
  display:grid; place-items:center;
  border: 1px solid var(--stroke2);
  background: rgba(255,255,255,.70);
  flex: 0 0 auto;
  font-weight: 1000;
  color: var(--ink);
}
@media (prefers-color-scheme: dark){
  .btn .btn-ic{ background: rgba(255,255,255,.06); }
}
.btn .btn-meta{ margin-left:auto; color: var(--muted); font-weight: 850; font-size:.9rem; }

.btn.primary{
  background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(6,182,212,.88));
  border-color: rgba(37,99,235,.18);
  color: #fff;
  box-shadow: 0 16px 40px rgba(2,6,23,.16);
}
.btn.primary .btn-ic{
  background: rgba(255,255,255,.14);
  border-color: rgba(255,255,255,.22);
  color: #fff;
}

.btn.ghost{
  background: rgba(255,255,255,.90);
  border-color: var(--stroke2);
  color: var(--ink);
}
@media (prefers-color-scheme: dark){
  .btn.ghost{ background: rgba(255,255,255,.06); }
}
.btn.ghost:hover{
  border-color: rgba(37,99,235,.20);
  box-shadow: 0 12px 24px rgba(2,6,23,.08);
}

/* Divider */
.divider{ position: relative; margin: 10px 0 6px; text-align:center; }
.divider::before{
  content:""; position:absolute; left:0; right:0; top: 50%;
  height:1px; background: var(--stroke2);
}
.divider span{
  position: relative; display:inline-block;
  padding: 0 10px; border-radius: 999px;
  background: rgba(255,255,255,.90);
  border: 1px solid var(--stroke2);
  color: var(--muted);
  font-weight: 900;
  font-size:.9rem;
}
@media (prefers-color-scheme: dark){
  .divider span{ background: rgba(9,12,24,.70); }
}

/* Secondary */
.secondary{
  display:flex; flex-direction: column; gap: 10px;
  align-items:center; padding-top: 4px;
}
.link{
  text-decoration:none;
  font-weight: 950;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px dashed rgba(15,23,42,.18);
  background: rgba(255,255,255,.88);
  color: var(--ink);
  transition: background .12s ease, border-color .12s ease, transform .12s ease, box-shadow .12s ease;
}
@media (prefers-color-scheme: dark){
  .link{ background: rgba(255,255,255,.06); border-color: rgba(148,163,184,.22); }
}
.link:hover{ transform: translateY(-1px); border-color: rgba(37,99,235,.22); }
.link:focus-visible{ box-shadow: var(--ring); outline: none; }

.fineprint{
  text-align:center;
  font-size: .9rem;
  color: var(--muted);
  font-weight: 850;
  max-width: 48ch;
  line-height: 1.35;
}
.link2{
  color: var(--ink);
  font-weight: 950;
  text-decoration: none;
  border-bottom: 1px solid rgba(15,23,42,.22);
}
@media (prefers-color-scheme: dark){
  .link2{ border-bottom-color: rgba(148,163,184,.28); }
}
.link2:hover{ border-bottom-color: rgba(37,99,235,.35); }

.mini-note{
  border-radius: 14px;
  padding: 12px 12px;
  border: 1px solid rgba(245,158,11,.24);
  background: rgba(245,158,11,.10);
  color: var(--ink);
  font-weight: 900;
  line-height: 1.35;
}

/* Responsive */
@media (max-width: 980px){
  .ss-account__container{ grid-template-columns: 1fr; }
  .ss-account__hero{ order: 2; }
  .ss-account__card{ order: 1; }
}

/* Mobile sticky helper */
.ss-account__sticky{
  position:fixed;
  left: 14px;
  right: 14px;
  bottom: 14px;
  z-index: 60;
  display:none;
  justify-content:center;
  pointer-events:none;
}
.ss-account__sticky.is-on{ display:flex; }
.ss-account__sticky .inner{
  pointer-events:auto;
  width: min(720px, 100%);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 12px 12px;
  border-radius: 999px;
  border: 1px solid var(--stroke2);
  background: rgba(255,255,255,.72);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  box-shadow: 0 30px 90px rgba(2,6,23,.16);
}
@media (prefers-color-scheme: dark){
  .ss-account__sticky .inner{ background: rgba(9,12,24,.62); }
}
.ss-account__sticky .t{ display:flex; flex-direction:column; gap:2px; }
.ss-account__sticky b{ color: var(--ink); font-weight: 1000; line-height:1.05; }
.ss-account__sticky span{ color: var(--muted); font-weight: 850; font-size:.9rem; }
.ss-account__sticky .go{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:.55rem;
  border-radius:999px;
  padding:.74rem 1.05rem;
  font-weight:1000;
  text-decoration:none;
  border:1px solid transparent;
  background: linear-gradient(135deg, var(--a), var(--b));
  color:#fff;
  box-shadow: 0 18px 40px rgba(2,6,23,.14);
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  .ss-account *{ transition:none!important; }
  .ss-account .btn:hover, .ss-account .tab:hover{ transform:none!important; }
}
</style>

<script>
/* Tabs: accesible + teclado + recuerda elecci√≥n (producci√≥n) */
(function(){
  const loginTab = document.getElementById("tab-login");
  const regTab = document.getElementById("tab-register");
  const loginPanel = document.getElementById("panel-login");
  const regPanel = document.getElementById("panel-register");
  const sticky = document.getElementById("accSticky");
  const stickyTitle = document.getElementById("accStickyTitle");
  const stickySub = document.getElementById("accStickySub");
  const stickyBtn = document.getElementById("accStickyBtn");
  if(!loginTab || !regTab || !loginPanel || !regPanel) return;

  const KEY = "ss_account_tab";
  const tabs = [loginTab, regTab];

  function setSticky(which){
    if(!sticky || !stickyTitle || !stickySub || !stickyBtn) return;
    const isMobile = window.matchMedia("(max-width: 980px)").matches;
    if(!isMobile){ sticky.classList.remove("is-on"); sticky.setAttribute("aria-hidden","true"); return; }

    sticky.classList.add("is-on");
    sticky.setAttribute("aria-hidden","false");

    if(which === "register"){
      stickyTitle.textContent = "Crear cuenta";
      stickySub.textContent = "R√°pido, 1 minuto";
      stickyBtn.textContent = "Crear ‚Üí";
      stickyBtn.href = "{{ url_for('auth.register', next=nxt) }}";
    }else{
      stickyTitle.textContent = "Iniciar sesi√≥n";
      stickySub.textContent = "Ya tengo cuenta";
      stickyBtn.textContent = "Entrar ‚Üí";
      stickyBtn.href = "{{ url_for('auth.login', next=nxt) }}";
    }
  }

  function setTab(which){
    const isLogin = which === "login";
    loginTab.classList.toggle("is-active", isLogin);
    regTab.classList.toggle("is-active", !isLogin);

    loginTab.setAttribute("aria-selected", isLogin ? "true" : "false");
    regTab.setAttribute("aria-selected", !isLogin ? "true" : "false");

    loginTab.tabIndex = isLogin ? 0 : -1;
    regTab.tabIndex = !isLogin ? 0 : -1;

    loginPanel.classList.toggle("is-hidden", !isLogin);
    regPanel.classList.toggle("is-hidden", isLogin);

    try{ localStorage.setItem(KEY, which); }catch(e){}
    setSticky(which);
  }

  function onKey(e, idx){
    const k = e.key;
    if(k !== "ArrowLeft" && k !== "ArrowRight" && k !== "Home" && k !== "End" && k !== "Enter" && k !== " ") return;
    e.preventDefault();

    let next = idx;
    if(k === "ArrowLeft") next = (idx + tabs.length - 1) % tabs.length;
    if(k === "ArrowRight") next = (idx + 1) % tabs.length;
    if(k === "Home") next = 0;
    if(k === "End") next = tabs.length - 1;

    tabs[next].focus();

    if(k === "Enter" || k === " ") {
      setTab(next === 0 ? "login" : "register");
    }
  }

  loginTab.addEventListener("click", ()=> setTab("login"));
  regTab.addEventListener("click", ()=> setTab("register"));
  loginTab.addEventListener("keydown", (e)=> onKey(e, 0));
  regTab.addEventListener("keydown", (e)=> onKey(e, 1));

  window.addEventListener("resize", () => {
    try{
      const saved = localStorage.getItem(KEY) || "login";
      setSticky(saved);
    }catch(e){}
  });

  let saved = "login";
  try{ saved = localStorage.getItem(KEY) || "login"; }catch(e){}
  if(saved !== "login" && saved !== "register") saved = "login";
  setTab(saved);
})();
</script>
{% endblock %}
