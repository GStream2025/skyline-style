<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  {% set _req = (request if request is defined and request else none) %}
  {% set _args = (_req.args if _req and _req.args else {}) %}
  {% set _path = (_req.path if _req and _req.path else '/') %}
  {% set _env  = (ENV if ENV is defined and ENV else 'production')|lower|trim %}
  {% set _app  = (APP_NAME if APP_NAME is defined and APP_NAME else 'Skyline Store')|string %}
  {% set _title = (meta_title if meta_title is defined and meta_title else _app)|string %}
  {% set _desc  = (meta_description if meta_description is defined and meta_description else 'Marketplace premium de tecnologÃ­a y streetwear.')|string %}
  {% set _cssv = (BASE_CSS_VER if BASE_CSS_VER is defined else (ASSET_VER if ASSET_VER is defined else '1'))|string %}
  {% set _nonce = (csp_nonce if csp_nonce is defined and csp_nonce else (nonce if nonce is defined else '')) %}
  {% set _vf = (current_app.view_functions if current_app is defined and current_app else {}) %}

  {% set _csrf = '' %}
  {% if csrf_token is defined %}
    {% set _csrf = (csrf_token() if csrf_token is callable else (csrf_token|string)) %}
  {% elif csrf_token_value is defined and csrf_token_value %}
    {% set _csrf = csrf_token_value %}
  {% elif session is defined and session.get is defined %}
    {% set _csrf = (session.get('csrf_token') or '') %}
  {% endif %}

  {% macro safe_url(ep, fb='/') -%}
    {%- if url_for is defined and ep and ep in _vf -%}
      {{- url_for(ep) -}}
    {%- else -%}
      {{- fb -}}
    {%- endif -%}
  {%- endmacro %}

  {% macro safe_static(f) -%}
    {%- if url_for is defined -%}
      {{- url_for('static', filename=f) ~ '?v=' ~ _cssv -}}
    {%- else -%}
      {{- '/static/' ~ f -}}
    {%- endif -%}
  {%- endmacro %}

  {% set _canonical = 'https://skyline-style.onrender.com' %}
  {% if _req and _req.url_root %}
    {% set _canonical = (_req.url_root.rstrip('/') ~ _path) %}
  {% endif %}

  {% set _og = (og_image if og_image is defined and og_image else safe_static('img/og/og-home.png')) %}
  {% set _q = (_args.get('q','') if _args else '')|string %}
  {% if _q|length > 80 %}{% set _q = _q[:80] %}{% endif %}

  <title>{% block title %}{{ _title|e }}{% endblock %}</title>
  <meta name="description" content="{{ _desc|e }}">
  <meta name="robots" content="{{ 'index,follow' if _env == 'production' else 'noindex,nofollow' }}">
  <link rel="canonical" href="{{ _canonical|e }}">

  <meta property="og:type" content="website">
  <meta property="og:site_name" content="{{ _app|e }}">
  <meta property="og:title" content="{{ _title|e }}">
  <meta property="og:description" content="{{ _desc|e }}">
  <meta property="og:url" content="{{ _canonical|e }}">
  {% if _og %}<meta property="og:image" content="{{ _og|e }}">{% endif %}

  <meta name="twitter:card" content="summary_large_image">
  <meta name="theme-color" content="#2563eb">
  <meta name="color-scheme" content="light dark">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="csrf-token" content="{{ (_csrf|string)|e }}">

  <link rel="icon" href="{{ safe_static('img/favicon.png') }}" type="image/png">
  <link rel="preload" as="font" href="{{ safe_static('fonts/inter-var.woff2') }}" type="font/woff2" crossorigin>

  {% set _base_css = safe_static('css/skyline-pro.css') %}
  <link rel="preload" as="style" href="{{ _base_css|e }}">
  <link rel="stylesheet" href="{{ _base_css|e }}">

  {% block extra_head %}{% endblock %}
</head>

<body>
<a href="#main" class="skip">Saltar al contenido</a>

{% set home = safe_url('main.home','/') %}
{% set shop = safe_url('shop.shop','/shop') %}
{% set cart = safe_url('cart.cart_view','/cart') %}
{% set account_panel = safe_url('auth.account','/auth/account') %}
{% set login_url = safe_url('auth.login_get', account_panel ~ '?tab=login') %}
{% set register_url = safe_url('auth.register_get', account_panel ~ '?tab=register') %}

{% set user_ok = false %}
{% if current_user is defined and current_user and current_user.is_authenticated is defined %}
  {% set user_ok = (current_user.is_authenticated == true) %}
{% elif is_authenticated is defined %}
  {% set user_ok = (is_authenticated == true) %}
{% endif %}

<header class="topbar" role="banner">
  <div class="topbar-inner">
    <a href="{{ home|e }}" class="brand" aria-label="Inicio">
      <span class="brand-dot" aria-hidden="true"></span>
      <span class="brand-txt">
        <span class="brand-name">{{ _app|e }}</span>
        <span class="brand-sub">Tech + Streetwear premium</span>
      </span>
    </a>

    <nav class="nav" aria-label="NavegaciÃ³n principal">
      <a href="{{ home|e }}" {% if _path == '/' %}aria-current="page"{% endif %}>Inicio</a>
      <a href="{{ shop|e }}" {% if (_path|string).startswith('/shop') %}aria-current="page"{% endif %}>Tienda</a>
      <a href="{{ (shop ~ ('&' if '?' in shop else '?') ~ 'ofertas=1')|e }}" {% if _args and _args.get('ofertas') %}aria-current="page"{% endif %}>Ofertas</a>
    </nav>

    <form class="search" action="{{ shop|e }}" method="get" role="search" autocomplete="off">
      <label class="sr-only" for="q">Buscar productos</label>
      <input id="q" type="search" name="q" placeholder="Buscar productosâ€¦" value="{{ _q|e }}" inputmode="search" maxlength="80">
      <button class="btn primary" type="submit">Buscar</button>
    </form>

    <div class="topbar-actions">
      <a href="{{ cart|e }}" class="icon-btn" aria-label="Carrito">
        ğŸ›’ <span class="cart-badge" data-cart-badge hidden>0</span>
      </a>

      {% if user_ok %}
        <a href="{{ account_panel|e }}" class="account-link" aria-label="Mi cuenta">
          ğŸ‘¤ <span class="txt"><strong>Mi cuenta</strong><small>Panel</small></span>
        </a>
      {% else %}
        <div class="account-cta" role="group" aria-label="Acceso a cuenta">
          <a href="{{ login_url|e }}" class="btn ghost" aria-label="Entrar">Entrar</a>
          <a href="{{ register_url|e }}" class="btn primary" aria-label="Crear cuenta">Crear</a>
        </div>
      {% endif %}
    </div>
  </div>
</header>

<main id="main" class="container" role="main" tabindex="-1">
  {% block content %}{% endblock %}
</main>

<footer class="footer" role="contentinfo">
  <div class="container grid-4">
    <div>
      <strong>{{ _app|e }}</strong>
      <p class="small">Marketplace premium de tecnologÃ­a y streetwear.</p>
    </div>
    <div>
      <strong>Explorar</strong><br>
      <a href="{{ shop|e }}">Tienda</a><br>
      <a href="{{ (shop ~ ('&' if '?' in shop else '?') ~ 'ofertas=1')|e }}">Ofertas</a>
    </div>
    <div>
      <strong>Cuenta</strong><br>
      <a href="{{ login_url|e }}">Ingresar</a><br>
      <a href="{{ register_url|e }}">Crear cuenta</a>
    </div>
    <div>
      <strong>Legal</strong><br>
      <a href="{{ safe_url('main.terms','/terms')|e }}">TÃ©rminos</a><br>
      <a href="{{ safe_url('main.privacy','/privacy')|e }}">Privacidad</a>
    </div>
  </div>
  <p class="small container">Â© {{ now_year|default(2026)|e }} {{ _app|e }}</p>
</footer>

<script{% if _nonce %} nonce="{{ _nonce|e }}"{% endif %}>
(() => {
  const meta = document.querySelector('meta[name="csrf-token"]');
  const token = meta && meta.content ? String(meta.content) : '';
  const badge = document.querySelector('[data-cart-badge]');
  const clampInt = (n, min, max) => {
    const v = Number.isFinite(+n) ? Math.trunc(+n) : 0;
    return Math.max(min, Math.min(max, v));
  };

  window.Skyline = window.Skyline || {};
  window.Skyline.setCartBadge = (n = 0) => {
    if (!badge) return;
    const num = clampInt(n, 0, 999);
    badge.textContent = String(num);
    if (num > 0) badge.removeAttribute('hidden');
    else badge.setAttribute('hidden', '');
  };

  const origFetch = window.fetch;
  if (origFetch && token) {
    window.fetch = (url, opts = {}) => {
      const o = Object.assign({}, opts);
      const m = String(o.method || 'GET').toUpperCase();
      const h = new Headers(o.headers || {});
      if (!h.has('X-Requested-With')) h.set('X-Requested-With', 'XMLHttpRequest');

      try {
        const u = new URL(String(url), window.location.href);
        const sameOrigin = (u.origin === window.location.origin);
        const unsafeMethod = !['GET', 'HEAD', 'OPTIONS'].includes(m);
        if (sameOrigin && unsafeMethod) {
          if (!h.has('X-CSRFToken')) h.set('X-CSRFToken', token);
          if (!h.has('X-CSRF-Token')) h.set('X-CSRF-Token', token);
          if (!o.credentials) o.credentials = 'same-origin';
        }
      } catch (_) {}

      o.headers = h;
      return origFetch(url, o);
    };
  }

  window.addEventListener('pageshow', () => {
    try { window.Skyline.setCartBadge(window.Skyline.cartCount || 0); } catch (_) {}
  });
})();
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
