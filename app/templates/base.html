<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="color-scheme" content="light" />

  {# =========================
     SEO dinÃ¡mico (desde ctx)
     main_routes ya inyecta meta_title/meta_description/og_image si querÃ©s
  ========================= #}
  <title>{% block title %}{{ meta_title if meta_title else "Skyline Store" }}{% endblock %}</title>
  <meta name="description" content="{{ meta_description if meta_description else 'Skyline Store â€” tienda online con estilo, ofertas y productos premium.' }}" />
  <link rel="canonical" href="{{ request.url }}" />

  <meta property="og:title" content="{{ meta_title if meta_title else 'Skyline Store' }}">
  <meta property="og:description" content="{{ meta_description if meta_description else 'Tienda online moderna tipo marketplace.' }}">
  <meta property="og:image" content="{{ og_image if og_image else url_for('static', filename='img/og.png', _external=True) }}">
  <meta property="og:type" content="website">

  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

  <!-- CSRF global (si existe). No rompe si no existe -->
  <meta name="csrf-token" content="{{ session.get('csrf_token','') }}"/>

  <!-- Preconnect fonts/icons si usÃ¡s -->
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#0b1220;
      --muted: rgba(11,18,32,.68);
      --stroke: rgba(15,23,42,.10);

      --a:#2563eb;
      --b:#06b6d4;
      --c:#f59e0b;

      --shadow1: 0 10px 26px rgba(2,6,23,.08);
      --shadow2: 0 18px 50px rgba(2,6,23,.10);

      --r: 14px;
      --r2: 18px;
      --max: 1220px;

      --ease: cubic-bezier(.2,.9,.2,1);
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background: linear-gradient(180deg,#fff, var(--bg));
    }

    a{color:inherit}
    img{max-width:100%;display:block}
    .container{max-width:var(--max);margin:0 auto;padding:0 18px}

    /* âœ… Mejora #1: A11y Skip link */
    .skip{
      position:absolute; left:-9999px; top:10px;
      background:#fff; border:1px solid var(--stroke);
      padding:10px 12px; border-radius:12px;
      box-shadow: var(--shadow1);
      font-weight:1000;
      z-index:9999;
    }
    .skip:focus{left:10px}

    /* ===== TOPBAR ===== */
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
    }
    .topbar-inner{
      display:flex; align-items:center; gap:14px;
      padding: 12px 0;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      text-decoration:none;
      font-weight:1000;
      letter-spacing:-.3px;
    }
    .brand-mark{
      width:30px; height:20px;
      border-radius:8px;
      background: linear-gradient(90deg, var(--a), var(--b), var(--c));
      box-shadow: 0 8px 18px rgba(2,6,23,.12);
    }
    .brand-name{
      font-weight:1000;
      text-transform:uppercase;
      font-size:1.05rem;
    }
    .brand-name b{color:var(--a)}

    .nav{
      display:none;
      gap:18px;
      margin-left:10px;
    }
    .nav a{
      text-decoration:none;
      font-weight:900;
      color: rgba(11,18,32,.82);
      padding:10px 6px;
      border-radius:10px;
      transition: background .2s var(--ease), transform .2s var(--ease);
    }
    .nav a:hover{
      background: rgba(37,99,235,.08);
      transform: translateY(-1px);
    }

    /* Search */
    .search{
      margin-left:auto;
      display:flex; align-items:center; gap:8px;
      background:#f3f4f6;
      border:1px solid rgba(15,23,42,.08);
      border-radius:999px;
      padding: 8px 10px;
      min-width: min(460px, 42vw);
      transition: box-shadow .2s var(--ease), border-color .2s var(--ease);
    }
    .search:focus-within{
      border-color: rgba(37,99,235,.22);
      box-shadow: 0 0 0 4px rgba(37,99,235,.14);
      background:#fff;
    }
    .search input{
      border:0; outline:0; background:transparent;
      width:100%;
      font-size: .98rem;
    }
    .search button{
      border:0;
      cursor:pointer;
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      border-radius:999px;
      padding: 8px 10px;
      transition: transform .2s var(--ease);
    }
    .search button:hover{transform: translateY(-1px)}

    .actions{display:flex; align-items:center; gap:10px}

    /* Cart icon button */
    .icon-btn{
      position:relative;
      width:44px;height:44px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      cursor:pointer;
      display:grid; place-items:center;
      text-decoration:none;
      transition: transform .2s var(--ease), box-shadow .2s var(--ease);
    }
    .icon-btn:hover{transform: translateY(-1px); box-shadow: 0 10px 18px rgba(2,6,23,.10)}

    .badge{
      position:absolute;
      top:-6px; right:-6px;
      min-width:20px; height:20px;
      padding:0 6px;
      border-radius:999px;
      background: linear-gradient(90deg, var(--a), var(--b), var(--c));
      color:#fff;
      display:none;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:1000;
      box-shadow: 0 8px 16px rgba(2,6,23,.14);
      border: 2px solid #fff;
    }
    .badge.is-on{display:flex}

    /* Cuenta */
    .account{
      display:flex; align-items:center; gap:8px;
      text-decoration:none;
      font-weight:1000;
      background: rgba(245,158,11,.14);
      border: 1px solid rgba(245,158,11,.25);
      padding: 10px 12px;
      border-radius:999px;
      white-space:nowrap;
      transition: transform .2s var(--ease), box-shadow .2s var(--ease);
    }
    .account:hover{transform: translateY(-1px); box-shadow: 0 10px 18px rgba(2,6,23,.10)}
    .acc-ico{
      width:28px;height:28px;border-radius:999px;
      display:grid;place-items:center;
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
    }

    /* Mobile menu */
    .burger{
      display:inline-flex; align-items:center; justify-content:center;
      width:44px;height:44px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      cursor:pointer;
      transition: transform .2s var(--ease);
    }
    .burger:hover{transform: translateY(-1px)}
    .mobile{
      display:none;
      border-top:1px solid var(--stroke);
      background:#fff;
      padding: 10px 0 14px;
    }
    .mobile a{
      display:block;
      padding: 12px 18px;
      text-decoration:none;
      font-weight:950;
      color: rgba(11,18,32,.85);
    }
    .mobile a:hover{background: rgba(37,99,235,.06)}
    .mobile.is-open{display:block}

    @media (min-width: 980px){
      .nav{display:flex}
      .burger{display:none}
      .mobile{display:none!important}
    }

    /* Flash */
    .flash-wrap{padding: 10px 0}
    .flash{
      background:#fff;
      border:1px solid var(--stroke);
      box-shadow: var(--shadow1);
      border-radius: 12px;
      padding: 10px 12px;
      margin: 10px 0;
      font-weight:900;
    }

    /* Offline banner */
    .offline{
      display:none;
      margin: 10px 0 0;
      background: rgba(245,158,11,.12);
      border: 1px solid rgba(245,158,11,.25);
      color: rgba(11,18,32,.85);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight:950;
      box-shadow: var(--shadow1);
    }
    .offline.is-on{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .offline button{
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-weight:1000;
      cursor:pointer;
    }

    /* Footer */
    footer{
      margin-top: 30px;
      background: linear-gradient(180deg, #ffffff, #f3f6ff);
      border-top:1px solid var(--stroke);
    }
    .footer-top{
      padding: 18px 0 10px;
      display:flex; flex-wrap:wrap; gap:12px;
      align-items:center; justify-content:space-between;
      color: rgba(11,18,32,.78);
      font-weight:900;
    }
    .footer-links{
      display:flex; flex-wrap:wrap; gap:12px;
      align-items:center;
    }
    .footer-links a{
      text-decoration:none;
      color: rgba(11,18,32,.75);
    }
    .footer-links a:hover{text-decoration:underline}
    .payrow{
      padding: 10px 0 18px;
      display:flex; gap:18px; align-items:center; justify-content:center;
      opacity:.9;
      flex-wrap:wrap;
    }
    .pay{
      width:74px; height:36px;
      border-radius:10px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      display:grid; place-items:center;
      font-weight:1000;
      color: rgba(11,18,32,.75);
    }
    .copyright{
      text-align:center;
      padding: 0 0 18px;
      color: rgba(11,18,32,.55);
      font-weight:800;
      font-size:.92rem;
    }

    /* âœ… Mejora #2: Focus visible pro */
    :focus-visible{
      outline:none;
      box-shadow: 0 0 0 4px rgba(37,99,235,.18);
      border-radius: 10px;
    }
    @media (prefers-reduced-motion: reduce){
      *{transition:none!important; scroll-behavior:auto!important}
    }

    /* ===== Toaster ===== */
    .toasts{
      position: fixed;
      right: 14px;
      bottom: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index: 9999;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      width: min(360px, calc(100vw - 28px));
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      box-shadow: var(--shadow2);
      border-radius: 14px;
      padding: 12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      transform: translateY(12px);
      opacity:0;
      transition: transform .25s var(--ease), opacity .25s var(--ease);
    }
    .toast.is-on{transform: translateY(0); opacity:1}
    .toast .dot{
      width:12px;height:12px;border-radius:999px;margin-top:4px;
      background: linear-gradient(90deg, var(--a), var(--b), var(--c));
      flex: 0 0 auto;
    }
    .toast .t-title{font-weight:1000; font-size:.95rem; color: rgba(11,18,32,.90)}
    .toast .t-msg{font-weight:850; font-size:.86rem; color: rgba(11,18,32,.62); margin-top:2px; line-height:1.25}
    .toast .t-close{
      margin-left:auto;
      border:0;
      background:transparent;
      cursor:pointer;
      font-weight:1000;
      opacity:.65;
    }
    .toast .t-close:hover{opacity:1}
  </style>

  {% block extra_head %}{% endblock %}
</head>

<body>
  <a class="skip" href="#main">Saltar al contenido</a>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="container topbar-inner">
      <a class="brand" href="/" aria-label="Ir a inicio">
        <span class="brand-mark" aria-hidden="true"></span>
        <span class="brand-name">SKYLINE <b>STYLE</b></span>
      </a>

      <nav class="nav" aria-label="NavegaciÃ³n principal">
        <a href="/">Inicio</a>
        <a href="/shop?categoria=ropa">Ropa</a>
        <a href="/shop?categoria=accesorios">Accesorios</a>
        <a href="/shop?categoria=tecnologia">TecnologÃ­a</a>
        <a href="/shop?ofertas=1">Ofertas</a>
      </nav>

      <!-- âœ… Mejora #3: mantiene la bÃºsqueda al navegar -->
      <form class="search" action="/shop" method="get" role="search" aria-label="Buscar productos">
        <input name="q" type="search" placeholder="Buscar productos..." autocomplete="off"
               value="{{ request.args.get('q','') }}" />
        <button type="submit" aria-label="Buscar">ðŸ”Ž</button>
      </form>

      <div class="actions">
        <a class="icon-btn" href="/cart" aria-label="Carrito">
          ðŸ›’
          <span class="badge" data-cart-badge>0</span>
        </a>

        <a class="account" href="/account" aria-label="Mi cuenta">
          <span class="acc-ico" aria-hidden="true">ðŸ‘¤</span>
          <span>Mi Cuenta</span>
        </a>

        <button class="burger" type="button" aria-label="Abrir menÃº" aria-expanded="false" id="burger">â˜°</button>
      </div>
    </div>

    <div class="mobile" id="mobileMenu" aria-label="MenÃº mÃ³vil">
      <a href="/">Inicio</a>
      <a href="/shop?categoria=ropa">Ropa</a>
      <a href="/shop?categoria=accesorios">Accesorios</a>
      <a href="/shop?categoria=tecnologia">TecnologÃ­a</a>
      <a href="/shop?ofertas=1">Ofertas</a>
      <a href="/cart">Carrito</a>
      <a href="/account">Mi Cuenta</a>
    </div>

    <div class="container">
      <div class="offline" id="offlineBanner" role="status" aria-live="polite">
        <span>EstÃ¡s sin conexiÃ³n. Algunas acciones pueden fallar.</span>
        <button type="button" id="offlineRetry">Reintentar</button>
      </div>
    </div>
  </header>

  <!-- FLASH -->
  <div class="container flash-wrap">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash" role="status">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <!-- CONTENIDO -->
  <main id="main">
    {% block content %}{% endblock %}
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="container footer-top">
      <div class="footer-links">
        <a href="/terms">TÃ©rminos y Condiciones</a>
        <a href="/privacy">PolÃ­tica de Privacidad</a>
        <a href="/help">Ayuda / Contacto</a>
      </div>

      <div class="footer-links" aria-label="Redes">
        <a href="#" aria-label="Facebook">ðŸ“˜</a>
        <a href="#" aria-label="Instagram">ðŸ“·</a>
        <a href="#" aria-label="WhatsApp">ðŸ’¬</a>
      </div>
    </div>

    <div class="container payrow" aria-label="Medios de pago">
      <div class="pay">MP</div>
      <div class="pay">VISA</div>
      <div class="pay">MC</div>
      <div class="pay">OCA</div>
    </div>

    <div class="copyright">
      Â© <span id="year"></span> Skyline Store. Todos los derechos reservados.
    </div>
  </footer>

  <!-- TOASTER -->
  <div class="toasts" aria-live="polite" aria-label="Notificaciones" id="toasts"></div>

  <script>
    // AÃ±o automÃ¡tico
    (function(){
      const y = document.getElementById('year');
      if(y) y.textContent = String(new Date().getFullYear());
    })();

    // MenÃº mÃ³vil
    (function(){
      const btn = document.getElementById("burger");
      const menu = document.getElementById("mobileMenu");
      if(!btn || !menu) return;
      btn.addEventListener("click", () => {
        const open = menu.classList.toggle("is-open");
        btn.setAttribute("aria-expanded", open ? "true" : "false");
      });
    })();

    // Toast global
    (function(){
      const host = document.getElementById('toasts');
      if(!host) return;

      const toast = (title, message, opts={}) => {
        const t = document.createElement('div');
        t.className = 'toast';
        t.innerHTML = `
          <div class="dot" aria-hidden="true"></div>
          <div class="t-body">
            <div class="t-title">${String(title || 'Listo')}</div>
            ${message ? `<div class="t-msg">${String(message)}</div>` : ``}
          </div>
          <button class="t-close" aria-label="Cerrar">âœ•</button>
        `;
        host.appendChild(t);

        const close = () => {
          t.classList.remove('is-on');
          setTimeout(() => t.remove(), 240);
        };
        t.querySelector('.t-close')?.addEventListener('click', close);

        requestAnimationFrame(() => t.classList.add('is-on'));
        const ms = Math.max(2200, Math.min(6500, parseInt(opts.timeout || 3200, 10)));
        setTimeout(close, ms);
      };

      window.toast = toast;
    })();

    // Offline banner
    (function(){
      const box = document.getElementById('offlineBanner');
      const btn = document.getElementById('offlineRetry');
      if(!box) return;

      const set = () => box.classList.toggle('is-on', !navigator.onLine);
      window.addEventListener('online', set);
      window.addEventListener('offline', set);
      set();

      if(btn){
        btn.addEventListener('click', () => window.location.reload());
      }
    })();

    // Fetch helpers (timeout + retry) + CSRF
    (function(){
      const csrf = (document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '').trim();

      const withTimeout = (ms, promise) => {
        const c = new AbortController();
        const t = setTimeout(() => c.abort(), ms);
        return Promise.race([ promise(c.signal).finally(() => clearTimeout(t)) ]);
      };

      const _req = async (method, url, body, tries=2) => {
        const headers = {'Accept':'application/json'};
        if(method !== 'GET') headers['Content-Type'] = 'application/json';
        if(csrf) headers['X-CSRF-Token'] = csrf;

        let lastErr = null;

        for(let i=0;i<tries;i++){
          try{
            const res = await withTimeout(8000, (signal) => fetch(url, {
              method,
              headers,
              body: (method === 'GET') ? undefined : JSON.stringify(body || {}),
              credentials: 'same-origin',
              signal
            }));

            let data = null;
            try { data = await res.json(); } catch(e) {}

            if(!res.ok){
              const msg = (data && data.error && (data.error.message || data.error)) ? (data.error.message || data.error) : 'OcurriÃ³ un error.';
              throw new Error(msg);
            }
            return data;
          }catch(e){
            lastErr = e;
            const isAbort = (String(e && e.name) === 'AbortError');
            const isNetwork = !navigator.onLine || isAbort || String(e.message || '').toLowerCase().includes('failed');
            if(i < tries-1 && isNetwork){
              await new Promise(r => setTimeout(r, 350 + i*350));
              continue;
            }
            throw e;
          }
        }
        throw lastErr || new Error('Error');
      };

      window.apiGet  = (url) => _req('GET', url, null, 2);
      window.apiPost = (url, body) => _req('POST', url, body, 2);
    })();

    // âœ… Mejora #4: CartStore (cache + sync pestaÃ±as)
    (function(){
      const KEY = 'skyline:cart:snap:v1';
      const badge = document.querySelector('[data-cart-badge]');
      const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('skyline_cart') : null;

      const read = () => {
        try { return JSON.parse(localStorage.getItem(KEY) || 'null'); } catch(e){ return null; }
      };
      const write = (snap) => {
        try { localStorage.setItem(KEY, JSON.stringify(snap)); } catch(e){}
        if(bc) bc.postMessage({type:'cart', snap});
        window.dispatchEvent(new CustomEvent('cart:updated', {detail:{snap}}));
      };

      const setBadge = (snap) => {
        if(!badge) return;
        const count = snap && typeof snap.items_count === 'number' ? snap.items_count : 0;
        badge.textContent = String(count);
        badge.classList.toggle('is-on', count > 0);
      };

      setBadge(read());

      if(bc){
        bc.onmessage = (ev) => {
          if(ev && ev.data && ev.data.type === 'cart'){
            setBadge(ev.data.snap);
            try { localStorage.setItem(KEY, JSON.stringify(ev.data.snap)); } catch(e){}
          }
        };
      }

      window.CartStore = {
        async refresh(){
          try{
            const d = await window.apiGet('/cart/json');
            const snap = d && d.cart ? d.cart : null;
            if(snap) write(snap);
            setBadge(snap);
            return snap;
          }catch(e){
            return read();
          }
        },
        update(snap){
          write(snap);
          setBadge(snap);
        },
        get(){ return read(); }
      };

      setTimeout(() => { window.CartStore.refresh(); }, 120);
    })();
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
