{# ======================================================================
   app/templates/base.html â€” Skyline Store (ULTRA PRO ENTERPRISE Â· v5.7 FINAL)
   Replica EXACTA header premium (barra Ãºnica)
   âœ… NO 500 / FAIL-SAFE / FUTURE-PROOF
   âœ… Header 1-line marketplace (igual a imagen)
   âœ… A11y + SEO + perf + CSP + CSRF
   âœ… Mobile limpio (sin bloques feos)
====================================================================== #}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  {# ---------- SAFE REQUEST ---------- #}
  {% set _req = request if request is defined and request else none %}
  {% set _path = (_req.path if _req and _req.path else '') %}
  {% set _args = (_req.args if _req and _req.args else {}) %}
  {% set _base_url = (_req.base_url if _req and _req.base_url else '/') %}

  {# ---------- SAFE ENDPOINT ---------- #}
  {% set _has_ep = has_endpoint if has_endpoint is defined and has_endpoint else none %}

  {% macro safe_url(endpoint, fallback='/') -%}
    {%- if _has_ep and endpoint and _has_ep(endpoint) -%}
      {{ url_for(endpoint) }}
    {%- else -%}
      {{ fallback }}
    {%- endif -%}
  {%- endmacro %}

  {% macro safe_static(filename) -%}
    {{ url_for('static', filename=filename) if url_for is defined else '' }}
  {%- endmacro %}

  {# ---------- SEO ---------- #}
  {% set _title = (meta_title or APP_NAME or "Skyline Store") %}
  {% set _desc  = (meta_description or "Marketplace premium de tecnologÃ­a y streetwear.") %}

  <title>{% block title %}{{ _title }}{% endblock %}</title>
  <meta name="description" content="{{ _desc|e }}">
  <link rel="canonical" href="{{ _base_url }}">

  <meta property="og:title" content="{{ _title|e }}">
  <meta property="og:description" content="{{ _desc|e }}">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="es_UY">

  <meta name="theme-color" content="#2563eb">
  <meta name="color-scheme" content="light dark">

  {# ---------- CSRF ---------- #}
  {% set _csrf = '' %}
  {% if csrf_token_value is defined and csrf_token_value %}
    {% set _csrf = csrf_token_value %}
  {% elif csrf_token is defined %}
    {% set _csrf = csrf_token() %}
  {% endif %}
  <meta name="csrf-token" content="{{ _csrf|e }}">

  {# ---------- FONTS ---------- #}
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  {# ---------- CSS GLOBAL ---------- #}
  <link rel="stylesheet" href="{{ safe_static('css/skyline-pro.css') }}?v=5.7">

  {% block extra_head %}{% endblock %}
</head>

<body>

<a href="#main" class="skip sr-only">Saltar al contenido</a>

{# ---------- URLS ---------- #}
{% set home = safe_url('main.home', '/') %}
{% set shop = safe_url('shop.shop', '/shop') %}
{% set cart = safe_url('cart.cart_view', '/cart') %}
{% set account = safe_url('main.account', '/account') %}
{% set login = account ~ '?tab=login' %}
{% set register = account ~ '?tab=register' %}

{% set user_ok = current_user is defined and current_user.is_authenticated is defined and current_user.is_authenticated %}

<!-- =======================
     HEADER â€” BARRA PREMIUM
======================= -->
<header class="topbar" role="banner">
  <div class="topbar-inner">

    <!-- Brand -->
    <a href="{{ home }}" class="brand" aria-label="Inicio">
      <span class="brand-dot"></span>
      <div class="brand-txt">
        <span class="brand-name">{{ APP_NAME or "Skyline Store" }}</span>
        <span class="brand-sub">Tech + Streetwear premium</span>
      </div>
    </a>

    <!-- Nav -->
    <nav class="nav" aria-label="NavegaciÃ³n principal">
      <a href="{{ home }}" class="{% if _path == '/' %}active{% endif %}">Inicio</a>
      <a href="{{ shop }}" class="{% if _path.startswith('/shop') and not _args.get('ofertas') %}active{% endif %}">Tienda</a>
      <a href="{{ shop }}?ofertas=1" class="{% if _args.get('ofertas') %}active{% endif %}">Ofertas</a>
    </nav>

    <!-- Search -->
    <form class="search" action="{{ shop }}" method="get" role="search">
      <span aria-hidden="true">âŒ•</span>
      <input type="search" name="q"
             placeholder="Buscar productos..."
             value="{{ _args.get('q','')|e }}">
      <button type="submit" class="btn primary">Buscar</button>
    </form>

    <!-- Actions -->
    <div class="topbar-actions">

      <a href="{{ cart }}" aria-label="Carrito" class="icon-btn">
        ðŸ›’
        <span class="cart-badge" data-cart-badge hidden>0</span>
      </a>

      <a href="{{ account if user_ok else login }}" class="account-link">
        <span class="icon">ðŸ‘¤</span>
        <span class="txt">
          <strong>Mi cuenta</strong>
          <small>{% if user_ok %}Panel{% else %}Entrar / Crear{% endif %}</small>
        </span>
      </a>

    </div>
  </div>
</header>

<!-- =======================
     MAIN
======================= -->
<main id="main" class="container">
  {% block content %}{% endblock %}
</main>

<!-- =======================
     FOOTER
======================= -->
<footer class="footer">
  <div class="container grid grid-4">
    <div>
      <strong>{{ APP_NAME or "Skyline Store" }}</strong>
      <p class="small">Marketplace premium de tecnologÃ­a y streetwear.</p>
    </div>
    <div>
      <strong>Explorar</strong><br>
      <a href="{{ shop }}">Tienda</a><br>
      <a href="{{ shop }}?ofertas=1">Ofertas</a>
    </div>
    <div>
      <strong>Cuenta</strong><br>
      <a href="{{ login }}">Ingresar</a><br>
      <a href="{{ register }}">Crear cuenta</a>
    </div>
    <div>
      <strong>Legal</strong><br>
      <a href="{{ safe_url('main.terms','/terms') }}">TÃ©rminos</a><br>
      <a href="{{ safe_url('main.privacy','/privacy') }}">Privacidad</a>
    </div>
  </div>
  <p class="small container">Â© {{ current_year or 2026 }} {{ APP_NAME or "Skyline Store" }}</p>
</footer>

<!-- =======================
     JS BASE (seguro)
======================= -->
<script>
(() => {
  const token = document.querySelector('meta[name="csrf-token"]')?.content;
  if (!token) return;

  const _fetch = window.fetch;
  window.fetch = (url, opts = {}) => {
    opts.headers = opts.headers || {};
    if (!opts.headers['X-CSRFToken']) {
      opts.headers['X-CSRFToken'] = token;
    }
    return _fetch(url, opts);
  };
})();
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
