{# ============================================================================
   Skyline Store ‚Äî SHOP (ULTRA PRO v8 SERVER-SIDE)
   ‚úî Server-side: q/categoria/sort/page
   ‚úî Paginaci√≥n robusta + conserva params
   ‚úî UI premium + A11y + dark + reduced motion
============================================================================ #}

{% extends "base.html" %}
{% block title %}Tienda | {{ (APP_NAME or "Skyline Store")|e }}{% endblock %}

{% block extra_head %}
<meta name="description" content="{{ meta_description | default('Explor√° tecnolog√≠a y streetwear premium en Skyline Store.', true) }}">
<link rel="canonical" href="{{ request.url|e }}">
<meta property="og:title" content="Tienda | Skyline Store">
<meta property="og:description" content="{{ meta_description | default('Explor√° tecnolog√≠a y streetwear premium en Skyline Store.', true) }}">
<meta property="og:type" content="website">

<style>
/* ===== ULTRA SHOP UI (scoped) ===== */
.shop-page{
  --bg0:#fff;--bg1:#f7f8fb;
  --ink:#0b1220;--muted:rgba(11,18,32,.68);
  --a:#2563eb;--b:#06b6d4;--c:#f59e0b;
  --stroke:rgba(15,23,42,.10);--stroke2:rgba(15,23,42,.07);
  --sh1:0 10px 24px rgba(2,6,23,.08);
  --sh2:0 30px 90px rgba(2,6,23,.12);
  --ring:0 0 0 4px rgba(37,99,235,.18);
  --r-xl:1.45rem;--r-2xl:1.85rem;--grid:1220px;
  color-scheme:light dark;
}
@media (prefers-color-scheme: dark){
  .shop-page{
    --bg0:#070b14;--bg1:#0b1020;
    --ink:#eef2ff;--muted:rgba(238,242,255,.65);
    --stroke:rgba(148,163,184,.18);--stroke2:rgba(148,163,184,.12);
    --sh1:0 10px 24px rgba(0,0,0,.35);
    --sh2:0 40px 110px rgba(0,0,0,.55);
  }
}
.shop-page{
  min-height:calc(100vh - 60px);
  background:
    radial-gradient(circle at 0% 0%, rgba(37,99,235,.12), transparent 40%),
    radial-gradient(circle at 100% 0%, rgba(6,182,212,.10), transparent 42%),
    linear-gradient(180deg,var(--bg0),var(--bg1));
}
.shop-wrap{ max-width:var(--grid); margin:0 auto; padding:clamp(2rem,5vw,3.2rem) 1rem 5rem; }
.shop-page a{ color:inherit; text-decoration:none; }
.shop-page :focus-visible{ outline:none; box-shadow:var(--ring); }

.shop-header{
  border-radius:calc(var(--r-2xl) + .4rem);
  padding:1.4rem;
  background:rgba(255,255,255,.70);
  border:1px solid var(--stroke);
  box-shadow:var(--sh2);
}
@media (prefers-color-scheme: dark){ .shop-header{ background:rgba(10,14,30,.70); } }

.shop-kicker{
  display:inline-flex;align-items:center;gap:.5rem;
  padding:.45rem 1rem;border-radius:999px;
  background:rgba(37,99,235,.12);
  font-size:.75rem;font-weight:900;letter-spacing:.12em;
}
.shop-kicker .dot{ width:8px;height:8px;border-radius:50%; background:linear-gradient(135deg,var(--a),var(--b)); }
.shop-h1{ margin:.85rem 0 0; font-size:clamp(2.1rem,4.2vw,3.2rem); font-weight:1000; line-height:1.02; color:var(--ink); }
.shop-h1 span{ background:linear-gradient(135deg,var(--a),var(--b)); -webkit-background-clip:text;background-clip:text;color:transparent; }
.shop-sub{ margin:.6rem 0 0; max-width:65ch; color:var(--muted); }

.controls{
  margin-top:1.1rem;
  padding:1rem;border-radius:var(--r-xl);
  background:rgba(255,255,255,.72);
  border:1px solid var(--stroke2);
  display:grid;gap:.8rem;
}
@media (prefers-color-scheme: dark){ .controls{ background:rgba(10,14,30,.70); } }
.searchRow{ display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
.shop-search{
  flex:1; min-width:240px;
  display:flex; gap:.6rem; align-items:center;
  padding:.78rem 1rem;border-radius:999px;
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.85);
}
@media (prefers-color-scheme: dark){ .shop-search{ background:rgba(255,255,255,.06); } }
.shop-search input{ border:0;outline:none;width:100%;background:transparent;font-weight:900;color:var(--ink); }
.shop-select,.shop-reset{
  padding:.78rem 1rem;border-radius:999px;border:1px solid var(--stroke);
  font-weight:900;background:rgba(255,255,255,.85); color:var(--ink);
}
@media (prefers-color-scheme: dark){ .shop-select,.shop-reset{ background:rgba(255,255,255,.06); } }
.shop-reset{ cursor:pointer; }
.shop-reset:hover{ border-color:rgba(37,99,235,.25); background:rgba(37,99,235,.10); }

.filters-scroll{ display:flex; gap:.5rem; overflow-x:auto; padding:.25rem 0; }
.pill{
  padding:.55rem 1rem;border-radius:999px;
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.78);
  font-size:.78rem;font-weight:900;cursor:pointer;white-space:nowrap;
}
@media (prefers-color-scheme: dark){ .pill{ background:rgba(255,255,255,.06); } }
.pill.is-on{
  background:linear-gradient(135deg,var(--a),var(--b));
  border-color:transparent;color:#fff;
}

.sectionTop{
  margin-top:1.25rem;
  display:flex; align-items:baseline; justify-content:space-between; gap:1rem;
}
.sectionTop h2{ margin:0; color:var(--ink); font-weight:1000; }
.sectionTop .meta{ color:var(--muted); font-weight:900; }

.shop-grid{ margin-top:1.1rem; display:grid; gap:1.2rem; }
@media(min-width:640px){ .shop-grid{ grid-template-columns:repeat(2,1fr);} }
@media(min-width:980px){ .shop-grid{ grid-template-columns:repeat(3,1fr);} }
@media(min-width:1260px){ .shop-grid{ grid-template-columns:repeat(4,1fr);} }

.shop-card{
  border-radius:var(--r-xl);
  border:1px solid var(--stroke2);
  background:rgba(255,255,255,.92);
  box-shadow:var(--sh1);
  overflow:hidden;
  transition:transform .25s ease, box-shadow .25s ease;
}
@media (prefers-color-scheme: dark){ .shop-card{ background:rgba(12,16,34,.90); } }
.shop-card:hover{ transform:translateY(-8px); box-shadow:var(--sh2); }

.media{ aspect-ratio:1/1; background:#f1f5f9; position:relative; }
.media img{ width:100%;height:100%;object-fit:cover; display:block; }
.badge{
  position:absolute; top:.7rem; right:.7rem;
  padding:.35rem .6rem;border-radius:999px;
  font-size:.7rem;font-weight:900;
  background:linear-gradient(135deg,#f97316,#ef4444); color:#fff;
}

.body{ padding:1rem; display:grid; gap:.35rem; }
.cat{ font-size:.65rem; letter-spacing:.12em; font-weight:900; color:var(--muted); text-transform:uppercase; }
.name{ font-weight:1000; font-size:1rem; line-height:1.25; color:var(--ink); }
.price{ font-weight:1000; color:var(--a); }

.empty{
  margin-top:1.8rem;
  padding:1.4rem;border-radius:var(--r-xl);
  border:1px solid var(--stroke2);
  background:rgba(255,255,255,.70);
  color:var(--muted);
}
@media (prefers-color-scheme: dark){ .empty{ background:rgba(12,16,34,.70); } }

.pager{
  margin-top:1.6rem;
  display:flex;justify-content:center;gap:.5rem;flex-wrap:wrap;
}
.pager a, .pager span{
  padding:.6rem .95rem;border-radius:999px;
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.78);
  font-weight:900;
}
@media (prefers-color-scheme: dark){ .pager a, .pager span{ background:rgba(255,255,255,.06); } }
.pager .on{
  background:linear-gradient(135deg,var(--a),var(--b));
  color:#fff;border-color:transparent;
}
@media (prefers-reduced-motion: reduce){
  .shop-page *{ transition:none!important; }
}
</style>
{% endblock %}

{% block content %}
{% set items = products if products is defined and products else [] %}
{% set total = total_count|default(items|length) %}
{% set page = page|default(1) %}
{% set pages = pages|default(1) %}
{% set qv = q|default(request.args.get('q','')) %}
{% set catv = categoria|default(request.args.get('categoria','')) %}
{% set sortv = sort|default(request.args.get('sort','')) %}

<section class="shop-page">
  <div class="shop-wrap">

    <header class="shop-header">
      <div class="shop-kicker"><span class="dot"></span> MARKETPLACE</div>
      <h1 class="shop-h1">Tienda <span>Skyline</span></h1>
      <p class="shop-sub">Busc√°, filtr√° y orden√° con experiencia marketplace real (server-side).</p>

      <div class="controls">
        <div class="searchRow">
          <form id="shopForm" class="shop-search" action="{{ url_for('shop.shop') }}" method="get" role="search" aria-label="Buscar productos">
            üîé
            <input id="q" name="q" type="search" value="{{ qv|e }}" placeholder="Buscar‚Ä¶ ej: hoodie, auriculares, smartwatch">
            {% if catv %}<input type="hidden" name="categoria" value="{{ catv|e }}">{% endif %}
            {% if sortv %}<input type="hidden" name="sort" value="{{ sortv|e }}">{% endif %}
          </form>

          <select id="sort" class="shop-select" aria-label="Ordenar">
            <option value="" {{ 'selected' if sortv=='' else '' }}>Ordenar</option>
            <option value="new" {{ 'selected' if sortv=='new' else '' }}>Novedades</option>
            <option value="price_asc" {{ 'selected' if sortv=='price_asc' else '' }}>Precio ‚Üë</option>
            <option value="price_desc" {{ 'selected' if sortv=='price_desc' else '' }}>Precio ‚Üì</option>
          </select>

          <button id="resetBtn" class="shop-reset" type="button">‚Ü∫ Reset</button>
        </div>

        <div class="filters-scroll" id="filters" aria-label="Filtros r√°pidos">
          <a class="pill {{ 'is-on' if not catv else '' }}"
             href="{{ url_for('shop.shop', q=qv, sort=sortv) }}">Todo</a>

          {% for c in categories|default([]) %}
            {% set slug = (c.slug if c.slug is defined else c['slug'] if c is mapping and c.get('slug') else c)|string %}
            {% set name = (c.name if c.name is defined else c['name'] if c is mapping and c.get('name') else slug)|string %}
            <a class="pill {{ 'is-on' if catv==slug else '' }}"
               href="{{ url_for('shop.shop', q=qv, sort=sortv, categoria=slug) }}">{{ name|e }}</a>
          {% endfor %}
        </div>
      </div>
    </header>

    <div class="sectionTop">
      <h2>Productos</h2>
      <div class="meta">{{ total }} resultado(s) ¬∑ P√°gina {{ page }}/{{ pages }}</div>
    </div>

    <div class="shop-grid">
      {% for p in items %}
        {% set title = (p.title if p.title is defined else (p.name if p.name is defined else 'Producto'))|string %}
        {% set img = (p.img if p.img is defined else (p.image if p.image is defined else ''))|string %}
        {% set cat = (p.category_slug if p.category_slug is defined else (p.category if p.category is defined else ''))|string %}
        {% set price = (p.price_display if p.price_display is defined else (p.price if p.price is defined else ''))|string %}
        {% set href = (p.href if p.href is defined and p.href else '')|string %}
        {% if not href and (p.slug is defined and p.slug) %}{% set href = '/product/' ~ (p.slug|string) %}{% endif %}
        {% if not href %}{% set href = url_for('shop.shop') %}{% endif %}

        <a class="shop-card" href="{{ href|e }}" aria-label="{{ title|e }}">
          <div class="media">
            {% if img %}
              <img src="{{ img|e }}" alt="{{ title|e }}" loading="lazy" decoding="async">
            {% endif %}
            {% if p.is_offer is defined and p.is_offer %}
              <span class="badge">OFERTA</span>
            {% endif %}
          </div>
          <div class="body">
            {% if cat %}<div class="cat">{{ cat|e }}</div>{% endif %}
            <div class="name">{{ title|e }}</div>
            <div class="price">{{ price|e }}</div>
          </div>
        </a>
      {% endfor %}
    </div>

    {% if items|length == 0 %}
      <div class="empty">
        <strong>No hay productos para mostrar.</strong><br>
        Prob√° otra b√∫squeda o carg√° productos desde Admin.
      </div>
    {% endif %}

    {% if pages|int > 1 %}
      <nav class="pager" aria-label="Paginaci√≥n">
        {% set prev = page|int - 1 %}
        {% set nxt = page|int + 1 %}

        {% if prev >= 1 %}
          <a href="{{ url_for('shop.shop', q=qv, sort=sortv, categoria=catv, page=prev) }}">‚Üê Anterior</a>
        {% endif %}

        {# ventana de p√°ginas (fail-safe) #}
        {% set start = (page|int - 2) %}
        {% set end = (page|int + 2) %}
        {% if start < 1 %}{% set start = 1 %}{% endif %}
        {% if end > pages %}{% set end = pages %}{% endif %}

        {% for n in range(start, end + 1) %}
          {% if n == page|int %}
            <span class="on">{{ n }}</span>
          {% else %}
            <a href="{{ url_for('shop.shop', q=qv, sort=sortv, categoria=catv, page=n) }}">{{ n }}</a>
          {% endif %}
        {% endfor %}

        {% if nxt <= pages|int %}
          <a href="{{ url_for('shop.shop', q=qv, sort=sortv, categoria=catv, page=nxt) }}">Siguiente ‚Üí</a>
        {% endif %}
      </nav>
    {% endif %}

  </div>
</section>

<script>
(() => {
  const sort = document.getElementById('sort');
  const reset = document.getElementById('resetBtn');

  if (sort) {
    sort.addEventListener('change', () => {
      const u = new URL(window.location.href);
      const v = (sort.value || '').trim();
      if (v) u.searchParams.set('sort', v);
      else u.searchParams.delete('sort');
      u.searchParams.delete('page'); // reset page al ordenar
      window.location.href = u.toString();
    });
  }

  if (reset) {
    reset.addEventListener('click', () => {
      const u = new URL(window.location.href);
      u.search = '';
      window.location.href = u.toString();
    });
  }
})();
</script>
{% endblock %}
