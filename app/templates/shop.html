{# templates/shop.html — Skyline Store · SHOP ULTRA PRO (Light Elegant Commerce) #}
{% extends "base.html" %}
{% block title %}Tienda · Skyline Style{% endblock %}

{% block extra_head %}
<style>
/* ==========================================================
   SKYLINE STYLE · SHOP — ULTRA PRO (LIGHT · ELEGANT)
   - conversión + performance + accesibilidad
   - filtros funcionales + robustos
========================================================== */

:root{
  --bg:#ffffff;
  --panel:#f8fafc;
  --panel-2:#f1f5f9;
  --border:rgba(15,23,42,.10);
  --text:#0f172a;
  --muted:#64748b;

  --brand:#2563eb;
  --brand2:#06b6d4;
  --brand-soft:rgba(37,99,235,.10);

  --accent:#f59e0b;
  --accent-soft:rgba(245,158,11,.14);

  --ok:#22c55e;
  --shadow-sm:0 10px 24px rgba(2,6,23,.08);
  --shadow-md:0 24px 70px rgba(2,6,23,.14);

  --r-xl: 1.35rem;
  --r-lg: 1.05rem;

  --ring: 0 0 0 3px rgba(37,99,235,.22);
  --grid: 1200px;
}

.shop-wrap{
  max-width: var(--grid);
  margin: 0 auto;
  padding: clamp(2.6rem, 5vw, 4rem) 1rem clamp(4rem, 7vw, 6rem);
}
@media(min-width:768px){
  .shop-wrap{ padding-left: 1.25rem; padding-right: 1.25rem; }
}

/* ---------- Header ---------- */
.shop-header{
  display:grid;
  gap:.65rem;
  margin-bottom: 1.75rem;
}
.kicker{
  display:inline-flex;
  align-items:center;
  gap:.55rem;
  width:fit-content;
  padding:.4rem .85rem;
  border-radius: 999px;
  border:1px solid rgba(37,99,235,.18);
  background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.72));
  box-shadow: 0 10px 18px rgba(2,6,23,.06);
  font-weight: 900;
  font-size: .72rem;
  letter-spacing:.18em;
  text-transform: uppercase;
  color: rgba(37,99,235,.96);
}
.kicker::before{
  content:"";
  width:10px;height:10px;border-radius:999px;
  background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb);
  box-shadow: 0 0 0 4px rgba(37,99,235,.12);
}

.shop-title{
  font-size: clamp(2rem, 3.6vw, 2.7rem);
  font-weight: 950;
  letter-spacing: -.6px;
  line-height:1.05;
  color: var(--text);
}
.shop-sub{
  max-width: 52rem;
  color: rgba(15,23,42,.70);
  line-height: 1.75;
  font-size: 1.02rem;
}

/* ---------- Controls row ---------- */
.controls{
  margin-top: 1rem;
  display:flex;
  flex-wrap:wrap;
  gap:.75rem;
  align-items:center;
  justify-content:space-between;
}
.filters-wrap{
  display:flex;
  gap:.55rem;
  flex-wrap:wrap;
  align-items:center;
}
.filters-scroll{
  display:flex;
  gap:.55rem;
  overflow-x:auto;
  padding: .25rem .1rem .35rem;
  -webkit-overflow-scrolling: touch;
  scroll-snap-type: x mandatory;
}
.filters-scroll::-webkit-scrollbar{ height: 10px; }
.filters-scroll::-webkit-scrollbar-thumb{ background: rgba(15,23,42,.16); border-radius: 999px; }
.filters-scroll::-webkit-scrollbar-track{ background: transparent; }

.pill{
  scroll-snap-align:start;
  border-radius:999px;
  padding:.55rem 1.05rem;
  font-size:.78rem;
  font-weight: 900;
  border:1px solid rgba(15,23,42,.12);
  background: rgba(255,255,255,.86);
  color: rgba(15,23,42,.74);
  cursor:pointer;
  transition: transform .18s ease, background .18s ease, border-color .18s ease, color .18s ease, box-shadow .18s ease;
  white-space:nowrap;
  user-select:none;
}
.pill:hover{
  border-color: rgba(37,99,235,.28);
  background: rgba(37,99,235,.08);
  color: rgba(37,99,235,.96);
  transform: translateY(-1px);
}
.pill:focus-visible{ outline:none; box-shadow: var(--ring), var(--shadow-sm); }
.pill[aria-pressed="true"]{
  background: linear-gradient(135deg, var(--brand), var(--brand2));
  border-color: transparent;
  color: #fff;
  box-shadow: var(--shadow-sm);
}

.count{
  display:inline-flex;
  align-items:center;
  gap:.5rem;
  padding:.55rem .95rem;
  border-radius: 999px;
  border:1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.75);
  backdrop-filter: blur(10px);
  color: rgba(15,23,42,.72);
  font-weight: 850;
  font-size: .82rem;
}
.count b{ color: rgba(15,23,42,.92); font-weight: 950; }

/* ---------- Sections ---------- */
.shop-section{
  margin-top: 1.8rem;
  margin-bottom: 2.8rem;
}
.section-title{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:1rem;
  margin-bottom: 1.05rem;
}
.section-title h2{
  font-size: 1.18rem;
  font-weight: 950;
  letter-spacing: -.3px;
  color: var(--text);
}
.section-title span{
  font-size:.85rem;
  color: var(--muted);
  font-weight: 800;
}

/* ---------- Grid ---------- */
.shop-grid{
  display:grid;
  gap: 1.05rem;
}
@media(min-width:640px){
  .shop-grid{ grid-template-columns: repeat(2, 1fr); }
}
@media(min-width:1024px){
  .shop-grid{ grid-template-columns: repeat(3, 1fr); gap: 1.25rem; }
}

/* ---------- Card ---------- */
.card{
  position:relative;
  display:flex;
  flex-direction:column;
  border-radius: var(--r-xl);
  border: 1px solid rgba(15,23,42,.10);
  background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.78));
  box-shadow: var(--shadow-sm);
  overflow:hidden;
  text-decoration:none;
  color: inherit;
  transition: transform .22s ease, box-shadow .22s ease, border-color .22s ease;
}
.card:hover{
  transform: translateY(-6px);
  box-shadow: var(--shadow-md);
  border-color: rgba(37,99,235,.18);
}
.card:focus-visible{ outline:none; box-shadow: var(--ring), var(--shadow-md); }

.media{
  position:relative;
  aspect-ratio: 1 / 1;
  background:
    radial-gradient(900px 420px at 20% 20%, rgba(37,99,235,.14), transparent 55%),
    radial-gradient(720px 420px at 85% 20%, rgba(245,158,11,.12), transparent 58%),
    var(--panel);
  overflow:hidden;
}
.media img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  transform: scale(1.001);
  transition: transform .65s ease;
}
.card:hover .media img{ transform: scale(1.06); }

.fallback{
  display:none;
  position:absolute;
  inset:0;
  place-items:center;
  text-align:center;
  padding:1rem;
  color: rgba(15,23,42,.72);
  font-weight: 950;
}

.body{
  padding: .95rem 1.05rem 1.05rem;
  display:flex;
  flex-direction:column;
  gap:.35rem;
}
.cat{
  font-size:.68rem;
  font-weight: 950;
  text-transform: uppercase;
  letter-spacing: .14em;
  color: rgba(15,23,42,.55);
}
.name{
  font-size: .98rem;
  font-weight: 950;
  letter-spacing: -.25px;
  color: rgba(15,23,42,.95);
  line-height:1.28;
}
.meta{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.75rem;
  margin-top:.15rem;
}
.price{
  font-size: 1.02rem;
  font-weight: 980;
  color: rgba(37,99,235,.98);
}
.mini{
  font-size:.82rem;
  color: rgba(15,23,42,.60);
  font-weight: 850;
}

/* badges */
.badge-price{
  position:absolute;
  top:.75rem;
  left:.75rem;
  padding:.35rem .6rem;
  border-radius:999px;
  font-size:.78rem;
  font-weight: 980;
  background: rgba(255,255,255,.88);
  border:1px solid rgba(15,23,42,.10);
  box-shadow: 0 10px 18px rgba(2,6,23,.06);
}
.badge-hot{
  position:absolute;
  top:.75rem;
  right:.75rem;
  padding:.35rem .6rem;
  border-radius:999px;
  font-size:.75rem;
  font-weight: 980;
  color: rgba(146,64,14,.98);
  background: rgba(245,158,11,.18);
  border:1px solid rgba(245,158,11,.28);
}

/* empty */
.empty{
  margin-top: 2rem;
  padding: 1.1rem 1.15rem;
  border-radius: var(--r-xl);
  border:1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.75);
  box-shadow: var(--shadow-sm);
  color: rgba(15,23,42,.68);
  line-height: 1.7;
}

/* motion safe */
@media (prefers-reduced-motion: reduce){
  *{ transition:none!important; animation:none!important; scroll-behavior:auto!important; }
}
</style>
{% endblock %}

{% block content %}

{# ========= labels + orden ========= #}
{% set order = ["buzos","remeras","gorros","camperas","otros"] %}
{% set labels = {
  "buzos":"Buzos / Hoodies",
  "remeras":"Remeras",
  "gorros":"Gorros",
  "camperas":"Camperas",
  "otros":"Otros"
} %}

{# ========= link robusto (no rompe si endpoint no existe) ========= #}
{% set DETAIL_PREFIX = "/product/" %}

{% macro product_href(product) -%}
  {%- if product and product.id is defined -%}
    {{ DETAIL_PREFIX ~ product.id }}
  {%- else -%}
    {{ DETAIL_PREFIX ~ "0" }}
  {%- endif -%}
{%- endmacro %}

{% macro product_card(product, cat) %}
  <a href="{{ product_href(product) }}"
     class="card"
     data-product-category="{{ cat|default('otros') }}">
    <div class="media">
      <span class="badge-price">$ {{ product.price }} UYU</span>
      <span class="badge-hot">Nuevo</span>

      <img src="{{ product.image }}"
           alt="{{ product.name }}"
           loading="lazy"
           decoding="async"
           data-fallback-title="{{ product.name|default('Producto') }}">

      <div class="fallback" aria-hidden="true">
        Imagen faltante<br><span style="opacity:.75;font-weight:900">Agregá la URL o archivo</span>
      </div>
    </div>

    <div class="body">
      <div class="cat">{{ labels.get(cat, cat) }}</div>
      <div class="name">{{ product.name }}</div>
      <div class="meta">
        <div class="price">$ {{ product.price }} UYU</div>
        <div class="mini">Ver detalle →</div>
      </div>
    </div>
  </a>
{% endmacro %}

<section class="shop-wrap" aria-label="Tienda Skyline Style">

  <header class="shop-header">
    <div class="kicker">Skyline Style Store</div>
    <h1 class="shop-title">Tienda oficial</h1>
    <p class="shop-sub">
      Productos seleccionados, dropshipping confiable y diseño pensado para durar.
      Comprá con seguridad, estilo y envío directo.
    </p>

    <div class="controls">
      <div class="filters-wrap" role="group" aria-label="Filtros por categoría">
        <div class="filters-scroll" data-category-filters>
          <button class="pill" data-filter-target="all" aria-pressed="true">Todos</button>
          {% for key,label in labels.items() %}
            <button class="pill" data-filter-target="{{ key }}" aria-pressed="false">{{ label }}</button>
          {% endfor %}
        </div>
      </div>

      <div class="count" aria-live="polite">
        Mostrando <b id="visibleCount">0</b> productos
      </div>
    </div>
  </header>

  {% if grouped_products %}
    {% for cat in order if grouped_products.get(cat) %}
      <section class="shop-section" data-category-section="{{ cat }}">
        <div class="section-title">
          <h2>{{ labels.get(cat, cat) }}</h2>
          <span>{{ grouped_products[cat]|length }} items</span>
        </div>

        <div class="shop-grid">
          {% for product in grouped_products[cat] %}
            {{ product_card(product, cat) }}
          {% endfor %}
        </div>
      </section>
    {% endfor %}

  {% elif products %}
    <section class="shop-section" data-category-section="all">
      <div class="section-title">
        <h2>Catálogo</h2>
        <span>{{ products|length }} items</span>
      </div>

      <div class="shop-grid">
        {% for product in products %}
          {{ product_card(product, product.category|default('otros')) }}
        {% endfor %}
      </div>
    </section>

  {% else %}
    <div class="empty">
      Todavía no hay productos disponibles.<br>
      Tip: cargá productos en tu backend y volvé a esta pantalla.
    </div>
  {% endif %}

</section>

<script>
/* ==========================================================
   SHOP ULTRA — filtros + contador + fallback imágenes
========================================================== */
(function(){
  const filterWrap = document.querySelector("[data-category-filters]");
  const pills = filterWrap ? Array.from(filterWrap.querySelectorAll("[data-filter-target]")) : [];
  const sections = Array.from(document.querySelectorAll("[data-category-section]"));
  const cards = Array.from(document.querySelectorAll("[data-product-category]"));
  const countEl = document.getElementById("visibleCount");

  // Fallback seguro para imágenes
  document.querySelectorAll("img[data-fallback-title]").forEach(img => {
    img.addEventListener("error", () => {
      const media = img.closest(".media");
      if(!media) return;
      const fb = media.querySelector(".fallback");
      if(fb) fb.style.display = "grid";
      img.style.display = "none";
    }, { once:true });
  });

  function setPressed(target){
    pills.forEach(p => p.setAttribute("aria-pressed", p.dataset.filterTarget === target ? "true" : "false"));
  }

  function updateCount(){
    if(!countEl) return;
    const visible = cards.filter(c => c.offsetParent !== null).length;
    countEl.textContent = String(visible);
  }

  function applyFilter(target){
    setPressed(target);

    // Si están por secciones (grouped_products)
    if(sections.length && sections.some(s => s.dataset.categorySection !== "all")){
      sections.forEach(sec => {
        const secCat = sec.dataset.categorySection;
        const show = (target === "all") || (secCat === target);
        sec.style.display = show ? "" : "none";
      });

      // Dentro de una sección visible, si querés igual filtrar cards por seguridad:
      cards.forEach(card => {
        const cat = card.dataset.productCategory || "otros";
        const show = (target === "all") || (cat === target);
        // Solo afecta si la sección está visible
        const sec = card.closest("[data-category-section]");
        if(sec && sec.style.display === "none") return;
        card.style.display = show ? "" : "none";
      });

    } else {
      // catálogo simple (products)
      cards.forEach(card => {
        const cat = card.dataset.productCategory || "otros";
        card.style.display = (target === "all" || cat === target) ? "" : "none";
      });
    }

    updateCount();
  }

  if(filterWrap){
    filterWrap.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-filter-target]");
      if(!btn) return;
      applyFilter(btn.dataset.filterTarget);
    });
  }

  // Estado inicial
  applyFilter("all");
})();
</script>

{% endblock %}
