{% extends "base.html" %}

{% block title %}Tienda Skyline Style{% endblock %}

{% block extra_head %}
<style>
    /* ---------- Efectos para cards ---------- */
    .card-hover {
        transition:
            transform 0.35s ease,
            box-shadow 0.35s ease,
            border-color 0.25s ease,
            background-color 0.25s ease;
    }
    .card-hover:hover {
        transform: translateY(-6px) scale(1.015);
        box-shadow: 0 20px 30px -10px rgba(15,23,42,0.18);
        border-color: rgba(251,191,36,0.8); /* amber-400 */
        background-color: #fefce8;          /* amber-50 */
    }

    /* Pills de filtros / categorías */
    .filter-pill {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        border-radius: 9999px;
        padding: .45rem 1.1rem;
        border: 1px solid #e2e8f0; /* slate-200 */
        font-size: .75rem;
        line-height: 1;
        color: #0f172a;
        background: rgba(248,250,252,0.9);
        cursor: pointer;
        white-space: nowrap;
        transition:
            background-color .25s ease,
            border-color .25s ease,
            color .25s ease,
            transform .2s ease;
    }
    .filter-pill:hover {
        border-color: #fbbf24;  /* amber-400 */
        color: #b45309;         /* amber-700 */
        transform: translateY(-1px);
        background: #fffbeb;    /* amber-50 */
    }
    .filter-pill.is-active {
        border-color: #f97316;  /* orange-500 */
        background: #fffbeb;
        color: #9a3412;
        font-weight: 600;
    }

    /* Scroll horizontal para filtros en mobile */
    .filters-scroll {
        display: flex;
        gap: .5rem;
        padding-bottom: .25rem;
        overflow-x: auto;
        scrollbar-width: thin;
    }
    .filters-scroll::-webkit-scrollbar {
        height: 4px;
    }
    .filters-scroll::-webkit-scrollbar-thumb {
        background: rgba(148,163,184,0.5);
        border-radius: 9999px;
    }
</style>
{% endblock %}

{% block content %}

<section class="max-w-6xl mx-auto px-4 pt-10 pb-16">

    <!-- ========== Header tienda ========== -->
    <div class="flex flex-wrap items-start justify-between gap-4 mb-8">
        <div class="max-w-xl">
            <p class="text-xs font-semibold tracking-[0.2em] uppercase text-amber-500">
                Nueva colección
            </p>
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900 tracking-tight mt-1">
                Tienda Skyline
            </h1>
            <p class="text-sm md:text-base text-slate-500 mt-2">
                Diseños exclusivos, drops limitados y streetwear listo para usar en la vida real.
            </p>
        </div>

        <!-- Filtros por categoría -->
        <div class="w-full md:w-auto">
            <div class="filters-scroll" data-category-filters>
                <a href="#cat-todos" class="filter-pill is-active" data-filter-target="todos">
                    <span>Todos</span>
                </a>
                <a href="#cat-buzos" class="filter-pill" data-filter-target="buzos">
                    <span>Buzos / Hoodies</span>
                </a>
                <a href="#cat-remeras" class="filter-pill" data-filter-target="remeras">
                    <span>Remeras</span>
                </a>
                <a href="#cat-gorros" class="filter-pill" data-filter-target="gorros">
                    <span>Gorros</span>
                </a>
                <a href="#cat-camperas" class="filter-pill" data-filter-target="camperas">
                    <span>Camperas</span>
                </a>
                <a href="#cat-otros" class="filter-pill" data-filter-target="otros">
                    <span>Otros</span>
                </a>
            </div>
        </div>
    </div>

    {# ======================================================
       MODO 1: backend manda grouped_products (dict por categoría)
       ======================================================= #}
    {% if grouped_products is defined %}

        {% set order = ["buzos", "remeras", "gorros", "camperas", "otros"] %}
        {% set labels = {
            "buzos": "Buzos / Hoodies",
            "remeras": "Remeras",
            "gorros": "Gorros",
            "camperas": "Camperas",
            "otros": "Otros"
        } %}

        <!-- Sección Todos -->
        <div id="cat-todos" class="mb-12" data-category-section="todos">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl md:text-2xl font-semibold text-slate-900">
                    Todos los productos
                </h2>
                <p class="text-xs md:text-sm text-slate-500">
                    Vista general de toda la colección Skyline Style.
                </p>
            </div>

            <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-6" data-shop-grid>
                {% for cat in order %}
                    {% if grouped_products.get(cat) %}
                        {% for product in grouped_products[cat] %}
                            <a href="{{ url_for('main.product_detail', product_id=product.id) }}"
                               class="group bg-white border border-slate-200 rounded-2xl overflow-hidden card-hover flex flex-col"
                               data-product-card
                               data-product-category="{{ cat }}">
                                <div class="aspect-square bg-slate-100 overflow-hidden">
                                    <img src="{{ product.image }}"
                                         alt="{{ product.name }}"
                                         loading="lazy"
                                         class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                                </div>
                                <div class="p-4 flex flex-col gap-1">
                                    <p class="text-[11px] uppercase tracking-wide text-slate-400">
                                        {{ labels.get(cat, cat)|default(cat)|capitalize }}
                                    </p>
                                    <h3 class="text-sm font-semibold text-slate-900 group-hover:text-amber-600 transition line-clamp-2">
                                        {{ product.name }}
                                    </h3>
                                    <p class="text-sm font-semibold text-amber-500 mt-1">
                                        $ {{ product.price }} UYU
                                    </p>
                                </div>
                            </a>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Secciones por categoría -->
        {% for cat in order %}
            {% if grouped_products.get(cat) %}
                <div id="cat-{{ cat }}" class="mb-12" data-category-section="{{ cat }}">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl md:text-2xl font-semibold text-slate-900">
                            {{ labels.get(cat, cat)|default(cat)|capitalize }}
                        </h2>
                    </div>

                    <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-6" data-shop-grid>
                        {% for product in grouped_products[cat] %}
                            <a href="{{ url_for('main.product_detail', product_id=product.id) }}"
                               class="group bg-white border border-slate-200 rounded-2xl overflow-hidden card-hover flex flex-col"
                               data-product-card
                               data-product-category="{{ cat }}">
                                <div class="aspect-square bg-slate-100 overflow-hidden">
                                    <img src="{{ product.image }}"
                                         alt="{{ product.name }}"
                                         loading="lazy"
                                         class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                                </div>
                                <div class="p-4 flex flex-col gap-1">
                                    <p class="text-[11px] uppercase tracking-wide text-slate-400">
                                        {{ labels.get(cat, cat)|default(cat)|capitalize }}
                                    </p>
                                    <h3 class="text-sm font-semibold text-slate-900 group-hover:text-amber-600 transition line-clamp-2">
                                        {{ product.name }}
                                    </h3>
                                    <p class="text-sm font-semibold text-amber-500 mt-1">
                                        $ {{ product.price }} UYU
                                    </p>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}

    {# ======================================================
       MODO 2: compatibilidad – si solo viene "products"
       ======================================================= #}
    {% else %}
        <div id="cat-todos" class="mb-12" data-category-section="todos">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl md:text-2xl font-semibold text-slate-900">
                    Todos los productos
                </h2>
            </div>

            <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-6" data-shop-grid>
                {% for product in products %}
                    <a href="{{ url_for('main.product_detail', product_id=product.id) }}"
                       class="group bg-white border border-slate-200 rounded-2xl overflow-hidden card-hover flex flex-col"
                       data-product-card
                       data-product-category="{{ product.category|default('otros')|lower }}">
                        <div class="aspect-square bg-slate-100 overflow-hidden">
                            <img src="{{ product.image }}"
                                 alt="{{ product.name }}"
                                 loading="lazy"
                                 class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                        </div>
                        <div class="p-4 flex flex-col gap-1">
                            <p class="text-[11px] uppercase tracking-wide text-slate-400">
                                {{ product.category or 'Otros' }}
                            </p>
                            <h3 class="text-sm font-semibold text-slate-900 group-hover:text-amber-600 transition line-clamp-2">
                                {{ product.name }}
                            </h3>
                            <p class="text-sm font-semibold text-amber-500 mt-1">
                                $ {{ product.price }} UYU
                            </p>
                        </div>
                    </a>
                {% endfor %}
            </div>
        </div>
    {% endif %}

</section>

{% endblock %}

{% block extra_js %}
<!-- GSAP animation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const grids = document.querySelectorAll('[data-shop-grid]');
        const sections = document.querySelectorAll('[data-category-section]');
        const pills = document.querySelectorAll('[data-category-filters] .filter-pill');

        // -------- Animación inicial de las cards --------
        function animateCards(grid) {
            if (!grid) return;
            const cards = grid.querySelectorAll('[data-product-card]');
            if (!cards.length) return;

            gsap.from(cards, {
                opacity: 0,
                y: 24,
                stagger: 0.05,
                duration: 0.45,
                ease: 'power3.out'
            });
        }

        grids.forEach(animateCards);

        // -------- Filtros por categoría --------
        function setActivePill(target) {
            pills.forEach(pill => {
                pill.classList.toggle('is-active', pill.dataset.filterTarget === target);
            });
        }

        function filterSections(target) {
            sections.forEach(sec => {
                const key = sec.dataset.categorySection;
                if (target === 'todos' || key === target) {
                    sec.style.display = '';
                } else {
                    sec.style.display = 'none';
                }
            });

            // Animar la primera sección visible después de filtrar
            const firstVisibleSection = Array.from(sections).find(
                sec => sec.style.display !== 'none'
            );
            if (firstVisibleSection) {
                const grid = firstVisibleSection.querySelector('[data-shop-grid]');
                animateCards(grid);

                firstVisibleSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }

        pills.forEach(pill => {
            pill.addEventListener('click', (event) => {
                event.preventDefault(); // evitamos salto de ancla
                const target = pill.dataset.filterTarget || 'todos';
                setActivePill(target);
                filterSections(target);
            });
        });

        // Estado inicial
        setActivePill('todos');
        filterSections('todos');
    });
</script>
{% endblock %}
