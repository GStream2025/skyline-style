{# templates/shop.html â€” Skyline Store Â· SHOP MARKETPLACE (Light Â· Vivid Â· Temu vibes) #}
{% extends "base.html" %}
{% block title %}Tienda Â· Skyline Store{% endblock %}

{% block extra_head %}
<style>
/* ==========================================================
   SKYLINE STORE Â· SHOP â€” MARKETPLACE (TEMU VIBES Â· LIGHT)
   - BÃºsqueda + filtros + ordenar + contador
   - Cards con badges + fallback robusto
   - Sin romper si faltan fields o cambian tipos (dict/model)
========================================================== */

:root{
  --bg0:#f7f8fb;
  --bg1:#ffffff;

  --ink:#0b1220;
  --muted: rgba(11,18,32,.68);
  --muted2: rgba(11,18,32,.52);

  --a:#2563eb;  /* blue */
  --b:#06b6d4;  /* cyan */
  --c:#f59e0b;  /* amber */
  --g:#22c55e;  /* green */
  --p:#a855f7;  /* violet */
  --r:#ef4444;  /* red/orange vibe */

  --stroke: rgba(15,23,42,.10);
  --stroke2: rgba(15,23,42,.08);

  --shadow1: 0 10px 24px rgba(2,6,23,.07);
  --shadow2: 0 22px 70px rgba(2,6,23,.10);

  --r-lg: 1.05rem;
  --r-xl: 1.45rem;
  --r-2xl: 1.85rem;

  --ring: 0 0 0 4px rgba(37,99,235,.18);
  --grid: 1220px;

  --ease: cubic-bezier(.2,.9,.2,1);
}

/* page */
.shop-page{
  background:
    radial-gradient(circle at 0% 0%, rgba(37,99,235,.06), transparent 42%),
    radial-gradient(circle at 100% 0%, rgba(6,182,212,.05), transparent 40%),
    radial-gradient(circle at 50% 100%, rgba(245,158,11,.05), transparent 45%),
    linear-gradient(180deg, var(--bg1), var(--bg0));
  min-height: calc(100vh - 60px);
}

.shop-wrap{
  max-width: var(--grid);
  margin: 0 auto;
  padding: clamp(2.2rem, 5vw, 3.4rem) 1rem clamp(4rem, 7vw, 6rem);
}
@media(min-width:768px){
  .shop-wrap{ padding-left: 1.25rem; padding-right: 1.25rem; }
}

/* header */
.shop-header{
  position:relative;
  border-radius: var(--r-2xl);
  border:1px solid var(--stroke);
  box-shadow: var(--shadow2);
  overflow:hidden;
  background:
    radial-gradient(900px 520px at 18% 22%, rgba(37,99,235,.14), transparent 62%),
    radial-gradient(860px 520px at 86% 25%, rgba(245,158,11,.12), transparent 62%),
    radial-gradient(900px 560px at 45% 95%, rgba(34,197,94,.10), transparent 62%),
    linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.86));
  padding: 1.1rem;
}
@media(min-width:900px){ .shop-header{ padding: 1.25rem; } }

.shop-header::after{
  content:"";
  position:absolute; inset:0;
  pointer-events:none;
  opacity:.035;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.8'/%3E%3C/svg%3E");
  mix-blend-mode:multiply;
}

.topline{
  position:relative;
  display:flex;
  flex-wrap:wrap;
  align-items:flex-start;
  justify-content:space-between;
  gap: 1rem;
}

.kicker{
  display:inline-flex;
  align-items:center;
  gap:.55rem;
  padding:.46rem .95rem;
  border-radius:999px;
  background: rgba(255,255,255,.88);
  border:1px solid rgba(15,23,42,.12);
  box-shadow: 0 10px 18px rgba(2,6,23,.06);
  font-weight: 950;
  font-size:.78rem;
  letter-spacing:.10em;
  text-transform: uppercase;
  color: rgba(11,18,32,.82);
}
.kicker .dot{
  width:8px;height:8px;border-radius:50%;
  background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb);
  box-shadow: 0 0 0 0 rgba(37,99,235,.45);
}

.h1{
  margin:.75rem 0 0;
  font-size: clamp(1.85rem, 3.8vw, 2.75rem);
  line-height: 1.05;
  font-weight: 1000;
  letter-spacing: -.75px;
  color: var(--ink);
}
.sub{
  margin:.55rem 0 0;
  max-width: 60rem;
  color: rgba(11,18,32,.72);
  line-height: 1.7;
  font-weight: 850;
  font-size: 1.02rem;
}

.badges{
  position:relative;
  display:flex;
  flex-wrap:wrap;
  gap:.55rem;
  margin-top:.9rem;
}
.badge{
  display:inline-flex;align-items:center;gap:.45rem;
  padding:.44rem .88rem;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.92);
  box-shadow: 0 12px 22px rgba(2,6,23,.06);
  font-size:.78rem;
  font-weight: 950;
  color: rgba(11,18,32,.74);
}
.badge b{ color: rgba(11,18,32,.92); font-weight: 1000; }

/* controls */
.controls{
  margin-top: 1rem;
  display:grid;
  gap:.75rem;
}
@media(min-width:900px){
  .controls{ grid-template-columns: 1.1fr .9fr; align-items:end; }
}

.searchRow{
  display:flex;
  gap:.55rem;
  flex-wrap:wrap;
  align-items:center;
}
.search{
  flex: 1;
  min-width: 240px;
  display:flex;
  align-items:center;
  gap:.6rem;
  padding:.78rem 1rem;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.14);
  background: rgba(255,255,255,.94);
  box-shadow: 0 12px 18px rgba(2,6,23,.06);
}
.search:focus-within{ box-shadow: var(--ring), 0 12px 18px rgba(2,6,23,.06); }
.search .ico{ font-weight: 1000; color: rgba(11,18,32,.55); }
.search input{
  border:0;
  outline:none;
  width:100%;
  background:transparent;
  font-weight: 900;
  color: rgba(11,18,32,.88);
}
.search input::placeholder{ color: rgba(11,18,32,.45); font-weight: 850; }

.select{
  padding:.78rem 1rem;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.14);
  background: rgba(255,255,255,.94);
  box-shadow: 0 12px 18px rgba(2,6,23,.06);
  font-weight: 950;
  color: rgba(11,18,32,.82);
  outline:none;
}
.select:focus-visible{ box-shadow: var(--ring), 0 12px 18px rgba(2,6,23,.06); }

.filters-wrap{
  display:flex;
  flex-wrap:wrap;
  gap:.55rem;
  align-items:center;
}
.filters-scroll{
  display:flex;
  gap:.55rem;
  overflow-x:auto;
  padding: .25rem .1rem .35rem;
  -webkit-overflow-scrolling: touch;
  scroll-snap-type: x mandatory;
}
.filters-scroll::-webkit-scrollbar{ height: 10px; }
.filters-scroll::-webkit-scrollbar-thumb{ background: rgba(15,23,42,.16); border-radius: 999px; }
.filters-scroll::-webkit-scrollbar-track{ background: transparent; }

.pill{
  scroll-snap-align:start;
  border-radius:999px;
  padding:.55rem 1.05rem;
  font-size:.78rem;
  font-weight: 950;
  border:1px solid rgba(15,23,42,.12);
  background: rgba(255,255,255,.90);
  color: rgba(15,23,42,.74);
  cursor:pointer;
  transition: transform .18s var(--ease), background .18s var(--ease), border-color .18s var(--ease), color .18s var(--ease), box-shadow .18s var(--ease);
  white-space:nowrap;
  user-select:none;
}
.pill:hover{
  border-color: rgba(37,99,235,.28);
  background: rgba(37,99,235,.08);
  color: rgba(37,99,235,.96);
  transform: translateY(-1px);
}
.pill:focus-visible{ outline:none; box-shadow: var(--ring), var(--shadow1); }
.pill[aria-pressed="true"]{
  background: linear-gradient(135deg, var(--a), var(--b));
  border-color: transparent;
  color: #fff;
  box-shadow: var(--shadow1);
}

.count{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:.5rem;
  padding:.55rem .95rem;
  border-radius: 999px;
  border:1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.78);
  box-shadow: 0 12px 18px rgba(2,6,23,.06);
  color: rgba(15,23,42,.72);
  font-weight: 900;
  font-size: .82rem;
}
.count b{ color: rgba(15,23,42,.92); font-weight: 1000; }

/* section */
.shop-section{
  margin-top: 1.4rem;
  margin-bottom: 2.2rem;
}
.section-title{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:1rem;
  margin: 1.05rem 0 .95rem;
}
.section-title h2{
  margin:0;
  font-size: 1.18rem;
  font-weight: 1000;
  letter-spacing: -.25px;
  color: var(--ink);
}
.section-title span{
  font-size:.85rem;
  color: var(--muted);
  font-weight: 900;
}

/* grid */
.shop-grid{
  display:grid;
  gap: 1.05rem;
}
@media(min-width:640px){ .shop-grid{ grid-template-columns: repeat(2, 1fr); } }
@media(min-width:1024px){ .shop-grid{ grid-template-columns: repeat(3, 1fr); gap: 1.25rem; } }

/* card */
.card{
  position:relative;
  display:flex;
  flex-direction:column;
  border-radius: var(--r-xl);
  border: 1px solid rgba(15,23,42,.10);
  background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.86));
  box-shadow: var(--shadow1);
  overflow:hidden;
  text-decoration:none;
  color: inherit;
  transition: transform .22s var(--ease), box-shadow .22s var(--ease), border-color .22s var(--ease), filter .22s var(--ease);
}
.card:hover{
  transform: translateY(-7px);
  box-shadow: var(--shadow2);
  border-color: rgba(37,99,235,.18);
  filter: saturate(1.04);
}
.card:focus-visible{ outline:none; box-shadow: var(--ring), var(--shadow2); }

.media{
  position:relative;
  aspect-ratio: 1 / 1;
  background:
    radial-gradient(900px 420px at 18% 20%, rgba(37,99,235,.14), transparent 55%),
    radial-gradient(720px 420px at 86% 20%, rgba(245,158,11,.12), transparent 58%),
    rgba(248,250,252,.9);
  overflow:hidden;
}
.media img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  transform: scale(1.001);
  transition: transform .65s var(--ease);
}
.card:hover .media img{ transform: scale(1.07); }

.fallback{
  display:none;
  position:absolute; inset:0;
  place-items:center;
  text-align:center;
  padding:1rem;
  color: rgba(15,23,42,.72);
  font-weight: 1000;
  background: rgba(255,255,255,.82);
}

/* badges on card */
.badge-left{
  position:absolute; top:.75rem; left:.75rem;
  padding:.35rem .6rem;
  border-radius:999px;
  font-size:.78rem;
  font-weight: 1000;
  background: rgba(255,255,255,.90);
  border:1px solid rgba(15,23,42,.10);
  box-shadow: 0 10px 18px rgba(2,6,23,.06);
}
.badge-right{
  position:absolute; top:.75rem; right:.75rem;
  padding:.35rem .6rem;
  border-radius:999px;
  font-size:.75rem;
  font-weight: 1000;
  color: rgba(255,255,255,.98);
  background: linear-gradient(135deg, #f97316, #ef4444);
  border: 1px solid rgba(239,68,68,.18);
  box-shadow: 0 12px 22px rgba(2,6,23,.10);
}

/* meta */
.body{
  padding: .95rem 1.05rem 1.05rem;
  display:flex;
  flex-direction:column;
  gap:.38rem;
}
.cat{
  font-size:.68rem;
  font-weight: 1000;
  text-transform: uppercase;
  letter-spacing: .14em;
  color: rgba(15,23,42,.55);
}
.name{
  font-size: 1rem;
  font-weight: 1000;
  letter-spacing: -.22px;
  color: rgba(15,23,42,.95);
  line-height:1.25;
}
.meta{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.75rem;
  margin-top:.15rem;
}
.price{
  font-size: 1.05rem;
  font-weight: 1000;
  color: rgba(37,99,235,.98);
}
.mini{
  font-size:.82rem;
  color: rgba(15,23,42,.60);
  font-weight: 900;
}

/* tiny strip benefits */
.bline{
  display:flex;
  flex-wrap:wrap;
  gap:.45rem;
  margin-top:.55rem;
}
.bchip{
  display:inline-flex;align-items:center;gap:.4rem;
  padding:.28rem .55rem;
  border-radius:999px;
  font-size:.72rem;
  font-weight:1000;
  border:1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.92);
  color: rgba(11,18,32,.72);
}
.bchip .ok{ color: rgba(34,197,94,.98); font-weight:1000; }

/* empty */
.empty{
  margin-top: 1.4rem;
  padding: 1.1rem 1.15rem;
  border-radius: var(--r-xl);
  border:1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.80);
  box-shadow: var(--shadow1);
  color: rgba(15,23,42,.68);
  line-height: 1.7;
  font-weight: 850;
}

/* sticky bottom CTA */
.sticky-cta{
  position:fixed;
  left: 16px;
  right: 16px;
  bottom: 14px;
  z-index: 50;
  display:flex;
  justify-content:center;
  pointer-events:none;
}
.sticky-cta .inner{
  pointer-events:auto;
  width:min(740px, 100%);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 10px 12px;
  border-radius: 999px;
  border:1px solid rgba(15,23,42,.12);
  background: rgba(255,255,255,.88);
  box-shadow: 0 20px 60px rgba(2,6,23,.16);
  backdrop-filter: blur(10px);
}
.sticky-cta b{ font-weight:1000; color: rgba(11,18,32,.88); }
.small{ font-size:.88rem; color: rgba(11,18,32,.62); font-weight: 850; }

.cta-btn{
  display:inline-flex;align-items:center;justify-content:center;gap:.55rem;
  border-radius:999px;
  padding:.70rem 1.0rem;
  font-weight:1000;
  text-decoration:none;
  border:1px solid transparent;
  background: linear-gradient(135deg, var(--a), var(--b));
  color:#fff;
  box-shadow: 0 14px 30px rgba(2,6,23,.12);
  transition: transform .22s var(--ease), filter .22s var(--ease);
}
.cta-btn:hover{ transform: translateY(-2px); filter:saturate(1.06); }
.cta-btn:focus-visible{ outline:none; box-shadow: var(--ring), 0 14px 30px rgba(2,6,23,.12); }

@media (prefers-reduced-motion: reduce){
  *{ transition:none!important; animation:none!important; scroll-behavior:auto!important; }
  .cta-btn:hover,.card:hover{ transform:none!important; }
}
</style>
{% endblock %}

{% block content %}

{# ========= labels + orden ========= #}
{% set order = ["buzos","remeras","gorros","camperas","otros"] %}
{% set labels = {
  "buzos":"Buzos / Hoodies",
  "remeras":"Remeras",
  "gorros":"Gorros",
  "camperas":"Camperas",
  "otros":"Otros"
} %}

{# ========= helpers seguros (dict o model) ========= #}
{% macro getf(obj, key, default="") -%}
  {%- if obj is mapping -%}
    {{ obj.get(key, default) }}
  {%- else -%}
    {{ attribute(obj, key) if obj is not none and (attribute(obj, key) is defined) else default }}
  {%- endif -%}
{%- endmacro %}

{% macro toint(v, default=0) -%}
  {%- set s = (v|string)|trim -%}
  {%- if s|length == 0 -%}{{ default }}
  {%- else -%}
    {%- set cleaned = s|replace("$","")|replace("UYU","")|replace("uyu","")|replace(",","")|trim -%}
    {%- if cleaned.isdigit() -%}{{ cleaned }}
    {%- else -%}{{ default }}
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}

{# ========= link robusto: intenta url_for si existe, si no cae a /product/<id> ========= #}
{% set FALLBACK_DETAIL_PREFIX = "/product/" %}
{% macro product_href(product) -%}
  {%- set pid = getf(product, "id", "0") -%}
  {%- if pid is none or (pid|string)|length == 0 -%}{% set pid = "0" %}{% endif -%}
  {# Intentos seguros: si endpoint no existe, no rompe porque usamos fallbacks simples #}
  {{ FALLBACK_DETAIL_PREFIX ~ pid }}
{%- endmacro %}

{% macro product_card(product, cat) %}
  {%- set name = getf(product, "name", getf(product, "title", "Producto")) -%}
  {%- set img  = getf(product, "image", getf(product, "img", "")) -%}
  {%- set price_raw = getf(product, "price", 0) -%}
  {%- set price_n = toint(price_raw, 0) -%}

  <a href="{{ product_href(product) }}"
     class="card"
     data-product-category="{{ cat|default('otros') }}"
     data-name="{{ (name|default(''))|lower }}"
     data-price="{{ price_n }}"
     aria-label="{{ name|e }}">
    <div class="media">
      <span class="badge-left">$ {{ price_n }} UYU</span>
      <span class="badge-right">ðŸ”¥ Oferta</span>

      {# imagen: si no viene, usamos placeholder local #}
      {% if img and (img|string)|length > 0 %}
        <img src="{{ img }}"
             alt="{{ name|e }}"
             loading="lazy"
             decoding="async"
             data-fallback-title="{{ name|default('Producto')|e }}">
      {% else %}
        <img src="{{ url_for('static', filename='img/products/hero-placeholder.png') }}"
             alt="{{ name|e }}"
             loading="lazy"
             decoding="async"
             data-fallback-title="{{ name|default('Producto')|e }}">
      {% endif %}

      <div class="fallback" aria-hidden="true">
        Imagen faltante<br><span style="opacity:.75;font-weight:900">AgregÃ¡ la URL o archivo</span>
      </div>
    </div>

    <div class="body">
      <div class="cat">{{ labels.get(cat, cat) }}</div>
      <div class="name">{{ name }}</div>

      <div class="meta">
        <div class="price">$ {{ price_n }} UYU</div>
        <div class="mini">Ver â†’</div>
      </div>

      <div class="bline" aria-label="Beneficios">
        <span class="bchip"><span class="ok">âœ“</span> Pago seguro</span>
        <span class="bchip"><span class="ok">âœ“</span> EnvÃ­o rÃ¡pido</span>
        <span class="bchip"><span class="ok">âœ“</span> Calidad</span>
      </div>
    </div>
  </a>
{% endmacro %}

<div class="shop-page">
  <section class="shop-wrap" aria-label="Tienda Skyline Store">

    <header class="shop-header">
      <div class="topline">
        <div>
          <div class="kicker"><span class="dot" aria-hidden="true"></span> Marketplace + Brand</div>
          <h1 class="h1">Tienda Skyline Store</h1>
          <p class="sub">
            CatÃ¡logo vivo tipo marketplace: encontrÃ¡ rÃ¡pido, filtrÃ¡ por categorÃ­a y comprÃ¡ sin vueltas.
          </p>

          <div class="badges" aria-label="Beneficios">
            <span class="badge">âœ… <b>Pagos seguros</b></span>
            <span class="badge">ðŸšš <b>EnvÃ­os rÃ¡pidos</b></span>
            <span class="badge">âš¡ <b>Ofertas flash</b></span>
            <span class="badge">ðŸ†• <b>Nuevos ingresos</b></span>
          </div>
        </div>

        <div style="display:flex;align-items:flex-start;justify-content:flex-end;gap:.55rem;flex-wrap:wrap">
          <span class="count" aria-live="polite">
            Mostrando <b id="visibleCount">0</b> productos
          </span>
        </div>
      </div>

      <div class="controls">
        <!-- Search + Sort -->
        <div class="searchRow" aria-label="Buscar y ordenar">
          <div class="search">
            <span class="ico" aria-hidden="true">ðŸ”Ž</span>
            <input id="q" type="search" placeholder="Buscar (ej: hoodie, gorra, smartwatch...)"
                   autocomplete="off" spellcheck="false" aria-label="Buscar productos">
          </div>

          <select id="sort" class="select" aria-label="Ordenar productos">
            <option value="reco">Orden: recomendados</option>
            <option value="price_asc">Precio: menor a mayor</option>
            <option value="price_desc">Precio: mayor a menor</option>
            <option value="name_asc">Nombre: A â†’ Z</option>
          </select>
        </div>

        <!-- Filters -->
        <div class="filters-wrap" role="group" aria-label="Filtros por categorÃ­a">
          <div class="filters-scroll" data-category-filters>
            <button class="pill" type="button" data-filter-target="all" aria-pressed="true">Todos</button>
            {% for key,label in labels.items() %}
              <button class="pill" type="button" data-filter-target="{{ key }}" aria-pressed="false">{{ label }}</button>
            {% endfor %}
          </div>
        </div>
      </div>
    </header>

    {% if grouped_products %}
      {% for cat in order if grouped_products.get(cat) %}
        <section class="shop-section" data-category-section="{{ cat }}">
          <div class="section-title">
            <h2>{{ labels.get(cat, cat) }}</h2>
            <span>{{ grouped_products[cat]|length }} items</span>
          </div>

          <div class="shop-grid" data-grid>
            {% for product in grouped_products[cat] %}
              {{ product_card(product, cat) }}
            {% endfor %}
          </div>
        </section>
      {% endfor %}

    {% elif products %}
      <section class="shop-section" data-category-section="all">
        <div class="section-title">
          <h2>CatÃ¡logo</h2>
          <span>{{ products|length }} items</span>
        </div>

        <div class="shop-grid" data-grid>
          {% for product in products %}
            {{ product_card(product, getf(product, "category", "otros")) }}
          {% endfor %}
        </div>
      </section>

    {% else %}
      <div class="empty">
        TodavÃ­a no hay productos disponibles.<br>
        Tip: cargÃ¡ productos en tu backend y volvÃ© a esta pantalla.
      </div>
    {% endif %}

  </section>

  <!-- Sticky CTA -->
  <div class="sticky-cta" aria-hidden="false">
    <div class="inner">
      <div>
        <b>âš¡ Promo activa</b>
        <div class="small">AgregÃ¡ al carrito y aprovechÃ¡ hoy</div>
      </div>
      <a class="cta-btn" href="/shop?carrito=1">Ver carrito â†’</a>
    </div>
  </div>
</div>

<script>
/* ==========================================================
   SHOP MARKETPLACE â€” filtros + bÃºsqueda + ordenar + contador
   - Estado consistente (category + search)
   - Orden original preservado (reco)
   - Mejor performance (rAF)
========================================================== */
(function(){
  const filterWrap = document.querySelector("[data-category-filters]");
  const pills = filterWrap ? Array.from(filterWrap.querySelectorAll("[data-filter-target]")) : [];
  const sections = Array.from(document.querySelectorAll("[data-category-section]"));
  const grids = Array.from(document.querySelectorAll("[data-grid]"));
  const allCards = Array.from(document.querySelectorAll("[data-product-category]"));
  const countEl = document.getElementById("visibleCount");
  const q = document.getElementById("q");
  const sortSel = document.getElementById("sort");

  let activeCategory = "all";
  let rafId = 0;

  // 1) Fallback seguro para imÃ¡genes
  document.querySelectorAll("img[data-fallback-title]").forEach(img => {
    const onErr = () => {
      const media = img.closest(".media");
      if(!media) return;
      const fb = media.querySelector(".fallback");
      if(fb) fb.style.display = "grid";
      img.style.display = "none";
    };
    img.addEventListener("error", onErr, { once:true });
    // si viene vacÃ­o por algÃºn motivo raro, tambiÃ©n:
    if(!img.getAttribute("src")) onErr();
  });

  // 2) Guardar orden original por grid (para "reco")
  grids.forEach(grid => {
    Array.from(grid.querySelectorAll("[data-product-category]")).forEach((card, idx) => {
      if(!card.dataset.origIndex) card.dataset.origIndex = String(idx);
    });
  });

  function setPressed(target){
    pills.forEach(p => {
      p.setAttribute("aria-pressed", (p.dataset.filterTarget === target) ? "true" : "false");
    });
  }

  function matchesCategory(card){
    const cat = (card.dataset.productCategory || "otros");
    return (activeCategory === "all" || cat === activeCategory);
  }

  function matchesSearch(card, term){
    if(!term) return true;
    const name = (card.dataset.name || "").toLowerCase();
    return name.includes(term);
  }

  function showHideSections(){
    // Si hay secciones por categorÃ­a, ocultamos las que no correspondan.
    const hasGrouped = sections.some(s => s.dataset.categorySection && s.dataset.categorySection !== "all");
    if(!hasGrouped) return;

    sections.forEach(sec => {
      const secCat = sec.dataset.categorySection || "otros";
      const show = (activeCategory === "all") || (secCat === activeCategory);
      sec.style.display = show ? "" : "none";
    });
  }

  function applyFilters(){
    const term = (q && q.value ? q.value.trim().toLowerCase() : "");

    showHideSections();

    allCards.forEach(card => {
      const sec = card.closest("[data-category-section]");
      if(sec && sec.style.display === "none"){
        card.style.display = "none";
        return;
      }
      const ok = matchesCategory(card) && matchesSearch(card, term);
      card.style.display = ok ? "" : "none";
    });
  }

  function applySort(){
    const sort = sortSel ? sortSel.value : "reco";

    const getPrice = (el) => {
      const n = Number(el.dataset.price || "0");
      return Number.isFinite(n) ? n : 0;
    };
    const getName = (el) => (el.dataset.name || "").toLowerCase();
    const getOrig = (el) => Number(el.dataset.origIndex || "0");

    grids.forEach(grid => {
      const cards = Array.from(grid.querySelectorAll("[data-product-category]"));

      let sorted = cards.slice();

      if(sort === "reco"){
        sorted.sort((a,b)=> getOrig(a) - getOrig(b));
      } else if(sort === "price_asc"){
        sorted.sort((a,b)=> getPrice(a) - getPrice(b));
      } else if(sort === "price_desc"){
        sorted.sort((a,b)=> getPrice(b) - getPrice(a));
      } else if(sort === "name_asc"){
        sorted.sort((a,b)=> getName(a).localeCompare(getName(b)));
      }

      // reinsert en orden
      sorted.forEach(el => grid.appendChild(el));
    });
  }

  function updateCount(){
    if(!countEl) return;
    let n = 0;
    allCards.forEach(c => { if(c.style.display !== "none") n++; });
    countEl.textContent = String(n);
  }

  function recompute(){
    applyFilters();
    applySort();
    updateCount();
  }

  function scheduleRecompute(){
    if(rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(() => {
      rafId = 0;
      recompute();
    });
  }

  function setCategory(target){
    activeCategory = target || "all";
    setPressed(activeCategory);
    scheduleRecompute();
  }

  // events
  if(filterWrap){
    filterWrap.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-filter-target]");
      if(!btn) return;
      setCategory(btn.dataset.filterTarget);
    });
  }
  if(q){
    q.addEventListener("input", scheduleRecompute, { passive:true });
  }
  if(sortSel){
    sortSel.addEventListener("change", scheduleRecompute);
  }

  // init
  setCategory("all");
})();
</script>

{% endblock %}
