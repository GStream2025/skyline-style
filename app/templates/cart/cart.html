<script>
document.addEventListener('DOMContentLoaded', () => {
  const root = document.querySelector('[data-cart-root]');
  if (!root) return;

  const $ = (sel, ctx = root) => ctx.querySelector(sel);
  const $$ = (sel, ctx = root) => Array.from(ctx.querySelectorAll(sel));

  const clamp = (n, a, b) => Math.min(b, Math.max(a, n));
  const toInt = (v, def = 1) => {
    const n = parseInt(String(v ?? ''), 10);
    return Number.isFinite(n) ? n : def;
  };
  const safeStr = (v, def = "") => (v === null || v === undefined) ? def : String(v);
  const nowMs = () => (Date.now ? Date.now() : new Date().getTime());

  const live = $('[data-cart-live]');
  let lastLive = '';
  let liveTimer = 0;
  const say = (msg) => {
    if (!live) return;
    const s = String(msg || '').trim();
    if (!s || s === lastLive) return;
    lastLive = s;
    if (liveTimer) clearTimeout(liveTimer);
    liveTimer = setTimeout(() => { live.textContent = s; }, 140);
  };

  const toastSafe = (t, m) => {
    try { if (typeof window.toast === 'function') window.toast(String(t || 'Info'), String(m || '')); } catch {}
  };

  const readCsrf = () => {
    try{
      const meta = document.querySelector('meta[name="csrf-token"]');
      if (meta && meta.content) return String(meta.content);
      const inp = document.querySelector('input[name="csrf_token"]');
      if (inp && inp.value) return String(inp.value);
    }catch{}
    return '';
  };
  let csrf = readCsrf();

  const errMsg = (j) => {
    if (!j) return 'Request failed';
    if (typeof j === 'string') return j;
    if (j && typeof j === 'object') {
      const e = j.error;
      if (e && typeof e === 'object' && e.message) return String(e.message);
      if (typeof e === 'string') return e;
      if (j.message) return String(j.message);
    }
    return 'Request failed';
  };

  const controllers = new Map();
  const abortPrev = (key) => {
    try { controllers.get(key)?.abort(); } catch {}
    const c = new AbortController();
    controllers.set(key, c);
    return c;
  };

  const sameOrigin = (u) => {
    try { return new URL(u, window.location.href).origin === window.location.origin; }
    catch { return false; }
  };

  const apiGet = async (url, key = 'get') => {
    const ctrl = abortPrev(key);

    if (typeof window.apiGet === 'function') {
      const d = await window.apiGet(url);
      if (d && d.ok === false) throw new Error(errMsg(d));
      return d;
    }

    const r = await fetch(url, {
      headers: { 'Accept': 'application/json' },
      credentials: 'same-origin',
      signal: ctrl.signal
    });

    let j = null;
    try { j = await r.json(); } catch { j = null; }
    if (!r.ok || (j && j.ok === false)) throw new Error(errMsg(j));
    return j;
  };

  const apiPost = async (url, body, key = 'post') => {
    const ctrl = abortPrev(key);

    if (typeof window.apiPost === 'function') {
      const d = await window.apiPost(url, body);
      if (d && d.ok === false) throw new Error(errMsg(d));
      return d;
    }

    const headers = {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    };

    csrf = csrf || readCsrf();
    if (csrf) headers['X-CSRFToken'] = csrf;
    headers['X-Requested-With'] = 'XMLHttpRequest';

    const doReq = async () => {
      const r = await fetch(url, {
        method: 'POST',
        headers,
        credentials: 'same-origin',
        body: JSON.stringify(body || {}),
        signal: ctrl.signal
      });
      let j = null;
      try { j = await r.json(); } catch { j = null; }
      return { r, j };
    };

    const { r, j } = await doReq();
    const msg = errMsg(j);
    const looksCsrf = /csrf|token/i.test(msg);

    if ((!r.ok || (j && j.ok === false)) && looksCsrf) {
      const fresh = readCsrf();
      if (fresh && fresh !== csrf) {
        csrf = fresh;
        headers['X-CSRFToken'] = csrf;
        const { r: r2, j: j2 } = await doReq();
        if (!r2.ok || (j2 && j2.ok === false)) throw new Error(errMsg(j2));
        return j2;
      }
    }

    if (!r.ok || (j && j.ok === false)) throw new Error(msg);
    return j;
  };

  const pickCart = (d) => {
    if (!d) return null;
    if (d.cart && typeof d.cart === 'object') return d.cart;
    return d;
  };

  const metaEl      = $('[data-cart-meta]');
  const subtotalEl  = $('[data-subtotal]');
  const discountEl  = $('[data-discount]');
  const discountRow = $('[data-discount-row]');
  const totalEl     = $('[data-total]');

  const fmtMoney = (v, def = '0.00') => {
    const s = safeStr(v, def);
    if (!s) return def;
    return s;
  };

  const setSummary = (snap) => {
    if (!snap) return;

    const itemsCount = safeStr(snap.items_count ?? 0, '0');
    const distinct   = safeStr(snap.distinct_items ?? 0, '0');

    if (metaEl) metaEl.textContent = `${itemsCount} item(s) • ${distinct} producto(s)`;
    if (subtotalEl) subtotalEl.textContent = fmtMoney(snap.subtotal, '0.00');

    const disc = fmtMoney(snap.discount_total, '0.00');
    if (discountEl) discountEl.textContent = disc;
    if (discountRow) discountRow.style.display = (disc && disc !== '0.00') ? '' : 'none';

    const total = fmtMoney(snap.total || snap.subtotal, '0.00');
    if (totalEl) totalEl.textContent = total;

    if (window.Skyline && typeof window.Skyline.setCartBadge === 'function') {
      try { window.Skyline.setCartBadge(Number(snap.items_count || 0)); } catch {}
    }
  };

  const renderLines = (snap) => {
    if (!snap || !Array.isArray(snap.lines)) return;

    const ids = new Set(snap.lines.map(x => safeStr(x.product_id, '')).filter(Boolean));

    for (const ln of snap.lines) {
      const pid = safeStr(ln.product_id, '');
      if (!pid) continue;

      let row = null;
      try { row = root.querySelector(`[data-line][data-id="${CSS.escape(pid)}"]`); }
      catch { row = root.querySelector(`[data-line][data-id="${pid.replace(/"/g, '&quot;')}"]`); }

      if (!row) continue;

      const qtyInput  = row.querySelector('[data-qty-input]');
      const lineTotal = row.querySelector('[data-line-total]');
      const unit      = row.querySelector('[data-unit]');

      const qtyVal = safeStr(ln.qty ?? 1, '1');
      if (qtyInput && qtyInput.value !== qtyVal) qtyInput.value = qtyVal;

      const lt = fmtMoney(ln.line_total_display || ln.line_total, '0.00');
      if (lineTotal && lineTotal.textContent !== lt) lineTotal.textContent = lt;

      const up = fmtMoney(ln.unit_price_display || ln.unit_price, '0.00');
      if (unit && unit.textContent !== up) unit.textContent = up;
    }

    for (const el of $$('[data-line]')) {
      const id = el.getAttribute('data-id') || '';
      if (id && !ids.has(id)) {
        el.classList.add('fade-out');
        setTimeout(() => { try { el.remove(); } catch {} }, 220);
      }
    }
  };

  const emitUpdated = (snap) => {
    try { window.dispatchEvent(new CustomEvent('cart:updated', { detail: { cart: snap } })); } catch {}
  };

  const applySnap = (snap) => {
    if (!snap) return;
    setSummary(snap);
    renderLines(snap);

    if (window.CartStore && typeof window.CartStore.update === 'function') {
      try { window.CartStore.update(snap); } catch {}
    }

    emitUpdated(snap);
  };

  let busy = false;
  const setBusy = (state) => {
    busy = !!state;
    for (const b of $$('[data-action]')) {
      const act = b.getAttribute('data-action');
      if (act === 'go-checkout') continue;
      if (busy) b.setAttribute('aria-disabled', 'true');
      else b.removeAttribute('aria-disabled');
      b.classList.toggle('btn-disabled', busy);
      if ('disabled' in b) {
        try { b.disabled = busy; } catch {}
      }
    }
    root.toggleAttribute('data-busy', busy);
  };

  let lastRefreshAt = 0;
  const refresh = async (retry = true) => {
    const t = nowMs();
    if (t - lastRefreshAt < 200) return;
    lastRefreshAt = t;

    if (busy) return;
    setBusy(true);
    say('Actualizando carrito…');

    try {
      const d = await apiGet('/cart/json', 'refresh');
      const snap = pickCart(d);
      applySnap(snap);
      say('Carrito actualizado.');
    } catch (e) {
      if (retry) {
        setTimeout(() => refresh(false), 320);
      } else {
        toastSafe('Ups', (e && e.message) ? e.message : 'No se pudo actualizar');
        say('Error al actualizar.');
      }
    } finally {
      setBusy(false);
    }
  };

  const debounceMap = new Map();
  const debounce = (key, fn, ms = 320) => {
    const t = debounceMap.get(key);
    if (t) clearTimeout(t);
    debounceMap.set(key, setTimeout(fn, ms));
  };

  const lockKeys = new Map();
  const withLock = async (key, fn) => {
    if (lockKeys.get(key)) return;
    lockKeys.set(key, true);
    try { await fn(); } finally { lockKeys.delete(key); }
  };

  const commitQty = async (id, qty) => {
    const pid = safeStr(id, '');
    if (!pid) return;

    const q = clamp(toInt(qty, 1), 1, 25);

    await withLock(`qty:${pid}`, async () => {
      try {
        setBusy(true);
        say('Actualizando cantidad…');
        const d = await apiPost('/cart/update?json=1', { id: pid, qty: q }, 'qty');
        const snap = pickCart(d);
        applySnap(snap);
        say('Cantidad actualizada.');
      } catch (e) {
        toastSafe('Ups', (e && e.message) ? e.message : 'No se pudo actualizar');
        say('Error al actualizar.');
        refresh();
      } finally {
        setBusy(false);
      }
    });
  };

  const optimisticRemove = (id) => {
    const pid = safeStr(id, '');
    if (!pid) return null;
    let row = null;
    try { row = root.querySelector(`[data-line][data-id="${CSS.escape(pid)}"]`); } catch {}
    if (!row) return null;
    row.classList.add('fade-out');
    setTimeout(() => { try { row.remove(); } catch {} }, 220);
    return row;
  };

  root.addEventListener('click', (ev) => {
    const btn = ev.target.closest('[data-action]');
    if (!btn) return;

    const action = btn.getAttribute('data-action') || '';
    const id = btn.getAttribute('data-id') || '';

    if (action === 'go-checkout') {
      ev.preventDefault();
      if (btn.dataset.loading === '1') return;

      btn.dataset.loading = '1';
      const original = btn.textContent;
      btn.textContent = 'Redirigiendo…';
      btn.classList.add('btn-disabled');
      say('Redirigiendo al checkout…');

      window.location.href = btn.getAttribute('href') || '/cart/checkout';

      setTimeout(() => {
        btn.textContent = original;
        btn.dataset.loading = '0';
        btn.classList.remove('btn-disabled');
      }, 2500);
      return;
    }

    if (action === 'refresh') { refresh(); return; }
    if (busy) return;

    if (action === 'clear') {
      withLock('clear', async () => {
        try {
          setBusy(true);
          say('Vaciando carrito…');
          const d = await apiPost('/cart/clear?json=1', {}, 'clear');
          const snap = pickCart(d);
          applySnap(snap);
          toastSafe('Listo', 'Carrito vacío ✅');
          say('Carrito vacío.');
        } catch (e) {
          toastSafe('Ups', (e && e.message) ? e.message : 'Error');
          say('Ocurrió un error.');
          refresh();
        } finally {
          setBusy(false);
        }
      });
      return;
    }

    if (action === 'remove') {
      withLock(`rm:${id}`, async () => {
        const removed = optimisticRemove(id);
        try {
          setBusy(true);
          say('Quitando producto…');
          const d = await apiPost('/cart/remove?json=1', { id }, 'remove');
          const snap = pickCart(d);
          applySnap(snap);
          toastSafe('Listo', 'Producto quitado ✅');
          say('Producto quitado.');
        } catch (e) {
          if (removed) refresh();
          toastSafe('Ups', (e && e.message) ? e.message : 'Error');
          say('Ocurrió un error.');
        } finally {
          setBusy(false);
        }
      });
      return;
    }

    if (action === 'inc' || action === 'dec') {
      const input = root.querySelector(`[data-qty-input][data-id="${CSS.escape(id)}"]`);
      const current = input ? toInt(input.value, 1) : 1;
      const next = action === 'inc' ? current + 1 : current - 1;
      const qty = clamp(next, 1, 25);
      if (input) input.value = String(qty);
      commitQty(id, qty);
      return;
    }
  }, { passive: true });

  root.addEventListener('input', (ev) => {
    const inp = ev.target.closest('[data-qty-input]');
    if (!inp) return;

    const id = inp.getAttribute('data-id') || '';
    debounce(`qty:${id}`, async () => {
      if (busy) return;
      const qty = clamp(toInt(inp.value, 1), 1, 25);
      inp.value = String(qty);
      await commitQty(id, qty);
    }, 420);
  });

  root.addEventListener('blur', (ev) => {
    const inp = ev.target.closest('[data-qty-input]');
    if (!inp) return;

    const id = inp.getAttribute('data-id') || '';
    const qty = clamp(toInt(inp.value, 1), 1, 25);
    inp.value = String(qty);
    debounce(`qtyblur:${id}`, () => commitQty(id, qty), 0);
  }, true);

  root.addEventListener('keydown', (ev) => {
    const inp = ev.target.closest('[data-qty-input]');
    if (!inp) return;

    if (ev.key === 'Enter') {
      ev.preventDefault();
      inp.blur();
    }
    if (ev.key === 'Escape') {
      ev.preventDefault();
      refresh();
      inp.blur();
    }
  });

  try {
    window.addEventListener('focus', () => {
      debounce('focusRefresh', () => refresh(false), 200);
    });
  } catch {}

  refresh();
});
</script>
