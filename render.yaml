services:
  - type: web
    name: skyline-style
    env: python
    region: oregon
    plan: free
    branch: master
    autoDeploy: true

    healthCheckPath: /health

    # Build reproducible + rápido
    buildCommand: |
      python -m pip install --upgrade pip setuptools wheel
      pip install --no-cache-dir -r requirements.txt

    # Gunicorn sólido para Render
    startCommand: >
      gunicorn wsgi:app
      --bind 0.0.0.0:$PORT
      --workers ${WEB_CONCURRENCY:-2}
      --threads ${GUNICORN_THREADS:-4}
      --timeout ${GUNICORN_TIMEOUT:-120}
      --graceful-timeout ${GUNICORN_GRACEFUL_TIMEOUT:-30}
      --keep-alive ${GUNICORN_KEEPALIVE:-5}
      --max-requests ${GUNICORN_MAX_REQUESTS:-1000}
      --max-requests-jitter ${GUNICORN_MAX_REQUESTS_JITTER:-100}
      --access-logfile -
      --error-logfile -
      --log-level ${LOG_LEVEL:-info}

    envVars:
      # -------------------------
      # Runtime
      # -------------------------
      - key: PYTHON_VERSION
        value: 3.12.9

      # -------------------------
      # App env
      # -------------------------
      - key: ENV
        value: production
      - key: DEBUG
        value: "0"
      - key: LOG_LEVEL
        value: info

      # -------------------------
      # Seguridad / HTTPS / Proxy
      # CLAVE para CSRF y sesiones en Render
      # -------------------------
      - key: FORCE_HTTPS
        value: "1"
      - key: TRUST_PROXY_HEADERS
        value: "1"
      - key: COOKIE_SECURE
        value: "1"
      - key: SESSION_SAMESITE
        value: Lax
      - key: SESSION_COOKIE_HTTPONLY
        value: "1"

      # Token CSRF con más tolerancia en mobile
      - key: WTF_CSRF_TIME_LIMIT
        value: "3600"

      # -------------------------
      # Secrets (solo dashboard)
      # -------------------------
      - key: SECRET_KEY
        sync: false
      - key: DATABASE_URL
        sync: false

      # -------------------------
      # Uploads (ojo: FREE no persiste)
      # -------------------------
      - key: UPLOADS_DIR
        value: static/uploads

      # -------------------------
      # Printful
      # -------------------------
      - key: PRINTFUL_API_KEY
        sync: false
      - key: PRINTFUL_STORE_ID
        sync: false
      - key: PRINTFUL_CACHE_TTL
        value: "300"

      # -------------------------
      # Mercado Pago
      # -------------------------
      - key: MP_ACCESS_TOKEN
        sync: false
      - key: MP_PUBLIC_KEY
        sync: false

      # -------------------------
      # Admin bootstrap
      # -------------------------
      - key: ADMIN_EMAIL
        sync: false
      - key: ADMIN_PASSWORD
        sync: false

      # -------------------------
      # Gunicorn tuning
      # -------------------------
      - key: WEB_CONCURRENCY
        value: "2"
      - key: GUNICORN_THREADS
        value: "4"
      - key: GUNICORN_TIMEOUT
        value: "120"
      - key: GUNICORN_GRACEFUL_TIMEOUT
        value: "30"
      - key: GUNICORN_KEEPALIVE
        value: "5"
      - key: GUNICORN_MAX_REQUESTS
        value: "1000"
      - key: GUNICORN_MAX_REQUESTS_JITTER
        value: "100"
